<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>StarryLand</title>
  
  <subtitle>æˆ‘çš„å…¨éƒ¨é“è·¯ï¼Œå°±æ˜¯ä»å­¤ç‹¬èµ°å‘äººé—´</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://rollingstarky.github.io/"/>
  <updated>2021-12-14T14:28:49.362Z</updated>
  <id>https://rollingstarky.github.io/</id>
  
  <author>
    <name>æ˜Ÿèˆ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetes in Action ç¬”è®° â€”â€” éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨</title>
    <link href="https://rollingstarky.github.io/2021/12/14/kubernetes-in-action-reading-notes-deploying-first-application/"/>
    <id>https://rollingstarky.github.io/2021/12/14/kubernetes-in-action-reading-notes-deploying-first-application/</id>
    <published>2021-12-13T16:00:00.000Z</published>
    <updated>2021-12-14T14:28:49.362Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Minikube-amp-kubectl"><a href="#Minikube-amp-kubectl" class="headerlink" title="Minikube &amp; kubectl"></a>Minikube &amp; kubectl</h4><p><a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener">Minikube</a> æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨æœ¬åœ°ç¯å¢ƒæ­å»º Kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œæ”¯æŒ Windowsã€Linux å’Œ MacOS ç­‰å¹³å°ï¼Œç”± Kubernetes ç¤¾åŒºè¿›è¡Œç»´æŠ¤ã€‚<br>å®ƒé€šå¸¸åœ¨ Linux è™šæ‹Ÿæœºä¸­è¿è¡Œ Kubernetesã€‚å¦‚æœå®¿ä¸»æœºæ˜¯åŸºäº Linux çš„ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Docker å®ç°ã€‚<br>å³ä¸ºäº†è¿è¡Œ Minikubeï¼Œéœ€è¦å…ˆå®‰è£… Hypervisor æ¯”å¦‚ Virtualboxï¼›å¯¹äº Linux ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Dockerã€‚</p><p>å…·ä½“çš„å®‰è£…é…ç½®æ­¥éª¤å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener">Getting Started Guide</a>ã€‚</p><p>kubectl æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œèƒ½å¤Ÿå‘ Kubernetes é›†ç¾¤å‘é€å‘½ä»¤å¹¶æ‰§è¡Œï¼Œæ”¯æŒçš„åŠŸèƒ½åŒ…æ‹¬éƒ¨ç½²åº”ç”¨ã€æŸ¥è¯¢å’Œç®¡ç†èµ„æºã€æŸ¥çœ‹æ—¥å¿—ç­‰ã€‚<br>å®‰è£…æ­¥éª¤å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/docs/tasks/tools/" target="_blank" rel="noopener">Install Tools</a>ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-cd8f312f56764487.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="kubectl"></p><h4 id="éƒ¨ç½²åº”ç”¨"><a href="#éƒ¨ç½²åº”ç”¨" class="headerlink" title="éƒ¨ç½²åº”ç”¨"></a>éƒ¨ç½²åº”ç”¨</h4><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œéƒ¨ç½²åº”ç”¨æ—¶è¦å‡†å¤‡ä¸€ä¸ª JSON æˆ–è€… YAML æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«å¯¹è¯¥åº”ç”¨çš„æ‰€æœ‰ç»„ä»¶çš„æè¿°ä¿¡æ¯ï¼Œå†æŠŠè¯¥æè¿°æ–‡ä»¶åº”ç”¨åˆ° Kubernetes é›†ç¾¤ã€‚<br>ä»æ¼”ç¤ºçš„è§’åº¦æ¥çœ‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å•è¡Œå‘½ä»¤çš„æ–¹å¼éƒ¨ç½²ç®€å•çš„åº”ç”¨ã€‚</p><h5 id="åˆ›å»º-deployment"><a href="#åˆ›å»º-deployment" class="headerlink" title="åˆ›å»º deployment"></a>åˆ›å»º deployment</h5><p>å¯ä»¥ä½¿ç”¨ <code>kubectl create deployment</code> å‘½ä»¤éƒ¨ç½²åº”ç”¨ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create deployment kubia --image=luksa/kubia:1.0</span></span><br><span class="line">deployment.apps/kubia created</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>kubia</code> è¡¨ç¤ºåˆ›å»ºçš„ <strong>deployment</strong> å¯¹è±¡çš„åç§°ï¼Œ<code>luksa/kubia:1.0</code> æŒ‡ä»£éœ€è¦ä½¿ç”¨çš„å®¹å™¨é•œåƒã€‚</p><p><code>kubia</code> å¯¹è±¡çš„å­˜åœ¨å‘Šè¯‰ Kubernetes <code>luksa/kubia:1.0</code> å®¹å™¨å¿…é¡»è¿è¡Œåœ¨é›†ç¾¤ä¸­ã€‚å®ƒå®šä¹‰äº†ä¸€ç§ç”¨æˆ·æœŸå¾…çš„çŠ¶æ€ï¼Œè€Œ Kubernetes è´Ÿè´£ç¡®ä¿å®é™…çš„çŠ¶æ€ä¸€å®šä¼šæ»¡è¶³è¯¥æœŸæœ›ã€‚</p><p><code>kubectl get deployment</code> å‘½ä»¤å¯ä»¥åˆ—å‡ºå½“å‰é›†ç¾¤ä¸­å­˜åœ¨çš„æ‰€æœ‰ deployment å¯¹è±¡åŠå…¶çŠ¶æ€ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get deployment</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubia   0/1     1            0           5m17s</span><br></pre></td></tr></table></figure></p><h5 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h5><p>å®¹å™¨å¹¶ä¸æ˜¯ Kubernetes ä¸­éƒ¨ç½²çš„æœ€å°å•ä½ã€‚ä¸åŒäºç›´æ¥éƒ¨ç½²ç‹¬ç«‹çš„å®¹å™¨ï¼ŒKubernetes å®é™…ä¸Šä¼šéƒ¨ç½²ä¸€ç»„ç›¸äº’å…³è”çš„å®¹å™¨ï¼Œç§°ä¸º <strong>pod</strong>ã€‚<br>pod åŒ…å«ä¸€ç»„ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Šå…³ç³»å¯†åˆ‡çš„å®¹å™¨å®ä¾‹ï¼ŒåŒæ—¶è¿è¡Œåœ¨åŒä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œå¹¶å…±äº«ç‰¹å®šçš„ Linux å‘½åç©ºé—´ã€‚<br>åŒä¸€ä¸ª pod ä¸­çš„å®¹å™¨å…±äº«ç›¸åŒçš„ç½‘ç»œå’Œ UTS å‘½åç©ºé—´ï¼Œå› è€Œå…±äº«åŒæ ·çš„ç½‘ç»œæ¥å£ã€IP åœ°å€ã€ç«¯å£ç©ºé—´å’Œä¸»æœºåç­‰ã€‚ä¹Ÿå¯ä»¥åœ¨æè¿°æ–‡ä»¶ä¸­å®šä¹‰å…¶ä»–éœ€è¦å…±äº«çš„å‘½åç©ºé—´ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-8722b456a653d61a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="pods"></p><p>æ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„ IPã€æœºå™¨åã€è¿›ç¨‹ã€ç½‘ç»œæ¥å£ä»¥åŠå…¶ä»–èµ„æºã€‚åŒä¸€ä¸ª pod ä¸­çš„å®¹å™¨éƒ½ä¼šå°†è‡ªå·±çœ‹ä½œæ˜¯ pod ä¸­å”¯ä¸€è¿è¡Œçš„å®¹å™¨ï¼Œå®ƒä»¬å¹¶ä¸èƒ½çœ‹åˆ°å…¶ä»–å®¹å™¨ä¸­çš„è¿›ç¨‹ã€‚</p><p>åˆ›å»º Deployment å¯¹è±¡åå°±è¡¨ç¤ºå·²ç»éƒ¨ç½²äº† podï¼ŒKubernetes ä¼šåŸºäº Deployment å¯¹è±¡åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª podã€‚<br>å¯ä»¥ä½¿ç”¨ <code>kubectl get pods</code> æ¥åˆ—å‡ºç³»ç»Ÿä¸­çš„ podï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-767f9bc59d-77d2z   1/1     Running   0          41m</span><br></pre></td></tr></table></figure></p><p>å¦‚æœæŸäº› issue å¯¼è‡´ pod è¿è¡Œå¤±è´¥ï¼Œæˆ–è€…å•çº¯æƒ³æŸ¥çœ‹æ›´å¤š pod ç›¸å…³çš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl describe pod</code> å‘½ä»¤ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod</span></span><br><span class="line">Name:         kubia-767f9bc59d-77d2z</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         minikube/192.168.49.2</span><br><span class="line">Start Time:   Tue, 14 Dec 2021 11:16:58 +0800</span><br><span class="line">Labels:       app=kubia</span><br><span class="line">              pod-template-hash=767f9bc59d</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           172.17.0.3</span><br><span class="line">IPs:</span><br><span class="line">  IP:           172.17.0.3</span><br><span class="line">Controlled By:  ReplicaSet/kubia-767f9bc59d</span><br><span class="line">Containers:</span><br><span class="line">  kubia:</span><br><span class="line">    Container ID:   docker://e9bd5cf8f2eb15959c08bc8f154742b7194030d8ce0f9e6290cd80fc21b48692</span><br><span class="line">    Image:          luksa/kubia:1.0</span><br><span class="line">    Image ID:       docker-pullable://luksa/kubia@sha256:a961dc8f377916936fa963508726d77cf77dcead5c97de7e5361f0875ba3bef7</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Tue, 14 Dec 2021 11:26:25 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-n9n9b (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-n9n9b:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  11m   default-scheduler  Successfully assigned default/kubia-767f9bc59d-77d2z to minikube</span><br><span class="line">  Normal  Pulling    11m   kubelet            Pulling image "luksa/kubia:1.0"</span><br><span class="line">  Normal  Pulled     115s  kubelet            Successfully pulled image "luksa/kubia:1.0" in 9m24.3380576s</span><br><span class="line">  Normal  Created    113s  kubelet            Created container kubia</span><br><span class="line">  Normal  Started    113s  kubelet            Started container kubia</span><br></pre></td></tr></table></figure></p><p>è¾“å‡ºçš„æœ€åå°±åŒ…å« pod åˆ›å»ºå’Œå¯åŠ¨æ—¶è§¦å‘çš„ä¸€ç³»åˆ—äº‹ä»¶ï¼ˆEventsï¼‰ã€‚</p><h5 id="Pods-çš„åˆ›å»ºæµç¨‹"><a href="#Pods-çš„åˆ›å»ºæµç¨‹" class="headerlink" title="Pods çš„åˆ›å»ºæµç¨‹"></a>Pods çš„åˆ›å»ºæµç¨‹</h5><ul><li>è¿è¡Œ <code>kubectl create deployment</code> å‘½ä»¤ï¼Œå‘ Kubernetes API Server å‘é€ HTTP è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Deployment å¯¹è±¡</li><li>ä¹‹å Kubernetes åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod å¯¹è±¡ï¼Œè¯¥ Pod å¯¹è±¡è¢«åˆ†é…ç»™æŸä¸ªå·¥ä½œèŠ‚ç‚¹</li><li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ Kubelet agent å¾—çŸ¥æ–°çš„ Pod å¯¹è±¡è¢«åˆ›å»ºï¼Œä¸”åˆ†é…ç»™äº†è‡ªå·±ã€‚äºæ˜¯ Kubelet æ§åˆ¶ Docker æ‹‰å–ç‰¹å®šçš„é•œåƒå¹¶åˆ›å»ºã€è¿è¡Œå®¹å™¨</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/6875152-a4e1b15833234eb4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Deployment object to a running container"></p><h4 id="å‘å¤–éƒ¨æš´éœ²åº”ç”¨"><a href="#å‘å¤–éƒ¨æš´éœ²åº”ç”¨" class="headerlink" title="å‘å¤–éƒ¨æš´éœ²åº”ç”¨"></a>å‘å¤–éƒ¨æš´éœ²åº”ç”¨</h4><p>åº”ç”¨å·²ç»æˆåŠŸè¿è¡Œäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ§åˆ¶å®ƒå¦‚ä½•è¢«å¤–éƒ¨è®¿é—®ã€‚æ¯ä¸ª pod éƒ½ä¼šè·å¾—ä¸€ä¸ªä¸“å±çš„ IP åœ°å€ï¼Œä½†è¯¥åœ°å€æ˜¯åªæœ‰é›†ç¾¤å†…éƒ¨å¯è§çš„ã€‚ä¸ºäº†ä½¿ pod èƒ½å¤Ÿä»å¤–éƒ¨è®¿é—®ï¼Œè¿˜éœ€è¦åˆ›å»ºä¸€ä¸ª <strong>Service</strong> å¯¹è±¡ã€‚</p><p>Service å¯¹è±¡æœ‰å¥½å‡ ç§ç±»å‹ï¼Œå…¶ä¸­ä¸€ç§ LoadBalancer ä¼šç”Ÿæˆä¸€ä¸ªå¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä»¤æœåŠ¡èƒ½å¤Ÿä»é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚<br>å¯ä»¥ä½¿ç”¨ <code>kubectl expose</code> å‘½ä»¤åˆ›å»º Serviceï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl expose deployment kubia --<span class="built_in">type</span>=LoadBalancer --port 8080</span></span><br><span class="line">service/kubia exposed</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨ <code>kubectl get svc</code> å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„ Serviceï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get svc</span></span><br><span class="line">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP      10.96.0.1       &lt;none&gt;        443/TCP          29d</span><br><span class="line">kubia        LoadBalancer   10.106.111.39   &lt;pending&gt;     8080:30077/TCP   2m28s</span><br></pre></td></tr></table></figure></p><p>åˆ›å»º LoadBalancer æœåŠ¡æ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹ Kubernetes ä¼šè®¿é—®äº‘æœåŠ¡æä¾›å•†ï¼Œä»¤å…¶åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨å¹¶è·å–å…¬å…± IPã€‚<br>Minikube æ˜¯æœ¬åœ°æ¨¡æ‹Ÿçš„é›†ç¾¤ç¯å¢ƒï¼Œå› è€Œæ— æ³•å®Œæˆä¸Šè¿°æ“ä½œã€‚kubia Service çš„ EXTERNAL-IP ä¼šä¸€ç›´å¤„äº <pending> çŠ¶æ€ã€‚</pending></p><p>åœ¨æ²¡æœ‰è·å–åˆ°å¤–éƒ¨ IP çš„æƒ…å†µä¸‹ï¼Œminikube å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•è·å–æœåŠ¡çš„ urlï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> minikube service kubia --url</span></span><br><span class="line">ğŸƒ  Starting tunnel for service kubia.</span><br><span class="line">|-----------|-------|-------------|------------------------|</span><br><span class="line">| NAMESPACE | NAME  | TARGET PORT |          URL           |</span><br><span class="line">|-----------|-------|-------------|------------------------|</span><br><span class="line">| default   | kubia |             | http://127.0.0.1:39529 |</span><br><span class="line">|-----------|-------|-------------|------------------------|</span><br><span class="line">http://127.0.0.1:39529</span><br><span class="line">â—  Because you are using a Docker driver on linux, the terminal needs to be open to run it.</span><br></pre></td></tr></table></figure></p><p>æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œçª—å£ï¼Œå¯ä»¥æˆåŠŸè®¿é—®ä¸Šé¢çš„ urlï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://127.0.0.1:39529</span></span><br><span class="line">Hey there, this is kubia-767f9bc59d-77d2z. Your IP is ::ffff:172.17.0.1.</span><br></pre></td></tr></table></figure></p><h5 id="LoadBalancer-çš„åˆ›å»ºæµç¨‹"><a href="#LoadBalancer-çš„åˆ›å»ºæµç¨‹" class="headerlink" title="LoadBalancer çš„åˆ›å»ºæµç¨‹"></a>LoadBalancer çš„åˆ›å»ºæµç¨‹</h5><p><img src="https://upload-images.jianshu.io/upload_images/6875152-847957263408bbb1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Service object to LoadBalancer"></p><h4 id="æ¨ªå‘æ‰©å±•åº”ç”¨"><a href="#æ¨ªå‘æ‰©å±•åº”ç”¨" class="headerlink" title="æ¨ªå‘æ‰©å±•åº”ç”¨"></a>æ¨ªå‘æ‰©å±•åº”ç”¨</h4><p>åœ¨å®¹å™¨ä¸­éƒ¨ç½²åº”ç”¨çš„ä¸€ä¸ªä¸»è¦å¥½å¤„å°±æ˜¯ï¼Œæ¨ªå‘æ‰©å±•åº”ç”¨å˜å¾—éå¸¸ç®€å•å’Œç›´è§‚ã€‚<br>å¯ä»¥ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤æ‰©å±• kubia åº”ç”¨ï¼Œä»¤å…¶åŒæ—¶è¿è¡Œ 3 ä¸ªå®ä¾‹å‰¯æœ¬ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl scale deployment kubia --replicas=3</span></span><br><span class="line">deployment.apps/kubia scaled</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get deploy</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubia   3/3     3            3           3h58m</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶å…±æœ‰ 3 ä¸ª pod å®ä¾‹è¿è¡Œï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-767f9bc59d-77d2z   1/1     Running   0          3h59m</span><br><span class="line">kubia-767f9bc59d-rvsdq   1/1     Running   0          3m56s</span><br><span class="line">kubia-767f9bc59d-sfn42   1/1     Running   0          3m56s</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥åŠ ä¸Š <code>-o wide</code> é€‰é¡¹è·å–æ›´è¯¦ç»†çš„ pods ä¿¡æ¯ï¼Œæ¯”å¦‚ IPã€è¿è¡Œçš„èŠ‚ç‚¹ç­‰ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">kubia-767f9bc59d-77d2z   1/1     Running   0          4h      172.17.0.3   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubia-767f9bc59d-rvsdq   1/1     Running   0          5m31s   172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubia-767f9bc59d-sfn42   1/1     Running   0          5m31s   172.17.0.4   minikube   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p><p>å†æ¬¡è®¿é—® Service çš„ URLï¼Œå¯ä»¥çœ‹åˆ°å¤šæ¬¡è®¿é—®è¿”å›çš„ä¿¡æ¯å¹¶ä¸ä¸€æ ·ï¼Œå¯ä»¥è¯å®åå°æä¾›æœåŠ¡çš„ pod å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œè€Œæ˜¯ 3 ä¸ª pod è½®æµæ¥æ”¶è¯·æ±‚å¹¶æä¾›æœåŠ¡ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://127.0.0.1:39529</span></span><br><span class="line">Hey there, this is kubia-767f9bc59d-sfn42. Your IP is ::ffff:172.17.0.1.</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://127.0.0.1:39529</span></span><br><span class="line">Hey there, this is kubia-767f9bc59d-77d2z. Your IP is ::ffff:172.17.0.1.</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://127.0.0.1:39529</span></span><br><span class="line">Hey there, this is kubia-767f9bc59d-sfn42. Your IP is ::ffff:172.17.0.1.</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://127.0.0.1:39529</span></span><br><span class="line">Hey there, this is kubia-767f9bc59d-rvsdq. Your IP is ::ffff:172.17.0.1.</span><br></pre></td></tr></table></figure></p><p>è´Ÿè½½å‡è¡¡æ¶æ„ç¤ºæ„å›¾ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/6875152-2ec179df5ff6687c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Load balancing"></p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul><li>éƒ¨ç½²åº”ç”¨å¯ä»¥ä½¿ç”¨ <code>kubectl create deployment</code> å‘½ä»¤ï¼Œæš´éœ²åº”ç”¨ä½¿ç”¨ <code>kubectl expose deployment</code> å‘½ä»¤ï¼Œæ¨ªå‘æ‰©å±•åº”ç”¨ä½¿ç”¨ <code>kubectl scale deployment</code> å‘½ä»¤ã€‚</li><li>åº”ç”¨éƒ¨ç½²çš„åŸºæœ¬å•ä½ä¸æ˜¯å®¹å™¨è€Œæ˜¯ podï¼Œä¸€ä¸ª pod å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç›¸äº’å…³è”çš„å®¹å™¨ã€‚</li><li>Deploymentsã€Servicesã€Pods å’Œ Nodes éƒ½æ˜¯ Kubernetes å¯¹è±¡/èµ„æºã€‚å¯ä»¥ä½¿ç”¨ <code>kubectl get</code> å‘½ä»¤è·å–è¿™äº›å¯¹è±¡çš„åˆ—è¡¨ï¼Œæˆ–è€…ä½¿ç”¨ <code>kubectl describe</code> å‘½ä»¤è·å–å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚</li><li>Deployment å¯¹è±¡è´Ÿè´£éƒ¨ç½²æŒ‡å®šæ•°é‡çš„ podsã€‚Services å¯¹è±¡åˆ™å¯ä»¥ä»¤è¿™äº› pods èƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªå•ä¸€çš„ IP åœ°å€è®¿é—®ã€‚</li><li>Service åœ¨é›†ç¾¤å†…éƒ¨æä¾›è´Ÿè½½å‡è¡¡ã€‚å¦‚æœæŒ‡å®šå…¶ç±»å‹ä¸º LoadBalancerï¼Œåˆ™ Kubernetes ä¼šè¯·æ±‚äº‘æœåŠ¡æä¾›å•†ä»¤åº”ç”¨å¯ä»¥é€šè¿‡å…¬å…±åœ°å€è®¿é—®ã€‚</li></ul><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://www.manning.com/books/kubernetes-in-action-second-edition" target="_blank" rel="noopener">Kubernetes in Action, Second Edition</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;Minikube-amp-kubectl&quot;&gt;&lt;a href=&quot;#Minikube-amp-kubectl&quot; class=&quot;headerlink&quot; title=&quot;Minikube &amp;amp; kubectl&quot;&gt;&lt;/a&gt;Minikube &amp;amp; kubectl&lt;/
      
    
    </summary>
    
      <category term="Linux" scheme="https://rollingstarky.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://rollingstarky.github.io/tags/Linux/"/>
    
      <category term="Server" scheme="https://rollingstarky.github.io/tags/Server/"/>
    
      <category term="Docker" scheme="https://rollingstarky.github.io/tags/Docker/"/>
    
      <category term="Container" scheme="https://rollingstarky.github.io/tags/Container/"/>
    
      <category term="Kubernetes" scheme="https://rollingstarky.github.io/tags/Kubernetes/"/>
    
      <category term="MicroService" scheme="https://rollingstarky.github.io/tags/MicroService/"/>
    
      <category term="Deployment" scheme="https://rollingstarky.github.io/tags/Deployment/"/>
    
      <category term="Cluster" scheme="https://rollingstarky.github.io/tags/Cluster/"/>
    
      <category term="LoadBalance" scheme="https://rollingstarky.github.io/tags/LoadBalance/"/>
    
  </entry>
  
  <entry>
    <title>Uncle Bob çš„ SOLID è½¯ä»¶è®¾è®¡åŸåˆ™â€”â€”Python å®ä¾‹è®²è§£</title>
    <link href="https://rollingstarky.github.io/2021/12/13/uncle-bob-SOLID-principles-in-python/"/>
    <id>https://rollingstarky.github.io/2021/12/13/uncle-bob-SOLID-principles-in-python/</id>
    <published>2021-12-12T16:00:00.000Z</published>
    <updated>2021-12-13T15:27:42.347Z</updated>
    
    <content type="html"><![CDATA[<p>SOLID æ˜¯ 5 ç§è½¯ä»¶è®¾è®¡åŸåˆ™çš„é¦–å­—æ¯ç¼©å†™ï¼Œç”±ç¾å›½çš„è½¯ä»¶å·¥ç¨‹å¸ˆ <a href="https://en.wikipedia.org/wiki/Robert_C._Martin" target="_blank" rel="noopener">Robert C. Martin</a>ï¼ˆä¹ æƒ¯ä¸Šè¢«ç§°ä¸º Uncle Bobï¼‰æ€»ç»“ã€‚å¯ä»¥å¸®åŠ©ç¨‹åºå‘˜å†™å‡ºæ›´åŠ çµæ´»ã€å®¹æ˜“ç†è§£ã€å¯ç»´æŠ¤æ€§å¼ºã€æ–¹ä¾¿æ‰©å±•çš„å¥å£®ä»£ç ã€‚</p><ul><li>S ä»£è¡¨ <a href="https://en.wikipedia.org/wiki/Single-responsibility_principle" target="_blank" rel="noopener">Single Responsibility Principle (SRP)</a>ï¼Œä¸€ä¸ªç±»åº”è¯¥åªåŒ…å«ä¸€ç§å•ä¸€çš„èŒè´£ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ç§åŸå› èƒ½ä¿ƒä½¿å…¶å˜æ›´ã€‚é€šä¿—ç‚¹è¯´ï¼Œè®©ä¸€ä¸ªç±»åªåšä¸€ä»¶äº‹ã€‚å¦‚æœéœ€è¦æ‰¿æ‹…æ›´å¤šçš„å·¥ä½œï¼Œé‚£ä¹ˆåˆ†è§£è¿™ä¸ªç±»ã€‚</li><li>O ä»£è¡¨ <a href="https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle" target="_blank" rel="noopener">Open/Closed Principle (OCP)</a>ï¼Œè½¯ä»¶å®ä½“åº”è¯¥å¯¹æ‰©å±•æ˜¯å¼€æ”¾çš„ï¼ŒåŒæ—¶å¯¹ä¿®æ”¹æ˜¯å°é—­çš„ã€‚å¦‚æœéœ€è¦æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œåº”è¯¥ä¼˜å…ˆæ‰©å±•æŸä¸ªç±»è€Œä¸æ˜¯ä¿®æ”¹å®ƒã€‚</li><li>L ä»£è¡¨ <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank" rel="noopener">Liskov Substitution Principle (LSP)</a>ï¼Œç¨‹åºä¸­çš„å¯¹è±¡åº”è¯¥èƒ½å¤Ÿæ›¿æ¢ä¸ºå…¶å­ç±»å‹çš„å®ä¾‹ï¼Œä»ä¸å½±å“ä»£ç çš„æ­£ç¡®æ€§ã€‚</li><li>I ä»£è¡¨ <a href="https://en.wikipedia.org/wiki/Interface_segregation_principle" target="_blank" rel="noopener">Interface Segregation Principle (ISP)</a>ï¼Œå¤šä¸ªä¸“é—¨çš„åŸºäºå®¢æˆ·ç«¯çš„æ¥å£è¦å¥½äºåªæœ‰ä¸€ä¸ªé€šç”¨çš„æ¥å£ã€‚ä¸€ä¸ªç±»å¯¹å¦ä¸€ä¸ªç±»çš„ä¾èµ–æ€§åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šï¼Œå®¢æˆ·ç«¯ä¸åº”è¯¥è¢«å¼ºè¿«å®ç°ä¸€äº›ä»–ä»¬ä¸ä¼šä½¿ç”¨çš„æ¥å£ã€‚</li><li>D ä»£è¡¨ <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle" target="_blank" rel="noopener">Dependency Inversion Principle (DIP)</a>ï¼ŒæŠ½è±¡ä¸åº”è¯¥ä¾èµ–äºç»†èŠ‚ï¼Œç»†èŠ‚åº”å½“ä¾èµ–äºæŠ½è±¡ã€‚å³è¦é’ˆå¯¹æŠ½è±¡ï¼ˆæ¥å£ï¼‰ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å®ç°ç»†èŠ‚ç¼–ç¨‹ã€‚</li></ul><h4 id="å®ä¾‹ä»£ç "><a href="#å®ä¾‹ä»£ç " class="headerlink" title="å®ä¾‹ä»£ç "></a>å®ä¾‹ä»£ç </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, payment_type, security_code)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> payment_type == <span class="string">"debit"</span>:</span><br><span class="line">            print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">            print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">            self.status = <span class="string">"paid"</span></span><br><span class="line">        <span class="keyword">elif</span> payment_type == <span class="string">"credit"</span>:</span><br><span class="line">            print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">            print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">            self.status = <span class="string">"paid"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f"Unknown payment type: <span class="subst">&#123;payment_type&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">order.pay(<span class="string">"debit"</span>, <span class="string">"0372846"</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿° Python ä»£ç å®ç°äº†ä¸€ä¸ªç®€å•çš„â€œè´­ç‰©è½¦â€ï¼ˆè®¢å•ï¼‰åº”ç”¨ã€‚</p><ul><li><code>add_item</code> æ–¹æ³•å¯ä»¥å‘è®¢å•ä¸­æ·»åŠ æ–°çš„è´§ç‰©</li><li><code>total_price</code> æ–¹æ³•å¯ä»¥è®¡ç®—è®¢å•çš„æ€»ä»·</li><li><code>pay</code> æ–¹æ³•å®ç°äº†è®¢å•çš„æ”¯ä»˜åŠŸèƒ½ï¼Œæ”¯æŒå€Ÿè®°å¡ã€ä¿¡ç”¨å¡ç­‰æ”¯ä»˜æ–¹å¼</li></ul><h4 id="Single-Responsibility-Principle"><a href="#Single-Responsibility-Principle" class="headerlink" title="Single Responsibility Principle"></a>Single Responsibility Principle</h4><p>å•ä¸€èŒèƒ½åŸåˆ™ã€‚<br>å°†æ”¯ä»˜åŠŸèƒ½ä» <code>Order</code> ç±»ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œåœ¨å¦ä¸€ä¸ª <code>PaymentProcessor</code> ç±»ä¸­å®ç°ã€‚åŒæ—¶å»æ‰ <code>pay</code> æ–¹æ³•ä¸­çš„ <code>if-else</code> åˆ¤æ–­ï¼Œåˆ†åˆ«ç”¨ä¸¤ä¸ªå‡½æ•° <code>pay_debit</code> å’Œ <code>pay_credit</code> å®ç°ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_debit</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_credit</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">processor = PaymentProcessor()</span><br><span class="line">processor.pay_debit(order, <span class="string">"0372846"</span>)</span><br></pre></td></tr></table></figure></p><h4 id="Open-Closed-Principle"><a href="#Open-Closed-Principle" class="headerlink" title="Open/Closed Principle"></a>Open/Closed Principle</h4><p>åœ¨æœ€æ–°çš„æ”¯ä»˜åŠŸèƒ½çš„å®ç°ä¸­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªæ–°çš„æ”¯ä»˜æ–¹æ³•ï¼ˆæ¯”å¦‚ PayPalï¼‰ï¼Œå°±å¿…é¡»ä¿®æ”¹ <code>PaymentProcessor</code> ç±»çš„åŸå§‹ä»£ç ã€‚è¿™å°±è¿åäº† Open/Closed åŸåˆ™ï¼Œé¢å¤–çš„åŠŸèƒ½åº”è¯¥é€šè¿‡æ‰©å±•è€Œä¸æ˜¯ä¿®æ”¹åŸæ¥çš„ç±»æ¥å®ç°ã€‚<br>æ”¹è¿›çš„æ–¹æ³•æ˜¯ç”¨ä¸€ä¸ªåŸºç±»ï¼ˆ<code>PaymentProcessor</code>ï¼‰æ¥å®šä¹‰åŸºæœ¬çš„æ”¯ä»˜é€»è¾‘ï¼Œå†é€šè¿‡å­ç±»ï¼ˆå¦‚ <code>DebitPaymentProcessor</code>ï¼‰æ¥å®ç°å…·ä½“çš„æ”¯ä»˜æ–¹æ³•ã€‚è¿™æ ·æ¯å½“æ·»åŠ ä¸€ç§æ–°çš„æ”¯ä»˜æ–¹å¼ï¼Œç›´æ¥å®ç°ä¸€ä¸ªæ–°çš„å­ç±»å³å¯ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebitPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">processor = DebitPaymentProcessor()</span><br><span class="line">processor.pay(order, <span class="string">"0372846"</span>)</span><br></pre></td></tr></table></figure></p><h4 id="Liskov-Substitution-Principle"><a href="#Liskov-Substitution-Principle" class="headerlink" title="Liskov Substitution Principle"></a>Liskov Substitution Principle</h4><p>å‡è®¾æˆ‘ä»¬ç°åœ¨éœ€è¦æ·»åŠ ä¸€ç§æ–°çš„æ”¯ä»˜æ–¹å¼ <code>PayPalPaymentProcessor</code>ï¼Œå®ƒåœ¨æ”¯ä»˜æ—¶å¹¶ä¸ä¾èµ–äº <code>security_code</code> è€Œæ˜¯éœ€è¦ <code>email_address</code> è¿›è¡ŒéªŒè¯ã€‚å³ <code>pay</code> æ–¹æ³•çš„å®šä¹‰æ˜¯ <code>pay(self, order, email_address)</code>ï¼Œä¸åŸºç±»ä¸­è™šæ‹Ÿæ–¹æ³•çš„ç­¾åå†²çªã€‚<br>æ”¹è¿›çš„æ–¹æ³•æ˜¯å°† <code>pay</code> æ–¹æ³•ä¾èµ–çš„å‚æ•° <code>security_code</code> æˆ– <code>email_address</code> ç§»åŠ¨åˆ°æ”¯ä»˜ç±»çš„ <code>__init__</code> æ–¹æ³•ä¸­ï¼Œå°†åŸºç±»å’Œå­ç±»çš„ <code>pay</code> æ–¹æ³•ç­¾åéƒ½æ”¹ä¸º <code>pay(self, order)</code>ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebitPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;self.security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaypalPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, email_address)</span>:</span></span><br><span class="line">        self.email_address = email_address</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing paypal payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying email address: <span class="subst">&#123;self.email_address&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">processor = PaypalPaymentProcessor(<span class="string">'hi@example.com'</span>)</span><br><span class="line">processor.pay(order)</span><br></pre></td></tr></table></figure></p><h4 id="Interface-Segregation-Principle"><a href="#Interface-Segregation-Principle" class="headerlink" title="Interface Segregation Principle"></a>Interface Segregation Principle</h4><p>å‡è®¾æˆ‘ä»¬éœ€è¦åœ¨æ”¯ä»˜ç»„ä»¶ä¸­æ·»åŠ ä¸€ä¸ªéªŒè¯çŸ­ä¿¡çš„åŠŸèƒ½ã€‚ç›´è§‚çš„æƒ³æ³•æ˜¯ç›´æ¥åœ¨ <code>PaymentProcessor</code> åŸºç±»ä¸­æ·»åŠ ä¸€ä¸ª <code>auth_sms</code> è™šæ‹Ÿæ–¹æ³•ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth_sms</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p><p>å¯¹äºéœ€è¦éªŒè¯çŸ­ä¿¡çš„æ”¯ä»˜æ–¹å¼æ¯”å¦‚å€Ÿè®°å¡ï¼Œæ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebitPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line">        self.verified = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth_sms</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        print(<span class="string">f"Verifying SMS code <span class="subst">&#123;code&#125;</span>"</span>)</span><br><span class="line">        self.verified = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.verified:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;self.security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br></pre></td></tr></table></figure></p><p>å¯¹äºä¸éœ€è¦çŸ­ä¿¡éªŒè¯çš„æ”¯ä»˜æ–¹å¼æ¯”å¦‚ä¿¡ç”¨å¡ï¼Œå°±æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth_sms</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> Exception(</span><br><span class="line">            <span class="string">"Credit card payments don't support SMS code authorization."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°å®ç°çš„é—®é¢˜åœ¨äºï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªé€šç”¨çš„æ”¯ä»˜æ¥å£ï¼ˆ<code>PaymentProcessor</code>ï¼‰ï¼ŒåŒ…å« <code>pay</code> å’Œ <code>auth_sms</code> ä¸¤ç§éªŒè¯é€»è¾‘ã€‚ä½†è¿™ä¸¤ç§é€»è¾‘å¹¶ä¸æ€»æ˜¯è¢«å…·ä½“çš„æ”¯ä»˜æ–¹å¼ï¼ˆæ¯”å¦‚ <code>CreditPaymentProcessor</code>ï¼‰æ‰€éœ€è¦ã€‚<br>è¿™è¿åäº†æ¥å£åˆ†ç¦»åŸåˆ™ã€‚å³æ¥å£çš„å®ç°åº”è¯¥ä¾èµ–äºå…·ä½“çš„å®¢æˆ·ç«¯ï¼ˆå­ç±»ï¼‰éœ€æ±‚ï¼Œè€Œä¸èƒ½ä¸ç®¡å®¢æˆ·ç«¯æ˜¯å¦éœ€è¦ï¼Œå°±å°†æ‰€æœ‰çš„åŠŸèƒ½éƒ½æ”¾åœ¨ä¸€ä¸ªèƒ–æ¥å£ä¸­ã€‚<br>å¯ä»¥é¢å¤–å†å®ç°ä¸€ä¸ª <code>PaymentProcessor_SMS</code> åŸºç±»æ¥å®šä¹‰çŸ­ä¿¡éªŒè¯çš„é€»è¾‘ï¼Œè®©ä¸éœ€è¦çŸ­ä¿¡éªŒè¯çš„æ”¯ä»˜æ–¹å¼ç»§æ‰¿ <code>PaymentProcessor</code> åŸºç±»ï¼Œéœ€è¦çŸ­ä¿¡éªŒè¯çš„æ”¯ä»˜æ–¹å¼ç»§æ‰¿ <code>PaymentProcessor_SMS</code> åŸºç±»ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor_SMS</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth_sms</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebitPaymentProcessor</span><span class="params">(PaymentProcessor_SMS)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line">        self.verified = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth_sms</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        print(<span class="string">f"Verifying SMS code <span class="subst">&#123;code&#125;</span>"</span>)</span><br><span class="line">        self.verified = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.verified:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;self.security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaypalPaymentProcessor</span><span class="params">(PaymentProcessor_SMS)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, email_address)</span>:</span></span><br><span class="line">        self.email_address = email_address</span><br><span class="line">        self.verified = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth_sms</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        print(<span class="string">f"Verifying SMS code <span class="subst">&#123;code&#125;</span>"</span>)</span><br><span class="line">        self.verified = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.verified:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing paypal payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying email address: <span class="subst">&#123;self.email_address&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">processor = PaypalPaymentProcessor(<span class="string">'hi@example.com'</span>)</span><br><span class="line">processor.auth_sms(<span class="number">123456</span>)</span><br><span class="line">processor.pay(order)</span><br></pre></td></tr></table></figure></p><h5 id="Composition-over-Inheritance"><a href="#Composition-over-Inheritance" class="headerlink" title="Composition over Inheritance"></a>Composition over Inheritance</h5><p>åœ¨è½¯ä»¶è®¾è®¡çš„å¤§éƒ¨åˆ†åœºæ™¯ä¸­ï¼Œç»„åˆè¦ä¼˜äºç»§æ‰¿ã€‚å› ä¸ºç»§æ‰¿æ€»æ˜¯æ„å‘³ç€æ›´ç´§å¯†çš„è€¦åˆæ€§ã€‚<br>å®é™…ä¸ŠçŸ­ä¿¡è®¤è¯å¹¶ä¸ä¸€å®šé€šè¿‡ç»§æ‰¿æ¥å®ç°ï¼ˆ<code>PaymentProcessor_SMS</code>ï¼‰ï¼Œè¿˜å¯ä»¥é€šè¿‡ç»„åˆæ¥å®ç°ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSAuth</span>:</span></span><br><span class="line">    authorized = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify_code</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        print(<span class="string">f"Verifying code <span class="subst">&#123;code&#125;</span>"</span>)</span><br><span class="line">        self.authorized = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_authorized</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="keyword">return</span> self.authorized</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebitPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code, authorizer: SMSAuth)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line">        self.authorizer = authorizer</span><br><span class="line">        self.verified = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.authorizer.is_authorized():</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;self.security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaypalPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, email_address, authorizer: SMSAuth)</span>:</span></span><br><span class="line">        self.email_address = email_address</span><br><span class="line">        self.authorizer = authorizer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.authorizer.is_authorized():</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing paypal payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying email address: <span class="subst">&#123;self.email_address&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">authorizer = SMSAuth()</span><br><span class="line">processor = DebitPaymentProcessor(<span class="string">'0372846'</span>, authorizer)</span><br><span class="line">authorizer.verify_code(<span class="number">123456</span>)</span><br><span class="line">processor.pay(order)</span><br></pre></td></tr></table></figure></p><p>å®šä¹‰ä¸€ä¸ª <code>SMS_Auth</code> ç±»æ¥å®ç°çŸ­ä¿¡éªŒè¯çš„é€»è¾‘ï¼Œå†é€šè¿‡ç»„åˆçš„æ–¹å¼å°†å…¶å®ä¾‹æ·»åŠ åˆ°å…·ä½“çš„éœ€è¦çŸ­ä¿¡éªŒè¯çš„æ”¯ä»˜æ–¹å¼ä¸­ï¼ˆæ¯”å¦‚ <code>DebitPaymentProcessor</code>ï¼‰ã€‚</p><h4 id="Dependency-Inversion-Principle"><a href="#Dependency-Inversion-Principle" class="headerlink" title="Dependency Inversion Principle"></a>Dependency Inversion Principle</h4><p>ç»†èŠ‚åº”è¯¥ä¾èµ–äºæŠ½è±¡ï¼Œè€Œä¸æ˜¯æŠ½è±¡ä¾èµ–äºç»†èŠ‚ã€‚ä¸Šè¿°å®ç°ä¸­å°±è¿åäº†è¿™ä¸ªåŸåˆ™ã€‚<br>æ¯”å¦‚å€Ÿè®°å¡æ”¯ä»˜æ–¹å¼ï¼ˆ<code>DebitPaymentProcessor</code>ï¼‰çš„ <code>__init__</code> æ–¹æ³•ï¼Œç­¾åæ˜¯ <code>__init__(self, security_code, authorizer: SMSAuth)</code>ã€‚å…¶ä¸­çš„ <code>SMSAuth</code> æ˜¯ä¸€ä¸ªå…·ä½“çš„çŸ­ä¿¡éªŒè¯ç±»å‹ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªé€šç”¨çš„ä»£è¡¨æŸç§éªŒè¯ç±»å‹çš„æŠ½è±¡ã€‚<br>è¿™æ ·å½“æ”¯ä»˜æ–¹å¼éœ€è¦çš„æ˜¯å¦å¤–ä¸€ç§éªŒè¯æ–¹æ³•ï¼ˆæ¯”å¦‚ <code>NotARobot</code>ï¼‰ï¼Œè¿™é‡Œçš„ç­¾åå°±éœ€è¦ä¿®æ”¹ã€‚</p><p>å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>Authorizer</code> åŸºç±»æ¥ä»£è¡¨é€šç”¨çš„éªŒè¯æ–¹å¼ï¼Œå…·ä½“çš„éªŒè¯æ–¹å¼æ¯”å¦‚ <code>SMSAuth</code>ã€<code>NotARobot</code> åˆ™ä½œä¸º <code>Authorizer</code> çš„å­ç±»æ¥å®ç°ã€‚<br>åœ¨æ”¯ä»˜æ–¹å¼çš„å®ç°ä¸­ï¼Œåˆ™ä½¿ç”¨ <code>Authorizer</code> ä½œä¸ºéªŒè¯æ–¹å¼çš„ç±»å‹å®šä¹‰ã€‚è¿™æ ·åœ¨ä½¿ç”¨æ”¯ä»˜ç±»çš„å®ä¾‹æ—¶ï¼Œå°±å¯ä»¥çµæ´»åœ°ä¼ å…¥ <code>Authorizer</code> çš„å­ç±» <code>SMSAuth</code> æˆ–è€… <code>NotARobot</code> è¿›è¡Œç»„åˆã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span></span><br><span class="line">    items = []</span><br><span class="line">    quantities = []</span><br><span class="line">    prices = []</span><br><span class="line">    status = <span class="string">"open"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_item</span><span class="params">(self, name, quantity, price)</span>:</span></span><br><span class="line">        self.items.append(name)</span><br><span class="line">        self.quantities.append(quantity)</span><br><span class="line">        self.prices.append(price)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_price</span><span class="params">(self)</span>:</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self.prices)):</span><br><span class="line">            total += self.quantities[i] * self.prices[i]</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authorizer</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_authorized</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSAuth</span><span class="params">(Authorizer)</span>:</span></span><br><span class="line">    authorized = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify_code</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        print(<span class="string">f"Verifying code <span class="subst">&#123;code&#125;</span>"</span>)</span><br><span class="line">        self.authorized = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_authorized</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="keyword">return</span> self.authorized</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotARobot</span><span class="params">(Authorizer)</span>:</span></span><br><span class="line">    authorized = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">not_a_robot</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Are you a robot? Naa"</span>)</span><br><span class="line">        self.authorized = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_authorized</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="keyword">return</span> self.authorized</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentProcessor</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebitPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code, authorizer: Authorizer)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line">        self.authorizer = authorizer</span><br><span class="line">        self.verified = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.authorizer.is_authorized():</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing debit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;self.security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_code)</span>:</span></span><br><span class="line">        self.security_code = security_code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order, security_code)</span>:</span></span><br><span class="line">        print(<span class="string">"Processing credit payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying security code: <span class="subst">&#123;security_code&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaypalPaymentProcessor</span><span class="params">(PaymentProcessor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, email_address, authorizer: Authorizer)</span>:</span></span><br><span class="line">        self.email_address = email_address</span><br><span class="line">        self.authorizer = authorizer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.authorizer.is_authorized():</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Not authorized"</span>)</span><br><span class="line">        print(<span class="string">"Processing paypal payment type"</span>)</span><br><span class="line">        print(<span class="string">f"Verifying email address: <span class="subst">&#123;self.email_address&#125;</span>"</span>)</span><br><span class="line">        order.status = <span class="string">"paid"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order = Order()</span><br><span class="line">order.add_item(<span class="string">"Keyborad"</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">order.add_item(<span class="string">"SSD"</span>, <span class="number">1</span>, <span class="number">150</span>)</span><br><span class="line">order.add_item(<span class="string">"USB cable"</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(order.total_price())</span><br><span class="line">authorizer = NotARobot()</span><br><span class="line">processor = DebitPaymentProcessor(<span class="string">'0372846'</span>, authorizer)</span><br><span class="line">authorizer.not_a_robot()</span><br><span class="line">processor.pay(order)</span><br></pre></td></tr></table></figure></p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://www.youtube.com/watch?v=pTB30aXS77U" target="_blank" rel="noopener">Uncle Bobâ€™s SOLID principles made easy ğŸ€ - in Python!</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;SOLID æ˜¯ 5 ç§è½¯ä»¶è®¾è®¡åŸåˆ™çš„é¦–å­—æ¯ç¼©å†™ï¼Œç”±ç¾å›½çš„è½¯ä»¶å·¥ç¨‹å¸ˆ &lt;a href=&quot;https://en.wikipedia.org/wiki/Robert_C._Martin&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Robert C. Marti
      
    
    </summary>
    
      <category term="Python" scheme="https://rollingstarky.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://rollingstarky.github.io/tags/Python/"/>
    
      <category term="OOP" scheme="https://rollingstarky.github.io/tags/OOP/"/>
    
      <category term="Class" scheme="https://rollingstarky.github.io/tags/Class/"/>
    
      <category term="Design" scheme="https://rollingstarky.github.io/tags/Design/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Interface" scheme="https://rollingstarky.github.io/tags/Interface/"/>
    
      <category term="Inheritance" scheme="https://rollingstarky.github.io/tags/Inheritance/"/>
    
      <category term="Principle" scheme="https://rollingstarky.github.io/tags/Principle/"/>
    
      <category term="SOLID" scheme="https://rollingstarky.github.io/tags/SOLID/"/>
    
      <category term="Composition" scheme="https://rollingstarky.github.io/tags/Composition/"/>
    
      <category term="Dependency" scheme="https://rollingstarky.github.io/tags/Dependency/"/>
    
  </entry>
  
  <entry>
    <title>Linux xargs å‘½ä»¤è§£æ</title>
    <link href="https://rollingstarky.github.io/2021/12/09/linux-xargs-usage-and-examples/"/>
    <id>https://rollingstarky.github.io/2021/12/09/linux-xargs-usage-and-examples/</id>
    <published>2021-12-08T16:00:00.000Z</published>
    <updated>2021-12-09T12:37:35.469Z</updated>
    
    <content type="html"><![CDATA[<h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p><code>xargs</code> æ˜¯ Linux ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒå¯ä»¥è¯»å–æ ‡å‡†è¾“å…¥å¹¶å°†å…¶ä½œä¸ºå‚æ•°æ„å»ºæ–°çš„å‘½ä»¤å¹¶æ‰§è¡Œã€‚<br><code>xargs</code> å¯ä»¥å¸®åŠ© <code>echo</code>ã€<code>rm</code>ã€<code>mkdir</code> ç­‰å‘½ä»¤æ¥æ”¶æ ‡å‡†è¾“å…¥ä½œä¸ºå‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> xargs mkdir</span></span><br><span class="line">test1 test2</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">test1  test2</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æ‰§è¡Œ <code>xargs mkdir</code> å‘½ä»¤ï¼Œè¾“å…¥ <code>test1 test2</code> åå›è½¦ï¼Œå†æŒ‰ <code>CTRL-D</code> ç»“æŸè¾“å…¥ï¼Œç­‰æ•ˆäºç›´æ¥æ‰§è¡Œ <code>mkdir test1 test2</code> å‘½ä»¤ã€‚<br>å³ <code>xarg</code> è¯»å–äº†æ ‡å‡†è¾“å…¥ä¸­çš„ <code>test1 test2</code>ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>mkdir</code> å‘½ä»¤ï¼Œç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„ <code>mkdir test1 test2</code> å‘½ä»¤å¹¶æ‰§è¡Œã€‚</p><p>å®é™…ä¸Š <code>xargs</code> å¾ˆå°‘ç”¨åœ¨ä¸Šè¿°äº¤äº’å¼åœºæ™¯ä¸­ï¼Œæ›´å¤šçš„æ˜¯æ­é…ç®¡é“ç¬¦ <code>|</code>ï¼Œé€šè¿‡å‰ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºæ„å»ºæ–°çš„å‘½ä»¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> test3 test4 test5 | xargs mkdir</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">test1  test2  test3  test4  test5</span><br></pre></td></tr></table></figure><p><code>|</code> å’Œ <code>| xargs</code> çš„åŒºåˆ«ï¼š</p><ul><li>ç®¡é“ç¬¦ <code>|</code> æ˜¯å°†å·¦è¾¹å‘½ä»¤çš„è¾“å‡ºç»“æœä½œä¸ºå³è¾¹å‘½ä»¤çš„è¾“å…¥å€¼</li><li><code>| xargs</code> åˆ™å¯ä»¥å°†å·¦è¾¹å‘½ä»¤çš„è¾“å‡ºç»“æœä½œä¸ºå³è¾¹å‘½ä»¤çš„å‚æ•°é€‰é¡¹</li></ul><h4 id="find-ä¸-xargs"><a href="#find-ä¸-xargs" class="headerlink" title="find ä¸ xargs"></a>find ä¸ xargs</h4><p><code>xargs</code> æœ€å¸¸è§çš„æ­é…åº”è¯¥å°±æ˜¯ <code>find</code> å‘½ä»¤äº†ã€‚å³é€šè¿‡ <code>find</code> æŸ¥æ‰¾ç‰¹å®šçš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå†å°†ç»“æœä¼ é€’ç»™ <code>xargs</code>ï¼Œå¯¹æ‰¾åˆ°çš„ç»“æœæ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚</p><p>å¦‚åˆ é™¤ <code>/tmp</code> è·¯å¾„ä¸‹æœ€è¿‘ä¸¤å‘¨å†…æœªåšæ”¹åŠ¨çš„æ–‡ä»¶ï¼š<br><code>find /tmp -type f -mtime +14 | xargs rm</code></p><p>æœ‰ä¸€ç‚¹ç‰¹åˆ«éœ€è¦æ³¨æ„ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>xargs</code> ä»æ ‡å‡†è¾“å…¥è¯»å–å‘½ä»¤å‚æ•°æ—¶ï¼Œä¼šä»¥ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦æ¥è¯†åˆ«å¤šä¸ªé€‰é¡¹ã€‚<br>è€Œæ–‡ä»¶å’Œç›®å½•çš„åå­—æœ‰æ—¶å€™ä¹Ÿä¼šåŒ…å«ç©ºæ ¼ï¼Œå¯¼è‡´ä¸€ä¸ªæ–‡ä»¶åè¢« <code>xargs</code> è¯†åˆ«ä¸ºä¸¤ä¸ªå‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir <span class="built_in">test</span>\ 6</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">'test 6'   test1   test2   test3   test4   test5</span><br><span class="line"><span class="meta">$</span><span class="bash"> find . -<span class="built_in">type</span> d | xargs rmdir</span></span><br><span class="line">rmdir: failed to remove './test': No such file or directory</span><br><span class="line">rmdir: failed to remove '6': No such file or directory</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">'test 6'</span><br></pre></td></tr></table></figure><p>æ›´å®‰å…¨ä¸€ç‚¹çš„åšæ³•æ˜¯ä½¿ç”¨ <code>-0</code> é€‰é¡¹ã€‚<code>-0</code> é€‰é¡¹å¯ä»¥æŒ‡å®š <code>xargs</code> åœ¨è¯»å–æ ‡å‡†è¾“å…¥æ—¶ä½¿ç”¨ <code>null</code> ä½œä¸ºåˆ†éš”ç¬¦ã€‚è€Œ <code>find</code> å‘½ä»¤çš„ <code>-print0</code> é€‰é¡¹åŒæ ·å¯ä»¥å°†è¾“å‡ºæŒ‡å®šä¸ºä½¿ç”¨ <code>null</code> è¿›è¡Œåˆ†å‰²ã€‚</p><p>å³å°†å‰é¢çš„å‘½ä»¤æ›¿æ¢ä¸º <strong><code>find . -type d -print0 | xargs -0 rmdir</code></strong>ã€‚</p><h5 id="find-æ­é…-exec-é€‰é¡¹å’Œæ­é…-xargs-å‘½ä»¤çš„åŒºåˆ«"><a href="#find-æ­é…-exec-é€‰é¡¹å’Œæ­é…-xargs-å‘½ä»¤çš„åŒºåˆ«" class="headerlink" title="find æ­é… -exec é€‰é¡¹å’Œæ­é… xargs å‘½ä»¤çš„åŒºåˆ«"></a>find æ­é… <code>-exec</code> é€‰é¡¹å’Œæ­é… xargs å‘½ä»¤çš„åŒºåˆ«</h5><p><code>find</code> å‘½ä»¤å¯ä»¥ä½¿ç”¨å…¶ <code>-exec</code> é€‰é¡¹å¯¹æŸ¥æ‰¾åˆ°çš„ç»“æœæ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚åŒæ ·çš„éœ€æ±‚ <code>xargs</code> ä¹Ÿå¯ä»¥å®ç°ã€‚</p><p>æ¯”å¦‚éœ€è¦åˆ é™¤å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„ TXT æ–‡ä»¶ï¼š</p><ul><li>ä½¿ç”¨ <code>-exec</code>ï¼š<code>find . -type f -name &quot;*.txt&quot; -exec rm {} \;</code></li><li>ä½¿ç”¨ <code>xargs</code>ï¼š<code>find . -type f -name &quot;*.txt&quot; | xargs rm</code></li></ul><p>å®é™…ä¸Šä¸¤è€…çš„æ‰§è¡Œæ•ˆç‡å­˜åœ¨ç€å¾ˆå¤§çš„å·®è·ã€‚<br>æ¯”å¦‚ä½¿ç”¨ <code>for i in {1..100}; do touch $i.txt; done</code> å‘½ä»¤åˆ›å»º 100 ä¸ª TXT æ–‡ä»¶ï¼Œå†åˆ†åˆ«ä½¿ç”¨ä¸Šè¿°ä¸¤ä¸ªå‘½ä»¤åˆ é™¤è¿™äº›æ–‡ä»¶ï¼ˆç”¨ <code>time</code> å‘½ä»¤è®¡æ—¶ï¼‰ï¼Œå…·ä½“çš„æ•ˆç‡å¦‚ä¸‹ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> touch <span class="variable">$i</span>.txt; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">1.txt    18.txt  27.txt  36.txt  45.txt  54.txt  63.txt  72.txt  81.txt  90.txt</span><br><span class="line">10.txt   19.txt  28.txt  37.txt  46.txt  55.txt  64.txt  73.txt  82.txt  91.txt</span><br><span class="line">100.txt  2.txt   29.txt  38.txt  47.txt  56.txt  65.txt  74.txt  83.txt  92.txt</span><br><span class="line">11.txt   20.txt  3.txt   39.txt  48.txt  57.txt  66.txt  75.txt  84.txt  93.txt</span><br><span class="line">12.txt   21.txt  30.txt  4.txt   49.txt  58.txt  67.txt  76.txt  85.txt  94.txt</span><br><span class="line">13.txt   22.txt  31.txt  40.txt  5.txt   59.txt  68.txt  77.txt  86.txt  95.txt</span><br><span class="line">14.txt   23.txt  32.txt  41.txt  50.txt  6.txt   69.txt  78.txt  87.txt  96.txt</span><br><span class="line">15.txt   24.txt  33.txt  42.txt  51.txt  60.txt  7.txt   79.txt  88.txt  97.txt</span><br><span class="line">16.txt   25.txt  34.txt  43.txt  52.txt  61.txt  70.txt  8.txt   89.txt  98.txt</span><br><span class="line">17.txt   26.txt  35.txt  44.txt  53.txt  62.txt  71.txt  80.txt  9.txt   99.txt</span><br><span class="line"><span class="meta">$</span><span class="bash"> time find . -<span class="built_in">type</span> f -name <span class="string">"*.txt"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span></span><br><span class="line">find . -type f -name "*.txt" -exec rm &#123;&#125; \;  0.05s user 0.02s system 104% cpu 0.060 total</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> touch <span class="variable">$i</span>.txt; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> time find . -<span class="built_in">type</span> f -name <span class="string">"*.txt"</span> | xargs rm</span></span><br><span class="line">find . -type f -name "*.txt"  0.00s user 0.00s system 80% cpu 0.001 total</span><br><span class="line">xargs rm  0.00s user 0.00s system 94% cpu 0.003 total</span><br></pre></td></tr></table></figure></p><p>å‰è€…æ˜¯ 0.06ï¼Œåè€…æ˜¯ 0.004ã€‚ä½¿ç”¨ <code>xargs</code> çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚</p><h4 id="è¾“å‡ºæ‰§è¡Œçš„å‘½ä»¤"><a href="#è¾“å‡ºæ‰§è¡Œçš„å‘½ä»¤" class="headerlink" title="è¾“å‡ºæ‰§è¡Œçš„å‘½ä»¤"></a>è¾“å‡ºæ‰§è¡Œçš„å‘½ä»¤</h4><p><code>-t</code> é€‰é¡¹å¯ä»¥æŠŠ <code>xargs</code> æ‹¼æ¥åæ‰§è¡Œçš„å‘½ä»¤æ‰“å°åˆ°ç»ˆç«¯çª—å£ä¸­ã€‚æ–¹ä¾¿å¯¹è„šæœ¬è¿›è¡Œè°ƒè¯•ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> test1 test2 test3 | xargs -t mkdir</span></span><br><span class="line">mkdir test1 test2 test3</span><br></pre></td></tr></table></figure></p><h4 id="è¾“å‡ºå‘½ä»¤å¹¶æç¤ºç”¨æˆ·ç¡®è®¤"><a href="#è¾“å‡ºå‘½ä»¤å¹¶æç¤ºç”¨æˆ·ç¡®è®¤" class="headerlink" title="è¾“å‡ºå‘½ä»¤å¹¶æç¤ºç”¨æˆ·ç¡®è®¤"></a>è¾“å‡ºå‘½ä»¤å¹¶æç¤ºç”¨æˆ·ç¡®è®¤</h4><p><code>-p</code> é€‰é¡¹å¯ä»¥æŠŠ <code>xargs</code> æ‹¼æ¥åæ‰§è¡Œçš„å‘½ä»¤æ‰“å°å‡ºæ¥ï¼Œå¹¶ç­‰å¾…ç”¨æˆ·è¿›è¡Œç¡®è®¤ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls | xargs -p rmdir</span></span><br><span class="line">rmdir test1 test2 test3 ?...y</span><br></pre></td></tr></table></figure></p><h4 id="æ‰§è¡Œå¤šä¸ªå‘½ä»¤"><a href="#æ‰§è¡Œå¤šä¸ªå‘½ä»¤" class="headerlink" title="æ‰§è¡Œå¤šä¸ªå‘½ä»¤"></a>æ‰§è¡Œå¤šä¸ªå‘½ä»¤</h4><p>å€ŸåŠ© <code>-I</code> é€‰é¡¹å¯ä»¥ä»¤ <code>xargs</code> åŒæ—¶æ‰§è¡Œå¤šä¸ªå‘½ä»¤ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat foo.txt</span></span><br><span class="line">one</span><br><span class="line">two</span><br><span class="line">three</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat foo.txt | xargs -I % sh -c <span class="string">'echo %; mkdir %'</span></span></span><br><span class="line">one</span><br><span class="line">two</span><br><span class="line">three</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">foo.txt  one  three  two</span><br></pre></td></tr></table></figure></p><h4 id="å¸¸ç”¨å®ä¾‹"><a href="#å¸¸ç”¨å®ä¾‹" class="headerlink" title="å¸¸ç”¨å®ä¾‹"></a>å¸¸ç”¨å®ä¾‹</h4><p><strong>æŸ¥æ‰¾å½“å‰è·¯å¾„ä¸‹æ‰€æœ‰çš„ PNG å›¾ç‰‡å¹¶å°†å®ƒä»¬å½’æ¡£åˆ° <code>images.tar.gz</code> å‹ç¼©åŒ…ä¸­</strong>ï¼š<br><code>$ find . -name &quot;*.png&quot; -type f -print0 | xargs -0 tar -cvzf images.tar.gz</code></p><p><strong>è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åï¼Œä»¥å•è¡Œåˆ—è¡¨çš„å½¢å¼è¾“å‡º</strong>ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cut -d: -f1 &lt; /etc/passwd | sort | xargs <span class="built_in">echo</span></span></span><br><span class="line">_apt backup bin daemon games gnats irc landscape list lp mail man messagebus news nobody pollinate postgres proxy root sshd starky sync sys syslog systemd-network systemd-resolve systemd-timesync tcpdump tss uucp uuidd www-data</span><br></pre></td></tr></table></figure></p><p><strong>åˆ é™¤å½“å‰è·¯å¾„ä¸‹åä¸º <code>no_use</code> çš„æ–‡ä»¶</strong>ï¼š<br><code>$ find . -name &quot;no_use&quot; -type f -print0 | xargs -0 rm -v -f</code></p><p><strong>å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶åˆ°å¤šä¸ªè·¯å¾„ä¸‹</strong>ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">dest1  dest2  test_file</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> ./dest1/ ./dest2/ | xargs -n 1 cp -v ./test_file</span></span><br><span class="line">'./test_file' -&gt; './dest1/test_file'</span><br><span class="line">'./test_file' -&gt; './dest2/test_file'</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢ä¾‹å­ä¸­ <code>xargs</code> çš„ <code>-n 1</code> é€‰é¡¹éå¸¸é‡è¦ã€‚<code>-n</code> é€‰é¡¹ç”¨äºæŒ‡å®š <code>xargs</code> åœ¨å°†æ ‡å‡†è¾“å…¥ä½œä¸ºå‚æ•°ä¸å‘½ä»¤æ‹¼æ¥åœ¨ä¸€èµ·æ—¶ï¼Œå‚æ•°çš„æœ€å¤§é•¿åº¦ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå½“ <code>-n</code> ä¸º 1 æ—¶ï¼Œæ ‡å‡†è¾“å…¥ä¸­ä»¥ç©ºæ ¼åˆ†å‰²çš„æ¯ä¸€é¡¹éƒ½ä¸å‘½ä»¤è¿›è¡Œæ‹¼æ¥ï¼Œæœ€ç»ˆå½¢æˆå¤šæ¡å‘½ä»¤ï¼›å½“ä¸å­˜åœ¨ <code>-n 1</code> æ—¶ï¼Œæ ‡å‡†è¾“å…¥ä¸­ä»¥ç©ºæ ¼åˆ†å‰²çš„æ‰€æœ‰å‚æ•°é¡¹ç›´æ¥ä¸å‘½ä»¤è¿›è¡Œæ‹¼æ¥ï¼Œå½¢æˆä¸€æ¡å‘½ä»¤å¹¶æ‰§è¡Œã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> ./dest1/ ./dest2/ | xargs -n 1 -t cp ./test_file</span></span><br><span class="line">cp ./test_file ./dest1/</span><br><span class="line">cp ./test_file ./dest2/</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> ./dest1/ ./dest2/ | xargs -t cp ./test_file</span></span><br><span class="line">cp ./test_file ./dest1/ ./dest2/</span><br><span class="line">cp: -r not specified; omitting directory './dest1/'</span><br></pre></td></tr></table></figure></p><ul><li><code>echo ./dest1/ ./dest2/ | xargs -n 1 cp ./test_file</code> ç­‰æ•ˆäº <code>cp ./test_file ./dest1/</code> å’Œ <code>cp ./test_file ./dest2/</code> ä¸¤æ¡å‘½ä»¤</li><li><code>echo ./dest1/ ./dest2/ | xargs cp ./test_file</code> ç­‰æ•ˆäº <code>cp ./test_file ./dest1/ ./dest2/</code> ä¸€æ¡å‘½ä»¤ï¼ˆè¯­æ³•æ˜¯é”™çš„ï¼‰</li></ul><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://shapeshed.com/unix-xargs/" target="_blank" rel="noopener">Linux and Unix xargs command tutorial with examples</a><br><a href="https://www.tecmint.com/xargs-command-examples/" target="_blank" rel="noopener">12 Practical Examples of Linux Xargs Command for Beginners</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#åŸºæœ¬ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;/a&gt;åŸºæœ¬ä½¿ç”¨&lt;/h4&gt;&lt;p&gt;&lt;code&gt;xargs&lt;/code&gt; æ˜¯ Linux ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒå¯ä»¥è¯»å–æ ‡å‡†è¾“å…¥å¹¶å°†å…¶ä½œä¸ºå‚æ•°æ„å»ºæ–°çš„å‘½ä»¤å¹¶
      
    
    </summary>
    
      <category term="Linux" scheme="https://rollingstarky.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://rollingstarky.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://rollingstarky.github.io/tags/Shell/"/>
    
      <category term="Script" scheme="https://rollingstarky.github.io/tags/Script/"/>
    
      <category term="Xargs" scheme="https://rollingstarky.github.io/tags/Xargs/"/>
    
      <category term="Administration" scheme="https://rollingstarky.github.io/tags/Administration/"/>
    
      <category term="Find" scheme="https://rollingstarky.github.io/tags/Find/"/>
    
  </entry>
  
  <entry>
    <title>Python code smells å®ä¾‹è®²è§£</title>
    <link href="https://rollingstarky.github.io/2021/12/06/7-python-code-smells-by-practical-example/"/>
    <id>https://rollingstarky.github.io/2021/12/06/7-python-code-smells-by-practical-example/</id>
    <published>2021-12-05T16:00:00.000Z</published>
    <updated>2021-12-06T15:38:09.787Z</updated>
    
    <content type="html"><![CDATA[<p><strong>code smells</strong> å¯ä»¥ç†è§£ä¸ºä»£ç ä¸­è®©äººæ„Ÿè§‰åˆ°ä¸èˆ’æœçš„åœ°æ–¹ã€‚å¯èƒ½æ˜¯ä»£ç è§„èŒƒé—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ˜¯è®¾è®¡ä¸Šçš„ç¼ºé™·ã€‚<br>å¾ˆå¤šæ—¶å€™ä¸€æ®µä»£ç ç¬¦åˆåŸºæœ¬é€»è¾‘ï¼Œèƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸ä»£è¡¨å®ƒæ˜¯ä¸â€œä¸‘â€çš„ã€‚ä»£ç ä¸­å¯èƒ½ä¼šå­˜åœ¨è¯¸å¦‚å¯è¯»æ€§å·®ã€ç»“æ„æ··ä¹±ã€é‡å¤ä»£ç å¤ªå¤šã€ä¸å¤Ÿå¥å£®ç­‰é—®é¢˜ã€‚</p><h4 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Very advanced Employee management system.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"></span><br><span class="line"><span class="comment"># The fixed number of vacation days that can be paid out.</span></span><br><span class="line">FIXED_VACATION_DAYS_PAYOUT = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span>:</span></span><br><span class="line">    <span class="string">"""Basic representation of an employee at the company"""</span></span><br><span class="line"></span><br><span class="line">    name: str</span><br><span class="line">    role: str</span><br><span class="line">    vacation_days: int = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">take_a_holiday</span><span class="params">(self, payout: bool)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Let the employee take a single holiday, or pay out 5 holidays."""</span></span><br><span class="line">        <span class="keyword">if</span> payout:</span><br><span class="line">            <span class="keyword">if</span> self.vacation_days &lt; FIXED_VACATION_DAYS_PAYOUT:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(</span><br><span class="line">                    <span class="string">f"You don't have enough holidays left over for a payout. \</span></span><br><span class="line"><span class="string">                            Remaining holidays: <span class="subst">&#123;self.vacation_days&#125;</span>"</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.vacation_days -= FIXED_VACATION_DAYS_PAYOUT</span><br><span class="line">                print(</span><br><span class="line">                    <span class="string">f"Paying out a holiday. Holidays left: <span class="subst">&#123;self.vacation_days&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> self.vacation_days &lt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(</span><br><span class="line">                    <span class="string">"You don't have any holidays left. Now back to work, you!"</span></span><br><span class="line">                )</span><br><span class="line">            self.vacation_days -= <span class="number">1</span></span><br><span class="line">            print(<span class="string">"Have fun on your holiday. Don't forget to check your emails!"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HourlyEmployee</span><span class="params">(Employee)</span>:</span></span><br><span class="line">    <span class="string">""" Employee that's paid based on number of worked hours."""</span></span><br><span class="line"></span><br><span class="line">    hourly_rate: float = <span class="number">50</span></span><br><span class="line">    amount: int = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalariedEmployee</span><span class="params">(Employee)</span>:</span></span><br><span class="line">    <span class="string">"""Employee that's paid based on a fixed monthly salary."""</span></span><br><span class="line"></span><br><span class="line">    monthly_salary: float = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span>:</span></span><br><span class="line">    <span class="string">"""Represents a company with employees."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.employees: List[Employee] = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_employee</span><span class="params">(self, employee: Employee)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.employees.append(employee)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_managers</span><span class="params">(self)</span> -&gt; List[Employee]:</span></span><br><span class="line">        managers = []</span><br><span class="line">        <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees:</span><br><span class="line">            <span class="keyword">if</span> employee.role == <span class="string">"manager"</span>:</span><br><span class="line">                managers.append(employee)</span><br><span class="line">        <span class="keyword">return</span> managers</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_vice_presidents</span><span class="params">(self)</span> -&gt; List[Employee]:</span></span><br><span class="line">        vice_presidents = []</span><br><span class="line">        <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees:</span><br><span class="line">            <span class="keyword">if</span> employee.role == <span class="string">"president"</span>:</span><br><span class="line">                vice_presidents.append(employee)</span><br><span class="line">        <span class="keyword">return</span> vice_presidents</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_interns</span><span class="params">(self)</span> -&gt; List[Employee]:</span></span><br><span class="line">        interns = []</span><br><span class="line">        <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees:</span><br><span class="line">            <span class="keyword">if</span> employee.role == <span class="string">"intern"</span>:</span><br><span class="line">                interns.append(employee)</span><br><span class="line">        <span class="keyword">return</span> interns</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_employee</span><span class="params">(self, employee: Employee)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(employee, SalariedEmployee):</span><br><span class="line">            print(</span><br><span class="line">                <span class="string">f"Paying employee <span class="subst">&#123;employee.name&#125;</span> a monthly salary of $<span class="subst">&#123;employee.monthly_salary&#125;</span>"</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> isinstance(employee, HourlyEmployee):</span><br><span class="line">            print(</span><br><span class="line">                <span class="string">f"Paying employee <span class="subst">&#123;employee.name&#125;</span> a hourly rate of \</span></span><br><span class="line"><span class="string">                            $<span class="subst">&#123;employee.hourly_rate&#125;</span> for <span class="subst">&#123;employee.amount&#125;</span> hours."</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    company = Company()</span><br><span class="line">    company.add_employee(SalariedEmployee(name=<span class="string">"Louis"</span>, role=<span class="string">"manager"</span>))</span><br><span class="line">    company.add_employee(HourlyEmployee(name=<span class="string">"Brenda"</span>, role=<span class="string">"president"</span>))</span><br><span class="line">    company.add_employee(HourlyEmployee(name=<span class="string">"Tim"</span>, role=<span class="string">"intern"</span>))</span><br><span class="line">    print(company.find_vice_presidents())</span><br><span class="line">    print(company.find_managers())</span><br><span class="line">    print(company.find_interns())</span><br><span class="line">    company.pay_employee(company.employees[<span class="number">0</span>])</span><br><span class="line">    company.employees[<span class="number">0</span>].take_a_holiday(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å®ç°äº†ä¸€ä¸ªç®€å•çš„â€œå‘˜å·¥ç®¡ç†ç³»ç»Ÿâ€ã€‚</p><ul><li>Employee ç±»ä»£è¡¨å…¬å¸é‡Œçš„å‘˜å·¥ï¼Œæœ‰å§“åã€è§’è‰²ã€å‡æœŸç­‰å±æ€§ã€‚å¯ä»¥è¯·å‡ï¼ˆ<code>take_a_holiday</code>ï¼‰ï¼Œæˆ–è€…å•ç‹¬è¯·ä¸€å¤©ï¼Œæˆ–è€…ä»¥ 5 å¤©ä¸ºå•ä½å°†å‡æœŸå…‘æ¢ä¸ºæŠ¥é…¬</li><li>HourlyEmployee å’Œ MonthlyEmployee åˆ†åˆ«ä»£è¡¨ä»¥æ—¶è–ªæˆ–è€…æœˆè–ªæ¥è®¡ç®—å·¥èµ„çš„å‘˜å·¥</li><li>Company ç±»ä»£è¡¨å…¬å¸ï¼Œå¯ä»¥æ‹›æ”¶å‘˜å·¥ï¼ˆ<code>add_employee</code>ï¼‰ã€è¿”å›ç‰¹å®šè§’è‰²çš„å‘˜å·¥åˆ—è¡¨ï¼ˆå¦‚ <code>find_managers</code>ï¼‰ã€å‘æ”¾è–ªèµ„ç­‰ï¼ˆ<code>pay_employee</code>ï¼‰</li></ul><h4 id="code-smells"><a href="#code-smells" class="headerlink" title="code smells"></a>code smells</h4><p>ä¸Šé¢çš„ä»£ç ä¸­å­˜åœ¨ç€å¾ˆå¤šå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ã€‚</p><h5 id="ç”¨-Enum-ç±»å‹æ›¿ä»£-str-ä½œä¸ºå‘˜å·¥çš„-role-å±æ€§"><a href="#ç”¨-Enum-ç±»å‹æ›¿ä»£-str-ä½œä¸ºå‘˜å·¥çš„-role-å±æ€§" class="headerlink" title="ç”¨ Enum ç±»å‹æ›¿ä»£ str ä½œä¸ºå‘˜å·¥çš„ role å±æ€§"></a>ç”¨ Enum ç±»å‹æ›¿ä»£ str ä½œä¸ºå‘˜å·¥çš„ role å±æ€§</h5><p>ä¸Šé¢çš„ <code>Employee</code> ç±»ä½¿ç”¨äº† <code>str</code> ç±»å‹æ¥å­˜å‚¨ <code>role</code> å±æ€§çš„å€¼ï¼Œæ¯”å¦‚ç”¨ <code>&quot;manager&quot;</code> ä»£è¡¨ç»ç†ï¼Œç”¨ <code>&quot;intern&quot;</code> ä»£è¡¨å®ä¹ ç”Ÿã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">company.add_employee(SalariedEmployee(name=<span class="string">"Louis"</span>, role=<span class="string">"manager"</span>))</span><br><span class="line">company.add_employee(HourlyEmployee(name=<span class="string">"Brenda"</span>, role=<span class="string">"president"</span>))</span><br><span class="line">company.add_employee(HourlyEmployee(name=<span class="string">"Tim"</span>, role=<span class="string">"intern"</span>))</span><br></pre></td></tr></table></figure></p><p>å®é™…ä¸Š String è¿‡äºçµæ´»ï¼Œå¯ä»¥æ‹¥æœ‰ä»»ä½•å«ä¹‰ï¼Œç”¨æ¥è¡¨ç¤ºè§’è‰²å±æ€§æ—¶ä¸å…·æœ‰è¶³å¤Ÿæ¸…æ™°çš„æŒ‡å‘æ€§ã€‚ä¸åŒçš„æ‹¼å†™è§„åˆ™å’Œå¤§å°å†™ä¹ æƒ¯éƒ½ä¼šå¯¼è‡´å‡ºç°é”™è¯¯çš„æŒ‡å‘ï¼Œæ¯”å¦‚ <code>&quot;Manager&quot;</code> å’Œ <code>&quot;manager&quot;</code>ï¼Œ<code>&quot;vice-president&quot;</code> å’Œ <code>&quot;vice_president&quot;</code>ã€‚<br>å¯ä»¥ä½¿ç”¨ Enum æ›¿ä»£ strã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum, auto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(Enum)</span>:</span></span><br><span class="line">    <span class="string">"""Employee roles."""</span></span><br><span class="line">    PRESIDENT = auto()</span><br><span class="line">    VICEPRESIDENT = auto()</span><br><span class="line">    MANAGER = auto()</span><br><span class="line">    LEAD = auto()</span><br><span class="line">    WORKER = auto()</span><br><span class="line">    INTERN = auto()</span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹ <code>Employee</code> ç±»ä¸­ <code>role</code> å±æ€§çš„å®šä¹‰ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span>:</span></span><br><span class="line"></span><br><span class="line">    name: str</span><br><span class="line">    role: Role</span><br><span class="line">    vacation_days: int = <span class="number">25</span></span><br></pre></td></tr></table></figure></p><p><code>Company</code> ç±»ä¸­ <code>find_managers</code> ç­‰æ–¹æ³•ä¹Ÿåšç›¸åº”çš„ä¿®æ”¹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_managers</span><span class="params">(self)</span> -&gt; List[Employee]:</span></span><br><span class="line">    managers = []</span><br><span class="line">    <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees:</span><br><span class="line">        <span class="keyword">if</span> employee.role == Role.MANAGER:</span><br><span class="line">            managers.append(employee)</span><br><span class="line">    <span class="keyword">return</span> managers</span><br></pre></td></tr></table></figure></p><p><code>main</code> æ–¹æ³•ä¸­ä½¿ç”¨æ–°çš„ role åˆ›å»ºå‘˜å·¥å¯¹è±¡ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">company.add_employee(SalariedEmployee(name=<span class="string">"Louis"</span>, role=Role.MANAGER))</span><br><span class="line">company.add_employee(HourlyEmployee(name=<span class="string">"Brenda"</span>, role=Role.VICEPRESIDENT))</span><br><span class="line">company.add_employee(HourlyEmployee(name=<span class="string">"Tim"</span>, role=Role.INTERN))</span><br></pre></td></tr></table></figure></p><h5 id="æ¶ˆé™¤é‡å¤ä»£ç "><a href="#æ¶ˆé™¤é‡å¤ä»£ç " class="headerlink" title="æ¶ˆé™¤é‡å¤ä»£ç "></a>æ¶ˆé™¤é‡å¤ä»£ç </h5><p><code>Company</code> ç±»ä¸­æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯è¿”å›ç‰¹å®šè§’è‰²çš„å‘˜å·¥åˆ—è¡¨ï¼Œå³ <code>find_managers</code>ã€<code>find_vice_presidents</code>ã€<code>find_interns</code> ä¸‰ä¸ªæ–¹æ³•ã€‚<br>è¿™ä¸‰ä¸ªæ–¹æ³•å®é™…ä¸Šæœ‰ç€åŒæ ·çš„é€»è¾‘ï¼Œå´åˆ†æ•£åœ¨äº†ä¸‰ä¸ªä¸åŒçš„å‡½æ•°é‡Œã€‚å¯ä»¥åˆå¹¶æˆä¸€ä¸ªæ–¹æ³•æ¥æ¶ˆé™¤é‡å¤ä»£ç ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_employees</span><span class="params">(self, role: Role)</span> -&gt; List[Employee]:</span></span><br><span class="line">    <span class="string">"""Find all employees with a particular role."""</span></span><br><span class="line">    employees = []</span><br><span class="line">    <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees:</span><br><span class="line">        <span class="keyword">if</span> employee.role == role:</span><br><span class="line">            employees.append(employee)</span><br><span class="line">    <span class="keyword">return</span> employees</span><br></pre></td></tr></table></figure></p><p>åŒæ—¶å°† <code>main</code> å‡½æ•°ä¸­çš„ <code>find_managers</code>ã€<code>find_vice_presidents</code>ã€<code>find_interns</code> éƒ½æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(company.find_employees(Role.VICEPRESIDENT))</span><br><span class="line">print(company.find_employees(Role.MANAGER))</span><br><span class="line">print(company.find_employees(Role.INTERN))</span><br></pre></td></tr></table></figure></p><h5 id="å°½é‡ä½¿ç”¨å†…ç½®å‡½æ•°"><a href="#å°½é‡ä½¿ç”¨å†…ç½®å‡½æ•°" class="headerlink" title="å°½é‡ä½¿ç”¨å†…ç½®å‡½æ•°"></a>å°½é‡ä½¿ç”¨å†…ç½®å‡½æ•°</h5><p>ä¸Šé¢ç‰ˆæœ¬ä¸­çš„ <code>find_employees</code> æ–¹æ³•ï¼ŒåŒ…å«äº†ä¸€ä¸ª <code>for</code> å¾ªç¯ã€‚å®é™…ä¸Šè¯¥éƒ¨åˆ†é€»è¾‘å¯ä»¥ä½¿ç”¨ Python å†…ç½®çš„<strong>åˆ—è¡¨æ¨å¯¼</strong>æ¥å®ç°ã€‚<br>åˆç†çš„ä½¿ç”¨ Python å†…ç½®å‡½æ•°å¯ä»¥ä½¿ä»£ç æ›´çŸ­ã€æ›´ç›´è§‚ï¼ŒåŒæ—¶å†…ç½®å‡½æ•°é’ˆå¯¹å¾ˆå¤šåœºæ™¯åœ¨æ€§èƒ½ä¸Šä¹Ÿåšäº†ä¸€å®šçš„ä¼˜åŒ–ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_employees</span><span class="params">(self, role: Role)</span> -&gt; List[Employee]:</span></span><br><span class="line">    <span class="string">"""Find all employees with a particular role."""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [employee <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees <span class="keyword">if</span> employee.role <span class="keyword">is</span> role]</span><br></pre></td></tr></table></figure></p><h5 id="æ›´æ¸…æ™°æ˜ç¡®çš„å˜é‡å"><a href="#æ›´æ¸…æ™°æ˜ç¡®çš„å˜é‡å" class="headerlink" title="æ›´æ¸…æ™°æ˜ç¡®çš„å˜é‡å"></a>æ›´æ¸…æ™°æ˜ç¡®çš„å˜é‡å</h5><p>æ—§ç‰ˆæœ¬ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HourlyEmployee</span><span class="params">(Employee)</span>:</span></span><br><span class="line">    <span class="string">""" Employee that's paid based on number of worked hours."""</span></span><br><span class="line"></span><br><span class="line">    hourly_rate: float = <span class="number">50</span></span><br><span class="line">    amount: int = <span class="number">10</span></span><br></pre></td></tr></table></figure></p><p>æ–°ç‰ˆæœ¬ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HourlyEmployee</span><span class="params">(Employee)</span>:</span></span><br><span class="line">    <span class="string">""" Employee that's paid based on number of worked hours."""</span></span><br><span class="line"></span><br><span class="line">    hourly_rate_dollars: float = <span class="number">50</span></span><br><span class="line">    hours_worked: int = <span class="number">10</span></span><br></pre></td></tr></table></figure></p><h5 id="isinstance"><a href="#isinstance" class="headerlink" title="isinstance"></a>isinstance</h5><p>å½“ä½ åœ¨ä»£ç çš„ä»»ä½•åœ°æ–¹çœ‹åˆ° <code>isinstance</code> è¿™ä¸ªå‡½æ•°æ—¶ï¼Œéƒ½éœ€è¦ç‰¹åˆ«åœ°åŠ ä»¥å…³æ³¨ã€‚å®ƒæ„å‘³ç€ä»£ç ä¸­æœ‰å¯èƒ½å­˜åœ¨æŸäº›æœ‰å¾…æå‡çš„è®¾è®¡ã€‚</p><p>æ¯”å¦‚ä»£ç ä¸­çš„ <code>pay_employee</code> å‡½æ•°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pay_employee</span><span class="params">(self, employee: Employee)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(employee, SalariedEmployee):</span><br><span class="line">        print(</span><br><span class="line">            <span class="string">f"Paying employee <span class="subst">&#123;employee.name&#125;</span> a monthly salary of $<span class="subst">&#123;employee.monthly_salary&#125;</span>"</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> isinstance(employee, HourlyEmployee):</span><br><span class="line">        print(</span><br><span class="line">            <span class="string">f"Paying employee <span class="subst">&#123;employee.name&#125;</span> a hourly rate of \</span></span><br><span class="line"><span class="string">                        $<span class="subst">&#123;employee.hourly_rate_dollars&#125;</span> for <span class="subst">&#123;employee.hours_worked&#125;</span> hours."</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œ <code>isinstance</code> çš„ä½¿ç”¨ï¼Œå®é™…ä¸Šåœ¨ <code>pay_employee</code> å‡½æ•°ä¸­å¼•å…¥äº†å¯¹ <code>Employee</code> çš„å­ç±»çš„ä¾èµ–ã€‚è¿™ç§ä¾èµ–å¯¼è‡´å„éƒ¨åˆ†ä»£ç ä¹‹é—´çš„èŒè´£åˆ’åˆ†ä¸å¤Ÿæ¸…æ™°ï¼Œè€¦åˆæ€§å˜å¼ºã€‚<br><code>pay_employee</code> æ–¹æ³•éœ€è¦ä¸ <code>Employee</code> çš„å­ç±»çš„å…·ä½“å®ç°ä¿æŒåŒæ­¥ã€‚æ¯æ–°å¢ä¸€ä¸ªæ–°çš„å‘˜å·¥ç±»å‹ï¼ˆ<code>Employee</code> çš„å­ç±»ï¼‰ï¼Œæ­¤æ–¹æ³•ä¸­çš„ <code>if-else</code> ä¹Ÿå°±å¿…é¡»å†æ–°å¢ä¸€ä¸ªåˆ†æ”¯ã€‚å³éœ€è¦åŒæ—¶æ”¹åŠ¨ä¸åŒä½ç½®çš„ä¸¤éƒ¨åˆ†ä»£ç ã€‚</p><p>å¯ä»¥å°† <code>pay_employee</code> çš„å®ç°ä» <code>Company</code> ç±»è½¬ç§»åˆ°å…·ä½“çš„ <code>Employee</code> å­ç±»ä¸­ã€‚å³ç‰¹å®šç±»å‹çš„å‘˜å·¥æ‹¥æœ‰å¯¹åº”çš„æŠ¥é…¬æ”¯ä»˜æ–¹æ³•ï¼Œå…¬å¸åœ¨å‘è–ªæ—¶åªéœ€è¦è°ƒç”¨å¯¹åº”å‘˜å·¥çš„ <code>pay</code> æ–¹æ³•ï¼Œæ— éœ€å®ç°è‡ªå·±çš„<code>pay_employee</code> æ–¹æ³•ã€‚<br>ç”± <code>isinstance</code> å¼•å…¥çš„ä¾èµ–å…³ç³»ä»è€Œè¢«ç§»é™¤ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@dataclass</span><br><span class="line">class HourlyEmployee(Employee):</span><br><span class="line">    &quot;&quot;&quot; Employee that&apos;s paid based on number of worked hours.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    hourly_rate_dollars: float = 50</span><br><span class="line">    hours_worked: int = 10</span><br><span class="line"></span><br><span class="line">    def pay(self):</span><br><span class="line">        print(</span><br><span class="line">            f&quot;Paying employee &#123;self.name&#125; a hourly rate of \</span><br><span class="line">                    $&#123;self.hourly_rate_dollars&#125; for &#123;self.hours_worked&#125; hours.&quot;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@dataclass</span><br><span class="line">class SalariedEmployee(Employee):</span><br><span class="line">    &quot;&quot;&quot;Employee that&apos;s paid based on a fixed monthly salary.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    monthly_salary: float = 5000</span><br><span class="line"></span><br><span class="line">    def pay(self):</span><br><span class="line">        print(</span><br><span class="line">            f&quot;Paying employee &#123;self.name&#125; a monthly salary of $&#123;self.monthly_salary&#125;&quot;</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p><p>å†æŠŠ <code>main</code> å‡½æ•°ä¸­çš„ <code>company.pay_employee(company.employees[0])</code> æ”¹ä¸º <code>company.employees[0].pay()</code>ã€‚</p><p>ç”±äºæ¯ä¸€ä¸ªç‰¹å®šçš„ <code>Employee</code> å­ç±»éƒ½éœ€è¦å®ç° <code>pay</code> æ–¹æ³•ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯å°† <code>Employee</code> å®ç°ä¸ºè™šæ‹ŸåŸºç±»ï¼Œ<code>pay</code> æˆä¸ºå­ç±»å¿…é¡»å®ç°çš„è™šæ‹Ÿæ–¹æ³•ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(ABC)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">()</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Method to call when paying an employee"""</span></span><br></pre></td></tr></table></figure></p><h5 id="Bool-flag"><a href="#Bool-flag" class="headerlink" title="Bool flag"></a>Bool flag</h5><p><code>Employee</code> ç±»ä¸­çš„ <code>take_a_holiday</code> æ–¹æ³•æœ‰ä¸€ä¸ªåä¸º <code>payout</code> çš„å‚æ•°ã€‚å®ƒæ˜¯å¸ƒå°”ç±»å‹ï¼Œä½œä¸ºä¸€ä¸ªå¼€å…³ï¼Œæ¥å†³å®šæŸä¸ªå‘˜å·¥æ˜¯è¯·ä¸€å¤©å‡ï¼Œè¿˜æ˜¯ä»¥ 5 å¤©ä¸ºå•ä½å°†å‡æœŸå…‘æ¢ä¸ºæŠ¥é…¬ã€‚<br>è¿™ä¸ªå¼€å…³å®é™…ä¸Šå¯¼è‡´äº† <code>take_a_holiday</code> æ–¹æ³•åŒ…å«äº†ä¸¤ç§ä¸åŒçš„èŒè´£ï¼Œåªé€šè¿‡ä¸€ä¸ªå¸ƒå°”å€¼æ¥å†³å®šå…·ä½“æ‰§è¡Œå“ªä¸€ä¸ªã€‚</p><p><strong>å‡½æ•°åŸæœ¬çš„ç›®çš„å°±æ˜¯èŒè´£çš„åˆ†ç¦»</strong>ã€‚ä½¿å¾—åŒä¸€ä¸ªä»£ç å—ä¸­ä¸ä¼šåŒ…å«è¿‡å¤šä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚<br>å› æ­¤ <code>take_a_holiday</code> æ–¹æ³•æœ€å¥½åˆ†å‰²æˆä¸¤ä¸ªä¸åŒçš„æ–¹æ³•ï¼Œåˆ†åˆ«åº”å¯¹ä¸åŒçš„ä¼‘å‡æ–¹å¼ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(ABC)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">take_a_holiday</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Let the employee take a single holiday."""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.vacation_days &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">"You don't have any holidays left. Now back to work, you!"</span></span><br><span class="line">            )</span><br><span class="line">        self.vacation_days -= <span class="number">1</span></span><br><span class="line">        print(<span class="string">"Have fun on your holiday. Don't forget to check your emails!"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">payout_a_holiday</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Let the employee get paid for unused holidays."""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.vacation_days &lt; FIXED_VACATION_DAYS_PAYOUT:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">f"You don't have enough holidays left over for a payout. \</span></span><br><span class="line"><span class="string">                        Remaining holidays: <span class="subst">&#123;self.vacation_days&#125;</span>"</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.vacation_days -= FIXED_VACATION_DAYS_PAYOUT</span><br><span class="line">            print(</span><br><span class="line">                <span class="string">f"Paying out a holiday. Holidays left: <span class="subst">&#123;self.vacation_days&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p><h5 id="Exceptions"><a href="#Exceptions" class="headerlink" title="Exceptions"></a>Exceptions</h5><p><code>payout_a_holiday</code> æ–¹æ³•ä¸­æœ‰ä¸€æ­¥ <code>try-except</code> ä»£ç ã€‚ä½†è¯¥éƒ¨åˆ†ä»£ç å®é™…ä¸Šå¯¹ Exception æ²¡æœ‰åšä»»ä½•äº‹ã€‚å¯¹äº Exception è€Œè¨€ï¼š</p><p><strong>å¦‚æœéœ€è¦ catch Exceptionï¼Œå°± catch ç‰¹å®šç±»å‹çš„æŸä¸ª Exceptionï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼›å¦‚æœä¸ä¼šå¯¹è¯¥ Exception åšä»»ä½•å¤„ç†ï¼Œå°±ä¸è¦ catch å®ƒ</strong>ã€‚</p><p>åœ¨æ­¤å¤„ä½¿ç”¨ <code>try-except</code> ä¼šé˜»æ­¢å¼‚å¸¸å‘å¤–æŠ›å‡ºï¼Œå¯¼è‡´å¤–éƒ¨ä»£ç åœ¨è°ƒç”¨ <code>payout_a_holiday</code> æ—¶è·å–ä¸åˆ°å¼‚å¸¸ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œä½¿ç”¨ <code>Exception</code> è€Œä¸æ˜¯æŸä¸ªç‰¹å®šç±»å‹çš„å¼‚å¸¸ï¼Œä¼šå¯¼è‡´æ‰€æœ‰çš„å¼‚å¸¸ä¿¡æ¯éƒ½è¢«å±è”½æ‰ï¼ŒåŒ…æ‹¬è¯­æ³•é”™è¯¯ã€é”®ç›˜ä¸­æ–­ç­‰ã€‚<br>å› æ­¤ï¼Œå»æ‰ä¸Šè¿°ä»£ç ä¸­çš„ <code>try-except</code>ã€‚</p><h5 id="ä½¿ç”¨è‡ªå®šä¹‰-Exception-æ›¿ä»£-ValueError"><a href="#ä½¿ç”¨è‡ªå®šä¹‰-Exception-æ›¿ä»£-ValueError" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰ Exception æ›¿ä»£ ValueError"></a>ä½¿ç”¨è‡ªå®šä¹‰ Exception æ›¿ä»£ ValueError</h5><p><code>ValueError</code> æ˜¯ Python å†…ç½®çš„åœ¨å†…éƒ¨å‡ºç°å€¼é”™è¯¯æ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¹¶ä¸é€‚åˆç”¨åœ¨è‡ªå®šä¹‰çš„åœºæ™¯ä¸­ã€‚æœ€å¥½åœ¨ä»£ç ä¸­å®šä¹‰è‡ªå·±çš„å¼‚å¸¸ç±»å‹ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VacationDaysShortageError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="string">"""Custom error that is raised when not enough vacation days available."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, requested_days: int, remaining_days: int, message: str)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.requested_days = requested_days</span><br><span class="line">        self.remaining_days = remaining_days</span><br><span class="line">        self.message = message</span><br><span class="line">        super().__init__(message)</span><br></pre></td></tr></table></figure></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payout_a_holiday</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="string">"""Let the employee get paid for unused holidays."""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.vacation_days &lt; FIXED_VACATION_DAYS_PAYOUT:</span><br><span class="line">        <span class="keyword">raise</span> VacationDaysShortageError(</span><br><span class="line">            requested_days=FIXED_VACATION_DAYS_PAYOUT,</span><br><span class="line">            remaining_days=self.vacation_days,</span><br><span class="line">            message=<span class="string">"You don't have enough holidays left over for a payout."</span>)</span><br><span class="line">    self.vacation_days -= FIXED_VACATION_DAYS_PAYOUT</span><br><span class="line">    print(<span class="string">f"Paying out a holiday. Holidays left: <span class="subst">&#123;self.vacation_days&#125;</span>"</span>)</span><br></pre></td></tr></table></figure><h4 id="æœ€ç»ˆç‰ˆæœ¬"><a href="#æœ€ç»ˆç‰ˆæœ¬" class="headerlink" title="æœ€ç»ˆç‰ˆæœ¬"></a>æœ€ç»ˆç‰ˆæœ¬</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Very advanced Employee management system.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum, auto</span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># The fixed number of vacation days that can be paid out.</span></span><br><span class="line">FIXED_VACATION_DAYS_PAYOUT = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VacationDaysShortageError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="string">"""Custom error that is raised when not enough vacation days available."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, requested_days: int, remaining_days: int, message: str)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.requested_days = requested_days</span><br><span class="line">        self.remaining_days = remaining_days</span><br><span class="line">        self.message = message</span><br><span class="line">        super().__init__(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(Enum)</span>:</span></span><br><span class="line">    <span class="string">"""Employee roles."""</span></span><br><span class="line">    PRESIDENT = auto()</span><br><span class="line">    VICEPRESIDENT = auto()</span><br><span class="line">    MANAGER = auto()</span><br><span class="line">    LEAD = auto()</span><br><span class="line">    WORKER = auto()</span><br><span class="line">    INTERN = auto()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(ABC)</span>:</span></span><br><span class="line">    <span class="string">"""Basic representation of an employee at the company"""</span></span><br><span class="line"></span><br><span class="line">    name: str</span><br><span class="line">    role: Role</span><br><span class="line">    vacation_days: int = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">take_a_holiday</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Let the employee take a single holiday."""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.vacation_days &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> VacationDaysShortageError(</span><br><span class="line">                requested_days=<span class="number">1</span>,</span><br><span class="line">                remaining_days=self.vacation_days,</span><br><span class="line">                message=<span class="string">"You don't have any holidays left. Now back to work, you!"</span>)</span><br><span class="line">        self.vacation_days -= <span class="number">1</span></span><br><span class="line">        print(<span class="string">"Have fun on your holiday. Don't forget to check your emails!"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">payout_a_holiday</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Let the employee get paid for unused holidays."""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.vacation_days &lt; FIXED_VACATION_DAYS_PAYOUT:</span><br><span class="line">            <span class="keyword">raise</span> VacationDaysShortageError(</span><br><span class="line">                requested_days=FIXED_VACATION_DAYS_PAYOUT,</span><br><span class="line">                remaining_days=self.vacation_days,</span><br><span class="line">                message=<span class="string">"You don't have enough holidays left over for a payout."</span></span><br><span class="line">            )</span><br><span class="line">        self.vacation_days -= FIXED_VACATION_DAYS_PAYOUT</span><br><span class="line">        print(<span class="string">f"Paying out a holiday. Holidays left: <span class="subst">&#123;self.vacation_days&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">()</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Method to call when paying an employee"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HourlyEmployee</span><span class="params">(Employee)</span>:</span></span><br><span class="line">    <span class="string">""" Employee that's paid based on number of worked hours."""</span></span><br><span class="line"></span><br><span class="line">    hourly_rate_dollars: float = <span class="number">50</span></span><br><span class="line">    hours_worked: int = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(</span><br><span class="line">            <span class="string">f"Paying employee <span class="subst">&#123;self.name&#125;</span> a hourly rate of \</span></span><br><span class="line"><span class="string">                    $<span class="subst">&#123;self.hourly_rate_dollars&#125;</span> for <span class="subst">&#123;self.hours_worked&#125;</span> hours."</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalariedEmployee</span><span class="params">(Employee)</span>:</span></span><br><span class="line">    <span class="string">"""Employee that's paid based on a fixed monthly salary."""</span></span><br><span class="line"></span><br><span class="line">    monthly_salary: float = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(</span><br><span class="line">            <span class="string">f"Paying employee <span class="subst">&#123;self.name&#125;</span> a monthly salary of $<span class="subst">&#123;self.monthly_salary&#125;</span>"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span>:</span></span><br><span class="line">    <span class="string">"""Represents a company with employees."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.employees: List[Employee] = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_employee</span><span class="params">(self, employee: Employee)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.employees.append(employee)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_employees</span><span class="params">(self, role: Role)</span> -&gt; List[Employee]:</span></span><br><span class="line">        <span class="string">"""Find all employees with a particular role."""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [employee <span class="keyword">for</span> employee <span class="keyword">in</span> self.employees <span class="keyword">if</span> employee.role <span class="keyword">is</span> role]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    company = Company()</span><br><span class="line">    company.add_employee(SalariedEmployee(name=<span class="string">"Louis"</span>, role=Role.MANAGER))</span><br><span class="line">    company.add_employee(HourlyEmployee(</span><br><span class="line">        name=<span class="string">"Brenda"</span>, role=Role.VICEPRESIDENT))</span><br><span class="line">    company.add_employee(HourlyEmployee(name=<span class="string">"Tim"</span>, role=Role.INTERN))</span><br><span class="line">    print(company.find_employees(Role.VICEPRESIDENT))</span><br><span class="line">    print(company.find_employees(Role.MANAGER))</span><br><span class="line">    print(company.find_employees(Role.INTERN))</span><br><span class="line">    company.employees[<span class="number">0</span>].pay()</span><br><span class="line">    company.employees[<span class="number">0</span>].take_a_holiday()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://www.youtube.com/watch?v=LrtnLEkOwFE" target="_blank" rel="noopener">7 Python Code Smells: Olfactory Offenses To Avoid At All Costs</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;code smells&lt;/strong&gt; å¯ä»¥ç†è§£ä¸ºä»£ç ä¸­è®©äººæ„Ÿè§‰åˆ°ä¸èˆ’æœçš„åœ°æ–¹ã€‚å¯èƒ½æ˜¯ä»£ç è§„èŒƒé—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ˜¯è®¾è®¡ä¸Šçš„ç¼ºé™·ã€‚&lt;br&gt;å¾ˆå¤šæ—¶å€™ä¸€æ®µä»£ç ç¬¦åˆåŸºæœ¬é€»è¾‘ï¼Œèƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸ä»£è¡¨å®ƒæ˜¯ä¸â€œä¸‘â€çš„ã€‚ä»£ç ä¸­å¯èƒ½ä¼šå­˜åœ¨è¯¸å¦‚å¯è¯»æ€§å·®ã€ç»“æ„æ··ä¹±ã€é‡å¤ä»£ç å¤ªå¤šã€ä¸å¤Ÿ
      
    
    </summary>
    
      <category term="Python" scheme="https://rollingstarky.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://rollingstarky.github.io/tags/Python/"/>
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="OOP" scheme="https://rollingstarky.github.io/tags/OOP/"/>
    
      <category term="Refactoring" scheme="https://rollingstarky.github.io/tags/Refactoring/"/>
    
      <category term="Class" scheme="https://rollingstarky.github.io/tags/Class/"/>
    
      <category term="Design" scheme="https://rollingstarky.github.io/tags/Design/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Exception" scheme="https://rollingstarky.github.io/tags/Exception/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes in Action ç¬”è®° â€”â€” Kubernetes ä»‹ç»</title>
    <link href="https://rollingstarky.github.io/2021/11/30/kubernetes-in-action-reading-notes-introducing-kubernetes/"/>
    <id>https://rollingstarky.github.io/2021/11/30/kubernetes-in-action-reading-notes-introducing-kubernetes/</id>
    <published>2021-11-29T16:00:00.000Z</published>
    <updated>2021-11-30T11:39:02.008Z</updated>
    
    <content type="html"><![CDATA[<p>Kubernetes è¿™ä¸ªåå­—æ¥è‡ªäºå¸Œè…Šè¯­ï¼Œæ„æ€æ˜¯èˆµæ‰‹ã€‚è¿˜æ˜¯å¾ˆç¬¦åˆè¿™ä¸ªå¹³å°çš„ä½œç”¨çš„ã€‚Kubernetes è´Ÿè´£ç®¡ç†éƒ¨ç½²çš„åº”ç”¨å¹¶æŠ¥å‘Šå®ƒä»¬çš„æƒ…å†µï¼Œè€Œç”¨æˆ·å°±åƒæ˜¯èˆ¹é•¿ï¼Œåªéœ€è¦å†³å®šæƒ³è¦æ•´ä¸ªç³»ç»Ÿè¾¾åˆ°æ€æ ·çš„çŠ¶æ€ã€‚</p><p><strong>Kubernetes æ˜¯ä¸€ä¸ªè´Ÿè´£è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œç®¡ç†åº”ç”¨çš„è½¯ä»¶ç³»ç»Ÿï¼Œä¸»è¦é’ˆå¯¹ç”±å®¹å™¨æ„æˆçš„å¤æ‚çš„å¤§å‹åº”ç”¨ç³»ç»Ÿ</strong>ã€‚</p><h4 id="Kubernetes-çš„åŸºæœ¬ç‰¹æ€§"><a href="#Kubernetes-çš„åŸºæœ¬ç‰¹æ€§" class="headerlink" title="Kubernetes çš„åŸºæœ¬ç‰¹æ€§"></a>Kubernetes çš„åŸºæœ¬ç‰¹æ€§</h4><p><strong>æŠ½è±¡åŒ–åŸºç¡€è®¾æ–½</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-8ecedf6a16f124ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Infrastructure abstraction"></p><p>Kubernetes ä¸ºç”¨æˆ·å’Œåº”ç”¨åœ¨åº•å±‚çš„ç¡¬ä»¶ä¹‹ä¸Šæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œåº•å±‚çš„åŸºç¡€è®¾æ–½å¦‚è®¡ç®—æœºã€ç½‘ç»œåŠå…¶ä»–ç»„ä»¶ç­‰å¯¹åº”ç”¨éƒ½æ˜¯ä¸å¯è§çš„ã€‚ç”¨æˆ·é€šè¿‡è¿™ä¸ªæŠ½è±¡å±‚éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ï¼Œä¸éœ€è¦å†é¢å¯¹æ¯ä¸€å°ç‰¹å®šçš„æœºå™¨ã€‚å› æ­¤é…ç½®èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚</p><p><strong>æ ‡å‡†åŒ–éƒ¨ç½²</strong><br>ç”±äºåº•å±‚åŸºç¡€è®¾æ–½çš„å…·ä½“ç»†èŠ‚ä¸ä¼šå†å½±å“åˆ°åº”ç”¨çš„éƒ¨ç½²ï¼Œæœ¬åœ°æ•°æ®ä¸­å¿ƒå’Œäº‘ç¯å¢ƒéƒ½å¯ä»¥ä½¿ç”¨åŒæ ·çš„éƒ¨ç½²æ–¹å¼ã€‚ä»»ä½•åº•å±‚åŸºç¡€è®¾æ–½çš„å·®å¼‚éƒ½äº¤ç»™ Kubernetes å»å¤„ç†ï¼Œç”¨æˆ·å¯ä»¥åªå…³æ³¨äº§å“åŠå…¶å†…éƒ¨é€»è¾‘ã€‚</p><p><strong>å£°æ˜å¼éƒ¨ç½²</strong><br>Kubernetes ä½¿ç”¨å£°æ˜å¼çš„æ¨¡å‹æ¥å®šä¹‰å…·ä½“çš„åº”ç”¨ã€‚ç”¨æˆ·åªéœ€è¦å®Œæˆå¯¹åº”ç”¨ä¸­å„ç»„ä»¶çš„æè¿°ï¼ŒKubernetes å°±ä¼šå°†è¿™äº›æè¿°è½¬åŒ–æˆè¿è¡Œçš„åº”ç”¨ã€‚å¹¶åœ¨ä¹‹åä¿è¯è¯¥åº”ç”¨çš„å¥åº·è¿è¡Œï¼Œåœ¨å¿…è¦çš„æ—¶å€™é‡å¯æˆ–é‡æ–°åˆ›å»ºæŸä¸ªç»„ä»¶ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-948914611a361f9e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Declarative model"></p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-4474de5ae26d30a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Changes in the description"></p><p>å½“ç”¨æˆ·ä¿®æ”¹äº†æŸäº›æè¿°ï¼ŒKubernetes ä¼šæ ¹æ®æ”¹åŠ¨è‡ªåŠ¨é‡‡å–å¿…è¦çš„æ­¥éª¤é‡æ–°é…ç½®åº”ç”¨ï¼Œä»¤åº”ç”¨æ»¡è¶³æœ€æ–°çš„æè¿°ã€‚</p><p><strong>æ¥ç®¡åº”ç”¨çš„æ—¥å¸¸ç®¡ç†</strong><br>ä¸€æ—¦ç”¨æˆ·é€šè¿‡ Kubernetes éƒ¨ç½²äº†æŸä¸ªåº”ç”¨ï¼Œè¯¥åº”ç”¨çš„æ—¥å¸¸ç®¡ç†å°±ä¼šè¢« Kubernetes æ¥ç®¡ã€‚å‡å¦‚æœåŠ¡åœæ­¢è¿è¡Œï¼ŒKubernetes ä¼šè‡ªåŠ¨é‡å¯è¯¥åº”ç”¨ï¼›æˆ–è€…ç”±äºç¡¬ä»¶å¤±æ•ˆã€åŸºç¡€è®¾æ–½æ¶æ„è°ƒæ•´å¯¼è‡´è¯¥åº”ç”¨éœ€è¦ç§»åŠ¨åˆ°å…¶ä»–æœºå™¨ä¸Šï¼ŒKubernetes ä¹Ÿä¼šè‡ªè¡Œå¤„ç†ã€‚</p><p>å°±åƒä¹‹å‰æåˆ°çš„ï¼Œç”¨æˆ·ç±»ä¼¼äºèˆ¹é•¿è´Ÿè´£æ›´é«˜å±‚çº§çš„å†³ç­–ï¼Œè€Œ Kubernetes åˆ™ç±»ä¼¼äºèˆµæ‰‹è´Ÿè´£æ‰§è¡Œå…·ä½“çš„åº•å±‚ä»»åŠ¡ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-4e8b20e65761088c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Kubernetes takes over the management of applications"></p><h4 id="Kubernetes-ä¸å¾®æœåŠ¡"><a href="#Kubernetes-ä¸å¾®æœåŠ¡" class="headerlink" title="Kubernetes ä¸å¾®æœåŠ¡"></a>Kubernetes ä¸å¾®æœåŠ¡</h4><p>ä¹‹å‰çš„å¹´å¤´ï¼Œç»å¤§å¤šæ•°åº”ç”¨éƒ½æ˜¯å•ä½“åº”ç”¨ã€‚åº”ç”¨é‡Œçš„å„ä¸ªç»„ä»¶æ˜¯å¼ºè€¦åˆçš„ï¼Œå…¨éƒ¨è¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œã€‚<br>å½“åº”ç”¨çš„å®¹é‡éœ€è¦æå‡æ—¶ï¼Œæ°´å¹³æ‰©å±•å•ä½“åº”ç”¨æ˜¯éå¸¸å›°éš¾çš„ã€‚åªèƒ½ä¸æ–­å‡çº§æœåŠ¡å™¨çš„ç¡¬ä»¶ï¼Œå³å‚ç›´æ‰©å±•ã€‚</p><p>å¾®æœåŠ¡èŒƒå¼æ˜¯åæ¥æ‰å‡ºç°çš„ã€‚å•ä½“åº”ç”¨è¢«åˆ†å‰²æˆæ•°åç”šè‡³æ•°ç™¾ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼ˆå¾®æœåŠ¡ï¼‰ã€‚æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ‹¥æœ‰è‡ªå·±æ‰€ç‹¬æœ‰çš„å¼€å‘å’Œéƒ¨ç½²å‘¨æœŸï¼Œä¸åŒå¾®æœåŠ¡çš„ä¾èµ–ä¼šéšç€æ—¶é—´çš„æ¨ç§»å·®è·è¶Šæ¥è¶Šå¤§ã€‚è¿™ä½¿å¾—åœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…éƒ¨è¿è¡Œä¸¤ä¸ªå¾®æœåŠ¡åº”ç”¨å˜å¾—éå¸¸å›°éš¾ã€‚<br>å®¹å™¨æ­£å¥½æ–¹ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ¯ä¸ªå¾®æœåŠ¡éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ï¼Œéœ€è¦å•ç‹¬è¿›è¡Œç®¡ç†ã€‚éšç€åº”ç”¨æ•°é‡çš„ä¸Šå‡è¿™å°†ä¼šè¶Šæ¥è¶Šå›°éš¾ã€‚<br>æ•´ä¸ªåº”ç”¨ç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†ä¸éœ€è¦éƒ¨ç½²åˆ°åŒä¸€å°æœºå™¨ä¸Šï¼Œè¿™ä½¿å¾—æ‰©å±•èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚ä½†åŒæ—¶ä¹Ÿæ„å‘³ç€å„ç»„ä»¶ä¹‹é—´éœ€è¦é…ç½®æˆèƒ½å¤Ÿç›¸äº’é€šä¿¡çš„çŠ¶æ€ã€‚åŒæ ·å¢åŠ äº†ç»´æŠ¤æˆæœ¬ã€‚<br>å› æ­¤å½“å¾®æœåŠ¡çš„è§„æ¨¡å˜å¾—å¾ˆå¤§æ—¶ï¼Œè‡ªåŠ¨åŒ–ç®¡ç†å°±æ˜¾å¾—å°¤ä¸ºå¿…è¦ã€‚Kubernetes åˆ™æ­£å¥½æä¾›äº†è¿™ç§è‡ªåŠ¨åŒ–åŠŸèƒ½ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-59ad3de50dca8dfa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Monolithic vs Microservices"></p><h4 id="Kubernetes-çš„æ¶æ„"><a href="#Kubernetes-çš„æ¶æ„" class="headerlink" title="Kubernetes çš„æ¶æ„"></a>Kubernetes çš„æ¶æ„</h4><p>Kubernetes å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªé¢å‘æœåŠ¡å™¨é›†ç¾¤çš„æ“ä½œç³»ç»Ÿã€‚<br>æ“ä½œç³»ç»Ÿç”¨æ¥æ”¯æ’‘è®¡ç®—æœºçš„åŸºæœ¬åŠŸèƒ½æ¯”å¦‚ CPU è°ƒåº¦ï¼Œä½œä¸ºåº”ç”¨å’Œè®¡ç®—æœºç¡¬ä»¶ä¹‹é—´æ²Ÿé€šçš„æ¥å£ã€‚ç±»ä¼¼çš„ï¼ŒKubernetes è´Ÿè´£åœ¨æœåŠ¡å™¨é›†ç¾¤çš„å„å°æœºå™¨ä¸Šè°ƒåº¦å®‰æ’åˆ†å¸ƒå¼åº”ç”¨çš„å„ä¸ªç»„ä»¶ï¼Œä½œä¸ºåº”ç”¨å’Œé›†ç¾¤ä¹‹é—´çš„æ¥å£ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-9daef5eac57b2474.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OS vs Kubernetes"></p><p>ä¸€ä¸ª Kubernetes é›†ç¾¤åŒ…å«ä¸¤ç»„èŠ‚ç‚¹ï¼š</p><ul><li>ä¸»èŠ‚ç‚¹ï¼šè´Ÿè´£è¿è¡Œ Control Plane ç»„ä»¶ï¼Œæ˜¯ç³»ç»Ÿçš„å¤§è„‘ï¼Œæ§åˆ¶æ•´ä¸ªé›†ç¾¤</li><li>å·¥ä½œèŠ‚ç‚¹ï¼šç»„æˆ Workload Planeï¼Œæ‰¿æ¥åº”ç”¨å’Œè´Ÿè½½</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/6875152-30cd2137a1a1be44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Kubernetes cluster"></p><h5 id="æ§åˆ¶å¹³å°"><a href="#æ§åˆ¶å¹³å°" class="headerlink" title="æ§åˆ¶å¹³å°"></a>æ§åˆ¶å¹³å°</h5><p>Control Plane è´Ÿè´£æ§åˆ¶æ•´ä¸ªé›†ç¾¤ã€‚å®ƒè¿è¡Œåœ¨ä¸€å°ä¸»èŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…ä»¥å‰¯æœ¬çš„æ–¹å¼è¿è¡Œåœ¨å¤šä¸ªä¸»èŠ‚ç‚¹ä¸Šã€‚åŒ…å« Schedulerã€Controllersã€Kubernetes API Serverã€etcd ç­‰å‡ ä¸ªç»„ä»¶ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-d8b81875430d46ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Components of Control Plane"></p><ul><li>Kubernetes API Server è´Ÿè´£æš´éœ² RESTful API æ¥å£ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ­¤æ¥å£åˆ›å»ºå¯¹è±¡</li><li>etcd åˆ†å¸ƒå¼æ•°æ®ä»“åº“è´Ÿè´£æŒä¹…åŒ–é€šè¿‡ API åˆ›å»ºçš„å¯¹è±¡ï¼Œå› ä¸º API Server æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ã€‚Server æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ etcd äº¤äº’çš„ç»„ä»¶</li><li>Scheduler è´Ÿè´£å†³å®šæ¯ä¸ªåº”ç”¨å®ä¾‹å…·ä½“è¿è¡Œåœ¨å“ªä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Š</li><li>Controllers è´Ÿè´£å…·ä½“åŒ–ç”± API åˆ›å»ºçš„å¯¹è±¡ã€‚å®ƒä»¬ä¸­çš„å¤§éƒ¨åˆ†å®é™…ä¸Šå°±æ˜¯è´Ÿè´£åˆ›å»ºå…¶ä»–å¯¹è±¡ï¼Œæœ‰ä¸€äº›ä¹Ÿä¼šä¸å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼ˆæ¯”å¦‚äº‘æä¾›å•†ï¼‰</li></ul><h5 id="è´Ÿè½½å¹³å°"><a href="#è´Ÿè½½å¹³å°" class="headerlink" title="è´Ÿè½½å¹³å°"></a>è´Ÿè½½å¹³å°</h5><p>å·¥ä½œèŠ‚ç‚¹å°±æ˜¯å®é™…ä¸Šè¿è¡Œåº”ç”¨çš„èŠ‚ç‚¹ï¼Œå®ƒä»¬æ„æˆäº† Workload Planeã€‚è´Ÿè´£è¿è¡Œã€ç›‘æ§å„ä¸ªåº”ç”¨ï¼Œå¹¶åœ¨å„åº”ç”¨ä¹‹é—´æä¾›è¿é€šæ€§ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-f0c322b076452baf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Workload Plane"></p><p>å…¶ä¸­å„ç»„ä»¶çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>Kubeletï¼šä¸€ä¸ªä¸ API Server è¿›è¡Œäº¤äº’çš„ agentï¼Œè´Ÿè´£ç®¡ç†å½“å‰èŠ‚ç‚¹ä¸Šè¿è¡Œçš„åº”ç”¨ã€‚ä¼šé€šè¿‡ API å‘ä¸»èŠ‚ç‚¹æŠ¥å‘Šåº”ç”¨çš„çŠ¶æ€</li><li>Container Runtimeï¼šå¯ä»¥æ˜¯ Docker æˆ–å…¶ä»–ä¸ Kubernetes å…¼å®¹çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå— kubelet æŒ‡æŒ¥ï¼Œè´Ÿè´£è¿è¡Œåº”ç”¨</li><li>Kubernetes Service Proxyï¼šåœ¨å„åº”ç”¨çš„ç½‘ç»œæµé‡ä¹‹é—´æä¾›è´Ÿè½½å‡è¡¡</li></ul><h4 id="Kubernetes-çš„å·¥ä½œæµç¨‹"><a href="#Kubernetes-çš„å·¥ä½œæµç¨‹" class="headerlink" title="Kubernetes çš„å·¥ä½œæµç¨‹"></a>Kubernetes çš„å·¥ä½œæµç¨‹</h4><p>Kubernetes ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½ç”±å¯¹è±¡è¡¨ç¤ºï¼Œå¯ä»¥é€šè¿‡ API åˆ›å»ºå’Œè·å–è¿™äº›å¯¹è±¡ã€‚ç”¨æˆ·éœ€è¦å‡ ç§ä¸åŒçš„å¯¹è±¡æ¥å®šä¹‰è‡ªå·±çš„åº”ç”¨ï¼Œé€šå¸¸åœ¨ YAML æˆ– JSON æ ¼å¼çš„æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-541fea79d28b6f43.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Deploying an application to Kubernetes"></p><p>å‘ Kubernetes éƒ¨ç½²åº”ç”¨çš„å…·ä½“æ­¥éª¤ä¸ºï¼š</p><ul><li>å‘ Kubernetes API æäº¤åº”ç”¨çš„ manifest æ–‡ä»¶ã€‚API Server å°†æ–‡ä»¶ä¸­å®šä¹‰çš„å¯¹è±¡å†™å…¥ etcd</li><li>controller æ¥åˆ°å·²ç»åˆ›å»ºäº†æ–°å¯¹è±¡çš„é€šçŸ¥ï¼Œç»§ç»­åˆ›å»ºå‡ ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¯¹åº”ä¸åŒçš„åº”ç”¨å®ä¾‹</li><li>Scheduler ä¸ºæ¯ä¸€ä¸ªåº”ç”¨å®ä¾‹åˆ†é…å·¥ä½œèŠ‚ç‚¹</li><li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ Kubelet æ¥åˆ°é€šçŸ¥ï¼Œå€ŸåŠ©å®¹å™¨è¿è¡Œæ—¶è¿è¡Œåº”ç”¨å®ä¾‹</li><li>åº”ç”¨å®ä¾‹å‡†å¤‡å¥½æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚åï¼ŒKube Proxy æ”¶åˆ°é€šçŸ¥ï¼Œä¸ºè¿™äº›åº”ç”¨å®ä¾‹é…ç½®è´Ÿè½½å‡è¡¡</li><li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ Kubelets å’Œ Controllers è´Ÿè´£ä¹‹åçš„ç›‘æ§å·¥ä½œï¼Œä¿è¯åº”ç”¨å¥åº·è¿è¡Œ</li></ul><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://www.manning.com/books/kubernetes-in-action-second-edition" target="_blank" rel="noopener">Kubernetes in Action, Second Edition</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Kubernetes è¿™ä¸ªåå­—æ¥è‡ªäºå¸Œè…Šè¯­ï¼Œæ„æ€æ˜¯èˆµæ‰‹ã€‚è¿˜æ˜¯å¾ˆç¬¦åˆè¿™ä¸ªå¹³å°çš„ä½œç”¨çš„ã€‚Kubernetes è´Ÿè´£ç®¡ç†éƒ¨ç½²çš„åº”ç”¨å¹¶æŠ¥å‘Šå®ƒä»¬çš„æƒ…å†µï¼Œè€Œç”¨æˆ·å°±åƒæ˜¯èˆ¹é•¿ï¼Œåªéœ€è¦å†³å®šæƒ³è¦æ•´ä¸ªç³»ç»Ÿè¾¾åˆ°æ€æ ·çš„çŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Kubernetes æ˜¯ä¸€ä¸ªè´Ÿè´£è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œ
      
    
    </summary>
    
      <category term="Linux" scheme="https://rollingstarky.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://rollingstarky.github.io/tags/Linux/"/>
    
      <category term="Server" scheme="https://rollingstarky.github.io/tags/Server/"/>
    
      <category term="Docker" scheme="https://rollingstarky.github.io/tags/Docker/"/>
    
      <category term="Container" scheme="https://rollingstarky.github.io/tags/Container/"/>
    
      <category term="Kubernetes" scheme="https://rollingstarky.github.io/tags/Kubernetes/"/>
    
      <category term="Microservice" scheme="https://rollingstarky.github.io/tags/Microservice/"/>
    
      <category term="Cloud" scheme="https://rollingstarky.github.io/tags/Cloud/"/>
    
      <category term="Virtualization" scheme="https://rollingstarky.github.io/tags/Virtualization/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes in Action ç¬”è®° â€”â€” ç†è§£å®¹å™¨æŠ€æœ¯</title>
    <link href="https://rollingstarky.github.io/2021/11/29/kubernetes-in-action-reading-notes-understanding-containers/"/>
    <id>https://rollingstarky.github.io/2021/11/29/kubernetes-in-action-reading-notes-understanding-containers/</id>
    <published>2021-11-28T16:00:00.000Z</published>
    <updated>2021-11-29T13:55:06.259Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä¸€ã€å®¹å™¨-vs-è™šæ‹Ÿæœº"><a href="#ä¸€ã€å®¹å™¨-vs-è™šæ‹Ÿæœº" class="headerlink" title="ä¸€ã€å®¹å™¨ vs è™šæ‹Ÿæœº"></a>ä¸€ã€å®¹å™¨ vs è™šæ‹Ÿæœº</h4><h5 id="ç³»ç»Ÿå¼€é”€"><a href="#ç³»ç»Ÿå¼€é”€" class="headerlink" title="ç³»ç»Ÿå¼€é”€"></a>ç³»ç»Ÿå¼€é”€</h5><p>æ¯ä¸€å°è™šæ‹Ÿæœºéƒ½éœ€è¦å®‰è£…ç‹¬å±äºè‡ªå·±çš„æ“ä½œç³»ç»Ÿï¼ŒåŒ…å«ä¸€ç³»åˆ—ç³»ç»Ÿè¿›ç¨‹ï¼›è€ŒåŒä¸€å°å®¿ä¸»æœºä¸Šçš„å¤šä¸ªå®¹å™¨ä¼šå…±äº«å®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿï¼Œå®ƒä»¬çš„ç¯å¢ƒä»ç„¶æ˜¯ç‹¬ç«‹çš„ã€‚<br>å³å¯¹äºå®¹å™¨è€Œè¨€ï¼Œä¸éœ€è¦è£…ä¸€ä¸ªç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿã€‚ä¸ä¼šåƒè™šæ‹Ÿæœºé‚£æ ·ï¼Œå­˜åœ¨å¾ˆå¤šå¥—é‡å¤çš„ç³»ç»Ÿè¿›ç¨‹ã€‚å› è€Œå®¹å™¨æ›´åŠ è½»é‡ã€‚<br><strong>å®¹å™¨åªåŒ…å«ä¸€å¥—éš”ç¦»çš„è¿›ç¨‹ï¼Œè¿è¡Œåœ¨å·²æœ‰çš„å®¿ä¸»æœºæ“ä½œç³»ç»Ÿä¸Šï¼Œåªä¼šæ¶ˆè€—è¿™å¥—éš”ç¦»è¿›ç¨‹è¿è¡Œæ‰€éœ€çš„ç³»ç»Ÿèµ„æº</strong>ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-a8f80aa3c08ae7fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="overhead VM vs Container"></p><p>ç”±äºè™šæ‹Ÿæœºé«˜é¢çš„å¼€é”€ï¼Œé€šå¸¸éœ€è¦å°†å¤šä¸ªå…³è”çš„åº”ç”¨éƒ¨ç½²åœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸Šã€‚å¯¹äºå¼€é”€è¾ƒä½çš„å®¹å™¨è€Œè¨€ï¼Œåˆ™å¯ä»¥ä¸ºæ¯ä¸€ä¸ªåº”ç”¨éƒ½åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ã€‚<br>å®é™…ä¸Šä¹Ÿåº”è¯¥<strong>ç¡®ä¿æ¯ä¸€ä¸ªå®¹å™¨éƒ½åªåŒ…å«ä¸€ä¸ªåº”ç”¨</strong>ï¼Œè¿™æ ·æ–¹ä¾¿ç®¡ç†ï¼ŒåŒæ—¶ Kubernetes ç­‰å®¹å™¨ç®¡ç†å¹³å°ä¹Ÿæ˜¯é»˜è®¤è¿™ä¸ªåŸåˆ™çš„ã€‚</p><h5 id="å¯åŠ¨æ—¶é—´"><a href="#å¯åŠ¨æ—¶é—´" class="headerlink" title="å¯åŠ¨æ—¶é—´"></a>å¯åŠ¨æ—¶é—´</h5><p>å®¹å™¨æ‹¥æœ‰æ›´å¿«çš„å¯åŠ¨æ—¶é—´ã€‚å› ä¸ºå®¹å™¨åªéœ€è¦å¯åŠ¨è‡ªèº«åŒ…å«çš„åº”ç”¨è¿›ç¨‹ï¼Œä¸éœ€è¦åƒå¯åŠ¨ä¸€å°æ–°çš„è™šæ‹Ÿæœºé‚£æ ·ï¼Œå…ˆå¯åŠ¨ä¸€äº›é¢å¤–çš„ç³»ç»Ÿè¿›ç¨‹ã€‚</p><h5 id="éš”ç¦»æ€§"><a href="#éš”ç¦»æ€§" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h5><p>æ— ç–‘è™šæ‹Ÿæœºçš„éš”ç¦»æ€§æ›´å¥½ã€‚<br>å½“ä½¿ç”¨è™šæ‹Ÿæœºéƒ¨ç½²åº”ç”¨æ—¶ï¼Œæ¯å°è™šæ‹Ÿæœºéƒ½æ‹¥æœ‰ä¸€å¥—ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿå’Œå†…æ ¸ã€‚è¿™äº›è™šæ‹Ÿæœºçš„åº•å±‚æ˜¯ hypervisorï¼Œå°†ç‰©ç†ç¡¬ä»¶åˆ’åˆ†æˆä¸€ç³»åˆ—æ›´å°çš„è™šæ‹Ÿèµ„æºï¼Œä¾›ç»™ä¸åŒçš„è™šæ‹Ÿæœºä½¿ç”¨ã€‚</p><p>å½“è™šæ‹Ÿæœºä¸­è¿è¡Œçš„åº”ç”¨å‘è™šæ‹Ÿæœºå†…æ ¸å‘èµ·ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šå…ˆåœ¨è™šæ‹Ÿçš„ CPU ä¸Šæ‰§è¡Œæœºå™¨æŒ‡ä»¤ï¼Œå†é€šè¿‡ hypervisor è½¬å‘ç»™å®¿ä¸»æœºçš„ç‰©ç† CPU æ‰§è¡Œã€‚<br>å®¹å™¨å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨åˆ™éƒ½å¯ä»¥ç›´æ¥ä¼ é€’ç»™å®¿ä¸»æœºä¸Šè¿è¡Œçš„ç³»ç»Ÿå†…æ ¸ï¼Œå†è½¬åŒ–ä¸ºæœºå™¨æŒ‡ä»¤ä¼ é€’ç»™å®¿ä¸»æœºçš„ CPUã€‚å®¿ä¸»æœº CPU ä¸éœ€è¦å¤„ç†ä»»ä½•å½¢å¼çš„è™šæ‹ŸåŒ–ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-e7e28095583e19c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="system calls"></p><p>åŒä¸€å°æœºå™¨ä¸Šçš„å¤šä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªå®¿ä¸»æœºå†…æ ¸ï¼Œä½†å®ƒä»¬ä¹‹é—´ä»ç„¶æ˜¯éš”ç¦»çš„ï¼Œç›¸äº’ä¹‹é—´å¹¶ä¸æ¸…æ¥šå…¶ä»–äººçš„å­˜åœ¨ï¼Œä¹Ÿåªèƒ½çœ‹åˆ°ä¸€éƒ¨åˆ†ç‰©ç†ç¡¬ä»¶ã€‚<br>è¿™ç§éš”ç¦»æ˜¯ç”±å®¿ä¸»æœºå†…æ ¸æä¾›çš„ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/6875152-f1b4cacdc98d0138.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Isolation"></p><h5 id="ç”±éš”ç¦»æ€§å¼•å‘çš„å®‰å…¨æ€§"><a href="#ç”±éš”ç¦»æ€§å¼•å‘çš„å®‰å…¨æ€§" class="headerlink" title="ç”±éš”ç¦»æ€§å¼•å‘çš„å®‰å…¨æ€§"></a>ç”±éš”ç¦»æ€§å¼•å‘çš„å®‰å…¨æ€§</h5><p>å®¹å™¨ä½¿ç”¨åŒä¸€ä¸ªå†…æ ¸ã€‚å¦‚æœå†…æ ¸å‡ºç° bugï¼ŒæŸä¸ªå®¹å™¨ä¸­çš„åº”ç”¨æœ‰å¯èƒ½ä¼šåˆ©ç”¨è¿™ä¸ª bug è¯»å–å…¶ä»–å®¹å™¨ä¸­å…¶ä»–åº”ç”¨çš„å†…å­˜ã€‚<br>æ­¤å¤–ï¼Œå®¹å™¨ä¼šå…±äº«å†…å­˜ç©ºé—´ã€‚å¦‚æœä¸é™åˆ¶æŸä¸ªå®¹å™¨èƒ½å¤Ÿä½¿ç”¨çš„å†…å­˜æ€»é‡ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–å®¹å™¨æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ä½¿ç”¨ã€‚</p><h4 id="äºŒã€Docker-å®¹å™¨å¹³å°ä»‹ç»"><a href="#äºŒã€Docker-å®¹å™¨å¹³å°ä»‹ç»" class="headerlink" title="äºŒã€Docker å®¹å™¨å¹³å°ä»‹ç»"></a>äºŒã€Docker å®¹å™¨å¹³å°ä»‹ç»</h4><p>Docker æ˜¯ä¸€ä¸ªå¸®åŠ©ç”¨æˆ·æ‰“åŒ…ã€å‘å¸ƒå’Œè¿è¡Œå®¹å™¨åº”ç”¨çš„å¹³å°ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Docker å°†åº”ç”¨åŠå…¶è¿è¡Œç¯å¢ƒï¼ˆå¯ä»¥æ˜¯ä¸€äº›åŠ¨æ€åº“ç­‰ä¾èµ–ï¼Œç”šè‡³æ“ä½œç³»ç»Ÿæä¾›çš„æ‰€æœ‰æ–‡ä»¶ï¼‰æ‰“åŒ…ï¼Œå¹¶å¯ä»¥å°†æ‰“åŒ…åçš„é•œåƒå‘å¸ƒåˆ°ä¸€ä¸ªå…¬å…±çš„é•œåƒæºï¼Œå†éƒ¨ç½²åˆ°å…¶ä»–å®‰è£…äº† Docker çš„æœºå™¨ä¸Šã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-651e5432eed2654a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Docker Platform"></p><p>ä¸‰ä¸ª Docker ä¸­çš„åŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>Imagesï¼ˆé•œåƒï¼‰ï¼šç±»ä¼¼äºä¸€ä¸ª zip å‹ç¼©åŒ…ï¼ŒåŒ…å«äº†åº”ç”¨åŠå…¶è¿è¡Œç¯å¢ƒ</li><li>Registriesï¼ˆæºï¼‰ï¼šä¸€ä¸ªæ–¹ä¾¿ç”¨æˆ·å’Œæœºå™¨åˆ†å‘ã€å…±äº«é•œåƒçš„ç«™ç‚¹ã€‚å¯ä»¥å°†æ‰“åŒ…å¥½çš„é•œåƒ push åˆ°æºï¼Œè¿™æ ·å¦ä¸€å°æœºå™¨å°±å¯ä»¥ä»é•œåƒæº pull è¯¥é•œåƒåˆ°æœ¬åœ°</li><li>Containersï¼ˆå®¹å™¨ï¼‰ï¼šç›¸å½“äºå®ä¾‹åŒ–çš„é•œåƒã€‚<strong>ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨ç›¸å½“äºå®¿ä¸»æœºä¸­ä¸€ä¸ªæ™®é€šçš„è¿›ç¨‹ï¼Œåªä¸è¿‡å®ƒçš„ç¯å¢ƒæ˜¯éš”ç¦»çš„</strong></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/6875152-4e505cff02f642b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="docker push"></p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-3f8802fae79fd57e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="docker pull"></p><h5 id="Image-Layers"><a href="#Image-Layers" class="headerlink" title="Image Layers"></a>Image Layers</h5><p>ä¸åŒäºè™šæ‹Ÿæœºé•œåƒæ˜¯ç”±æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæ„æˆçš„ä¸€ä¸ªå¤§çš„æ–‡ä»¶å—ï¼Œå®¹å™¨é•œåƒé€šå¸¸æ˜¯ç”±æ›´å°çš„<strong>å±‚</strong>æ„æˆã€‚è¿™äº›å±‚å¯ä»¥è¢«å¤šä¸ªé•œåƒæ‰€å…±äº«ã€‚<br>å¦‚æœæŸä¸ªé•œåƒéœ€è¦çš„éƒ¨åˆ†é•œåƒå±‚å·²ç»è¢«ä¸‹è½½åˆ°äº†å®¿ä¸»æœºä¸Šï¼ˆåœ¨ pull å…¶ä»–é•œåƒçš„æ—¶å€™ï¼‰ï¼Œåˆ™ pull è¯¥é•œåƒæ—¶åªéœ€è¦ä¸‹è½½ä¹‹å‰æœª pull çš„å±‚å³å¯ã€‚<br>é•œåƒå±‚ä½¿å¾—å‘å¸ƒé•œåƒå˜å¾—æ›´åŠ é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿæå‡äº†å®¿ä¸»æœºçš„å­˜å‚¨ç©ºé—´ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-bf0919122843a478.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Image Layers"></p><p>å¦‚ä¸Šå›¾ä¸­çš„ä¸‰ä¸ªå®¹å™¨ï¼Œå®ƒä»¬å¯ä»¥å…±äº«è®¿é—®ä¸€éƒ¨åˆ†å…±æœ‰çš„æ–‡ä»¶ã€‚ä½†å®ƒä»¬æ˜¯å¦‚ä½•åŒæ—¶åšåˆ°éš”ç¦»çš„å‘¢ï¼Ÿå…¶ä¸­æŸä¸ªå®¹å™¨è‹¥ä¿®æ”¹äº†å…±äº«çš„æ–‡ä»¶ï¼Œå¦‚ä½•åšåˆ°ä¸å¯¹å…¶ä»–å®¹å™¨å¯è§ï¼Ÿ<br>æ–‡ä»¶ç³»ç»Ÿçš„éš”ç¦»ç”± <strong>Copy-on-Write (CoW)</strong> æœºåˆ¶å®ç°ã€‚<br>å®¹å™¨ä¸­çš„æ–‡ä»¶ç³»ç»Ÿç”±ä»é•œåƒè€Œæ¥çš„åªè¯»å±‚å’ŒåŠ åœ¨åªè¯»å±‚ä¸Šé¢çš„ä¸€ä¸ªè¯»å†™å±‚æ„æˆã€‚å½“æŸä¸ªè¿è¡Œçš„å®¹å™¨ä¿®æ”¹äº†åªè¯»å±‚ä¸­çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šè¢«æ•´ä¸ªå¤åˆ¶åˆ°å®¹å™¨çš„è¯»å†™å±‚ã€‚æ¯ä¸ªå®¹å™¨éƒ½æ‹¥æœ‰è‡ªå·±æ‰€ç‹¬æœ‰çš„è¯»å†™å±‚ï¼Œå› æ­¤å¯¹å…±äº«æ–‡ä»¶çš„ä¿®æ”¹å¹¶ä¸ä¼šå¯¹å…¶ä»–å®¹å™¨å¯è§ã€‚<br>å½“åˆ é™¤æŸä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åªæ˜¯åœ¨è¯»å†™å±‚ä¸­è¢«æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œå®é™…ä¸Šè¯¥æ–‡ä»¶ä»ç„¶å­˜åœ¨äºåªè¯»å±‚ä¸­ã€‚å› æ­¤åˆ é™¤æ–‡ä»¶å¹¶ä¸ä¼šå‡å°‘é•œåƒçš„å¤§å°ã€‚</p><h5 id="é•œåƒå±‚çš„æ½œåœ¨é™åˆ¶"><a href="#é•œåƒå±‚çš„æ½œåœ¨é™åˆ¶" class="headerlink" title="é•œåƒå±‚çš„æ½œåœ¨é™åˆ¶"></a>é•œåƒå±‚çš„æ½œåœ¨é™åˆ¶</h5><p>ç†è®ºä¸Šè®²ï¼ŒåŸºäº Docker çš„é•œåƒå¯ä»¥è¿è¡Œåœ¨ä»»æ„ä¸€å°å¯ç”¨äº† Docker çš„æœºå™¨ä¸Šã€‚ä½†æ˜¯ç”±äºå®¹å™¨å¹¶æ²¡æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨éœ€è¦ç‰¹å®šç‰ˆæœ¬çš„å†…æ ¸æ‰èƒ½è¿è¡Œï¼Œå®ƒæœ‰å¯èƒ½ä¸ä¼šè¿è¡Œåœ¨æ¯ä¸€å°æœºå™¨ä¸Šã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-bedcb0dfebe1576c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="container requires specific kernel version"></p><p>æ­¤å¤–ï¼Œå®¹å™¨åŒ–çš„åº”ç”¨åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„ç¡¬ä»¶æ¶æ„ä¸Šã€‚æ¯”å¦‚ä¸èƒ½æŠŠä¸€ä¸ªæ„å»ºåœ¨ x86 CPU æ¶æ„ä¸Šçš„åº”ç”¨ï¼Œéƒ¨ç½²åœ¨ ARM å¹³å°çš„ Docker ä¸Šã€‚</p><h4 id="ä¸‰ã€å®¹å™¨èƒŒåçš„æŠ€æœ¯"><a href="#ä¸‰ã€å®¹å™¨èƒŒåçš„æŠ€æœ¯" class="headerlink" title="ä¸‰ã€å®¹å™¨èƒŒåçš„æŠ€æœ¯"></a>ä¸‰ã€å®¹å™¨èƒŒåçš„æŠ€æœ¯</h4><h5 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h5><p>Linux å‘½åç©ºé—´å¯ä»¥ç¡®ä¿æ¯ä¸ªè¿›ç¨‹éƒ½åªèƒ½çœ‹åˆ°å®ƒè‡ªå·±è§†è§’çš„ç³»ç»Ÿã€‚å³å®¹å™¨ä¸­çš„è¿›ç¨‹åªèƒ½çœ‹åˆ°éƒ¨åˆ†æ–‡ä»¶ã€è¿›ç¨‹ã€ç½‘ç»œæ¥å£å’Œæœºå™¨åï¼Œå°±å¥½åƒå®ƒè¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºä¸Šã€‚<br>å†…æ ¸å¯ä»¥åˆ›å»ºé¢å¤–çš„å‘½åç©ºé—´ï¼Œç„¶åå°†éƒ¨åˆ†èµ„æºç§»åŠ¨åˆ°è¯¥å‘½åç©ºé—´ï¼Œå¹¶ä»¤å…¶åªå¯¹æŸä¸€ä¸ªæˆ–ä¸€ç»„è¿›ç¨‹å¯è§ã€‚</p><p>å‘½åç©ºé—´çš„ç±»å‹ï¼š</p><ul><li>Mount å‘½åç©ºé—´ç”¨æ¥éš”ç¦»æŒ‚è½½ç‚¹ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰</li><li>Process ID å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹ ID</li><li>Network å‘½åç©ºé—´ç”¨æ¥éš”ç¦»ç½‘ç»œè®¾å¤‡ã€ç«¯å£ç­‰</li><li>ipc å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹é—´çš„é€šä¿¡ï¼ˆåŒ…æ‹¬ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ç­‰ï¼‰</li><li>UTS (UNIX Time-sharing System) å‘½åç©ºé—´ç”¨æ¥éš”ç¦»ç³»ç»Ÿçš„ä¸»æœºåå’Œ NIS (Network Information Service) åŸŸå</li><li>User ID å‘½åç©ºé—´ç”¨æ¥éš”ç¦»ç”¨æˆ·å’Œç»„ ID</li><li>Cgroup å‘½åç©ºé—´ç”¨æ¥éš”ç¦» Control Groups æ ¹ç›®å½•</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/6875152-e436794540627a33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="network namespace"></p><p>æœ‰æ—¶å€™å¹¶ä¸ä¼šæƒ³è¦å°†æŸä¸ªå®¹å™¨ä¸å¦ä¸€ä¸ªå®¹å™¨å®Œå…¨éš”ç¦»ï¼Œç›¸äº’å…³è”çš„å®¹å™¨ä¹‹é—´æœ‰å¯èƒ½ä¼šå…±äº«ç‰¹å®šçš„èµ„æºã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-120889e397b108e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="shared namespace"></p><p>æ¯”å¦‚ä¸Šå›¾ä¸­çš„ä¸¤ä¸ªå®¹å™¨ã€‚å®ƒä»¬å¯ä»¥çœ‹è§å¹¶ä½¿ç”¨ç›¸åŒçš„ä¸¤ä¸ªç½‘ç»œè®¾å¤‡ï¼ˆ<code>eth0</code> å’Œ <code>lo</code>ï¼‰ï¼Œå› ä¸ºå®ƒä»¬æ‹¥æœ‰ç›¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ã€‚å®ƒä»¬ä¹Ÿå› æ­¤å¯ä»¥ç»‘å®šç›¸åŒçš„ IP åœ°å€å¹¶é€šè¿‡ loopback è®¾å¤‡ç›¸äº’é€šä¿¡ã€‚<br>è¿™ä¸¤ä¸ªå®¹å™¨è¿˜ä½¿ç”¨åŒä¸€ä¸ª UTS å‘½åç©ºé—´ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥è§åˆ°ç›¸åŒçš„ä¸»æœºåã€‚ä½†å®ƒä»¬çš„ Mount å‘½åç©ºé—´æ˜¯ä¸åŒçš„ï¼Œå³æ‹¥æœ‰ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><p><strong>å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹åªæ˜¯ä¸€ä¸ªç»‘å®šäº† 7 ç±»å‘½åç©ºé—´çš„æ™®é€šè¿›ç¨‹</strong>ã€‚</p><h5 id="Linux-Control-Groups"><a href="#Linux-Control-Groups" class="headerlink" title="Linux Control Groups"></a>Linux Control Groups</h5><p>Linux å‘½åç©ºé—´å¯ä»¥æ§åˆ¶è¿›ç¨‹åªèƒ½è®¿é—®ä¸€éƒ¨åˆ†ç³»ç»Ÿèµ„æºï¼Œä½†å®ƒä»¬ä¸èƒ½é™åˆ¶æ¯ä¸ªè¿›ç¨‹æ¶ˆè€—çš„èµ„æºæ€»é‡ã€‚<br>Linux Control Groups (cgroups) åˆ™å¯ä»¥é™åˆ¶è¿›ç¨‹åªèƒ½ä½¿ç”¨é¢„å…ˆåˆ†é…å¥½çš„å›ºå®šé¢åº¦çš„ CPU æ—¶é—´ã€å†…å­˜å’Œç½‘ç»œå¸¦å®½ç­‰ã€‚é¿å…æŸäº›è¿›ç¨‹åƒæ‰æ‰€æœ‰çš„ç³»ç»Ÿèµ„æºã€‚</p><h4 id="sys-calls"><a href="#sys-calls" class="headerlink" title="sys-calls"></a>sys-calls</h4><p>Linux å‘½åç©ºé—´å’Œ Cgroups èƒ½å¤Ÿéš”ç¦»å®¹å™¨çš„ç¯å¢ƒå¹¶é˜²æ­¢æŸä¸ªå®¹å™¨æ¶ˆè€—æ‰æ‰€æœ‰çš„è®¡ç®—èµ„æºã€‚ä½†è¿™äº›å®¹å™¨ä¸­çš„è¿›ç¨‹ä»ç„¶ä½¿ç”¨åŒä¸€ä¸ªç³»ç»Ÿå†…æ ¸ï¼Œä¸€ä¸ªéæ³•å®¹å™¨ä»ç„¶å¯ä»¥é€šè¿‡ä¸€äº›æ¶æ„çš„ç³»ç»Ÿè°ƒç”¨æ¥å½±å“å…¶ä»–å®¹å™¨ã€‚</p><p>å†…æ ¸æä¾›äº†ä¸€ç³»åˆ— sys-calls å¯ä»¥è¢«ç¨‹åºç”¨æ¥ä¸æ“ä½œç³»ç»ŸåŠåº•å±‚çš„ç¡¬ä»¶äº¤äº’ï¼ŒåŒ…æ‹¬åˆ›å»ºè¿›ç¨‹ã€æ“ä½œæ–‡ä»¶å’Œè®¾å¤‡ã€åˆ›å»ºåº”ç”¨é—´çš„é€šä¿¡é€šé“ç­‰ã€‚<br>å…¶ä¸­æœ‰äº› sys-calls æ˜¯å®‰å…¨çš„ï¼Œå¯ä»¥è¢«ä»»æ„è¿›ç¨‹ä½¿ç”¨ã€‚å…¶ä»–ä¸€äº›åˆ™åªå…è®¸å…·æœ‰æ›´é«˜æƒé™çš„è¿›ç¨‹ä½¿ç”¨ã€‚æ¯”å¦‚å®¹å™¨ä¸­çš„åº”ç”¨åº”è¯¥å…è®¸è®¿é—®å®ƒä»¬çš„æœ¬åœ°æ–‡ä»¶ï¼Œä½†ä¸èƒ½ä¿®æ”¹ç³»ç»Ÿæ—¶é’Ÿæˆ–è€…ä»¥ç ´åå…¶ä»–å®¹å™¨çš„æ–¹å¼ä¿®æ”¹å†…æ ¸ã€‚</p><p>Linux å†…æ ¸æŠŠè¿™äº›æƒé™åˆ†æˆäº†åä¸º capabilities çš„å•ä½ã€‚å¦‚ï¼š</p><ul><li>CAP_NET_ADMINï¼šå…è®¸è¿›ç¨‹æ‰§è¡Œç½‘ç»œç›¸å…³çš„æ“ä½œ</li><li>CAP_NET_BIND_SERVICEï¼šå…è®¸è¿›ç¨‹ç»‘å®šå°äº 1024 çš„ç«¯å£å·</li><li>CAP_SYS_TIMEï¼šå…è®¸è¿›ç¨‹ä¿®æ”¹ç³»ç»Ÿæ—¶é’Ÿ</li></ul><p>Capabilities èƒ½å¤Ÿåœ¨å®¹å™¨åˆ›å»ºæ—¶æ·»åŠ æˆ–ç§»é™¤ï¼Œæ¯ä¸ª Capability éƒ½ä»£è¡¨ä¸€ç³»åˆ—ç‰¹æ®Šæƒé™ã€‚<br>æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <strong>seccomp (Secure Computing Mode)</strong> ã€‚åˆ›å»ºä¸€ä¸ª åŒ…å« seccomp é…ç½®çš„ JSON æ–‡ä»¶ï¼Œåœ¨æ„å»ºå®¹å™¨æ—¶æä¾›ç»™ Dockerã€‚</p><h5 id="AppArmor-amp-SELinux"><a href="#AppArmor-amp-SELinux" class="headerlink" title="AppArmor &amp; SELinux"></a>AppArmor &amp; SELinux</h5><p>å®¹å™¨è¿˜å¯ä»¥ä¾é ä¸¤ç§ MACï¼ˆå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼‰æœºåˆ¶ SELinux å’Œ AppArmor æ¥è·å¾—æ›´é«˜çš„å®‰å…¨æ€§ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://www.manning.com/books/kubernetes-in-action-second-edition" target="_blank" rel="noopener">Kubernetes in Action, Second Edition</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ä¸€ã€å®¹å™¨-vs-è™šæ‹Ÿæœº&quot;&gt;&lt;a href=&quot;#ä¸€ã€å®¹å™¨-vs-è™šæ‹Ÿæœº&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å®¹å™¨ vs è™šæ‹Ÿæœº&quot;&gt;&lt;/a&gt;ä¸€ã€å®¹å™¨ vs è™šæ‹Ÿæœº&lt;/h4&gt;&lt;h5 id=&quot;ç³»ç»Ÿå¼€é”€&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿå¼€é”€&quot; class=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://rollingstarky.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://rollingstarky.github.io/tags/Linux/"/>
    
      <category term="Docker" scheme="https://rollingstarky.github.io/tags/Docker/"/>
    
      <category term="Container" scheme="https://rollingstarky.github.io/tags/Container/"/>
    
      <category term="Kubernetes" scheme="https://rollingstarky.github.io/tags/Kubernetes/"/>
    
      <category term="Virtualization" scheme="https://rollingstarky.github.io/tags/Virtualization/"/>
    
      <category term="Isolation" scheme="https://rollingstarky.github.io/tags/Isolation/"/>
    
      <category term="VM" scheme="https://rollingstarky.github.io/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Python è¯­è¨€å®ç°å¾ªç¯çš„æœ€å¿«æ–¹å¼ï¼ˆforã€while ç­‰é€Ÿåº¦å¯¹æ¯”ï¼‰</title>
    <link href="https://rollingstarky.github.io/2021/11/23/the-fastest-way-to-loop-in-python/"/>
    <id>https://rollingstarky.github.io/2021/11/23/the-fastest-way-to-loop-in-python/</id>
    <published>2021-11-22T16:00:00.000Z</published>
    <updated>2021-11-23T12:51:53.254Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython ä¸æ˜¯ä¸€ç§æ‰§è¡Œæ•ˆç‡è¾ƒé«˜çš„è¯­è¨€ã€‚æ­¤å¤–åœ¨ä»»ä½•è¯­è¨€ä¸­ï¼Œå¾ªç¯éƒ½æ˜¯ä¸€ç§éå¸¸æ¶ˆè€—æ—¶é—´çš„æ“ä½œã€‚<br>å‡å¦‚ä»»æ„ä¸€ç§ç®€å•çš„å•æ­¥æ“ä½œè€—è´¹çš„æ—¶é—´ä¸º 1 ä¸ªå•ä½ï¼Œå°†æ­¤æ“ä½œé‡å¤æ‰§è¡Œä¸Šä¸‡æ¬¡ï¼Œæœ€ç»ˆè€—è´¹çš„æ—¶é—´ä¹Ÿå°†å¢é•¿ä¸Šä¸‡å€ã€‚</p><p><code>while</code> å’Œ <code>for</code> æ˜¯ Python ä¸­å¸¸ç”¨çš„ä¸¤ç§å®ç°å¾ªç¯çš„å…³é”®å­—ï¼Œå®ƒä»¬çš„è¿è¡Œæ•ˆç‡å®é™…ä¸Šæ˜¯æœ‰å·®è·çš„ã€‚æ¯”å¦‚ä¸‹é¢çš„æµ‹è¯•ä»£ç ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">while_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        s += i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        s += i</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'while loop\t\t'</span>, timeit.timeit(while_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'for loop\t\t'</span>, timeit.timeit(for_loop, number=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="comment"># =&gt; while loop               4.718853999860585</span></span><br><span class="line"><span class="comment"># =&gt; for loop                 3.211570399813354</span></span><br></pre></td></tr></table></figure></p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ±‚å’Œæ“ä½œï¼Œè®¡ç®—ä» 1 åˆ° n ä¹‹é—´æ‰€æœ‰è‡ªç„¶æ•°çš„æ€»å’Œã€‚<br>å¯ä»¥çœ‹åˆ° <code>for</code> å¾ªç¯ç›¸æ¯” <code>while</code> è¦å¿« 1.5 ç§’ã€‚å…¶ä¸­çš„å·®è·ä¸»è¦åœ¨äºä¸¤è€…çš„æœºåˆ¶ä¸åŒã€‚<br>åœ¨æ¯æ¬¡å¾ªç¯ä¸­ï¼Œ<code>while</code> å®é™…ä¸Šæ¯” <code>for</code> å¤šæ‰§è¡Œäº†ä¸¤æ­¥æ“ä½œï¼šè¾¹ç•Œæ£€æŸ¥å’Œå˜é‡ <code>i</code> çš„è‡ªå¢ã€‚å³æ¯è¿›è¡Œä¸€æ¬¡å¾ªç¯ï¼Œwhile éƒ½ä¼šåšä¸€æ¬¡è¾¹ç•Œæ£€æŸ¥ (<code>while i &lt; n</code>ï¼‰å’Œè‡ªå¢è®¡ç®—ï¼ˆ<code>i +=1</code>ï¼‰ã€‚è¿™ä¸¤æ­¥æ“ä½œéƒ½æ˜¯æ˜¾å¼çš„çº¯ Python ä»£ç ã€‚<br><code>for</code> å¾ªç¯ä¸éœ€è¦æ‰§è¡Œè¾¹ç•Œæ£€æŸ¥å’Œè‡ªå¢æ“ä½œï¼Œæ²¡æœ‰å¢åŠ æ˜¾å¼çš„ Python ä»£ç ï¼ˆçº¯ Python ä»£ç æ•ˆç‡ä½äºåº•å±‚çš„ C ä»£ç ï¼‰ã€‚å½“å¾ªç¯çš„æ¬¡æ•°è¶³å¤Ÿå¤šï¼Œå°±å‡ºç°äº†æ˜æ˜¾çš„æ•ˆç‡å·®è·ã€‚</p><p>å¯ä»¥å†å¢åŠ ä¸¤ä¸ªå‡½æ•°ï¼Œåœ¨ <code>for</code> å¾ªç¯ä¸­åŠ ä¸Šä¸å¿…è¦çš„è¾¹ç•Œæ£€æŸ¥å’Œè‡ªå¢è®¡ç®—ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">while_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        s += i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        s += i</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_loop_with_inc</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        s += i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_loop_with_test</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">if</span> i &lt; n:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        s += i</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'while loop\t\t'</span>, timeit.timeit(while_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'for loop\t\t'</span>, timeit.timeit(for_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'for loop with increment\t\t'</span>,</span><br><span class="line">          timeit.timeit(for_loop_with_inc, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'for loop with test\t\t'</span>, timeit.timeit(for_loop_with_test, number=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="comment"># =&gt; while loop               4.718853999860585</span></span><br><span class="line"><span class="comment"># =&gt; for loop                 3.211570399813354</span></span><br><span class="line"><span class="comment"># =&gt; for loop with increment          4.602369500091299</span></span><br><span class="line"><span class="comment"># =&gt; for loop with test               4.18337869993411</span></span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹å‡ºï¼Œå¢åŠ çš„è¾¹ç•Œæ£€æŸ¥å’Œè‡ªå¢æ“ä½œç¡®å®å¤§å¤§å½±å“äº† <code>for</code> å¾ªç¯çš„æ‰§è¡Œæ•ˆç‡ã€‚</p><p>å‰é¢æåˆ°è¿‡ï¼ŒPython åº•å±‚çš„è§£é‡Šå™¨å’Œå†…ç½®å‡½æ•°æ˜¯ç”¨ C è¯­è¨€å®ç°çš„ã€‚è€Œ C è¯­è¨€çš„æ‰§è¡Œæ•ˆç‡è¿œå¤§äº Pythonã€‚<br>å¯¹äºä¸Šé¢çš„æ±‚ç­‰å·®æ•°åˆ—ä¹‹å’Œçš„æ“ä½œï¼Œå€ŸåŠ©äº Python å†…ç½®çš„ <code>sum</code> å‡½æ•°ï¼Œå¯ä»¥è·å¾—è¿œå¤§äº <code>for</code> æˆ– <code>while</code> å¾ªç¯çš„æ‰§è¡Œæ•ˆç‡ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">while_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        s += i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        s += i</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum_range</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(range(n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'while loop\t\t'</span>, timeit.timeit(while_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'for loop\t\t'</span>, timeit.timeit(for_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'sum range\t\t'</span>, timeit.timeit(sum_range, number=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="comment"># =&gt; while loop               4.718853999860585</span></span><br><span class="line"><span class="comment"># =&gt; for loop                 3.211570399813354</span></span><br><span class="line"><span class="comment"># =&gt; sum range                0.8658821999561042</span></span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨å†…ç½®å‡½æ•° <code>sum</code> æ›¿ä»£å¾ªç¯ä¹‹åï¼Œä»£ç çš„æ‰§è¡Œæ•ˆç‡å®ç°äº†æˆå€çš„å¢é•¿ã€‚å†…ç½®å‡½æ•° <code>sum</code> çš„ç´¯åŠ æ“ä½œå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ç§å¾ªç¯ï¼Œä½†å®ƒç”± C è¯­è¨€å®ç°ï¼Œè€Œ <code>for</code> å¾ªç¯ä¸­çš„æ±‚å’Œæ“ä½œæ˜¯ç”±çº¯ Python ä»£ç  <code>s += i</code> å®ç°çš„ã€‚C &gt; Pythonã€‚</p><p>å†æ‹“å±•ä¸€ä¸‹æ€ç»´ã€‚å°æ—¶å€™éƒ½å¬è¯´è¿‡ç«¥å¹´é«˜æ–¯å·§å¦™åœ°è®¡ç®— 1 åˆ° 100 ä¹‹å’Œçš„æ•…äº‹ã€‚1â€¦100 ä¹‹å’Œç­‰äº (1 + 100) * 50ã€‚è¿™ä¸ªè®¡ç®—æ–¹æ³•åŒæ ·å¯ä»¥åº”ç”¨åˆ°ä¸Šé¢çš„æ±‚å’Œæ“ä½œä¸­ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">while_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        s += i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_loop</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        s += i</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum_range</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(range(n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">math_sum</span><span class="params">(n=<span class="number">100</span>_000_000)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (n * (n - <span class="number">1</span>)) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'while loop\t\t'</span>, timeit.timeit(while_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'for loop\t\t'</span>, timeit.timeit(for_loop, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'sum range\t\t'</span>, timeit.timeit(sum_range, number=<span class="number">1</span>))</span><br><span class="line">    print(<span class="string">'math sum\t\t'</span>, timeit.timeit(math_sum, number=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="comment"># =&gt; while loop               4.718853999860585</span></span><br><span class="line"><span class="comment"># =&gt; for loop                 3.211570399813354</span></span><br><span class="line"><span class="comment"># =&gt; sum range                0.8658821999561042</span></span><br><span class="line"><span class="comment"># =&gt; math sum                 2.400018274784088e-06</span></span><br></pre></td></tr></table></figure></p><p>æœ€ç»ˆ math sum çš„æ‰§è¡Œæ—¶é—´çº¦ä¸º <code>2.4e-6</code>ï¼Œç¼©çŸ­äº†ä¸Šç™¾ä¸‡å€ã€‚è¿™é‡Œçš„æ€è·¯å°±æ˜¯ï¼Œæ—¢ç„¶å¾ªç¯çš„æ•ˆç‡ä½ï¼Œä¸€æ®µä»£ç è¦é‡å¤æ‰§è¡Œä¸Šäº¿æ¬¡ã€‚<br>ç´¢æ€§ç›´æ¥ä¸è¦å¾ªç¯ï¼Œé€šè¿‡æ•°å­¦å…¬å¼ï¼ŒæŠŠä¸Šäº¿æ¬¡çš„å¾ªç¯æ“ä½œå˜æˆåªæœ‰ä¸€æ­¥æ“ä½œã€‚æ•ˆç‡è‡ªç„¶å¾—åˆ°äº†ç©ºå‰çš„åŠ å¼ºã€‚</p><p>æœ€åçš„ç»“è®ºï¼ˆæœ‰ç‚¹è°œè¯­äººï¼‰ï¼š</p><p><strong>å®ç°å¾ªç¯çš„æœ€å¿«æ–¹å¼</strong><br>â€”â€”<br>â€”â€”<br>â€”â€”<br><strong>å°±æ˜¯ä¸ç”¨å¾ªç¯</strong></p><p>å¯¹äº Python è€Œè¨€ï¼Œåˆ™å°½å¯èƒ½åœ°ä½¿ç”¨å†…ç½®å‡½æ•°ï¼Œå°†å¾ªç¯ä¸­çš„çº¯ Python ä»£ç é™åˆ°æœ€ä½ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://youtu.be/Qgevy75co8c" target="_blank" rel="noopener">The Fastest Way to Loop in Python - mCoding</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython ä¸æ˜¯ä¸€ç§æ‰§è¡Œæ•ˆç‡è¾ƒé«˜çš„è¯­è¨€ã€‚æ­¤å¤–åœ¨ä»»ä½•è¯­è¨€ä¸­ï¼Œå¾ªç¯éƒ½æ˜¯ä¸€ç§éå¸¸æ¶ˆè€—æ—¶é—´çš„æ“ä½œã€‚&lt;br&gt;å‡å¦‚ä»»æ„ä¸€ç§ç®€å•çš„å•æ­¥æ“ä½œè€—è´¹çš„æ—¶é—´ä¸º 1 ä¸ªå•ä½ï¼Œå°†æ­¤æ“ä½œé‡å¤æ‰§è¡Œä¸Šä¸‡æ¬¡ï¼Œæœ€ç»ˆè€—è´¹çš„æ—¶é—´ä¹Ÿå°†å¢é•¿ä¸Šä¸‡å€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;while&lt;/code&gt; å’Œ 
      
    
    </summary>
    
      <category term="Python" scheme="https://rollingstarky.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://rollingstarky.github.io/tags/Python/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Efficiency" scheme="https://rollingstarky.github.io/tags/Efficiency/"/>
    
      <category term="loop" scheme="https://rollingstarky.github.io/tags/loop/"/>
    
      <category term="C" scheme="https://rollingstarky.github.io/tags/C/"/>
    
      <category term="big-O" scheme="https://rollingstarky.github.io/tags/big-O/"/>
    
  </entry>
  
  <entry>
    <title>Ansible ä½¿ç”¨ lineinfile æ¨¡å—ä¿®æ”¹é…ç½®æ–‡ä»¶</title>
    <link href="https://rollingstarky.github.io/2021/11/16/ansible-lineinfile-module-for-modifying-configuration/"/>
    <id>https://rollingstarky.github.io/2021/11/16/ansible-lineinfile-module-for-modifying-configuration/</id>
    <published>2021-11-15T16:00:00.000Z</published>
    <updated>2021-11-16T14:33:03.362Z</updated>
    
    <content type="html"><![CDATA[<p>éœ€è¦ç”¨ Ansible ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯åœ¨æŸä¸ªæ–‡ä»¶æœ«å°¾æ·»åŠ å‡ è¡Œå†…å®¹ã€‚ç›´è§‚åœ°æƒ³ï¼Œç›´æ¥ç”¨ <code>shell</code> æ¨¡å—ï¼Œ<code>echo</code> åŠ  <code>&gt;&gt;</code> å°±å®Œäº‹äº†ã€‚<br>ä½†ä»”ç»†ä¸€ç¢ç£¨ï¼Œå¾ˆå¯èƒ½ä¼šå¼•å‘ä¸€äº›æ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å¦‚æœéœ€è¦æ·»åŠ çš„é…ç½®å·²ç»å­˜åœ¨ï¼Œ<code>echo</code> ä»ä¼šå‘é…ç½®æ–‡ä»¶åº•éƒ¨æ·»åŠ åŒæ ·çš„å†…å®¹</li><li>å¦‚æœæ·»åŠ é…ç½®çš„ä»»åŠ¡é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œåˆ™é…ç½®æ–‡ä»¶ä¸­ä¹Ÿä¼šå¤šæ¬¡å‡ºç°é‡å¤çš„å†…å®¹ã€‚æ— æ³•åšåˆ°<strong>å¹‚ç­‰</strong></li><li>å¦‚ä½•åšåˆ°ï¼Œå½“å¯¹åº”çš„é…ç½®å·²ç»å­˜åœ¨ï¼Œåˆ™å°†è¯¥é…ç½®æ”¹ä¸ºæœŸæœ›çš„å€¼ï¼›å½“å¯¹åº”çš„é…ç½®ä¸å­˜åœ¨ï¼Œä¸åšä»»ä½•æ“ä½œï¼ˆæœ‰å°±ä¿®æ”¹ï¼Œæ²¡æœ‰å°±ä¸åŠ¨ã€‚å¥½åƒå¯ä»¥ç”¨ <code>sed</code>ï¼‰</li><li>å¦‚ä½•å®‰å…¨åœ°ç§»é™¤æŒ‡å®šçš„é…ç½®é¡¹</li></ul><p>è¯¸å¦‚æ­¤ç±»ã€‚è¿ç»´å·¥ä½œå¸¸å¸¸è¦å…³ç³»åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ä»»ä½•æ— æ³•é¢„æœŸçš„æ•ˆæœéƒ½å¯èƒ½äº§ç”Ÿä¸¥é‡çš„å½±å“ã€‚è€Œå•çº¯ä½¿ç”¨ <code>echo</code> å’Œ <code>&gt;&gt;</code> å‘é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å†…å®¹ï¼Œå…·æœ‰å¾ˆå¤§çš„ä¸ç¡®å®šæ€§ã€‚<br>å½“ç„¶å¯ä»¥å½¢æˆä¸€ä¸ª Shell è„šæœ¬ï¼Œå¯¹å„ç§è¾¹ç•Œè¿›è¡Œè¶³å¤Ÿçš„æ£€æŸ¥å’Œåˆ¤å®šï¼Œä½†è¿™ä¼šå¯¼è‡´ä»£ç é‡å˜å¤§ï¼Œç»“æ„å¤æ‚éš¾ä»¥æ ‡å‡†åŒ–ï¼›åŒæ—¶ä¹Ÿå®¹æ˜“å‡ºç°é—æ¼çš„æƒ…å†µã€‚</p><p>å®é™…ä¸Š Ansible å†…ç½®çš„ <code>lineinfile</code> å°±æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†ä¸Šè¿°ä»»åŠ¡çš„æ¨¡å—ã€‚</p><p>æ¯”å¦‚é’ˆå¯¹å¦‚ä¸‹å†…å®¹çš„é…ç½®æ–‡ä»¶ <code>test_conf.ini</code>ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">FIRST</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">SECOND</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure></p><p>éœ€è¦æ·»åŠ ä¸€è¡Œé…ç½® <code>THIRD=3</code>ã€‚</p><p>å¯ä»¥è¿è¡Œå¦‚ä¸‹å†…å®¹çš„ playbook <code>change_config.yml</code>ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">change</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">change</span> <span class="string">content</span> <span class="string">in</span> <span class="string">test_conf.ini</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/home/starky/projects/ansible/practice/test_conf.ini</span></span><br><span class="line"><span class="attr">        regexp:</span> <span class="string">'^THIRD'</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">THIRD=3</span></span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>lineinfile</code> æ¨¡å—çš„ <code>path</code> å‚æ•°ç”¨äºæŒ‡å®šç›®æ ‡é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼›<code>regexp</code> å‚æ•°åˆ™ç”¨äºæŒ‡å®šå¯¹æ–‡ä»¶å†…å®¹è¿›è¡ŒåŒ¹é…æ—¶ä½¿ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼ï¼›æœ€åçš„ <code>line</code> å‚æ•°è¡¨ç¤ºå¸Œæœ›åœ¨ç›®æ ‡æ–‡ä»¶ä¸­å‡ºç°çš„å†…å®¹ã€‚</p><p>å…·ä½“çš„æ­¥éª¤ä¸ºï¼š</p><ul><li>æ£€æŸ¥ <code>line</code> å¯¹åº”çš„å†…å®¹æ˜¯å¦å­˜åœ¨äº <code>path</code> å¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ä¸­</li><li>è‹¥å·²ç»å­˜åœ¨ã€‚åˆ™ç›®æ ‡æ–‡ä»¶ç¬¦åˆè¦æ±‚ï¼Œä¸å¯¹è¯¥æ–‡ä»¶åšä»»ä½•æ“ä½œ</li><li>è‹¥ä¸å­˜åœ¨ã€‚é€šè¿‡ <code>regexp</code> æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼å¯¹ç›®æ ‡æ–‡ä»¶è¿›è¡ŒåŒ¹é…</li><li>è‹¥ <code>regexp</code> åŒ¹é…åˆ°æ–‡æœ¬è¡Œï¼Œåˆ™å°†è¯¥è¡Œå†…å®¹ä¿®æ”¹ä¸º <code>line</code> æŒ‡å®šçš„å†…å®¹</li><li>è‹¥ <code>regexp</code> æœªåŒ¹é…åˆ°æ–‡æœ¬è¡Œï¼Œåˆ™å°† <code>line</code> å¯¹åº”çš„å†…å®¹ä½œä¸ºæ–°çš„ä¸€è¡Œæ·»åŠ åˆ°ç›®æ ‡æ–‡ä»¶æœ«å°¾</li></ul><p>è¿è¡Œæ•ˆæœï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook change_config.yml</span><br><span class="line"></span><br><span class="line">PLAY [change configuration] *********************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [change content <span class="keyword">in</span> test_conf.ini] **********************************************************************************************</span><br><span class="line">changed: [localhost]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************</span><br><span class="line">localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶ <code>test_conf.ini</code> é…ç½®æ–‡ä»¶çš„å†…å®¹è¢«ä¿®æ”¹ä¸ºï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">FIRST</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">SECOND</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">THIRD</span>=<span class="number">3</span></span><br></pre></td></tr></table></figure></p><p>è‹¥å†æ¬¡è¿è¡Œ <code>ansible-playbook change_config.yml</code> å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook change_config.yml</span><br><span class="line"></span><br><span class="line">PLAY [change configuration] *********************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [change content <span class="keyword">in</span> test_conf.ini] **********************************************************************************************</span><br><span class="line">ok: [localhost]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************</span><br><span class="line">localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ä¿®æ”¹é…ç½®æ–‡ä»¶çš„ä»»åŠ¡æ‰§è¡Œç»“æœä¸º <code>ok</code>ï¼Œè€Œä¸åŒäºä¸Šä¸€æ¬¡çš„ <code>changed</code>ã€‚è¿™è¡¨ç¤º <code>lineinfile</code> æ¨¡å—å¯¹é…ç½®æ–‡ä»¶çš„å†…å®¹è¿›è¡Œäº†æ£€æŸ¥ï¼Œå‘ç°éœ€è¦æ·»åŠ çš„é…ç½®è¡Œå·²ç»å­˜åœ¨ï¼Œå› æ­¤æœªåšä»»ä½•æ”¹åŠ¨ã€‚ç¬¦åˆ<strong>å¹‚ç­‰</strong>çš„åŸåˆ™ã€‚</p><p>å‡å¦‚å°†é…ç½®æ–‡ä»¶ä¸­çš„ <code>THIRD=3</code> æ”¹ä¸º <code>THIRD=false</code>ï¼Œå†æ¬¡è¿è¡Œ playbookï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook change_config.yml</span><br><span class="line"></span><br><span class="line">PLAY [change configuration] *********************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [change content <span class="keyword">in</span> test_conf.ini] **********************************************************************************************</span><br><span class="line">changed: [localhost]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************</span><br><span class="line">localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>æ­£åˆ™è¡¨è¾¾å¼ <code>^THIRD</code> ä¼šåŒ¹é…åˆ°é…ç½®æ–‡ä»¶çš„ç¬¬ä¸‰è¡Œ <code>THIRD=false</code>ï¼Œå†å°†è¯¥è¡Œå†…å®¹æ›¿æ¢ä¸º <code>THIRD=3</code>ã€‚</p><p>æœ€ç»ˆä»å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å†…å®¹ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">FIRST</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">SECOND</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">THIRD</span>=<span class="number">3</span></span><br></pre></td></tr></table></figure></p><p>å¯¹äº Ansible playbook è€Œè¨€ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨<strong>æœŸæœ›è¾¾åˆ°çš„çŠ¶æ€</strong>ï¼Œè€Œä¸ç”¨çº ç»“<strong>ä¸ºäº†è¾¾åˆ°è¯¥çŠ¶æ€éœ€è¦æ‰§è¡Œå“ªäº›æ­¥éª¤</strong>ã€‚<br>å¦‚ <code>lineinfile</code> æ¨¡å—ï¼Œ<code>line</code> æŒ‡å®šçš„å†…å®¹å³ä¸ºæˆ‘ä»¬æœŸæœ›ç›®æ ‡æ–‡ä»¶è¾¾åˆ°çš„çŠ¶æ€ã€‚å³è¯¥æ–‡ä»¶æœ€ç»ˆä¸€å®šä¼šåŒ…å«ä¸€è¡Œä¸ <code>line</code> ç›¸åŒçš„æ–‡æœ¬ã€‚<br>ä¸ç®¡è¯¥è¡Œå†…å®¹æ˜¯æœ¬å°±å·²ç»å­˜åœ¨çš„ï¼Œè¿˜æ˜¯é€šè¿‡ä¿®æ”¹ <code>regexp</code> åŒ¹é…åˆ°çš„æ–‡æœ¬è¡Œå¾—åˆ°çš„ï¼Œè¿˜æ˜¯ç›´æ¥åœ¨ç›®æ ‡æ–‡ä»¶æœ«å°¾æ–°å¢çš„ã€‚è€Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ <code>path</code>ã€<code>regexp</code>ã€<code>line</code> ä¸‰ä¸ªå‚æ•°å³å¯ã€‚</p><h4 id="å…¶ä»–ç”¨æ³•"><a href="#å…¶ä»–ç”¨æ³•" class="headerlink" title="å…¶ä»–ç”¨æ³•"></a>å…¶ä»–ç”¨æ³•</h4><h5 id="backrefs"><a href="#backrefs" class="headerlink" title="backrefs"></a>backrefs</h5><p><code>lineinfile</code> é»˜è®¤çš„è¡Œä¸ºæ˜¯è‹¥ <code>line</code> æŒ‡å®šçš„å†…å®¹æœªå­˜åœ¨ï¼Œ<code>regexp</code> æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œå°±åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€è¡Œ <code>line</code> æŒ‡å®šçš„å†…å®¹ã€‚<br><code>backrefs</code> å‚æ•°å¯ä»¥ä¿®æ”¹æ­¤è¡Œä¸ºã€‚å½“ <code>backrefs</code> è®¾å®šä¸º <code>true</code> æ—¶ï¼Œè‹¥ <code>line</code> æŒ‡å®šçš„å†…å®¹ä¸å­˜åœ¨ï¼Œæ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ²¡æœ‰åŒ¹é…ã€‚åˆ™ä¸åšä»»ä½•æ“ä½œã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹ playbookï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">change</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">change</span> <span class="string">content</span> <span class="string">in</span> <span class="string">test_conf.ini</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/home/starky/projects/ansible/practice/test_conf.ini</span></span><br><span class="line"><span class="attr">        regexp:</span> <span class="string">'^THIRD'</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">'THIRD=3'</span></span><br><span class="line"><span class="attr">        backrefs:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>å½“ç›®æ ‡æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">FIRST</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">SECOND</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure></p><p>playbook å®é™…ä¸ä¼šå¯¹å…¶åšä»»ä½•ä¿®æ”¹ï¼Œä¸ä¼šåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ  <code>THIRD=3</code>ã€‚åªæœ‰å½“æ–‡ä»¶ä¸­å­˜åœ¨å¦‚ <code>THIRD=false</code> è¿™ç±»å†…å®¹æ—¶ï¼Œplaybook æ‰ä¼šå®ŒæˆåŒ¹é…å¹¶æ›¿æ¢å¯¹åº”çš„è¡Œã€‚</p><p>æ²¡æœ‰ <code>backrefs</code> è¡¨ç¤ºåŒ¹é…å°±æ›¿æ¢ï¼Œä¸åŒ¹é…å°±åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼›æœ‰ <code>backrefs</code> è¡¨ç¤ºåŒ¹é…å°±æ›¿æ¢ï¼Œä¸åŒ¹é…å°±ä¸åŠ¨ã€‚</p><h5 id="åˆ é™¤ä¸€è¡Œå†…å®¹"><a href="#åˆ é™¤ä¸€è¡Œå†…å®¹" class="headerlink" title="åˆ é™¤ä¸€è¡Œå†…å®¹"></a>åˆ é™¤ä¸€è¡Œå†…å®¹</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">change</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">change</span> <span class="string">content</span> <span class="string">in</span> <span class="string">test_conf.ini</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/home/starky/projects/ansible/practice/test_conf.ini</span></span><br><span class="line"><span class="attr">        regexp:</span> <span class="string">'^THIRD'</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">absent</span></span><br></pre></td></tr></table></figure><h5 id="åœ¨åŒ¹é…è¡Œå‰-åæ·»åŠ "><a href="#åœ¨åŒ¹é…è¡Œå‰-åæ·»åŠ " class="headerlink" title="åœ¨åŒ¹é…è¡Œå‰/åæ·»åŠ "></a>åœ¨åŒ¹é…è¡Œå‰/åæ·»åŠ </h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">change</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">change</span> <span class="string">content</span> <span class="string">in</span> <span class="string">test_conf.ini</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/home/starky/projects/ansible/practice/test_conf.ini</span></span><br><span class="line"><span class="attr">        insertbefore:</span> <span class="string">'^FIRST'</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">'ZERO=false'</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">change</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">change</span> <span class="string">content</span> <span class="string">in</span> <span class="string">test_conf.ini</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/home/starky/projects/ansible/practice/test_conf.ini</span></span><br><span class="line"><span class="attr">        insertafter:</span> <span class="string">'^THIRD'</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">'FOURTH=4'</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>å½“ <code>line</code> æŒ‡å®šçš„å†…å®¹å·²ç»å­˜åœ¨äºç›®æ ‡æ–‡ä»¶ä¸­æ—¶ï¼Œä¸ç®¡å…¶å…·ä½“åœ¨ä»€ä¹ˆä½ç½®ï¼Œç›®æ ‡æ–‡ä»¶éƒ½ä¸ä¼šåšä»»ä½•ä¿®æ”¹</li><li>å½“ <code>insertbefore</code> æˆ– <code>insertafter</code> æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰ä»»ä½•åŒ¹é…æ—¶ï¼Œéƒ½ä¼šåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ  <code>line</code> æŒ‡å®šçš„å†…å®¹</li></ul><h4 id="å®˜ç½‘ç¤ºä¾‹"><a href="#å®˜ç½‘ç¤ºä¾‹" class="headerlink" title="å®˜ç½‘ç¤ºä¾‹"></a>å®˜ç½‘ç¤ºä¾‹</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Before 2.3, option 'dest', 'destfile' or 'name' was used instead of 'path'</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Ensure</span> <span class="string">SELinux</span> <span class="string">is</span> <span class="string">set</span> <span class="string">to</span> <span class="string">enforcing</span> <span class="string">mode</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/selinux/config</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^SELINUX='</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">SELINUX=enforcing</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Make</span> <span class="string">sure</span> <span class="string">group</span> <span class="string">wheel</span> <span class="string">is</span> <span class="string">not</span> <span class="string">in</span> <span class="string">the</span> <span class="string">sudoers</span> <span class="string">configuration</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/sudoers</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">absent</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^%wheel'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Replace</span> <span class="string">a</span> <span class="string">localhost</span> <span class="string">entry</span> <span class="string">with</span> <span class="string">our</span> <span class="string">own</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^127\.0\.0\.1'</span></span><br><span class="line"><span class="attr">    line:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">'0644'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Replace</span> <span class="string">a</span> <span class="string">localhost</span> <span class="string">entry</span> <span class="string">searching</span> <span class="string">for</span> <span class="string">a</span> <span class="string">literal</span> <span class="string">string</span> <span class="string">to</span> <span class="string">avoid</span> <span class="string">escaping</span></span><br><span class="line"><span class="attr">  lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="attr">    search_string:</span> <span class="string">'127.0.0.1'</span></span><br><span class="line"><span class="attr">    line:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">'0644'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Ensure</span> <span class="string">the</span> <span class="string">default</span> <span class="string">Apache</span> <span class="string">port</span> <span class="string">is</span> <span class="number">8080</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^Listen '</span></span><br><span class="line"><span class="attr">    insertafter:</span> <span class="string">'^#Listen '</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">Listen</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Ensure</span> <span class="string">php</span> <span class="string">extension</span> <span class="string">matches</span> <span class="string">new</span> <span class="string">pattern</span></span><br><span class="line"><span class="attr">  lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    search_string:</span> <span class="string">'&lt;FilesMatch ".php[45]?$"&gt;'</span></span><br><span class="line"><span class="attr">    insertafter:</span> <span class="string">'^\t&lt;Location \/&gt;\n'</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">'        &lt;FilesMatch ".php[34]?$"&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Ensure</span> <span class="string">we</span> <span class="string">have</span> <span class="string">our</span> <span class="string">own</span> <span class="string">comment</span> <span class="string">added</span> <span class="string">to</span> <span class="string">/etc/services</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/services</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^# port for http'</span></span><br><span class="line"><span class="attr">    insertbefore:</span> <span class="string">'^www.*80/tcp'</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">'# port for http by default'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Add</span> <span class="string">a</span> <span class="string">line</span> <span class="string">to</span> <span class="string">a</span> <span class="string">file</span> <span class="string">if</span> <span class="string">the</span> <span class="string">file</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist,</span> <span class="string">without</span> <span class="string">passing</span> <span class="string">regexp</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/tmp/testfile</span></span><br><span class="line"><span class="attr">    line:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.99</span> <span class="string">foo.lab.net</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Yaml requires escaping backslashes in double quotes but not in single quotes</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Ensure</span> <span class="string">the</span> <span class="string">JBoss</span> <span class="string">memory</span> <span class="string">settings</span> <span class="string">are</span> <span class="string">exactly</span> <span class="string">as</span> <span class="string">needed</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/opt/jboss-as/bin/standalone.conf</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^(.*)Xms(\d+)m(.*)$'</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">'\1Xms$&#123;xms&#125;m\3'</span></span><br><span class="line"><span class="attr">    backrefs:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Fully quoted because of the ': ' on the line. See the Gotchas in the YAML docs.</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Validate</span> <span class="string">the</span> <span class="string">sudoers</span> <span class="string">file</span> <span class="string">before</span> <span class="string">saving</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/sudoers</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">'^%ADMIN ALL='</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">'%ADMIN ALL=(ALL) NOPASSWD: ALL'</span></span><br><span class="line"><span class="attr">    validate:</span> <span class="string">/usr/sbin/visudo</span> <span class="bullet">-cf</span> <span class="string">%s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3/library/re.html for further details on syntax</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Use</span> <span class="string">backrefs</span> <span class="string">with</span> <span class="string">alternative</span> <span class="string">group</span> <span class="string">syntax</span> <span class="string">to</span> <span class="string">avoid</span> <span class="string">conflicts</span> <span class="string">with</span> <span class="string">variable</span> <span class="string">values</span></span><br><span class="line">  <span class="string">ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/tmp/config</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">^(host=).*</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">\g&lt;1&gt;&#123;&#123;</span> <span class="string">hostname</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    backrefs:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html" target="_blank" rel="noopener">ansible.builtin.lineinfile â€“ Manage lines in text files</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;éœ€è¦ç”¨ Ansible ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯åœ¨æŸä¸ªæ–‡ä»¶æœ«å°¾æ·»åŠ å‡ è¡Œå†…å®¹ã€‚ç›´è§‚åœ°æƒ³ï¼Œç›´æ¥ç”¨ &lt;code&gt;shell&lt;/code&gt; æ¨¡å—ï¼Œ&lt;code&gt;echo&lt;/code&gt; åŠ  &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; å°±å®Œäº‹äº†ã€‚&lt;br&gt;ä½†ä»”ç»†ä¸€ç¢ç£¨ï¼Œå¾ˆå¯èƒ½ä¼šå¼•å‘ä¸€äº›æ„æƒ³ä¸
      
    
    </summary>
    
      <category term="Linux" scheme="https://rollingstarky.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://rollingstarky.github.io/tags/Linux/"/>
    
      <category term="Configuration" scheme="https://rollingstarky.github.io/tags/Configuration/"/>
    
      <category term="Shell" scheme="https://rollingstarky.github.io/tags/Shell/"/>
    
      <category term="Ansible" scheme="https://rollingstarky.github.io/tags/Ansible/"/>
    
      <category term="Devops" scheme="https://rollingstarky.github.io/tags/Devops/"/>
    
      <category term="Automation" scheme="https://rollingstarky.github.io/tags/Automation/"/>
    
  </entry>
  
  <entry>
    <title>Effective Python ç¬”è®° â€”â€” å¹¶å‘ä¸å¹¶è¡Œï¼ˆQueueï¼‰</title>
    <link href="https://rollingstarky.github.io/2021/10/08/effective-python-notes-concurrency-and-queue/"/>
    <id>https://rollingstarky.github.io/2021/10/08/effective-python-notes-concurrency-and-queue/</id>
    <published>2021-10-07T16:00:00.000Z</published>
    <updated>2021-10-08T15:08:25.436Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å€ŸåŠ©-Queue-å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ"><a href="#å€ŸåŠ©-Queue-å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ" class="headerlink" title="å€ŸåŠ© Queue å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ"></a>å€ŸåŠ© Queue å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ</h4><h5 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h5><p>å¹¶è¡Œåœ°æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„ Python ç¨‹åºé€šå¸¸éƒ½éœ€è¦ä¸€ç§åä½œæœºåˆ¶ï¼Œä½¿å¾—å¤šä¸ªçº¿ç¨‹è´Ÿè´£çš„å„éƒ¨åˆ†ä¹‹é—´çš„å·¥ä½œèƒ½å¤Ÿç›¸äº’ååŒã€‚<br>å…¶ä¸­ä¸€ç§åä½œæœºåˆ¶ç§°ä¸º<strong>ç®¡çº¿</strong>ï¼ˆ<em>pipeline</em>ï¼‰ã€‚pipeline çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äºå·¥å‚é‡Œçš„æµæ°´çº¿ï¼Œåˆ†ä¸ºä¸²è¡Œæ’åˆ—çš„å¤šé“å·¥åºï¼ˆ<em>phase</em>ï¼‰ã€‚æ¯é“å·¥åºéƒ½ç”±ç‰¹å®šçš„å‡½æ•°å¤„ç†ï¼Œå‡½æ•°ä¹‹é—´å¯ä»¥å¹¶è¡Œåœ°æ‰§è¡Œã€‚</p><p>æ¯”å¦‚éœ€è¦åˆ›å»ºè¿™æ ·ä¸€ä¸ªç³»ç»Ÿï¼Œå¯ä»¥ä»ç›¸æœºæ¥æ”¶æŒç»­çš„å›¾ç‰‡æµï¼Œå†å°†æ”¶åˆ°çš„å›¾ç‰‡æ›´æ”¹å°ºå¯¸ï¼Œæœ€åä¸Šä¼ åˆ°çº¿ä¸Šçš„å›¾ç‰‡åº“ä¸­ã€‚<br>è¿™æ ·çš„ç³»ç»Ÿå°±å¯ä»¥åˆ†ä¸ºä¸‰é“å·¥åºï¼Œåˆ†åˆ«ç”¨ <code>download</code>ã€<code>resize</code>ã€<code>upload</code> ä¸‰ä¸ªå‡½æ•°å»å¤„ç†ã€‚æ­¤å¤–è¿˜éœ€è¦ä¸€ä¸ªåœ¨å„é“å·¥åºé—´ä¼ é€’ä»»åŠ¡å¯¹è±¡çš„åª’ä»‹ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡çº¿ç¨‹å®‰å…¨çš„ <strong>producer-consumer</strong> é˜Ÿåˆ—å»å®ç°ã€‚</p><p>å…·ä½“çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resize</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyQueue</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.items = deque()</span><br><span class="line">        self.lock = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            self.items.append(item)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> self.items.popleft()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, in_queue, out_queue)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.in_queue = in_queue</span><br><span class="line">        self.out_queue = out_queue</span><br><span class="line">        self.polled_count = <span class="number">0</span></span><br><span class="line">        <span class="comment"># self.work_done = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            self.polled_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                item = self.in_queue.get()</span><br><span class="line">            <span class="keyword">except</span> IndexError:</span><br><span class="line">                time.sleep(<span class="number">0.01</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result = self.func(item)</span><br><span class="line">                self.out_queue.put(result)</span><br><span class="line">                <span class="comment"># self.work_done += 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">download_queue = MyQueue()</span><br><span class="line">resize_queue = MyQueue()</span><br><span class="line">upload_queue = MyQueue()</span><br><span class="line">done_queue = MyQueue()</span><br><span class="line"></span><br><span class="line">threads = [</span><br><span class="line">    Worker(download, download_queue, resize_queue),</span><br><span class="line">    Worker(resize, resize_queue, upload_queue),</span><br><span class="line">    Worker(upload, upload_queue, done_queue),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    download_queue.put(object())</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> len(done_queue.items) &lt; <span class="number">100</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">processed = len(done_queue.items)</span><br><span class="line">polled = sum(t.polled_count <span class="keyword">for</span> t <span class="keyword">in</span> threads)</span><br><span class="line">print(<span class="string">f'Processed <span class="subst">&#123;processed&#125;</span> items after '</span></span><br><span class="line">      <span class="string">f'polling <span class="subst">&#123;polled&#125;</span> times'</span>)</span><br><span class="line"><span class="comment"># Processed 100 items after polling 308 times</span></span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°å®ç°è™½ç„¶èƒ½å¤Ÿå¤„ç†å®Œæˆè¾“å…¥çš„æ‰€æœ‰ä»»åŠ¡ï¼Œä½†ä»å­˜åœ¨å¾ˆå¤šé—®é¢˜ã€‚<br>é¦–å…ˆæ˜¯ <code>polled_count</code> å€¼è¿œå¤§äºä»»åŠ¡çš„æ•°é‡ã€‚å³å·¥ä½œçº¿ç¨‹çš„ <code>run</code> æ–¹æ³•ä¸­å®šä¹‰çš„ä»é˜Ÿåˆ—ä¸­å–é¡¹ç›®çš„åŠ¨ä½œæ‰§è¡Œäº†å¤ªå¤šæ¬¡ã€‚<br>å„ä¸ªå·¥ä½œå‡½æ•°çš„æ‰§è¡Œé€Ÿåº¦å…¶å®æ˜¯ä¸ä¸€è‡´çš„ï¼Œå‰ç½®ä½çš„å·¥ä½œå‡½æ•°ï¼ˆæ¯”å¦‚ <code>download</code>ï¼‰è¿è¡Œç¼“æ…¢ï¼Œä¼šå¯¼è‡´åä¸€é“å·¥åºï¼ˆæ¯”å¦‚ <code>resize</code>ï¼‰ä¸Šçš„å‡½æ•°æŒç»­ä¸æ–­çš„å‘å…¶é˜Ÿåˆ—è¯·æ±‚æ–°çš„ä»»åŠ¡ï¼Œç„¶è€Œé˜Ÿåˆ—ä¸ºç©ºå¯¼è‡´ä¸æ–­åœ°è§¦å‘ <code>IndexError</code> é”™è¯¯ï¼Œæœ€ç»ˆå¯¼è‡´ CPU æ—¶é—´çš„æµªè´¹ã€‚</p><p>å…¶æ¬¡ï¼Œç¡®è®¤æ‰€æœ‰ä»»åŠ¡æ˜¯å¦å…¨éƒ¨å®Œæˆï¼Œéœ€è¦ä¸€ä¸ª <code>while</code> å¾ªç¯ä¸æ–­åœ°æ£€æŸ¥ <code>done_queue</code> é˜Ÿåˆ—ä¸­å…ƒç´ çš„æ•°é‡ã€‚</p><p>å†æ¬¡ï¼Œå·¥ä½œçº¿ç¨‹ä¸­çš„ <code>run</code> æ–¹æ³•ä¼šä¸€ç›´å¤„äº <code>while True</code> çš„å¾ªç¯å½“ä¸­ï¼Œæ²¡æœ‰ä¸€ç§æ˜æ˜¾çš„æ–¹æ³•å¯ä»¥å‘è¯¥å·¥ä½œçº¿ç¨‹å‘é€ä»»åŠ¡å®Œæˆå¯ä»¥é€€å‡ºçš„æ¶ˆæ¯ã€‚</p><p>æœ€åï¼Œå½“ç¬¬ä¸€é“å·¥åºæ‰§è¡Œå¾ˆå¿«è€Œç¬¬äºŒé“å·¥åºæ‰§è¡Œå¾ˆæ…¢æ—¶ï¼Œå¤„äºä¸¤é“å·¥åºä¹‹é—´çš„é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡ä¼šæŒç»­å¢é•¿ã€‚å¦‚æœæœ‰è¶³å¤Ÿå¤šçš„ä»»åŠ¡å’Œè¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œç¨‹åºæœ€ç»ˆä¼šè€—å°½å†…å­˜å¹¶å´©æºƒã€‚</p><h5 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h5><p>å†…ç½®çš„ <code>queue</code> æ¨¡å—ä¸­çš„ <code>Queue</code> ç±»å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p><p><code>Queue</code> ç±»ä¸­çš„ <code>get</code> æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œå³åœ¨æœ‰æ–°çš„é¡¹ç›®æ”¾ç½®åˆ°é˜Ÿåˆ—ä¸­ä»¥å‰ï¼Œ<code>get</code> ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è·å–åˆ°æŸä¸ªé¡¹ç›®ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">my_queue = Queue()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Consumer waiting'</span>)</span><br><span class="line">    my_queue.get()</span><br><span class="line">    print(<span class="string">'Consumer done'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread = Thread(target=consumer)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(<span class="string">'Producer putting'</span>)</span><br><span class="line">my_queue.put(object())</span><br><span class="line">print(<span class="string">'Producer done'</span>)</span><br><span class="line">thread.join()</span><br><span class="line"><span class="comment"># Consumer waiting</span></span><br><span class="line"><span class="comment"># Producer putting</span></span><br><span class="line"><span class="comment"># Producer done</span></span><br><span class="line"><span class="comment"># Consumer done</span></span><br></pre></td></tr></table></figure></p><p>å³ä¾¿çº¿ç¨‹å…ˆäºä¸»ç¨‹åºè¿è¡Œï¼Œå®ƒä¹Ÿä¼šå…ˆå¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°ä¸€ä¸ªæ–°çš„é¡¹ç›®è¢«æ”¾ç½®åˆ°é˜Ÿåˆ—ä¸­ï¼Œèƒ½å¤Ÿè¢« <code>get</code> è·å–åˆ°ã€‚<br>è¿™å¯ä»¥è§£å†³å‰é¢çš„ç¨‹åºä¸­ <code>polled_count</code> å€¼è¿‡å¤§çš„é—®é¢˜ã€‚</p><p><code>Queue</code> ç±»å¯ä»¥æŒ‡å®š buffer sizeï¼Œä»è€Œé™åˆ¶äº†ä¸¤é“å·¥åºé—´ pending çš„ä»»åŠ¡çš„æœ€å¤§æ•°é‡ã€‚å³é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡è¾¾åˆ°æœ€å¤§å€¼åï¼Œå‘é˜Ÿåˆ—ä¸­æ”¾å…¥æ–°å…ƒç´ çš„ <code>put</code> æ–¹æ³•ä¼šé˜»å¡ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­æŸä¸ªå…ƒç´ è¢«æ¶ˆè€—ä»è€Œä¸ºæ–°å…ƒç´ è…¾å‡ºç©ºé—´ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line">my_queue = Queue(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    my_queue.get()</span><br><span class="line">    print(<span class="string">'Consumer got 1'</span>)</span><br><span class="line">    my_queue.get()</span><br><span class="line">    print(<span class="string">'Consumer got 2'</span>)</span><br><span class="line">    print(<span class="string">'Consumer done'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread = Thread(target=consumer)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line">my_queue.put(object())</span><br><span class="line">print(<span class="string">'Producer put 1'</span>)</span><br><span class="line">my_queue.put(object())</span><br><span class="line">print(<span class="string">'Producer put 2'</span>)</span><br><span class="line">print(<span class="string">'Producer done'</span>)</span><br><span class="line">thread.join()</span><br><span class="line"><span class="comment"># Producer put 1</span></span><br><span class="line"><span class="comment"># Consumer got 1</span></span><br><span class="line"><span class="comment"># Producer put 2</span></span><br><span class="line"><span class="comment"># Producer done</span></span><br><span class="line"><span class="comment"># Consumer got 2</span></span><br><span class="line"><span class="comment"># Consumer done</span></span><br></pre></td></tr></table></figure></p><p>Consumer çº¿ç¨‹ä¸­çš„ <code>sleep</code> åº”è¯¥ä½¿å¾—ä¸»ç¨‹åºæœ‰è¶³å¤Ÿçš„æ—¶é—´å°†ä¸¤ä¸ªå¯¹è±¡éƒ½æ”¾ç½®åˆ°é˜Ÿåˆ—ä¸­ã€‚ä½†é˜Ÿåˆ—çš„å¤§å°æ˜¯ 1ï¼Œå°±å¯¼è‡´é˜Ÿåˆ—ä¸­å…ˆæ”¾å…¥çš„å…ƒç´ å¿…é¡»é€šè¿‡ <code>get</code> æ–¹æ³•å–å‡ºä¹‹åï¼Œæ‰èƒ½ç»§ç»­ä½¿ç”¨ <code>put</code> æ–¹æ³•æ”¾ç½®æ–°çš„å…ƒç´ è¿›å»ã€‚<br>å³ Producer ä¼šç­‰å¾… Consumer çº¿ç¨‹æŠŠæ”¾ç½®åˆ°é˜Ÿåˆ—ä¸­çš„æ—§å…ƒç´ æ¶ˆè€—æ‰ï¼Œæ‰èƒ½ç»§ç»­å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ–°çš„å…ƒç´ ã€‚</p><h5 id="task-done"><a href="#task-done" class="headerlink" title="task_done"></a>task_done</h5><p><code>Queue</code> ç±»å¯ä»¥ä½¿ç”¨å…¶ <code>task_done</code> æ–¹æ³•æ¥è¿½è¸ªä»»åŠ¡çš„è¿›åº¦ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥ç¡®ä¿åœ¨æŸä¸ªç‰¹å®šçš„æ—¶é—´ç‚¹ï¼Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»è¢«å¤„ç†å®Œæˆã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">in_queue = Queue()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Consumer waiting'</span>)</span><br><span class="line">    work = in_queue.get()</span><br><span class="line">    print(<span class="string">'Consumer working'</span>)</span><br><span class="line">    print(<span class="string">'Consumer done'</span>)</span><br><span class="line">    in_queue.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread = Thread(target=consumer)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Producer putting'</span>)</span><br><span class="line">in_queue.put(object())</span><br><span class="line">print(<span class="string">'Producer waiting'</span>)</span><br><span class="line">in_queue.join()</span><br><span class="line">print(<span class="string">'Producer done'</span>)</span><br><span class="line">thread.join()</span><br><span class="line"><span class="comment"># Consumer waiting</span></span><br><span class="line"><span class="comment"># Producer putting</span></span><br><span class="line"><span class="comment"># Producer waiting</span></span><br><span class="line"><span class="comment"># Consumer working</span></span><br><span class="line"><span class="comment"># Consumer done</span></span><br><span class="line"><span class="comment"># Producer done</span></span><br></pre></td></tr></table></figure></p><p>åœ¨ä»£ç ä¸­è°ƒç”¨ <code>in_queue.join()</code> åï¼Œåªæœ‰é˜Ÿåˆ— <code>in_queue</code> ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½æ‰§è¡Œäº†ä¸€é <code>task_done</code>ï¼ˆå³æœ‰å‡ ä¸ªå…ƒç´ å°±éœ€è¦å‡ æ¡ <code>task_done</code>ï¼‰ï¼Œ<code>in_queue.join()</code> ä¹‹åçš„ä»£ç æ‰ä¼šæ‰§è¡Œã€‚å¦åˆ™å°±ç»§ç»­ç­‰å¾…ï¼Œç›´åˆ° Consumer è°ƒç”¨äº†è¶³å¤Ÿæ¬¡æ•°çš„ <code>task_done</code>ã€‚</p><p>ç»“åˆå‰é¢æåˆ°çš„ç‰¹æ€§ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Queue</code> ç±»ï¼Œå®ƒèƒ½å¤Ÿå‘ŠçŸ¥å·¥ä½œçº¿ç¨‹ä»€ä¹ˆæ—¶å€™è¯¥åœæ­¢æ‰§è¡Œã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosableQueue</span><span class="params">(Queue)</span>:</span></span><br><span class="line">    SENTINEL = object()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.put(self.SENTINEL)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            item = self.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> item <span class="keyword">is</span> self.SENTINEL:</span><br><span class="line">                    <span class="keyword">return</span>  <span class="comment"># Cause the thread to exit</span></span><br><span class="line">                <span class="keyword">yield</span> item</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self.task_done()</span><br></pre></td></tr></table></figure></p><p>æ›´æ–°åçš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resize</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosableQueue</span><span class="params">(Queue)</span>:</span></span><br><span class="line">    SENTINEL = object()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.put(self.SENTINEL)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            item = self.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> item <span class="keyword">is</span> self.SENTINEL:</span><br><span class="line">                    <span class="keyword">return</span>  <span class="comment"># Cause the thread to exit</span></span><br><span class="line">                <span class="keyword">yield</span> item</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoppableWorker</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, in_queue, out_queue)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.in_queue = in_queue</span><br><span class="line">        self.out_queue = out_queue</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.in_queue:</span><br><span class="line">            result = self.func(item)</span><br><span class="line">            self.out_queue.put(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">download_queue = ClosableQueue()</span><br><span class="line">resize_queue = ClosableQueue()</span><br><span class="line">upload_queue = ClosableQueue()</span><br><span class="line">done_queue = ClosableQueue()</span><br><span class="line"></span><br><span class="line">threads = [</span><br><span class="line">    StoppableWorker(download, download_queue, resize_queue),</span><br><span class="line">    StoppableWorker(resize, resize_queue, upload_queue),</span><br><span class="line">    StoppableWorker(upload, upload_queue, done_queue),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    download_queue.put(object())</span><br><span class="line"></span><br><span class="line">download_queue.close()</span><br><span class="line">download_queue.join()</span><br><span class="line">resize_queue.close()</span><br><span class="line">resize_queue.join()</span><br><span class="line">upload_queue.close()</span><br><span class="line">upload_queue.join()</span><br><span class="line">print(done_queue.qsize(), <span class="string">'items finished'</span>)</span><br><span class="line"><span class="comment"># 1000 items finished</span></span><br></pre></td></tr></table></figure></p><p>é€»è¾‘ä¸Šå°±æ˜¯ç»™ <code>Queue</code> ç±»åŠ äº†ä¸€ä¸ª <code>SENTINEL</code> å¯¹è±¡ï¼Œç”¨æ¥ä½œä¸ºé˜Ÿåˆ—ç»“æŸçš„æ ‡å¿—ã€‚å·¥ä½œçº¿ç¨‹é€šè¿‡å¾ªç¯è¯»å–è¾“å…¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯¹è±¡ç»è¿‡ç‰¹å®šå‡½æ•°å¤„ç†åæ”¾ç½®åˆ°è¾“å‡ºé˜Ÿåˆ—ä¸­ã€‚è‹¥è¯»å–åˆ°çš„ä»»åŠ¡æ˜¯ <code>SENTINEL</code> å¯¹è±¡ï¼Œåˆ™çº¿ç¨‹ç»“æŸè¿è¡Œã€‚</p><p><code>task_done</code> æ–¹æ³•å’Œä¸»ç¨‹åºä¸­çš„ <code>xxx_queue.join</code> ç”¨äºç¡®ä¿æŸä¸ªé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»å¤„ç†å®Œæˆï¼Œè½¬ç§»åˆ°äº†ä¸‹ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚åé¢å†è°ƒç”¨ä¸‹ä¸€ä¸ªé˜Ÿåˆ—çš„ <code>close</code> æ–¹æ³•åœ¨è¯¥é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ ä¸€ä¸ª <code>SENTINEL</code> å¯¹è±¡ï¼Œä½œä¸ºé˜Ÿåˆ—çš„ç»“æŸæ ‡å¿—ã€‚</p><p>ä¸Šè¿°å®ç°çš„å¥½å¤„åœ¨äºï¼Œå·¥ä½œçº¿ç¨‹ä¼šåœ¨è¯»å–åˆ° <code>SENTINEL</code> å¯¹è±¡æ—¶è‡ªåŠ¨ç»“æŸè¿è¡Œï¼›ä¸»ç¨‹åºä¸­ <code>upload_queue.join()</code> æ‰§è¡Œç»“æŸåå°±èƒ½ä¿è¯ä¸‰ä¸ªé˜¶æ®µçš„æ‰€æœ‰ä»»åŠ¡éƒ½è¢«å¤„ç†å®Œäº†ï¼Œè€Œä¸å†éœ€è¦é¢‘ç¹åœ°å»æ£€æŸ¥ <code>done_queue</code> ä¸­çš„å…ƒç´ æ•°é‡ã€‚</p><h5 id="æœ€ç»ˆå®ç°"><a href="#æœ€ç»ˆå®ç°" class="headerlink" title="æœ€ç»ˆå®ç°"></a>æœ€ç»ˆå®ç°</h5><p>å½“éœ€è¦å¯¹ä¸åŒçš„é˜¶æ®µï¼ˆ<code>download</code>ã€<code>resize</code>ã€<code>upload</code>ï¼‰éƒ½åˆ†åˆ«ç»‘å®šå¤šä¸ªçº¿ç¨‹å»å¤„ç†æ—¶ï¼Œåªç¨å¾®ä¿®æ”¹ä¸‹ä»£ç å°±å¯ä»¥äº†ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resize</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosableQueue</span><span class="params">(Queue)</span>:</span></span><br><span class="line">    SENTINEL = object()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.put(self.SENTINEL)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            item = self.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> item <span class="keyword">is</span> self.SENTINEL:</span><br><span class="line">                    <span class="keyword">return</span>  <span class="comment"># Cause the thread to exit</span></span><br><span class="line">                <span class="keyword">yield</span> item</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoppableWorker</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, in_queue, out_queue)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.in_queue = in_queue</span><br><span class="line">        self.out_queue = out_queue</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.in_queue:</span><br><span class="line">            result = self.func(item)</span><br><span class="line">            self.out_queue.put(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_threads</span><span class="params">(count, *args)</span>:</span></span><br><span class="line">    threads = [StoppableWorker(*args) <span class="keyword">for</span> _ <span class="keyword">in</span> range(count)]</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.start()</span><br><span class="line">    <span class="keyword">return</span> threads</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_threads</span><span class="params">(closable_queue, threads)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> threads:</span><br><span class="line">        closable_queue.close()</span><br><span class="line"></span><br><span class="line">    closable_queue.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">download_queue = ClosableQueue()</span><br><span class="line">resize_queue = ClosableQueue()</span><br><span class="line">upload_queue = ClosableQueue()</span><br><span class="line">done_queue = ClosableQueue()</span><br><span class="line"></span><br><span class="line">download_threads = start_threads(</span><br><span class="line">    <span class="number">3</span>, download, download_queue, resize_queue)</span><br><span class="line">resize_threads = start_threads(</span><br><span class="line">    <span class="number">4</span>, resize, resize_queue, upload_queue)</span><br><span class="line">upload_threads = start_threads(</span><br><span class="line">    <span class="number">5</span>, upload, upload_queue, done_queue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    download_queue.put(object())</span><br><span class="line"></span><br><span class="line">stop_threads(download_queue, download_threads)</span><br><span class="line">stop_threads(resize_queue, resize_threads)</span><br><span class="line">stop_threads(upload_queue, upload_threads)</span><br><span class="line"></span><br><span class="line">print(done_queue.qsize(), <span class="string">'items finished'</span>)</span><br><span class="line"><span class="comment"># 1000 items finished</span></span><br></pre></td></tr></table></figure></p><h4 id="è¦ç‚¹"><a href="#è¦ç‚¹" class="headerlink" title="è¦ç‚¹"></a>è¦ç‚¹</h4><ul><li>Pipeline å¯ä»¥å¾ˆå¥½åœ°ç»„ç»‡æµæ°´çº¿ç±»å‹çš„å·¥ä½œï¼Œå°¤å…¶æ˜¯ IO ç›¸å…³çš„ Python å¤šçº¿ç¨‹ç¨‹åº</li><li>éœ€è¦ç‰¹åˆ«æ³¨æ„æ„å»º pipeline æ—¶çš„éšè—é—®é¢˜ï¼šæ€æ ·å‘Šè¯‰å·¥ä½œçº¿ç¨‹ç»ˆæ­¢è¿è¡Œã€busy waiting ä»¥åŠæ½œåœ¨çš„å†…å­˜çˆ†ç‚¸ç­‰</li><li><code>Queue</code> ç±»å…·å¤‡æ„å»ºå¥å£®çš„ pipeline æ‰€éœ€çš„ç‰¹æ€§ï¼Œå¦‚é˜»å¡å¼æ“ä½œã€buffer size å’Œ joining ç­‰ã€‚</li></ul><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://effectivepython.com/" target="_blank" rel="noopener">Effective PYTHON Second Edition</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å€ŸåŠ©-Queue-å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ&quot;&gt;&lt;a href=&quot;#å€ŸåŠ©-Queue-å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ&quot; class=&quot;headerlink&quot; title=&quot;å€ŸåŠ© Queue å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ&quot;&gt;&lt;/a&gt;å€ŸåŠ© Queue å®ç°å¤šçº¿ç¨‹é—´çš„ååŒ&lt;/h4&gt;&lt;h5 id=&quot;P
      
    
    </summary>
    
      <category term="Python" scheme="https://rollingstarky.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://rollingstarky.github.io/tags/Python/"/>
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Concurrency" scheme="https://rollingstarky.github.io/tags/Concurrency/"/>
    
      <category term="Queue" scheme="https://rollingstarky.github.io/tags/Queue/"/>
    
      <category term="Pipeline" scheme="https://rollingstarky.github.io/tags/Pipeline/"/>
    
      <category term="Producer" scheme="https://rollingstarky.github.io/tags/Producer/"/>
    
      <category term="Consumer" scheme="https://rollingstarky.github.io/tags/Consumer/"/>
    
  </entry>
  
  <entry>
    <title>Vim æŠ€å·§ â€”â€” å®ç°å¤šè¡Œæ³¨é‡Šçš„å‡ ç§æ–¹æ³•</title>
    <link href="https://rollingstarky.github.io/2021/10/08/vim-tricks-some-ways-to-comment-multiple-lines/"/>
    <id>https://rollingstarky.github.io/2021/10/08/vim-tricks-some-ways-to-comment-multiple-lines/</id>
    <published>2021-10-07T16:00:00.000Z</published>
    <updated>2021-10-08T15:12:59.653Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹ æƒ¯é—®é¢˜ï¼Œä¸€ç›´åœ¨ç”¨ Vimã€‚ä¹‹å‰è£…çš„å‡ ä¸ªæ’ä»¶ï¼ŒåŸºæœ¬ä¸Šè¦†ç›–äº†æ—¥å¸¸ä½¿ç”¨ä¸­çš„ç»å¤§éƒ¨åˆ†åœºæ™¯ã€‚åªæ˜¯é‡åˆ°éœ€è¦å¤šè¡Œæ³¨é‡Šçš„æ—¶å€™ï¼Œä¸€ç›´æ²¡æœ‰ä¸€å¥—æ¯”è¾ƒç›´æ¥çš„æ–¹æ³•ã€‚<br>äºæ˜¯ä¸Šç½‘æŸ¥äº†äº›èµ„æ–™ï¼Œä¹Ÿå®é™…æµ‹è¯•äº†ä¸‹æ•ˆæœã€‚æ•´ç†å‡ºä¸€éƒ¨åˆ†æ–¹æ³•ï¼ˆä¸å€ŸåŠ©æ’ä»¶ï¼‰ï¼Œä»¥ä½œå¤‡å¿˜ã€‚</p><h4 id="å­—ç¬¦ä¸²æ›¿æ¢"><a href="#å­—ç¬¦ä¸²æ›¿æ¢" class="headerlink" title="å­—ç¬¦ä¸²æ›¿æ¢"></a>å­—ç¬¦ä¸²æ›¿æ¢</h4><p>å‘½ä»¤æ¨¡å¼ä¸‹å¯ä»¥ä½¿ç”¨ <code>:s/old/new</code> æ›¿æ¢å½“å‰æ–‡æœ¬è¡Œä¸­çš„æŒ‡å®šå­—ç¬¦ä¸²ã€‚å‰é¢è¿˜å¯ä»¥åŠ ä¸Šæ•°å­—ç­‰ç”¨æ¥æŒ‡å®šèŒƒå›´ã€‚å¦‚ï¼š</p><ul><li><code>:n1,n2 s/old/new</code>ï¼šä» <code>n1</code> è¡Œå¼€å§‹ï¼Œåˆ° <code>n2</code> è¡Œç»“æŸï¼Œå°†æ¯ä¸€è¡Œä¸­ç¬¦åˆ <code>old</code> æ¨¡å¼çš„å†…å®¹æ›¿æ¢ä¸º <code>new</code></li><li><code>:% s/old/new</code>ï¼šå°†æ•´ä¸ªæ–‡ä»¶ä¸­çš„ <code>old</code> æ›¿æ¢ä¸º <code>new</code></li></ul><p>ç±»ä¼¼äº Vim ä¸­å†…ç½®äº†ä¸€ä¸ª <code>sed</code> å·¥å…·ã€‚</p><p>å¯¹äº Python ä»£ç ï¼Œæ³¨é‡Šä»£ç å—å½“ç„¶å¯ä»¥ç”¨åŒ <code>&#39;&#39;&#39;</code>ï¼Œä¸´æ—¶çš„æ³¨é‡Šæˆ‘ä¸ªäººæ¯”è¾ƒåå‘è¡Œé¦–åŠ  <code>#</code>ã€‚å€ŸåŠ©å­—ç¬¦ä¸²æ›¿æ¢å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š<br><code>:n1,n2 s/^/#</code><br>å°† <code>n1</code> åˆ° <code>n2</code> è¡Œä¸­çš„è¡Œé¦–ç©ºç™½å­—ç¬¦æ›¿æ¢ä¸º <code>#</code>ï¼Œç­‰åŒäºåœ¨æ¯ä¸€è¡Œè¡Œé¦–æ’å…¥ <code>#</code></p><p>å¯¹äºå¦‚ä¸‹ Python ä»£ç ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> calendar</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">current_time = datetime.now()</span><br><span class="line">total_days = calendar.monthrange(current_time.year, current_time.month)</span><br><span class="line">total_days = total_days[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(total_days):</span><br><span class="line">    os.mkdir(str(i + <span class="number">1</span>))</span><br></pre></td></tr></table></figure></p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-30ef29b5184224b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="before replace"></p><p>åœ¨ Vim ä¸­è¿è¡Œ <code>:1,3 s/^/#</code>ï¼Œåï¼Œæ•ˆæœå¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from datetime import datetime</span></span><br><span class="line"><span class="comment"># import calendar</span></span><br><span class="line"><span class="comment"># import os</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">current_time = datetime.now()</span><br><span class="line">total_days = calendar.monthrange(current_time.year, current_time.month)</span><br><span class="line">total_days = total_days[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(total_days):</span><br><span class="line">    os.mkdir(str(i + <span class="number">1</span>))</span><br></pre></td></tr></table></figure></p><p>å¦‚æœè¦å–æ¶ˆæ³¨é‡Šï¼Œå†è¿è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ï¼š<br><code>:1,3 s/# /</code><br>å°† 1 - 3 è¡Œè¡Œé¦–çš„ <code>#</code> æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆå³ç§»é™¤è¡Œé¦–çš„ <code>#</code>)</p><h5 id="visual-æ¨¡å¼ä¸‹æŒ‡å®šæ–‡æœ¬èŒƒå›´"><a href="#visual-æ¨¡å¼ä¸‹æŒ‡å®šæ–‡æœ¬èŒƒå›´" class="headerlink" title="visual æ¨¡å¼ä¸‹æŒ‡å®šæ–‡æœ¬èŒƒå›´"></a>visual æ¨¡å¼ä¸‹æŒ‡å®šæ–‡æœ¬èŒƒå›´</h5><p>å¦‚æœä¸å–œæ¬¢ç”¨æ•°å­—è¡Œå·æŒ‡å®šæ–½è¡Œæ›¿æ¢çš„æ–‡æœ¬è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ Visual æ¨¡å¼ä¸‹æ‰‹åŠ¨é€‰æ‹©ç”Ÿæ•ˆçš„æ–‡æœ¬èŒƒå›´ã€‚</p><p>Normal æ¨¡å¼ä¸‹æŒ‰é”®ç›˜ä¸Šçš„ <code>v</code> é”®è¿›å…¥ visual æ¨¡å¼ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡å…‰æ ‡ç§»åŠ¨å‘½ä»¤ï¼ˆå¦‚ <code>h</code>ã€<code>j</code>ã€<code>k</code>ã€<code>l</code>ã€<code>{</code>ã€<code>}</code> ç­‰ï¼‰é€‰ä¸­å¤šè¡Œæ–‡æœ¬ã€‚</p><p>æ¥ç€åœ¨å‘½ä»¤æ¨¡å¼ä¸‹è¿è¡Œ <code>:&#39;&lt;,&#39;&gt; s/^/#</code> å³å¯åœ¨é€‰ä¸­çš„æ–‡æœ¬ä¸Šæ‰§è¡Œæ–‡æœ¬æ›¿æ¢ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/6875152-161da4aa97379bda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="select &amp; replace"></p><p>å…¶ä¸­ <code>&#39;&lt;,&#39;&gt;</code> å³ä»£è¡¨ visual æ¨¡å¼ä¸‹é€‰ä¸­çš„æ–‡æœ¬è¡Œã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé€‰ä¸­æ–‡æœ¬ä»¥åå†æŒ‰ <code>:</code> è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼Œ<code>&#39;&lt;,&#39;&gt;</code> éƒ¨åˆ†å†…å®¹ä¼šè‡ªåŠ¨è¡¥å…¨ã€‚</p><h4 id="å¤šè¡Œç¼–è¾‘"><a href="#å¤šè¡Œç¼–è¾‘" class="headerlink" title="å¤šè¡Œç¼–è¾‘"></a>å¤šè¡Œç¼–è¾‘</h4><p>å¤šè¡Œç¼–è¾‘æŒ‡åŒæ—¶åœ¨å¤šè¡Œæ–‡æœ¬ä¸­æ¯ä¸€è¡Œçš„ç›¸åŒä½ç½®æ’å…¥ç›¸åŒçš„å†…å®¹ã€‚åªéœ€è¦ç¼–è¾‘æŸä¸€è¡Œæ–‡æœ¬ï¼Œå…¶ä»–æ–‡æœ¬è¡Œå°±ä¼šè‡ªåŠ¨è¿›è¡ŒåŒæ ·çš„ä¿®æ”¹ã€‚</p><p>æ¯”å¦‚éœ€è¦æ³¨é‡Š Python ä»£ç çš„å‰ 3 è¡Œï¼Œå°±å¯ä»¥åŒæ—¶ç¼–è¾‘è¿™ 3 è¡Œæ–‡æœ¬ï¼Œåœ¨ç¬¬ä¸€è¡Œè¡Œé¦–æ’å…¥ <code>#</code>ï¼Œåˆ™å‰ 3 è¡Œä¼šåŒæ—¶è¢«æ³¨é‡Šæ‰ã€‚</p><p>é¦–å…ˆå…‰æ ‡å®šä½åˆ°ç¬¬ä¸€è¡Œè¡Œé¦–ï¼ŒæŒ‰ä¸‹é”®ç›˜ä¸Šçš„ <code>ctrl + v</code> ç»„åˆé”®ï¼ˆWindows ä¸‹å¯ä»¥ç”¨ <code>ctrl + q</code>ï¼‰è¿›å…¥ Visual Block æ¨¡å¼ï¼ŒæŒ‰ä¸¤æ¬¡ <code>j</code> é”®ä¸‹ç§»å…‰æ ‡ï¼Œé€‰ä¸­å‰ä¸‰è¡Œçš„é¦–å­—ç¬¦ã€‚<br>å†æŒ‰ä¸‹é”®ç›˜ä¸Š <code>I</code>ï¼ˆå¤§å†™ï¼‰é”®è¿›å…¥æ’å…¥æ¨¡å¼ï¼Œåœ¨ç¬¬ä¸€è¡Œè¡Œé¦–æ’å…¥ <code>#</code> å­—ç¬¦ã€‚<br>æŒ‰ä¸‹ <code>Esc</code> é€€å‡ºæ’å…¥æ¨¡å¼ï¼Œåˆ™åä¸¤è¡Œè¡Œé¦–ä¹Ÿä¼šè‡ªåŠ¨æ’å…¥ <code>#</code> å­—ç¬¦ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-b302ab3a0626969b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="VISUAL BLOCK"></p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-e830dec31ab8eef1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="before Esc"></p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-0e7546479fe2f06f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="after Esc"></p><h4 id="å½•åˆ¶-Macro"><a href="#å½•åˆ¶-Macro" class="headerlink" title="å½•åˆ¶ Macro"></a>å½•åˆ¶ Macro</h4><p>Vim ä¸­çš„<strong>å®</strong>ï¼ˆMacroï¼‰å³ä¸€ç³»åˆ—ç¼–è¾‘æ“ä½œçš„åˆé›†ã€‚<br>åœ¨ Vim ä¸­ï¼Œå¯ä»¥æŠŠéœ€è¦é‡å¤æ‰§è¡Œçš„å¤šæ­¥ç¼–è¾‘æ“ä½œå½•åˆ¶ä¸‹æ¥ï¼Œç»‘å®šåˆ°æŸä¸ªæŒ‰é”®ä¸Šã€‚ä¹‹åå°±å¯ä»¥æŒ‰ä¸‹ <code>@ç»‘å®šçš„æŒ‰é”®</code> é‡å¤æ‰§è¡Œå½•åˆ¶å¥½çš„æ­¥éª¤ã€‚<br>æœ‰ç‚¹åƒå®šä¹‰å’Œè°ƒç”¨å‡½æ•°ã€‚</p><p>ä½¿ç”¨ <code>qæŸæŒ‰é”®</code> å¼€å§‹å½•åˆ¶å®ï¼Œæ‰§è¡ŒæŸäº›ç¼–è¾‘æ“ä½œåï¼Œå†æŒ‰ä¸‹ <code>q</code> ç»“æŸå½•åˆ¶ã€‚éšåæŒ‰ä¸‹ <code>@æŸæŒ‰é”®</code> è°ƒç”¨å½•åˆ¶å¥½çš„å®ã€‚</p><p>å¦‚éœ€è¦æ³¨é‡Šå‰ 3 è¡Œ Python ä»£ç ï¼Œåˆ™å¯ä»¥å½•åˆ¶åŒ…å«å¦‚ä¸‹æ­¥éª¤çš„å®ï¼š</p><ul><li>åœ¨å½“å‰è¡Œçš„è¡Œé¦–å¼€å§‹æ’å…¥æ–‡æœ¬ï¼ˆ<code>I</code>ï¼‰</li><li>è¾“å…¥æ³¨é‡Šç¬¦å·ï¼ˆ<code>#</code>ï¼‰</li><li>é€€å‡ºæ’å…¥æ¨¡å¼ï¼ˆ<code>Esc</code>ï¼‰</li><li>ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼ˆ<code>j</code>)</li></ul><p>ä¸Šè¿°å®ä¸­çš„æ“ä½œæ­¥éª¤å¯ä»¥é¦–å°¾ç›¸æ¥ï¼Œæ— é™å¾ªç¯ã€‚å³æ³¨é‡Šå½“å‰è¡Œï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼›æ³¨é‡Šå½“å‰è¡Œï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œã€‚ã€‚ã€‚</p><p>å…·ä½“çš„æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ Normal æ¨¡å¼ä¸‹ï¼Œå…‰æ ‡ç§»åŠ¨åˆ°é¦–è¡Œï¼ŒæŒ‰ä¸‹ <code>qq</code> å¼€å§‹å½•åˆ¶å®ï¼ˆå½•åˆ¶ç»“æŸåä¼šç»‘å®šç»™ <code>q</code>ï¼‰</li><li>æŒ‰ä¸‹ <code>I</code> é”®ï¼ˆå¤§å†™ï¼‰ï¼Œè¿›å…¥è¡Œé¦–æ’å…¥æ¨¡å¼</li><li>è¾“å…¥ <code>#</code></li><li>æŒ‰ä¸‹ <code>Esc</code> é€€å‡ºæ’å…¥æ¨¡å¼</li><li>æŒ‰ä¸‹ <code>j</code> ç§»åŠ¨å…‰æ ‡åˆ°ä¸‹ä¸€è¡Œæ–‡æœ¬</li><li>æŒ‰ä¸‹ <code>q</code> ç»“æŸå®çš„å½•åˆ¶</li></ul><p>å®å½•åˆ¶ç»“æŸåï¼Œå³å¯è¿æŒ‰ä¸¤æ¬¡ <code>@q</code> è¿ç»­è°ƒç”¨ä¸¤æ¬¡å®ï¼Œåˆ†åˆ«æ³¨é‡Šç¬¬äºŒè¡Œå’Œç¬¬ä¸‰è¡Œå†…å®¹ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/6875152-397bc3a22c028f5f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="recording macro"></p><h5 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title=". å‘½ä»¤"></a><code>.</code> å‘½ä»¤</h5><p><code>.</code> å‘½ä»¤ç›¸å½“äºä¸€ç§ç®€åŒ–äº†çš„å®ã€‚å®ƒè¡¨ç¤ºé‡å¤åº”ç”¨ä¸Šä¸€æ­¥ä¸­å¯¹å†…å®¹çš„æ›´æ”¹ã€‚<br><code>.</code> å‘½ä»¤æ— éœ€å½•åˆ¶ï¼Œä½†åªä¼šé‡å¤å¯¹å†…å®¹çš„ç¼–è¾‘ï¼ˆå¦‚æ’å…¥ã€æ›¿æ¢ç­‰ï¼‰ï¼Œä¸ä¼šé‡å¤å…¶ä»–æ“ä½œã€‚<br>æ¯”å¦‚å‰é¢çš„éœ€è¦æ³¨é‡Š Python ä»£ç çš„å‰ä¸‰è¡Œï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ul><li>å…‰æ ‡å®šä½åˆ°é¦–è¡Œï¼ŒæŒ‰ <code>I</code>ï¼ˆå¤§å†™ï¼‰åœ¨è¡Œé¦–æ’å…¥å†…å®¹</li><li>è¾“å…¥æ³¨é‡Šç¬¦å· <code>#</code></li><li>æŒ‰ä¸‹ <code>Esc</code> é€€å‡ºæ’å…¥æ¨¡å¼</li><li>æŒ‰ä¸‹ <code>j</code> è·³è½¬åˆ°ä¸‹ä¸€è¡Œï¼ŒæŒ‰ <code>.</code> é‡å¤æ‰§è¡Œå¯¹ä¸Šä¸€è¡Œçš„ç¼–è¾‘æ“ä½œï¼ˆè¡Œé¦–æ’å…¥ <code>#</code>ï¼‰</li><li>é‡å¤ä¸Šä¸€æ­¥æ“ä½œï¼ˆ<code>j.</code>ï¼‰ï¼Œæ³¨é‡Šç¬¬ä¸‰è¡Œ</li></ul><h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><p>åœ¨æŸ¥é˜…èµ„æ–™çš„æ—¶å€™ï¼Œè¿˜å‘ç°ä¸€ä¸ª <code>norm</code> å‘½ä»¤ã€‚<br>æ¯”å¦‚è¿˜æ˜¯éœ€è¦æ³¨é‡Šå‰ 3 è¡Œï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<br><code>:1,3 norm I #</code></p><p>å…¶ä¸­ <code>1,3</code> è¡¨ç¤ºåªå¯¹ 1 - 3 è¡Œåº”ç”¨åé¢çš„å‘½ä»¤ï¼›<br><code>norm</code> è¡¨ç¤ºä» Normal æ¨¡å¼ä¸‹å¼€å§‹ï¼›<br><code>I #</code> è¡¨ç¤ºè¿›å…¥æ’å…¥æ¨¡å¼ï¼ˆåŒæ—¶å…‰æ ‡ç§»åŠ¨åˆ°è¡Œé¦–ï¼‰ï¼Œæ’å…¥æ–‡æœ¬ <code>#</code>ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://stackoverflow.com/questions/9549729/vim-insert-the-same-characters-across-multiple-lines" target="_blank" rel="noopener">Vim: insert the same characters across multiple lines</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¹ æƒ¯é—®é¢˜ï¼Œä¸€ç›´åœ¨ç”¨ Vimã€‚ä¹‹å‰è£…çš„å‡ ä¸ªæ’ä»¶ï¼ŒåŸºæœ¬ä¸Šè¦†ç›–äº†æ—¥å¸¸ä½¿ç”¨ä¸­çš„ç»å¤§éƒ¨åˆ†åœºæ™¯ã€‚åªæ˜¯é‡åˆ°éœ€è¦å¤šè¡Œæ³¨é‡Šçš„æ—¶å€™ï¼Œä¸€ç›´æ²¡æœ‰ä¸€å¥—æ¯”è¾ƒç›´æ¥çš„æ–¹æ³•ã€‚&lt;br&gt;äºæ˜¯ä¸Šç½‘æŸ¥äº†äº›èµ„æ–™ï¼Œä¹Ÿå®é™…æµ‹è¯•äº†ä¸‹æ•ˆæœã€‚æ•´ç†å‡ºä¸€éƒ¨åˆ†æ–¹æ³•ï¼ˆä¸å€ŸåŠ©æ’ä»¶ï¼‰ï¼Œä»¥ä½œå¤‡å¿˜ã€‚&lt;/p&gt;
&lt;h4 id=&quot;å­—ç¬¦ä¸²æ›¿æ¢&quot;&gt;&lt;a
      
    
    </summary>
    
      <category term="Linux" scheme="https://rollingstarky.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://rollingstarky.github.io/tags/Linux/"/>
    
      <category term="Tools" scheme="https://rollingstarky.github.io/tags/Tools/"/>
    
      <category term="Tricks" scheme="https://rollingstarky.github.io/tags/Tricks/"/>
    
      <category term="Vim" scheme="https://rollingstarky.github.io/tags/Vim/"/>
    
      <category term="Editor" scheme="https://rollingstarky.github.io/tags/Editor/"/>
    
      <category term="Efficiency" scheme="https://rollingstarky.github.io/tags/Efficiency/"/>
    
      <category term="Macro" scheme="https://rollingstarky.github.io/tags/Macro/"/>
    
  </entry>
  
  <entry>
    <title>Effective Python ç¬”è®° â€”â€” å¹¶å‘ä¸å¹¶è¡Œï¼ˆsubprocessã€Threadã€Lockï¼‰</title>
    <link href="https://rollingstarky.github.io/2021/09/23/effective-python-notes-concurrency-subprocess-thread-and-lock/"/>
    <id>https://rollingstarky.github.io/2021/09/23/effective-python-notes-concurrency-subprocess-thread-and-lock/</id>
    <published>2021-09-22T16:00:00.000Z</published>
    <updated>2021-09-23T14:32:01.125Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä½¿ç”¨-subprocess-ç®¡ç†å­è¿›ç¨‹"><a href="#ä½¿ç”¨-subprocess-ç®¡ç†å­è¿›ç¨‹" class="headerlink" title="ä½¿ç”¨ subprocess ç®¡ç†å­è¿›ç¨‹"></a>ä½¿ç”¨ <code>subprocess</code> ç®¡ç†å­è¿›ç¨‹</h4><p>ç”± Python å¯åŠ¨çš„å­è¿›ç¨‹èƒ½å¤Ÿä»¥<strong>å¹¶è¡Œ</strong>çš„æ–¹å¼è¿è¡Œï¼Œä»è€Œæœ€å¤§åŒ–åœ°åˆ©ç”¨ CPU çš„å¤šä¸ªæ ¸å¿ƒã€‚</p><p>å¯ä»¥å€ŸåŠ© <code>subprocess</code> å†…ç½®æ¨¡å—è°ƒç”¨å­è¿›ç¨‹ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">result = subprocess.run(</span><br><span class="line">    [<span class="string">'echo'</span>, <span class="string">'Hello from the child!'</span>],</span><br><span class="line">    capture_output=<span class="keyword">True</span>,</span><br><span class="line">    encoding=<span class="string">'utf-8'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">result.check_returncode()</span><br><span class="line">print(result.stdout)</span><br><span class="line"><span class="comment"># =&gt; Hello from the child!</span></span><br></pre></td></tr></table></figure></p><p>å­è¿›ç¨‹ç›¸å¯¹äºå…¶çˆ¶è¿›ç¨‹æ˜¯ç‹¬ç«‹åœ°è¿è¡Œçš„ã€‚<br>å¦‚æœä½¿ç”¨ <code>Popen</code> ç±»åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹å¤„ç†æŸä¸ªä»»åŠ¡ï¼Œåˆ™ä¸»ç¨‹åºèƒ½å¤Ÿåœ¨å¤„ç†å…¶ä»–ä»»åŠ¡çš„åŒæ—¶ï¼Œé€šè¿‡è½®è¯¢çš„æ–¹å¼å®šæœŸæŸ¥çœ‹å­è¿›ç¨‹çš„çŠ¶æ€ï¼Œç¡®è®¤å…¶æ˜¯å¦å·²ç»ç»ˆæ­¢è¿è¡Œã€‚<br><code>Popen</code> ä¸­çš„ <code>poll</code> æ–¹æ³•å¯ä»¥å®æ—¶åœ°æ£€æŸ¥å­è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚è‹¥å­è¿›ç¨‹è¿˜åœ¨è¿è¡Œä¸­ï¼Œåˆ™è¿”å› <code>None</code>ï¼›è‹¥å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™è¿”å›ä¸€ä¸ª <em>returncode</em> å€¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">proc = subprocess.Popen([<span class="string">'sleep'</span>, <span class="string">'1'</span>])</span><br><span class="line"><span class="keyword">while</span> proc.poll() <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">    print(<span class="string">'Working...'</span>)</span><br><span class="line">print(<span class="string">'Exit status'</span>, proc.poll())</span><br><span class="line"><span class="comment"># Working...</span></span><br><span class="line"><span class="comment"># Working...</span></span><br><span class="line"><span class="comment"># Working...</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># Exit status 0</span></span><br></pre></td></tr></table></figure><p>è§£è€¦å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹ä½¿å¾—çˆ¶è¿›ç¨‹å¯ä»¥åŒæ—¶è°ƒç”¨å¤šä¸ªå¹¶è¡Œæ‰§è¡Œçš„å­ç¨‹åºã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">start = time.time()</span><br><span class="line">sleep_procs = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    proc = subprocess.Popen([<span class="string">'sleep'</span>, <span class="string">'1'</span>])</span><br><span class="line">    sleep_procs.append(proc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> sleep_procs:</span><br><span class="line">    proc.communicate()</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">print(<span class="string">f'Finished in <span class="subst">&#123;(end - start):<span class="number">.3</span>&#125;</span> seconds'</span>)</span><br><span class="line"><span class="comment"># =&gt; Finished in 1.01 seconds</span></span><br></pre></td></tr></table></figure></p><p>ä»£ç ä¸­çš„ <code>communicate</code> æ–¹æ³•å¯ä»¥ç”¨æ¥ä¸å­è¿›ç¨‹é€šä¿¡å¹¶ç­‰å¾…å…¶ç»ˆæ­¢ï¼Œæ­¤å¤„ç”¨äºç­‰å¾…æ‰€æœ‰çš„å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚<br>å¦‚æœä¸Šè¿°ä»£ç ä¸­çš„å­è¿›ç¨‹ä»¥é¡ºåºçš„æ–¹å¼æ‰§è¡Œï¼Œæœ€ç»ˆæ•´ä½“çš„å»¶è¿Ÿä¼šè¾¾åˆ° 10s ä»¥ä¸Šã€‚è€Œå®é™…çš„å»¶è¿Ÿåªç•¥å¤§äº 1sï¼Œå³å¤šä¸ªå­è¿›ç¨‹ä¹‹é—´æ˜¯å¹¶è¡Œçš„å…³ç³»ã€‚</p><p>å¯ä»¥é€šè¿‡<strong>ç®¡é“</strong>ä» Python ç¨‹åºå‘è°ƒç”¨çš„å­è¿›ç¨‹ä¼ é€’æ•°æ®ï¼Œå¹¶è·å–å­è¿›ç¨‹çš„è¾“å‡ºå†…å®¹ã€‚<br>æ¯”å¦‚è°ƒç”¨å¦‚ä¸‹å½¢å¼çš„ Shell æµ‹è¯•è„šæœ¬ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> input your name</span><br><span class="line"><span class="built_in">read</span> name</span><br><span class="line"><span class="built_in">echo</span> your name is <span class="variable">$name</span></span><br></pre></td></tr></table></figure></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">proc = subprocess.Popen(<span class="string">'bash name.sh'</span>,</span><br><span class="line">                        stdin=subprocess.PIPE,</span><br><span class="line">                        stdout=subprocess.PIPE,</span><br><span class="line">                        shell=<span class="keyword">True</span>)</span><br><span class="line">proc.stdin.write(<span class="string">b'john'</span>)</span><br><span class="line">proc.stdin.flush()</span><br><span class="line"></span><br><span class="line">stdout, stderr = proc.communicate()</span><br><span class="line">print(stdout)</span><br><span class="line"><span class="comment"># b'input your name\nyour name is john\n'</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­åœ¨åˆå§‹åŒ– <code>Popen</code> å¯¹è±¡æ—¶ï¼Œä¼ å…¥äº† <code>stdin=subprocess.PIPE</code> å’Œ <code>stdout=subprocess.PIPE</code> ä¸¤ä¸ªå‚æ•°ï¼Œç›®çš„æ˜¯å°†å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ STDIN ç»‘å®šåˆ° <code>proc</code> å®ä¾‹çš„ <code>stdin</code> å±æ€§ä¸Šï¼Œå°†æ ‡å‡†è¾“å‡º STDOUT ç»‘å®šåˆ° <code>proc</code> å®ä¾‹çš„ <code>stdout</code> å±æ€§ä¸Šã€‚ä»è€Œå¯ä»¥ä½¿ç”¨ <code>proc.stdin.write()</code> æ–¹æ³•å‘å­è¿›ç¨‹ä¼ å…¥æ•°æ®ã€‚<br><code>proc</code> å®ä¾‹çš„ <code>communicate</code> æ–¹æ³•ä¼šç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢ï¼Œå¹¶è¿”å› <code>stdout</code> å’Œ <code>stderr</code>ï¼Œå³å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºã€‚<br>è‹¥åˆå§‹åŒ– <code>Popen</code> æ—¶æœªä¼ å…¥ <code>stdout=subprocess.PIPE</code> å‚æ•°ï¼Œåˆ™ä¸Šé¢è¿”å›çš„ <code>stdout</code> ä¸º <code>None</code>ã€‚</p><p>å¦‚æœæ‹…å¿ƒå­ç¨‹åºæ°¸è¿œä¸ä¼šç»ˆæ­¢æˆ–è€…é•¿æ—¶é—´é˜»å¡äº†è¾“å…¥å’Œè¾“å‡ºï¼Œå¯ä»¥å‘ <code>communicate</code> æ–¹æ³•ä¼ å…¥ <code>timeout</code> å‚æ•°æ¥æŒ‡å®šç­‰å¾…çš„æœ€é•¿æ—¶é—´ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">proc = subprocess.Popen([<span class="string">'sleep'</span>, <span class="string">'10'</span>])</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    proc.communicate(timeout=<span class="number">0.1</span>)</span><br><span class="line"><span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">    proc.terminate()</span><br><span class="line">    proc.wait()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Exit status'</span>, proc.poll())</span><br><span class="line"><span class="comment"># Exit status -15</span></span><br></pre></td></tr></table></figure></p><h5 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h5><ul><li><code>subprocess</code> æ¨¡å—å¯ä»¥è°ƒç”¨å­è¿›ç¨‹ï¼Œä¸”èƒ½å¤Ÿç®¡ç†å­è¿›ç¨‹çš„è¾“å…¥æµå’Œè¾“å‡ºæµï¼Œè¾¾åˆ°æºç¨‹åºä¸å­è¿›ç¨‹äº¤äº’çš„ç›®çš„</li><li>å­è¿›ç¨‹å’Œ Python è§£é‡Šå™¨ä¹‹é—´æ˜¯å¹¶è¡Œè¿è¡Œçš„ï¼Œå› è€Œå¯ä»¥æœ€å¤§åŒ–åœ°åˆ©ç”¨ CPU çš„å¤šä¸ªæ ¸å¿ƒ</li><li><code>subprocess</code> æ¨¡å—æä¾›çš„ <code>run</code> å‡½æ•°å¯ä»¥å®Œæˆç®€å•çš„è°ƒç”¨æ“ä½œï¼Œè€Œ <code>Popen</code> ç±»æä¾›äº†ç±»ä¼¼ Unix ç®¡çº¿çš„é«˜çº§åŠŸèƒ½</li><li><code>communicate</code> æ–¹æ³•çš„ <code>timeout</code> å‚æ•°å¯ä»¥é¿å…æ­»é”åŠå¡ä½çš„å­è¿›ç¨‹</li></ul><h4 id="ä½¿ç”¨çº¿ç¨‹å¤„ç†é˜»å¡å¼-IO"><a href="#ä½¿ç”¨çº¿ç¨‹å¤„ç†é˜»å¡å¼-IO" class="headerlink" title="ä½¿ç”¨çº¿ç¨‹å¤„ç†é˜»å¡å¼ IO"></a>ä½¿ç”¨çº¿ç¨‹å¤„ç†é˜»å¡å¼ IO</h4><p>Python çš„æ ‡å‡†å®ç°å«åš <strong>CPython</strong>ã€‚CPython åœ¨è¿è¡Œ Python ç¨‹åºæ—¶ï¼Œä¼šé¦–å…ˆè§£ææºä»£ç å¹¶å°†å…¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†é€šè¿‡ä¸€ä¸ªåŸºäºæ ˆçš„è§£é‡Šå™¨æ¥è¿è¡Œå­—èŠ‚ç ã€‚<br>CPython é€šè¿‡ä¸€ç§ç§°ä¸º <strong>GIL</strong> çš„æœºåˆ¶æ¥ç®¡ç†è§£é‡Šå™¨è‡ªèº«çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¼ºåŒ–å…¶ä¸€è‡´æ€§ã€‚GIL æ˜¯ä¸€ç§å¯ä»¥é˜»æ­¢ CPython è§£é‡Šå™¨å—<strong>æŠ¢å å¼</strong>å¤šçº¿ç¨‹å½±å“çš„<strong>äº’æ–¥é”</strong>ï¼ˆmutexï¼‰ï¼Œä»è€Œä½¿æ§åˆ¶ç¨‹åºçš„çº¿ç¨‹ä¸ä¼šè¢«å¦ä¸€ä¸ªçº¿ç¨‹æ„å¤–ä¸­æ–­ï¼Œå¯¼è‡´è§£é‡Šå™¨çš„çŠ¶æ€å‘ç”Ÿæ··ä¹±ã€‚</p><p>ä½† GIL æœ‰ä¸€ä¸ªéå¸¸ä¸¥é‡çš„è´Ÿé¢å½±å“ã€‚ä¸åƒ C++ æˆ– Java ç­‰è¯­è¨€å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æœ€å¤§åŒ–å¤šæ ¸å¿ƒ CPU çš„è®¡ç®—èƒ½åŠ›ï¼ŒPython è™½ç„¶æ”¯æŒå¤šçº¿ç¨‹ï¼Œä½† <strong>GIL ä¼šå¯¼è‡´ä»»ä¸€æ—¶åˆ»å®é™…ä¸Šéƒ½åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ¨è¿›</strong>ã€‚<br>ç®€å•æ¥è¯´ï¼ŒPython ä¸­çš„å¤šçº¿ç¨‹ä¸æ˜¯<strong>å¹¶è¡Œ</strong>è®¡ç®—ï¼Œæ— æ³•åŒæ—¶åˆ©ç”¨ CPU çš„å¤šä¸ªæ ¸å¿ƒæ¥æå‡<strong>è®¡ç®—å¯†é›†å‹</strong>å¤šä»»åŠ¡çš„æ•ˆç‡ã€‚</p><p>å•çº¿ç¨‹å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">factorize</span><span class="params">(number)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, number + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> number % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">numbers = [<span class="number">21390799</span>, <span class="number">12147599</span>, <span class="number">15166379</span>, <span class="number">18522859</span>, <span class="number">12345678</span>, <span class="number">87654321</span>]</span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> number <span class="keyword">in</span> numbers:</span><br><span class="line">    list(factorize(number))</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;(end - start):<span class="number">.3</span>&#125;</span> seconds'</span>)</span><br><span class="line"><span class="comment"># Took 6.19 seconds</span></span><br></pre></td></tr></table></figure></p><p>å¤šçº¿ç¨‹å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">factorize</span><span class="params">(number)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, number + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> number % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FactorizeThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, number)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.number = number</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.factors = list(factorize(self.number))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">numbers = [<span class="number">21390799</span>, <span class="number">12147599</span>, <span class="number">15166379</span>, <span class="number">18522859</span>, <span class="number">12345678</span>, <span class="number">87654321</span>]</span><br><span class="line">start = time.time()</span><br><span class="line">threads = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> number <span class="keyword">in</span> numbers:</span><br><span class="line">    thread = FactorizeThread(number)</span><br><span class="line">    thread.start()</span><br><span class="line">    threads.append(thread)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;(end -start):<span class="number">.3</span>&#125;</span> seconds'</span>)</span><br><span class="line"><span class="comment"># Took 6.3 seconds</span></span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹å‡ºï¼ŒPython ä¸­çš„å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹åœ¨åº”å¯¹è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ—¶ï¼Œä¸¤è€…çš„å¤„ç†æ—¶é—´æ²¡æœ‰ç›¸å·®å¤šå°‘ã€‚</p><p>ä½†æ˜¯å¯¹äº <strong>IO å¯†é›†</strong> å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ä»ç£ç›˜è¯»å†™æ–‡ä»¶ã€ç½‘ç»œä¼ è¾“ç­‰<strong>é˜»å¡å¼ IO</strong> æ“ä½œï¼Œä½¿ç”¨ Python ä¸­çš„å¤šçº¿ç¨‹å¯¹äºæ•ˆç‡çš„æå‡å°±ä¼šéå¸¸æ˜¾è‘—ã€‚<br>å¤šçº¿ç¨‹ä½¿å¾— CPU ä¸å¿…å»ç­‰å¾…ç¼“æ…¢çš„æ–‡ä»¶è¯»å†™ç­‰ IO æ“ä½œã€‚</p><p>å•çº¿ç¨‹å¤„ç† IO å¯†é›†å‹ä»»åŠ¡ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_example_page</span><span class="params">()</span>:</span></span><br><span class="line">    urlopen(<span class="string">'https://example.org'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start = time.time()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    get_example_page()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;time.time() - start&#125;</span> seconds'</span>)</span><br><span class="line"><span class="comment"># Took 6.853585243225098 seconds</span></span><br></pre></td></tr></table></figure></p><p>å¤šçº¿ç¨‹å¤„ç† IO å¯†é›†å‹ä»»åŠ¡ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_example_page</span><span class="params">()</span>:</span></span><br><span class="line">    urlopen(<span class="string">'https://example.org'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start = time.time()</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    thread = Thread(target=get_example_page)</span><br><span class="line">    thread.start()</span><br><span class="line">    threads.append(thread)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;time.time() - start&#125;</span> seconds'</span>)</span><br><span class="line"><span class="comment"># Took 0.8039891719818115 seconds</span></span><br></pre></td></tr></table></figure></p><h5 id="çŸ¥è¯†ç‚¹-1"><a href="#çŸ¥è¯†ç‚¹-1" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h5><ul><li>ç”±äº GIL çš„å­˜åœ¨ï¼ŒPython ä¸­çš„çº¿ç¨‹æ— æ³•å¹¶è¡Œåœ°åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸Šæ‰§è¡Œ</li><li>Python ä¸­çš„å¤šçº¿ç¨‹èƒ½å¤Ÿå¹¶è¡Œåœ°å‘èµ·å¤šä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå› è€Œå¯ä»¥åŒæ—¶å¤„ç†è®¡ç®—ä»»åŠ¡å’Œé˜»å¡å¼ IO</li></ul><h4 id="ä½¿ç”¨-Lock-é¿å…æ•°æ®ç«äº‰"><a href="#ä½¿ç”¨-Lock-é¿å…æ•°æ®ç«äº‰" class="headerlink" title="ä½¿ç”¨ Lock é¿å…æ•°æ®ç«äº‰"></a>ä½¿ç”¨ Lock é¿å…æ•°æ®ç«äº‰</h4><p>GIL æ€»æ˜¯ä¼šé˜»æ­¢ Python ä»£ç åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸Šå¹¶è¡Œæ‰§è¡Œï¼Œä»»æ„æ—¶åˆ»éƒ½åªèƒ½æœ‰ä¸€ä¸ª Python çº¿ç¨‹å¤„äºæ´»è·ƒçŠ¶æ€ã€‚<br>ä½† GIL å¹¶ä¸ä¼šä¿æŠ¤ä»£ç ä¸å—æ•°æ®ç«äº‰çš„å½±å“ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹äºæ•°æ®ç»“æ„çš„æ“ä½œä»æœ‰å¯èƒ½è¢« Python è§£é‡Šå™¨ä¸­é‚»è¿‘çš„å­—èŠ‚ç ç ´åï¼Œå°¤å…¶æ˜¯åœ¨é€šè¿‡å¤šçº¿ç¨‹åŒæ­¥åœ°å»è®¿é—®åŒä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increment</span><span class="params">(self, offset)</span>:</span></span><br><span class="line">        self.count += offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(sensor_index, how_many, counter)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(how_many):</span><br><span class="line">        counter.increment(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">how_many = <span class="number">10</span> ** <span class="number">5</span></span><br><span class="line">counter = Counter()</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    thread = Thread(target=worker,</span><br><span class="line">                    args=(i, how_many, counter))</span><br><span class="line">    threads.append(thread)</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">expected = how_many * <span class="number">5</span></span><br><span class="line">found = counter.count</span><br><span class="line">print(<span class="string">f'Counter should be <span class="subst">&#123;expected&#125;</span>, got <span class="subst">&#123;found&#125;</span>'</span>)</span><br><span class="line"><span class="comment"># Counter should be 500000, got 252472</span></span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°ä»£ç æ¨¡æ‹Ÿäº†ä¸€ä¸ªä»ä¼ æ„Ÿå™¨ç½‘ç»œå¹¶è¡Œåœ°è¯»å–æ•°æ®å¹¶è®¡æ•°çš„è¿‡ç¨‹ã€‚å¯¹ä»»æ„ä¸€ä¸ªä¼ æ„Ÿå™¨ï¼Œå…¶æ•°æ®çš„è¯»å–éƒ½å±äºé˜»å¡å¼ IOï¼Œç”±ç‹¬ç«‹çš„å·¥ä½œçº¿ç¨‹å»å¤„ç†ï¼Œæ•°æ®è¯»å–å®Œæˆåè¯¥å·¥ä½œçº¿ç¨‹ä¼šè°ƒç”¨ä¸€ä¸ªè®¡æ•°å™¨å¯¹è±¡æ¥ç´¯è®¡ç»“æœã€‚</p><p>ä½†ç¨‹åºè¿è¡Œåï¼Œå®é™…å¾—åˆ°çš„è®¡æ•°ç»“æœä¸é¢„æœŸå·®è·å¾ˆå¤§ã€‚<br>Python è§£é‡Šå™¨åœ¨æ‰§è¡Œå¤šä¸ªçº¿ç¨‹æ—¶ä¼šç¡®ä¿è¿™äº›çº¿ç¨‹ä¹‹é—´çš„â€œå¹³ç­‰å…³ç³»â€ï¼Œä»¤å®ƒä»¬è·å¾—å‡ ä¹ç›¸ç­‰çš„å¤„ç†æ—¶é—´ã€‚è¿™å› æ­¤éœ€è¦ Python æ—¶ä¸æ—¶åœ°åœ¨çº¿ç¨‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œæš‚æ—¶æŒ‚èµ·ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œè½¬è€Œå»æ¢å¤æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ã€‚<br>ä¸€ä¸ªçº¿ç¨‹ç”šè‡³æœ‰å¯èƒ½åœ¨çœ‹ä¼¼ç¬¦åˆåŸå­æ€§çš„æ“ä½œä¸­é—´è¢«æš‚åœã€‚</p><p>æ¯”å¦‚ <code>+=</code> æ“ä½œç¬¦åœ¨ä½œç”¨åˆ°å®ä¾‹çš„å±æ€§ä¸Šæ—¶ï¼Œç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter.count += <span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>å®é™…ä¸Šç­‰åŒäº Python åšå‡ºå¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªåˆ†å¼€çš„æ­¥éª¤ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value = getattr(counter, <span class="string">'count'</span>)</span><br><span class="line">result = value + <span class="number">1</span></span><br><span class="line">setattr(counter, <span class="string">'count'</span>, result)</span><br></pre></td></tr></table></figure></p><p>å†åŠ ä¸Šçº¿ç¨‹åˆ‡æ¢ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å‡ºç°ä¸‹é¢è¿™ç§æƒ…å†µï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Running in Thread A</span></span><br><span class="line">value_a = getattr(counter, <span class="string">'count'</span>)</span><br><span class="line"><span class="comment"># Context switch to Thread B</span></span><br><span class="line">value_b = getattr(counter, <span class="string">'count'</span>)</span><br><span class="line">result_b = value_b + <span class="number">1</span></span><br><span class="line">setattr(counter, <span class="string">'count'</span>, result_b)</span><br><span class="line"><span class="comment"># Context switch back to Thread A</span></span><br><span class="line">result_a = value_a + <span class="number">1</span></span><br><span class="line">setattr(counter, <span class="string">'count'</span>, result_a)</span><br></pre></td></tr></table></figure></p><p>å³åŸæœ¬åº”è¯¥è®¡ç®—ä¸¤æ¬¡çš„ç´¯åŠ æ“ä½œå®é™…ä¸Šåªæœ‰ä¸€æ¬¡ç”Ÿæ•ˆäº†ï¼Œæœ€ç»ˆå¯¼è‡´å‡ºç°é”™è¯¯çš„ç»“æœã€‚</p><p>ä¸ºé¿å…ä¸Šè¿°æƒ…å½¢ä¸­çš„æ•°æ®ç«äº‰æˆ–è€…å…¶ä»–å½¢å¼çš„æ•°æ®ç»“æ„æŸåç°è±¡ï¼Œå¯ä»¥å€ŸåŠ© <code>Lock</code> ç±»ä¿æŠ¤ç‰¹å®šçš„å€¼ä¸è¢«å¤šä¸ªçº¿ç¨‹åŒæ­¥è®¿é—®ã€‚å³ä»»ä¸€æ—¶åˆ»éƒ½åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—è¯¥æ•°æ®çš„é”ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, Lock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockingCounter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.lock = Lock()</span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increment</span><span class="params">(self, offset)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            self.count += offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(sensor_index, how_many, counter)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(how_many):</span><br><span class="line">        counter.increment(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">how_many = <span class="number">10</span> ** <span class="number">5</span></span><br><span class="line">counter = LockingCounter()</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    thread = Thread(target=worker,</span><br><span class="line">                    args=(i, how_many, counter))</span><br><span class="line">    threads.append(thread)</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">expected = how_many * <span class="number">5</span></span><br><span class="line">found = counter.count</span><br><span class="line">print(<span class="string">f'Counter should be <span class="subst">&#123;expected&#125;</span>, got <span class="subst">&#123;found&#125;</span>'</span>)</span><br><span class="line"><span class="comment"># Counter should be 500000, got 500000</span></span><br></pre></td></tr></table></figure></p><h5 id="çŸ¥è¯†ç‚¹-2"><a href="#çŸ¥è¯†ç‚¹-2" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h5><ul><li>Python æœ‰ GILï¼Œä½†åœ¨ç¼–å†™ä»£ç æ—¶ä»éœ€å…³æ³¨å¤šçº¿ç¨‹ä¸­çš„æ•°æ®ç«äº‰</li><li>å…è®¸å¤šä¸ªçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªä¸åŠ é”çš„å¯¹è±¡ï¼Œæœ‰å¯èƒ½ä¼šæŸåæ•°æ®ç»“æ„</li><li><code>Lock</code> ç±»å¯ä»¥ä¿æŠ¤å¤šçº¿ç¨‹ä¸­æ•°æ®çš„ä¸€è‡´æ€§</li></ul><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://effectivepython.com/" target="_blank" rel="noopener">Effective PYTHON Second Edition</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ä½¿ç”¨-subprocess-ç®¡ç†å­è¿›ç¨‹&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨-subprocess-ç®¡ç†å­è¿›ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨ subprocess ç®¡ç†å­è¿›ç¨‹&quot;&gt;&lt;/a&gt;ä½¿ç”¨ &lt;code&gt;subprocess&lt;/code&gt; ç®¡ç†
      
    
    </summary>
    
      <category term="Python" scheme="https://rollingstarky.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://rollingstarky.github.io/tags/Python/"/>
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Concurrency" scheme="https://rollingstarky.github.io/tags/Concurrency/"/>
    
      <category term="Thread" scheme="https://rollingstarky.github.io/tags/Thread/"/>
    
      <category term="Process" scheme="https://rollingstarky.github.io/tags/Process/"/>
    
      <category term="Lock" scheme="https://rollingstarky.github.io/tags/Lock/"/>
    
  </entry>
  
  <entry>
    <title>The Rust programming language è¯»ä¹¦ç¬”è®°â€”â€”é¢å‘å¯¹è±¡ç¼–ç¨‹</title>
    <link href="https://rollingstarky.github.io/2021/08/11/the-rust-programming-language-reading-notes-oop/"/>
    <id>https://rollingstarky.github.io/2021/08/11/the-rust-programming-language-reading-notes-oop/</id>
    <published>2021-08-10T16:00:00.000Z</published>
    <updated>2021-08-11T14:18:48.184Z</updated>
    
    <content type="html"><![CDATA[<p><strong>é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰</strong>æ˜¯ä¸€ç§ç¨‹åºå»ºæ¨¡çš„æ–¹æ³•ã€‚é€šå¸¸è®¤ä¸ºé¢å‘å¯¹è±¡çš„è¯­è¨€éœ€è¦åŒ…å«å‘½åå¯¹è±¡ã€å°è£…ã€ç»§æ‰¿ç­‰ç‰¹æ€§ã€‚</p><p><strong>å¯¹è±¡åŒ…å«æ•°æ®å’Œè¡Œä¸º</strong></p><p>é¢å‘å¯¹è±¡çš„ç¨‹åºç”±å¯¹è±¡æ„æˆã€‚å¯¹è±¡åŒ…è£…äº†æ•°æ®å’Œæ“ä½œè¿™äº›æ•°æ®çš„æµç¨‹ï¼ˆç§°ä½œæ–¹æ³•)ã€‚<br>åŸºäºè¿™ä¸ªå®šä¹‰ï¼ŒRust æ˜¯é¢å‘å¯¹è±¡çš„ã€‚æ¯”å¦‚ç»“æ„ä½“å’Œæšä¸¾éƒ½å¯ä»¥åŒ…å«æ•°æ®ï¼Œè€Œ <code>impl</code> å—åˆ™æä¾›äº†å¯ç”¨äºç»“æ„ä½“å’Œæšä¸¾çš„æ–¹æ³•ã€‚</p><h4 id="å°è£…å®ç°ç»†èŠ‚"><a href="#å°è£…å®ç°ç»†èŠ‚" class="headerlink" title="å°è£…å®ç°ç»†èŠ‚"></a>å°è£…å®ç°ç»†èŠ‚</h4><p>å°è£…ä½¿å¾—è°ƒç”¨å¯¹è±¡çš„å¤–éƒ¨ä»£ç æ— æ³•ç›´æ¥è®¿é—®å¯¹è±¡å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œè€Œå”¯ä¸€å¯ä»¥ä¸å¯¹è±¡è¿›è¡Œäº¤äº’çš„æ–¹æ³•ä¾¿æ˜¯é€šè¿‡å®ƒå…¬å¼€çš„æ¥å£ã€‚<br><strong>ä½¿ç”¨å¯¹è±¡çš„ä»£ç ä¸åº”å½“æ·±å…¥å¯¹è±¡çš„å†…éƒ¨å»æ”¹å˜æ•°æ®æˆ–è¡Œä¸ºï¼Œå°è£…ä½¿å¾—å¼€å‘è€…åœ¨ä¿®æ”¹æˆ–é‡æ„å¯¹è±¡çš„å†…éƒ¨å®ç°æ—¶æ— éœ€æ”¹å˜è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„å¤–éƒ¨ä»£ç </strong>ã€‚</p><p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>pub</code> å…³é”®å­—æ¥å†³å®šä»£ç ä¸­å“ªäº›æ¨¡å—ã€ç±»å‹ã€å‡½æ•°å’Œæ–¹æ³•æ˜¯å…¬å¼€çš„ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰å†…å®¹éƒ½æ˜¯ç§æœ‰çš„ã€‚</p><p>å¦‚ä¸‹é¢è®¡ç®—ç§»åŠ¨å¹³å‡å€¼çš„ä»£ç ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AveragedCollection</span></span> &#123;</span><br><span class="line">    list: <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt;,</span><br><span class="line">    average: <span class="built_in">f64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> AveragedCollection &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, value: <span class="built_in">i32</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.list.push(value);</span><br><span class="line">        <span class="keyword">self</span>.update_average();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">self</span>.list.pop();</span><br><span class="line">        <span class="keyword">match</span> result &#123;</span><br><span class="line">            <span class="literal">Some</span>(value) =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.update_average();</span><br><span class="line">                <span class="literal">Some</span>(value)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">None</span> =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">average</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">f64</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.average</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">update_average</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> total: <span class="built_in">i32</span> = <span class="keyword">self</span>.list.iter().sum();</span><br><span class="line">        <span class="keyword">self</span>.average = total <span class="keyword">as</span> <span class="built_in">f64</span> / <span class="keyword">self</span>.list.len() <span class="keyword">as</span> <span class="built_in">f64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> collection = AveragedCollection &#123;</span><br><span class="line">        list: <span class="built_in">vec!</span>[],</span><br><span class="line">        average: <span class="number">0.0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    collection.add(<span class="number">1</span>);</span><br><span class="line">    collection.add(<span class="number">2</span>);</span><br><span class="line">    collection.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The average of the collection is: &#123;&#125;"</span>, collection.average());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…ˆæ˜¯å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>AveragedCollection</code> çš„ç»“æ„ä½“ï¼Œå…¶ <code>list</code> å­—æ®µåŒ…å«äº†ä¸€ä¸ªå­˜å‚¨ <code>i32</code> å…ƒç´ çš„åŠ¨æ€æ•°ç»„ï¼›ä¸ºäº†é¿å…æ¯æ¬¡å–å…ƒç´ å¹³å‡å€¼çš„æ—¶å€™é‡å¤è®¡ç®—ï¼Œåˆæ·»åŠ äº†ä¸€ä¸ªç”¨äºå­˜å‚¨å¹³å‡å€¼çš„ <code>average</code> å­—æ®µã€‚<br>ç»“æ„ä½“æœ¬èº«è¢«æ ‡è®°ä¸º <code>pub</code> ä½¿å¾—å…¶ä»–ä»£ç å¯ä»¥ä½¿ç”¨å®ƒï¼Œä½†å…¶å†…éƒ¨å­—æ®µä»ç„¶ä¿æŒç§æœ‰ã€‚<br>å…¬å…±æ–¹æ³• <code>add</code>ã€<code>remove</code>ã€<code>average</code> æ˜¯ä»…æœ‰çš„å‡ ä¸ªå¯ä»¥è®¿é—®æˆ–ä¿®æ”¹ <code>AveragedCollection</code> å®ä¾‹ä¸­æ•°æ®çš„æ–¹æ³•ã€‚å½“ç”¨æˆ·è°ƒç”¨ <code>add</code> æ–¹æ³•å‘ <code>list</code> ä¸­æ·»åŠ å…ƒç´ ï¼Œæˆ–è€…è°ƒç”¨ <code>remove</code> ä» <code>list</code> ä¸­åˆ é™¤å…ƒç´ æ—¶ï¼Œæ–¹æ³•å†…éƒ¨çš„å®ç°éƒ½ä¼šå†è°ƒç”¨ç§æœ‰æ–¹æ³• <code>update_average</code> æ¥æ›´æ–° <code>average</code> å­—æ®µã€‚</p><p>ç”±äº <code>list</code> å’Œ <code>average</code> å­—æ®µæ˜¯ç§æœ‰çš„ï¼Œå¤–éƒ¨ä»£ç æ— æ³•ç›´æ¥è¯»å– <code>list</code> å­—æ®µæ¥å¢åŠ æˆ–åˆ é™¤å…¶ä¸­çš„å…ƒç´ ã€‚<br>ä¸€æ—¦ç¼ºå°‘äº†è¿™æ ·çš„å°è£…ï¼Œ<code>average</code> å­—æ®µä¾¿æ— æ³•åœ¨ç”¨æˆ·ç§è‡ªæ›´æ–° <code>list</code> å­—æ®µæ—¶åŒæ­¥ä¿æŒæ›´æ–°ã€‚</p><p>å› ä¸ºç»“æ„ä½“ <code>AveragedCollection</code> å°è£…äº†å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœªæ¥è½»æ¾åœ°æ”¹å˜æ•°æ®ç»“æ„ç­‰å†…éƒ¨å®ç°ã€‚æ¯”å¦‚å¯ä»¥åœ¨ <code>list</code> å­—æ®µä¸Šä½¿ç”¨ <code>HashSet&lt;i32&gt;</code> æ›¿ä»£ <code>Vec&lt;i32&gt;</code>ã€‚<br>åªè¦ <code>add</code>ã€<code>remove</code>ã€<code>average</code> è¿™å‡ ä¸ªå…¬å…±æ–¹æ³•çš„ç­¾åä¿æŒä¸å˜ï¼Œæ­£åœ¨ä½¿ç”¨ <code>AveragedCollection</code> çš„å¤–éƒ¨ä»£ç å°±æ— éœ€è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚<br>å‡å¦‚å°† <code>list</code> å­—æ®µå£°æ˜ä¸º <code>pub</code>ï¼Œå°±å¿…ç„¶ä¼šå¤±å»ä¸Šé¢è¿™ä¸€ä¼˜åŠ¿ã€‚<code>HashSet&lt;i32&gt;</code> å’Œ <code>Vec&lt;i32&gt;</code> åœ¨å¢åŠ æˆ–åˆ é™¤å…ƒç´ æ—¶ä½¿ç”¨çš„å…·ä½“æ–¹æ³•æ˜¯ä¸åŒçš„ï¼Œå› æ­¤è‹¥ç›´æ¥ä¿®æ”¹ <code>list</code>ï¼Œå¤–éƒ¨ä»£ç å°†ä¸å¾—ä¸éšä¹‹å‘ç”Ÿå˜åŒ–ã€‚</p><h4 id="ä½œä¸ºç±»å‹ç³»ç»Ÿå’Œä»£ç å…±äº«æœºåˆ¶çš„ç»§æ‰¿"><a href="#ä½œä¸ºç±»å‹ç³»ç»Ÿå’Œä»£ç å…±äº«æœºåˆ¶çš„ç»§æ‰¿" class="headerlink" title="ä½œä¸ºç±»å‹ç³»ç»Ÿå’Œä»£ç å…±äº«æœºåˆ¶çš„ç»§æ‰¿"></a>ä½œä¸ºç±»å‹ç³»ç»Ÿå’Œä»£ç å…±äº«æœºåˆ¶çš„ç»§æ‰¿</h4><p>ç»§æ‰¿æœºåˆ¶ä½¿å¾—å¯¹è±¡å¯ä»¥æ²¿ç”¨å¦ä¸€ä¸ªå¯¹è±¡çš„æ•°æ®ä¸è¡Œä¸ºï¼Œè€Œæ— éœ€é‡å¤å®šä¹‰ä»£ç ã€‚<br>Rust ä¸­æ— æ³•å®šä¹‰ä¸€ä¸ªç»§æ‰¿çˆ¶ç»“æ„ä½“å­—æ®µå’Œæ–¹æ³•çš„å­ç»“æ„ä½“ã€‚</p><p>é€‰æ‹©ç»§æ‰¿ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ã€‚å…¶ä¸€æ˜¯ä»£ç å¤ç”¨ï¼Œä½œä¸ºæ›¿ä»£æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨ Rust ä¸­çš„é»˜è®¤ <code>trait</code> æ–¹æ³•æ¥è¿›è¡Œä»£ç å…±äº«ã€‚<br>å®ƒä¸ç»§æ‰¿ååˆ†ç›¸ä¼¼ï¼Œçˆ¶ç±»ä¸­å®ç°çš„æ–¹æ³•å¯ä»¥è¢«ç»§æ‰¿å®ƒçš„å­ç±»æ‰€æ‹¥æœ‰ï¼›å­ç±»ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›–çˆ¶ç±»ä¸­çš„æ–¹æ³•ã€‚</p><p>å¦ä¸€ä¸ªä½¿ç”¨ç»§æ‰¿çš„åŸå› ä¸ç±»å‹ç³»ç»Ÿæœ‰å…³ï¼Œå¸Œæœ›å­ç±»å‹èƒ½å¤Ÿè¢«åº”ç”¨åˆ°ä¸€ä¸ªéœ€è¦çˆ¶ç±»å‹çš„åœ°æ–¹ã€‚å³<strong>å¤šæ€</strong>ï¼š<strong>å¦‚æœä¸€äº›å¯¹è±¡å…·æœ‰æŸäº›å…±åŒçš„ç‰¹å¾ï¼Œåˆ™è¿™äº›å¯¹è±¡å°±å¯ä»¥åœ¨è¿è¡Œæ—¶ç›¸äº’æ›¿æ¢ä½¿ç”¨</strong>ã€‚<br>å¯ä»¥åœ¨ Rust ä¸­ä½¿ç”¨æ³›å‹æ¥æ„å»ºä¸åŒç±»å‹çš„æŠ½è±¡ï¼Œå¹¶ä½¿ç”¨ <code>trait</code> çº¦æŸæ¥å†³å®šç±»å‹å¿…é¡»æä¾›çš„å…·ä½“ç‰¹æ€§ã€‚è¿™ä¸€æŠ€æœ¯è¢«ç§°ä¸º<strong>é™å®šå‚æ•°åŒ–å¤šæ€</strong>ã€‚</p><p>è®¸å¤šè¾ƒä¸ºæ–°æ½®çš„è¯­è¨€å·²ç»ä¸å¤ªå–œæ¬¢å°†ç»§æ‰¿ä½œä¸ºå†…ç½®çš„ç¨‹åºè®¾è®¡æ–¹æ¡ˆï¼Œå› ä¸º<strong>ä½¿ç”¨ç»§æ‰¿æ„å‘³ç€ä½ ä¼šæ— æ„é—´å…±äº«å‡ºæ¯”æ‰€éœ€å†…å®¹æ›´å¤šçš„ä»£ç </strong>ã€‚<br>å­ç±»å¹¶ä¸åº”è¯¥æ€»æ˜¯å…±äº«çˆ¶ç±»çš„æ‰€æœ‰ç‰¹æ€§ï¼Œä½†ä½¿ç”¨ç»§æ‰¿æœºåˆ¶å´ä¼šå§‹ç»ˆäº§ç”Ÿè¿™æ ·çš„ç»“æœï¼Œè¿›è€Œä½¿ç¨‹åºè®¾è®¡ç¼ºä¹çµæ´»æ€§ã€‚è€ŒæŸäº›è¯­è¨€å¼ºåˆ¶è¦æ±‚å­ç±»åªèƒ½ç»§æ‰¿è‡ªå•ä¸ªçˆ¶ç±»ï¼Œè¿›ä¸€æ­¥é™åˆ¶äº†ç¨‹åºè®¾è®¡çš„çµæ´»æ€§ã€‚</p><h4 id="ä½¿ç”¨-trait-å¯¹è±¡æ¥å­˜å‚¨ä¸åŒç±»å‹çš„å€¼"><a href="#ä½¿ç”¨-trait-å¯¹è±¡æ¥å­˜å‚¨ä¸åŒç±»å‹çš„å€¼" class="headerlink" title="ä½¿ç”¨ trait å¯¹è±¡æ¥å­˜å‚¨ä¸åŒç±»å‹çš„å€¼"></a>ä½¿ç”¨ trait å¯¹è±¡æ¥å­˜å‚¨ä¸åŒç±»å‹çš„å€¼</h4><p>åŠ¨æ€æ•°ç»„æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå³åªèƒ½å­˜å‚¨åŒä¸€ç±»å‹çš„å…ƒç´ ã€‚æœ‰äº›æ—¶å€™çš„å˜é€šæ–¹æ¡ˆå¯ä»¥ä½¿ç”¨æšä¸¾ã€‚<br>æ¯”å¦‚å®šä¹‰ä¸€ä¸ª <code>SpreadsheetCell</code> æšä¸¾åŒæ—¶åŒ…å«äº†å¯ä»¥æŒæœ‰æ•´æ•°ã€æµ®ç‚¹æ•°å’Œæ–‡æœ¬çš„å˜ä½“ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æ¯ä¸ªè¡¨æ ¼ä¸­å­˜å‚¨ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œä¸”ä¾ç„¶èƒ½å¤Ÿç”¨ä¸€ä¸ªåŠ¨æ€æ•°ç»„æ¥è¡¨ç¤ºä¸€æ•´è¡Œå•å…ƒæ ¼ã€‚<br>ä½†æ˜¯æ€»æœ‰æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿåœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ä¸ºç±»å‹çš„é›†åˆè¿›è¡Œæ‰©å±•ã€‚</p><p>æ¯”å¦‚éœ€è¦åˆ›å»ºä¸€ä¸ªå«æœ‰ GUI åº“æ¶æ„çš„ gui åŒ…ï¼Œå¹¶åœ¨åŒ…ä¸­æä¾›ä¸€äº›å¯ä¾›ç”¨æˆ·ä½¿ç”¨çš„å…·ä½“ç±»å‹ï¼Œå¦‚ <code>Button</code> æˆ– <code>TextField</code> ç­‰ï¼Œè¿™äº›ç±»å‹éƒ½å®ç°äº† <code>draw</code> æ–¹æ³•ç”¨äºæ”¯æŒå°†å…¶ç»˜åˆ¶åˆ°å±å¹•ä¸­ã€‚<br>æ­¤å¤–ï¼Œgui çš„ç”¨æˆ·ä¹Ÿåº”å½“èƒ½å¤Ÿåˆ›å»ºæ”¯æŒç»˜åˆ¶çš„è‡ªå®šä¹‰ç±»å‹ï¼Œå¦‚æŸäº›å¼€å‘è€…å¯èƒ½ä¼šæ·»åŠ  <code>Image</code>ï¼Œå¦ä¸€äº›å¯èƒ½ä¼šæ·»åŠ  <code>SelectBox</code> ç­‰ã€‚<br>åœ¨é‚£äº›æ”¯æŒç»§æ‰¿çš„è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å‡ºä¸€ä¸ªæ‹¥æœ‰ <code>draw</code> æ–¹æ³•çš„ <code>Component</code> ç±»ã€‚å…¶ä»–å¦‚ <code>Button</code>ã€<code>Image</code>ã€<code>SelectBox</code> ç­‰åˆ™éƒ½éœ€è¦ç»§æ‰¿ <code>Component</code> ç±»æ¥è·å¾— <code>draw</code> æ–¹æ³•ã€‚<br>å½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›– <code>draw</code> æ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰è¡Œä¸ºï¼Œä½†æ¡†æ¶ä¼šåœ¨å¤„ç†è¿‡ç¨‹ä¸­å°†å®ƒä»¬å…¨éƒ¨è§†ä½œ <code>Component</code> ç±»å‹çš„å®ä¾‹ï¼Œå¹¶ä»¥æ­¤è°ƒç”¨ <code>draw</code> æ–¹æ³•ã€‚</p><h5 id="ä¸ºå…±æœ‰è¡Œä¸ºå®šä¹‰ä¸€ä¸ª-trait"><a href="#ä¸ºå…±æœ‰è¡Œä¸ºå®šä¹‰ä¸€ä¸ª-trait" class="headerlink" title="ä¸ºå…±æœ‰è¡Œä¸ºå®šä¹‰ä¸€ä¸ª trait"></a>ä¸ºå…±æœ‰è¡Œä¸ºå®šä¹‰ä¸€ä¸ª trait</h5><p>Rust æ²¡æœ‰ç»§æ‰¿åŠŸèƒ½ã€‚<br>ä¸ºäº†åœ¨ gui ä¸­å®ç°é¢„æœŸçš„åŠŸèƒ½ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªæ‹¥æœ‰ <code>draw</code> æ–¹æ³•çš„ <code>Draw</code> traitã€‚trait å¯¹è±¡å¯ä»¥è¢«ç”¨åœ¨æ³›å‹æˆ–å…·ä½“ç±»å‹æ‰€å¤„çš„ä½ç½®ï¼Œæ— è®ºæˆ‘ä»¬åœ¨å“ªé‡Œä½¿ç”¨ trait å¯¹è±¡ï¼ŒRust ç±»å‹ç³»ç»Ÿéƒ½ä¼šåœ¨ç¼–è¯‘æ—¶ç¡®ä¿å‡ºç°åœ¨ç›¸åº”ä½ç½®ä¸Šçš„å€¼å®ç°äº† trait å¯¹è±¡ä¸­çš„æŒ‡å®šæ–¹æ³•ã€‚</p><p>Rust æœ‰æ„é¿å…å°†ç»“æ„ä½“å’Œæšä¸¾ç§°ä¸ºå¯¹è±¡ï¼Œä»¥ä¾¿äºä¸å…¶ä»–è¯­è¨€ä¸­çš„å¯¹è±¡åŒºåˆ«å¼€ã€‚<strong>å¯¹äºç»“æ„ä½“å’Œæšä¸¾è€Œè¨€ï¼Œå…¶å­—æ®µä¸­çš„æ•°æ®ä¸ <code>impl</code> å—ä¸­çš„è¡Œä¸ºæ˜¯åˆ†å¼€çš„ï¼›è€Œåœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œæ•°æ®å’Œè¡Œä¸ºå¾€å¾€è¢«ç»„åˆåœ¨åä¸ºå¯¹è±¡çš„æ¦‚å¿µä¸­</strong>ã€‚<br>trait å¯¹è±¡åˆ™æœ‰äº›ç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„å¯¹è±¡ï¼Œå®ƒä¹Ÿåœ¨æŸç§ç¨‹åº¦ä¸Šç»„åˆäº†æ•°æ®å’Œè¡Œä¸ºã€‚ä½† trait å¯¹è±¡è¢«ä¸“é—¨ç”¨äºæŠ½è±¡æŸäº›å…±æœ‰è¡Œä¸ºï¼Œæ²¡æœ‰å…¶ä»–è¯­è¨€ä¸­çš„å¯¹è±¡é‚£ä¹ˆé€šç”¨ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåä¸º <code>gui</code> çš„ Rust é¡¹ç›®ï¼š<br><code>cargo new gui</code></p><p>åœ¨ <code>lib.rs</code> ä¸­å®šä¹‰ä¸€ä¸ªæ‹¥æœ‰ <code>draw</code> æ–¹æ³•çš„ Draw traitï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Draw</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®šä¹‰ä¸€ä¸ªæŒæœ‰ <code>components</code> åŠ¨æ€æ•°ç»„çš„ <code>Screen</code> ç»“æ„ä½“ï¼Œä»£ç ä¸­çš„ <code>Box&lt;dyn Draw&gt;</code> ä»£è¡¨æ‰€æœ‰è¢«æ”¾ç½®åœ¨ <code>Box</code> ä¸­ä¸”å®ç°äº† Draw trait çš„å…·ä½“ç±»å‹ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Screen</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> components: <span class="built_in">Vec</span>&lt;<span class="built_in">Box</span>&lt;dyn Draw&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>Screen</code> ç»“æ„ä½“å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>run</code> çš„æ–¹æ³•ï¼Œä¼šé€ä¸€è°ƒç”¨ <code>components</code> ä¸­æ¯ä¸ªå…ƒç´ çš„ <code>draw</code> æ–¹æ³•ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">impl</span> Screen &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> component <span class="keyword">in</span> <span class="keyword">self</span>.components.iter() &#123;</span><br><span class="line">            component.draw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="å®ç°-trait"><a href="#å®ç°-trait" class="headerlink" title="å®ç° trait"></a>å®ç° trait</h5><p>åœ¨ä»£ç ä¸­æ·»åŠ ä¸€äº›å®ç°äº† Draw trait çš„å…·ä½“ç±»å‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>draw</code> æ–¹æ³•ä¸ä¼šåŒ…å«ä»»ä½•æœ‰æ„ä¹‰çš„å†…å®¹ï¼Œä»…ä½œä¸ºæ¼”ç¤ºï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Button</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> width: <span class="built_in">u32</span>, </span><br><span class="line">    <span class="keyword">pub</span> height: <span class="built_in">u32</span>, </span><br><span class="line">    <span class="keyword">pub</span> label: <span class="built_in">String</span>, </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Draw <span class="keyword">for</span> Button &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Drawing a button, the button's label is &#123;&#125;"</span>, <span class="keyword">self</span>.label);</span><br><span class="line">        <span class="comment">// å®é™…ç»˜åˆ¶ä¸€ä¸ªæŒ‰é’®çš„ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>Button</code> ä¸­æŒæœ‰çš„ <code>width</code>ã€<code>height</code> å’Œ <code>label</code> å­—æ®µä¹Ÿè®¸ä¼šä¸åŒäºå…¶ä»–ç»„ä»¶ä¸­çš„å­—æ®µï¼Œæ¯”å¦‚ <code>TextField</code> ç±»å‹å°±å¯èƒ½åœ¨è¿™äº›å­—æ®µå¤–é¢å¤–æŒæœ‰ä¸€ä¸ª <code>placeholder</code> å­—æ®µã€‚<br>æ¯ä¸€ä¸ªå¸Œæœ›ç»˜åˆ¶åœ¨å±å¹•ä¸Šçš„ç±»å‹éƒ½åº”å½“å®ç° Draw traitï¼Œå¹¶åœ¨ <code>draw</code> æ–¹æ³•ä¸­ä½¿ç”¨ä¸åŒçš„ä»£ç æ¥è‡ªå®šä¹‰å…·ä½“çš„ç»˜åˆ¶è¡Œä¸ºã€‚<br>é™¤äº†å®ç° Draw traitï¼Œ<code>Button</code> ç±»å‹ä¹Ÿè®¸ä¼šåœ¨å¦å¤–çš„ <code>impl</code> å—ä¸­å®ç°å“åº”ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶çš„è¡Œä¸ºï¼Œè¿™äº›æ–¹æ³•å¹¶ä¸é€‚ç”¨äº <code>TextField</code> ç­‰å…¶ä»–ç±»å‹ã€‚</p><p>ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨ <code>main.rs</code> ä¸­ä¸º<code>SelectBox</code> è¿™ç§è‡ªå®šä¹‰ç±»å‹å®ç° Draw traitï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="keyword">use</span> gui::Draw;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SelectBox</span></span> &#123;</span><br><span class="line">    width: <span class="built_in">u32</span>,</span><br><span class="line">    height: <span class="built_in">u32</span>,</span><br><span class="line">    options: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Draw <span class="keyword">for</span> SelectBox &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Drawing a selectbox, the options are &#123;:?&#125;"</span>, <span class="keyword">self</span>.options);</span><br><span class="line">        <span class="comment">// å®é™…ç»˜åˆ¶ä¸€ä¸ªé€‰æ‹©æ¡†çš„ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶å°±å¯ä»¥åœ¨ç¼–å†™ <code>main</code> å‡½æ•°çš„æ—¶å€™åˆ›å»º <code>Screen</code> å®ä¾‹äº†ã€‚ä½¿ç”¨ <code>Box&lt;T&gt;</code> ç”Ÿæˆ <code>SelectBox</code> æˆ– <code>Button</code> çš„ trait å¯¹è±¡ï¼Œå†å°†å®ƒä»¬æ·»åŠ åˆ° <code>Screen</code> å®ä¾‹ä¸­ã€‚ä¾¿å¯ä»¥è¿è¡Œ <code>Screen</code> å®ä¾‹çš„ <code>run</code> æ–¹æ³•æ¥ä¾æ¬¡è°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ <code>draw</code> å®ç°ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="keyword">use</span> gui::&#123;Screen, Button&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> scrren = Screen &#123;</span><br><span class="line">        components: <span class="built_in">vec!</span>[</span><br><span class="line">            <span class="built_in">Box</span>::new(SelectBox &#123;</span><br><span class="line">                width: <span class="number">75</span>,</span><br><span class="line">                height: <span class="number">10</span>,</span><br><span class="line">                options: <span class="built_in">vec!</span>[</span><br><span class="line">                    <span class="built_in">String</span>::from(<span class="string">"Yes"</span>),</span><br><span class="line">                    <span class="built_in">String</span>::from(<span class="string">"Maybe"</span>),</span><br><span class="line">                    <span class="built_in">String</span>::from(<span class="string">"No"</span>),</span><br><span class="line">                ],</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="built_in">Box</span>::new(Button &#123;</span><br><span class="line">                width: <span class="number">50</span>,</span><br><span class="line">                height: <span class="number">10</span>,</span><br><span class="line">                label: <span class="built_in">String</span>::from(<span class="string">"OK"</span>),</span><br><span class="line">            &#125;),</span><br><span class="line">        ],</span><br><span class="line">    &#125;;</span><br><span class="line">    scrren.run()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// =&gt; Drawing a selectbox, the options are ["Yes", "Maybe", "No"]</span></span><br><span class="line"><span class="comment">// =&gt; Drawing a button, the button's label is OK</span></span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬åœ¨ç¼–å†™åº“çš„æ—¶å€™æ— æ³•å¾—çŸ¥ç”¨æˆ·æ˜¯å¦ä¼šæ·»åŠ è‡ªå®šä¹‰çš„ <code>SelectBox</code> ç±»å‹ï¼Œä½†æˆ‘ä»¬çš„ <code>Screen</code> å®ç°ä¾ç„¶èƒ½å¤Ÿæ¥æ”¶æ–°çš„ç±»å‹å¹¶å®Œæˆç»˜åˆ¶å·¥ä½œã€‚å› ä¸º <code>SelectBox</code> å®ç°äº† Draw trait åŠå…¶ <code>draw</code> æ–¹æ³•ã€‚</p><p><code>run</code> æ–¹æ³•åªå…³å¿ƒå€¼å¯¹è¡Œä¸ºçš„å“åº”ï¼Œè€Œä¸åœ¨æ„å€¼çš„å…·ä½“ç±»å‹ã€‚è¿™ä¸€æ¦‚å¿µä¸åŠ¨æ€ç±»å‹ä¸­çš„ <strong>duck typing</strong> ååˆ†ç›¸ä¼¼ã€‚<br>é€šè¿‡åœ¨å®šä¹‰åŠ¨æ€æ•°ç»„ <code>components</code> æ—¶æŒ‡å®š <code>Box&lt;dyn Draw&gt;</code> å…ƒç´ ç±»å‹ï¼Œ<code>Screen</code> å®ä¾‹åªä¼šæ¥æ”¶é‚£äº›èƒ½å¤Ÿè°ƒç”¨ <code>draw</code> æ–¹æ³•çš„å€¼ï¼Œè€Œä¸ä¼šå»æ£€æŸ¥è¯¥å€¼ç©¶ç«Ÿæ˜¯ <code>Button</code> å®ä¾‹è¿˜æ˜¯ <code>SelectBox</code> å®ä¾‹ã€‚</p><p>ä½¿ç”¨ trait å¯¹è±¡ä¸ç±»å‹ç³»ç»Ÿå®ç° duck typing çš„ä¼˜åŠ¿åœ¨äºï¼Œä¸éœ€è¦åœ¨è¿è¡Œæ—¶æ£€æŸ¥æŸä¸ªå€¼æ˜¯å¦å®ç°äº†æŒ‡å®šçš„æ–¹æ³•ï¼Œæˆ–è€…æ‹…å¿ƒå‡ºç°è°ƒç”¨æœªå®šä¹‰æ–¹æ³•ç­‰è¿è¡Œæ—¶é”™è¯¯ã€‚Rust ä¼šåœ¨ç¼–è¯‘æ—¶å‘ç°è¿™ç±»é”™è¯¯ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener">The Rust Programming Language</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰&lt;/strong&gt;æ˜¯ä¸€ç§ç¨‹åºå»ºæ¨¡çš„æ–¹æ³•ã€‚é€šå¸¸è®¤ä¸ºé¢å‘å¯¹è±¡çš„è¯­è¨€éœ€è¦åŒ…å«å‘½åå¯¹è±¡ã€å°è£…ã€ç»§æ‰¿ç­‰ç‰¹æ€§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¯¹è±¡åŒ…å«æ•°æ®å’Œè¡Œä¸º&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é¢å‘å¯¹è±¡çš„ç¨‹åºç”±å¯¹è±¡æ„æˆã€‚å¯¹è±¡åŒ…è£…äº†æ•°æ®å’Œæ“ä½œè¿™äº›æ•°æ®
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="OOP" scheme="https://rollingstarky.github.io/tags/OOP/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Rust" scheme="https://rollingstarky.github.io/tags/Rust/"/>
    
      <category term="Trait" scheme="https://rollingstarky.github.io/tags/Trait/"/>
    
      <category term="Encapsulation" scheme="https://rollingstarky.github.io/tags/Encapsulation/"/>
    
      <category term="Inheritance" scheme="https://rollingstarky.github.io/tags/Inheritance/"/>
    
      <category term="Polymorphism" scheme="https://rollingstarky.github.io/tags/Polymorphism/"/>
    
  </entry>
  
  <entry>
    <title>The Rust programming language è¯»ä¹¦ç¬”è®°â€”â€”ä¸å®‰å…¨ Rust</title>
    <link href="https://rollingstarky.github.io/2021/08/11/the-rust-programming-language-reading-notes-unsafe-rust/"/>
    <id>https://rollingstarky.github.io/2021/08/11/the-rust-programming-language-reading-notes-unsafe-rust/</id>
    <published>2021-08-10T16:00:00.000Z</published>
    <updated>2021-08-11T14:11:49.524Z</updated>
    
    <content type="html"><![CDATA[<p>Rust å†…éƒ¨éšè—äº†ä¸€ç§ä¸ä¼šå¼ºåˆ¶å®æ–½å†…å­˜å®‰å…¨ä¿éšœçš„è¯­è¨€ï¼š<strong>ä¸å®‰å…¨ Rust</strong>ã€‚<br>å…¶ä¹‹æ‰€ä»¥å­˜åœ¨ï¼Œæ˜¯å› ä¸ºé™æ€åˆ†æä»æœ¬è´¨ä¸Šè®²æ˜¯ä¿å®ˆçš„ï¼Œå®ƒå®å¯é”™æ€ä¸€äº›åˆæ³•ç¨‹åºä¹Ÿä¸ä¼šæ¥å—å¯èƒ½éæ³•çš„ä»£ç ã€‚<br>ä½¿ç”¨ä¸å®‰å…¨ä»£ç çš„ç¼ºç‚¹åœ¨äºç¨‹åºå‘˜éœ€è¦å¯¹è‡ªå·±çš„è¡Œä¸ºè´Ÿè´£ã€‚è‹¥é”™è¯¯åœ°ä½¿ç”¨äº†ä¸å®‰å…¨ä»£ç ï¼Œå°±å¯èƒ½å¼•å‘ä¸å®‰å…¨çš„å†…å­˜é—®é¢˜ï¼Œå¦‚ç©ºæŒ‡é’ˆè§£å¼•ç”¨ç­‰ã€‚</p><p>å¦ä¸€ä¸ªåŸå› åœ¨äºåº•å±‚è®¡ç®—æœºç¡¬ä»¶å›ºæœ‰çš„ä¸å®‰å…¨æ€§ã€‚è‹¥ Rust ä¸å…è®¸è¿›è¡Œä¸å®‰å…¨çš„æ“ä½œï¼Œåˆ™æŸäº›åº•å±‚ä»»åŠ¡å¯èƒ½æ ¹æœ¬å°±å®Œæˆä¸äº†ã€‚</p><p>ä¸å®‰å…¨ Rust å…è®¸ä½ æ‰§è¡Œ 4 ç§åœ¨å®‰å…¨ Rust ä¸­ä¸è¢«å…è®¸çš„æ“ä½œï¼š</p><ul><li>è§£å¼•ç”¨è£¸æŒ‡é’ˆ</li><li>è°ƒç”¨ä¸å®‰å…¨çš„å‡½æ•°æˆ–æ–¹æ³•</li><li>è®¿é—®æˆ–ä¿®æ”¹å¯å˜çš„é™æ€å˜é‡</li><li>å®ç°ä¸å®‰å…¨ trait</li></ul><p>å¯ä»¥åœ¨ä»£ç å—å‰ä½¿ç”¨å…³é”®å­— <code>unsafe</code> æ¥åˆ‡æ¢åˆ°ä¸å®‰å…¨æ¨¡å¼ã€‚<code>unsafe</code> å…³é”®å­—å¹¶ä¸ä¼šå…³é—­å€Ÿç”¨æ£€æŸ¥å™¨æˆ–ç¦ç”¨ä»»ä½•å…¶ä»– Rust å®‰å…¨æ£€æŸ¥ã€‚<code>unsafe</code> ä»…ä»…ä»¤ä½ å¯ä»¥è®¿é—®ä¸Šè¿° 4 ç§ä¸ä¼šè¢«ç¼–è¯‘å™¨æ£€æŸ¥çš„ç‰¹æ€§ã€‚å› æ­¤å³ä¾¿å¤„äºä¸å®‰å…¨çš„ä»£ç å—ä¸­ï¼Œä¹Ÿä»ç„¶å¯ä»¥è·å¾—ä¸€å®šç¨‹åº¦çš„å®‰å…¨æ€§ã€‚</p><p><code>unsafe</code> å¹¶ä¸æ„å‘³ç€å—ä¸­çš„ä»£ç ä¸€å®šå°±æ˜¯å±é™©çš„æˆ–ä¸€å®šä¼šå¯¼è‡´å†…å­˜å®‰å…¨é—®é¢˜ï¼Œå®ƒä»…ä»…æ˜¯å°†è´£ä»»è½¬ç§»åˆ°äº†ç¨‹åºå‘˜çš„è‚©ä¸Šã€‚<br>é€šè¿‡å¯¹ 4 ç§ä¸å®‰å…¨æ“ä½œæ ‡è®°ä¸Š <code>unsafe</code>ï¼Œå¯ä»¥åœ¨å‡ºç°å†…å­˜ç›¸å…³çš„é”™è¯¯æ—¶å¿«é€Ÿåœ°å°†é—®é¢˜å®šä½åˆ° <code>unsafe</code> ä»£ç å—ä¸­ã€‚<br><strong>åº”å½“å°½é‡é¿å…ä½¿ç”¨ <code>unsafe</code> ä»£ç å—</strong>ã€‚</p><p>ä¸ºäº†å°½å¯èƒ½åœ°éš”ç¦»ä¸å®‰å…¨ä»£ç ï¼Œå¯ä»¥å°†å…¶å°è£…åœ¨ä¸€ä¸ªå®‰å…¨çš„æŠ½è±¡ä¸­å¹¶æä¾›ä¸€å¥—å®‰å…¨çš„ APIã€‚å®é™…ä¸ŠæŸäº›æ ‡å‡†åº“åŠŸèƒ½åŒæ ·ä½¿ç”¨äº†ä¸å®‰å…¨ä»£ç ï¼Œå¹¶ä»¥æ­¤ä¸ºåŸºç¡€æä¾›äº†å®‰å…¨çš„æŠ½è±¡æ¥å£ã€‚</p><h4 id="è§£å¼•ç”¨è£¸æŒ‡é’ˆ"><a href="#è§£å¼•ç”¨è£¸æŒ‡é’ˆ" class="headerlink" title="è§£å¼•ç”¨è£¸æŒ‡é’ˆ"></a>è§£å¼•ç”¨è£¸æŒ‡é’ˆ</h4><p>ä¸å®‰å…¨ Rust æ‹¥æœ‰ä¸¤ç§ç±»ä¼¼äºå¼•ç”¨çš„æ–°æŒ‡é’ˆç±»å‹ï¼Œéƒ½è¢«å«åš<strong>è£¸æŒ‡é’ˆï¼ˆraw pointerï¼‰</strong>ã€‚ä¸å¼•ç”¨ç±»ä¼¼ï¼Œè£¸æŒ‡é’ˆè¦ä¹ˆæ˜¯å¯å˜çš„ï¼Œè¦ä¹ˆæ˜¯ä¸å¯å˜çš„ï¼Œåˆ†åˆ«å†™ä½œ <code>*const T</code> å’Œ <code>*mut T</code>ã€‚è¿™é‡Œçš„æ˜Ÿå· <code>*</code> æ˜¯ç±»å‹åçš„ä¸€éƒ¨åˆ†è€Œä¸ä»£è¡¨è§£å¼•ç”¨æ“ä½œã€‚</p><p>è£¸æŒ‡é’ˆä¸å¼•ç”¨ã€æ™ºèƒ½æŒ‡é’ˆçš„åŒºåˆ«ï¼š</p><ul><li>å…è®¸å¿½ç•¥å€Ÿç”¨è§„åˆ™ï¼Œå¯ä»¥åŒæ—¶æ‹¥æœ‰æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€çš„å¯å˜å’Œä¸å¯å˜æŒ‡é’ˆï¼Œæˆ–è€…æ‹¥æœ‰æŒ‡å‘åŒä¸€ä¸ªåœ°å€çš„å¤šä¸ªå¯å˜æŒ‡é’ˆ</li><li>ä¸èƒ½ä¿è¯è‡ªå·±æ€»æ˜¯æŒ‡å‘äº†æœ‰æ•ˆçš„å†…å­˜åœ°å€</li><li>å…è®¸ä¸ºç©º</li><li>æ²¡æœ‰å®ç°ä»»ä½•è‡ªåŠ¨æ¸…ç†æœºåˆ¶</li></ul><p>åœ¨é¿å… Rust å¼ºåˆ¶æ‰§è¡ŒæŸäº›ä¿éšœåï¼Œå°±èƒ½å¤Ÿä»¥æ”¾å¼ƒå®‰å…¨ä¿éšœä¸ºä»£ä»·æ¢å–æ›´å¥½çš„æ€§èƒ½ï¼Œæˆ–è€…ä¸å…¶ä»–è¯­è¨€ã€ç¡¬ä»¶è¿›è¡Œäº¤äº’çš„èƒ½åŠ›ã€‚</p><p><strong>é€šè¿‡å¼•ç”¨åˆ›å»ºè£¸æŒ‡é’ˆ</strong><br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> num = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> r1 = &amp;num <span class="keyword">as</span> *<span class="keyword">const</span> <span class="built_in">i32</span>;</span><br><span class="line">    <span class="keyword">let</span> r2 = &amp;<span class="keyword">mut</span> num <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">i32</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°ä»£ç ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨ <code>unsafe</code> å…³é”®å­—ã€‚ä½ å¯ä»¥åœ¨å®‰å…¨ä»£ç å†…åˆæ³•åœ°åˆ›å»ºè£¸æŒ‡é’ˆï¼Œä½†ä¸èƒ½åœ¨ä¸å®‰å…¨ä»£ç å—å¤–è§£å¼•ç”¨è£¸æŒ‡é’ˆã€‚</p><p>åˆ›å»ºä¸€ä¸ªæŒ‡å‘ä»»æ„å†…å­˜åœ°å€çš„è£¸æŒ‡é’ˆï¼Œè¿™ä¸ªåœ°å€å¯èƒ½æœ‰æ•°æ®ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰æ•°æ®ï¼Œå› æ­¤æ— æ³•ç¡®å®šå…¶æœ‰æ•ˆæ€§ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> address = <span class="number">0x012345usize</span>;</span><br><span class="line"><span class="keyword">let</span> r = address <span class="keyword">as</span> *<span class="keyword">const</span> <span class="built_in">i32</span>;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†ä½¿ç”¨ <code>*</code> è§£å¼•ç”¨è£¸æŒ‡é’ˆï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ª <code>unsafe</code> å—ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> num = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> r1 = &amp;num <span class="keyword">as</span> *<span class="keyword">const</span> <span class="built_in">i32</span>;</span><br><span class="line">    <span class="keyword">let</span> r2 = &amp;<span class="keyword">mut</span> num <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">i32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"r1 is: &#123;&#125;"</span>, *r1);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"r2 is: &#123;&#125;"</span>, *r2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ä½¿ç”¨è£¸æŒ‡é’ˆæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºåŒæ—¶æŒ‡å‘åŒä¸€åœ°å€çš„å¯å˜æŒ‡é’ˆå’Œä¸å¯å˜æŒ‡é’ˆï¼Œå¹¶é€šè¿‡å¯å˜æŒ‡é’ˆæ¥ä¿®æ”¹æ•°æ®ã€‚è¿™æ ·çš„ä¿®æ”¹æ“ä½œä¼šå¯¼è‡´æ½œåœ¨çš„æ•°æ®ç«äº‰ã€‚<br>è£¸æŒ‡é’ˆä¸»è¦ç”¨æ¥ä¸ C ä»£ç æ¥å£è¿›è¡Œäº¤äº’ï¼Œæˆ–è€…æ„é€ ä¸€äº›å€Ÿç”¨æ£€æŸ¥å™¨æ— æ³•ç†è§£çš„å®‰å…¨æŠ½è±¡ã€‚</p><h4 id="è°ƒç”¨ä¸å®‰å…¨å‡½æ•°æˆ–æ–¹æ³•"><a href="#è°ƒç”¨ä¸å®‰å…¨å‡½æ•°æˆ–æ–¹æ³•" class="headerlink" title="è°ƒç”¨ä¸å®‰å…¨å‡½æ•°æˆ–æ–¹æ³•"></a>è°ƒç”¨ä¸å®‰å…¨å‡½æ•°æˆ–æ–¹æ³•</h4><p>é™¤äº†åœ¨å®šä¹‰å‰é¢è¦æ ‡è®° <code>unsafe</code>ï¼Œä¸å®‰å…¨å‡½æ•°æˆ–æ–¹æ³•çœ‹ä¸Šå»ä¸æ­£å¸¸çš„å‡½æ•°æˆ–æ–¹æ³•å‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚<br>è¿™é‡Œçš„ <code>unsafe</code> å…³é”®å­—æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶æ‰‹åŠ¨æ»¡è¶³ä¸€äº›å…ˆå†³æ¡ä»¶ï¼Œå› ä¸º Rust æ— æ³•å¯¹è¿™äº›æ¡ä»¶è¿›è¡ŒéªŒè¯ã€‚é€šè¿‡åœ¨ <code>unsafe</code> ä»£ç å—ä¸­è°ƒç”¨ä¸å®‰å…¨å‡½æ•°ï¼Œæˆ‘ä»¬å‘ Rust è¡¨æ˜è‡ªå·±ç¡®å®ç†è§£å¹¶å®ç°äº†ç›¸å…³çº¦å®šã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">dangerous</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">    dangerous();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å› ä¸ºä¸å®‰å…¨å‡½æ•°çš„å‡½æ•°ä½“ä¹Ÿæ˜¯ <code>unsafe</code> ä»£ç å—ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨ä¸€ä¸ªä¸å®‰å…¨å‡½æ•°ä¸­æ‰§è¡Œå…¶ä»–ä¸å®‰å…¨æ“ä½œè€Œæ— éœ€æ·»åŠ é¢å¤–çš„ <code>unsafe</code> ä»£ç å—ã€‚</p><h5 id="åˆ›å»ºä¸å®‰å…¨ä»£ç çš„å®‰å…¨æŠ½è±¡"><a href="#åˆ›å»ºä¸å®‰å…¨ä»£ç çš„å®‰å…¨æŠ½è±¡" class="headerlink" title="åˆ›å»ºä¸å®‰å…¨ä»£ç çš„å®‰å…¨æŠ½è±¡"></a>åˆ›å»ºä¸å®‰å…¨ä»£ç çš„å®‰å…¨æŠ½è±¡</h5><p>å‡½æ•°ä¸­åŒ…å«ä¸å®‰å…¨ä»£ç å¹¶ä¸æ„å‘³ç€æˆ‘ä»¬éœ€è¦å°†æ•´ä¸ªå‡½æ•°éƒ½æ ‡è®°ä¸ºä¸å®‰å…¨çš„ã€‚å®é™…ä¸Šï¼Œå°†ä¸å®‰å…¨ä»£ç å°è£…åœ¨å®‰å…¨å‡½æ•°ä¸­æ˜¯ä¸€ç§ååˆ†å¸¸è§çš„æŠ½è±¡ã€‚</p><p>æ¯”å¦‚æ ‡å‡†åº“ä¸­ä½¿ç”¨äº†ä¸å®‰å…¨ä»£ç çš„ <code>split_at_mut</code> å‡½æ•°ã€‚è¿™ä¸ªå®‰å…¨æ–¹æ³•è¢«å®šä¹‰åœ¨å¯å˜åˆ‡ç‰‡ä¸Šï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªåˆ‡ç‰‡å¹¶ä»ç»™å®šçš„ç´¢å¼•å‚æ•°å¤„å°†å…¶åˆ†å‰²ä¸ºä¸¤ä¸ªåˆ‡ç‰‡ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="keyword">let</span> r = &amp;<span class="keyword">mut</span> v[..];</span><br><span class="line">    <span class="keyword">let</span> (a, b) = r.split_at_mut(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(a, &amp;<span class="keyword">mut</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(b, &amp;<span class="keyword">mut</span> [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬æ— æ³•ä»…ä»…ä½¿ç”¨å®‰å…¨ Rust æ¥å®ç°è¿™ä¸ªå‡½æ•°ã€‚æ¯”å¦‚å°è¯•ç”¨å®‰å…¨ä»£ç å°† <code>split_at_mut</code> å®ç°ä¸ºå‡½æ•°ï¼Œå¹¶åªå¤„ç† i32 ç±»å‹çš„åˆ‡ç‰‡ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">split_at_mut</span></span>(slice: &amp;<span class="keyword">mut</span> [<span class="built_in">i32</span>], mid: <span class="built_in">usize</span>) -&gt; (&amp;<span class="keyword">mut</span> [<span class="built_in">i32</span>], &amp;<span class="keyword">mut</span> [<span class="built_in">i32</span>]) &#123;</span><br><span class="line">    <span class="keyword">let</span> len = slice.len();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert!</span>(mid &lt;= len);</span><br><span class="line"></span><br><span class="line">    (&amp;<span class="keyword">mut</span> slice[..mid], &amp;<span class="keyword">mut</span> slice[mid..])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªå‡½æ•°ä¼šé¦–å…ˆå–å¾—æ•´ä¸ªåˆ‡ç‰‡çš„é•¿åº¦ï¼Œå¹¶é€šè¿‡æ–­è¨€æ£€æŸ¥ç»™å®šçš„å‚æ•°æ˜¯å¦å°äºæˆ–ç­‰äºå½“å‰åˆ‡ç‰‡çš„é•¿åº¦ã€‚è‹¥å¤§äºåˆ™ä¼šåœ¨å°è¯•ä½¿ç”¨è¯¥ç´¢å¼•å‰è§¦å‘ panicã€‚<br>æˆ‘ä»¬ä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå¯å˜åˆ‡ç‰‡çš„å…ƒç»„ï¼Œä¸€ä¸ªä»åŸåˆ‡ç‰‡çš„èµ·å§‹ä½ç½®åˆ° <code>mid</code> ç´¢å¼•çš„ä½ç½®ï¼Œå¦ä¸€ä¸ªåˆ™ä» <code>mid</code> ç´¢å¼•çš„ä½ç½®åˆ°åŸåˆ‡ç‰‡çš„æœ«å°¾ã€‚</p><p>å°è¯•ç¼–è¯‘ä¸Šè¿°ä»£ç ä¼šè§¦å‘ <code>error[E0499]: cannot borrow `*slice` as mutable more than once at a time</code> é”™è¯¯ã€‚<br>Rust çš„å€Ÿç”¨æ£€æŸ¥å™¨æ— æ³•ç†è§£æˆ‘ä»¬æ­£åœ¨å€Ÿç”¨ä¸€ä¸ªåˆ‡ç‰‡çš„ä¸åŒéƒ¨åˆ†ï¼Œå®ƒåªçŸ¥é“æˆ‘ä»¬å€Ÿç”¨äº†ä¸¤æ¬¡åŒä¸€ä¸ªåˆ‡ç‰‡ã€‚å€Ÿç”¨ä¸€ä¸ªåˆ‡ç‰‡çš„ä¸åŒéƒ¨åˆ†ä»åŸç†ä¸Šæ¥è®²æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œå› ä¸ºæ²¡æœ‰äº¤å‰çš„åœ°æ–¹ã€‚ä½† Rust æ²¡æœ‰è¶³å¤Ÿæ™ºèƒ½åˆ°ç†è§£è¿™äº›ä¿¡æ¯ã€‚æ­¤ç±»åœºæ™¯å³é€‚ç”¨äºä¸å®‰å…¨ä»£ç ã€‚</p><p>ä½¿ç”¨ <code>unsafe</code>ã€è£¸æŒ‡é’ˆåŠä¸€äº›ä¸å®‰å…¨å‡½æ•°å®ç° <code>split_at_mut</code>ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::slice;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">split_at_mut</span></span>(slice: &amp;<span class="keyword">mut</span> [<span class="built_in">i32</span>], mid: <span class="built_in">usize</span>) -&gt; (&amp;<span class="keyword">mut</span> [<span class="built_in">i32</span>], &amp;<span class="keyword">mut</span> [<span class="built_in">i32</span>]) &#123;</span><br><span class="line">    <span class="keyword">let</span> len = slice.len();</span><br><span class="line">    <span class="keyword">let</span> ptr = slice.as_mut_ptr();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert!</span>(mid &lt;= len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        (</span><br><span class="line">            slice::from_raw_parts_mut(ptr, mid),</span><br><span class="line">            slice::from_raw_parts_mut(ptr.offset(mid <span class="keyword">as</span> <span class="built_in">isize</span>), len - mid),</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="keyword">let</span> r = &amp;<span class="keyword">mut</span> v[..];</span><br><span class="line">    <span class="keyword">let</span> (a, b) = split_at_mut(r, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(a, &amp;<span class="keyword">mut</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(b, &amp;<span class="keyword">mut</span> [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ unsafe ä»£ç ä¸­ï¼Œ<code>slice::from_raw_parts_mut</code> å‡½æ•°æ¥æ”¶ä¸€ä¸ªè£¸æŒ‡é’ˆå’Œé•¿åº¦æ¥åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ã€‚è¿™é‡Œä½¿ç”¨è¯¥å‡½æ•°ä» <code>ptr</code> å¤„åˆ›å»ºäº†ä¸€ä¸ªæ‹¥æœ‰ <code>mid</code> ä¸ªå…ƒç´ çš„åˆ‡ç‰‡ï¼Œæ¥ç€åˆåœ¨ <code>ptr</code> ä¸Šä½¿ç”¨ <code>mid</code> ä½œä¸ºåç§»é‡å‚æ•°è°ƒç”¨ <code>offset</code> æ–¹æ³•å¾—åˆ°äº†ä¸€ä¸ªä» <code>mid</code> å¤„å¼€å§‹çš„è£¸æŒ‡é’ˆï¼Œå¹¶åŸºäºå®ƒåˆ›å»ºäº†å¦å¤–ä¸€ä¸ªèµ·å§‹äº <code>mid</code> å¤„ä¸”æ‹¥æœ‰å‰©ä½™æ‰€æœ‰å…ƒç´ çš„åˆ‡ç‰‡ã€‚</p><p>å‡½æ•° <code>slice::from_raw_parts_mut</code> æ¥æ”¶ä¸€ä¸ªè£¸æŒ‡é’ˆä½œä¸ºå‚æ•°å¹¶é»˜è®¤è¯¥å‚æ•°çš„åˆæ³•æ€§ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸å®‰å…¨çš„ã€‚è£¸æŒ‡é’ˆçš„ <code>offset</code> æ–¹æ³•é»˜è®¤æ­¤åœ°å€çš„åç§»é‡ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æŒ‡é’ˆï¼Œå®ƒä¹Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚<br>å› æ­¤æˆ‘ä»¬å¿…é¡»åœ¨ <code>unsafe</code> ä»£ç å—ä¸­è°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ã€‚é€šè¿‡å®¡æŸ¥ä»£ç å¹¶æ·»åŠ æ–­è¨€ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®š <code>unsafe</code> ä¸­çš„è£¸æŒ‡é’ˆéƒ½ä¼šæŒ‡å‘æœ‰æ•ˆçš„åˆ‡ç‰‡æ•°æ®ä¸”ä¸ä¼šäº§ç”Ÿæ•°æ®ç«äº‰ã€‚è¿™å°±æ˜¯ä¸€ä¸ªæ°å½“çš„ <code>unsafe</code> ä½¿ç”¨åœºæ™¯ã€‚</p><p>ä»£ç æ²¡æœ‰å°† <code>split_at_mut</code> å‡½æ•°æ ‡è®°ä¸º <code>unsafe</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å®‰å…¨ Rust ä¸­è°ƒç”¨è¯¥å‡½æ•°ã€‚è¿™å°±æ˜¯å¯¹ä¸å®‰å…¨ä»£ç çš„å®‰å…¨æŠ½è±¡ã€‚</p><p>ä¸ä¸Šè¿°ä»£ç ç›¸åï¼Œä¸‹é¢å¯¹ <code>slice::from_raw_parts_mut</code> å‡½æ•°çš„è°ƒç”¨å°±å¾ˆæœ‰å¯èƒ½å¯¼è‡´å´©æºƒã€‚å…¶è¯•å›¾ç”¨ä¸€ä¸ªéšæ„çš„å†…å­˜åœ°å€æ¥åˆ›å»ºæ‹¥æœ‰ 10000 ä¸ªå…ƒç´ çš„åˆ‡ç‰‡ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::slice;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> address = <span class="number">0x01234usize</span>;</span><br><span class="line">    <span class="keyword">let</span> r = address <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">i32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> slice: &amp;[<span class="built_in">i32</span>] = <span class="keyword">unsafe</span> &#123; slice::from_raw_parts_mut(r, <span class="number">10000</span>) &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, slice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="ä½¿ç”¨-extern-å‡½æ•°è°ƒç”¨å¤–éƒ¨ä»£ç "><a href="#ä½¿ç”¨-extern-å‡½æ•°è°ƒç”¨å¤–éƒ¨ä»£ç " class="headerlink" title="ä½¿ç”¨ extern å‡½æ•°è°ƒç”¨å¤–éƒ¨ä»£ç "></a>ä½¿ç”¨ <code>extern</code> å‡½æ•°è°ƒç”¨å¤–éƒ¨ä»£ç </h5><p>Rust ä»£ç å¯èƒ½éœ€è¦ä¸å¦å¤–ä¸€ç§è¯­è¨€ç¼–å†™çš„ä»£ç è¿›è¡Œäº¤äº’ã€‚Rust ä¸ºæ­¤æä¾›äº† <code>extern</code> å…³é”®å­—æ¥ç®€åŒ–åˆ›å»ºå’Œä½¿ç”¨<strong>å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼‰</strong>çš„è¿‡ç¨‹ã€‚<br>ä»»ä½• <code>extern</code> å—ä¸­å£°æ˜çš„å‡½æ•°éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚å› ä¸ºå…¶ä»–è¯­è¨€ä¸ä¼šå¼ºåˆ¶æ‰§è¡Œ Rust éµå®ˆçš„è§„åˆ™ï¼ŒRust åˆæ— æ³•å¯¹å®ƒä»¬è¿›è¡Œæ£€æŸ¥ã€‚å› æ­¤ä¿è¯å®‰å…¨çš„è´£ä»»å°±è½åˆ°äº†å¼€å‘è€…èº«ä¸Šã€‚</p><p>ä¸‹é¢çš„ä»£ç é›†æˆäº† C æ ‡å‡†åº“ä¸­çš„ <code>abs</code> å‡½æ•°ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">abs</span></span>(input: <span class="built_in">i32</span>) -&gt; <span class="built_in">i32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Absolute value of -3: &#123;&#125;"</span>, abs(-<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="è®¿é—®æˆ–ä¿®æ”¹é™æ€å˜é‡"><a href="#è®¿é—®æˆ–ä¿®æ”¹é™æ€å˜é‡" class="headerlink" title="è®¿é—®æˆ–ä¿®æ”¹é™æ€å˜é‡"></a>è®¿é—®æˆ–ä¿®æ”¹é™æ€å˜é‡</h4><p>Rust æ”¯æŒå…¨å±€å˜é‡ï¼Œä½†åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¯èƒ½å› ä¸ºæ‰€æœ‰æƒæœºåˆ¶è€Œäº§ç”ŸæŸäº›é—®é¢˜ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªå¯å˜çš„å…¨å±€å˜é‡ï¼Œå°±ä¼šäº§ç”Ÿæ•°æ®ç«äº‰ã€‚<br>å…¨å±€å˜é‡ä¹Ÿè¢«ç§°ä¸º<strong>é™æ€ï¼ˆstaticï¼‰å˜é‡</strong>ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> HELLO_WORLD: &amp;<span class="built_in">str</span> = <span class="string">"Hello World"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"name is: &#123;&#125;"</span>, HELLO_WORLD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é™æ€å˜é‡å¿…é¡»è¦æ ‡æ³¨ç±»å‹ï¼Œè®¿é—®ä¸€ä¸ªä¸å¯å˜çš„é™æ€å˜é‡æ˜¯å®‰å…¨çš„ã€‚<br>é™æ€å˜é‡çš„å€¼åœ¨å†…å­˜ä¸­æ‹¥æœ‰å›ºå®šçš„åœ°å€ï¼Œä½¿ç”¨å®ƒçš„å€¼æ€»ä¼šè®¿é—®åˆ°åŒæ ·çš„æ•°æ®ã€‚è€Œå¸¸é‡åˆ™å…è®¸åœ¨ä»»ä½•è¢«ä½¿ç”¨åˆ°çš„æ—¶å€™å¤åˆ¶å…¶æ•°æ®ã€‚<br>ä¸å¸¸é‡ä¸åŒçš„æ˜¯ï¼Œé™æ€å˜é‡æ˜¯å¯å˜çš„ã€‚ä½†è®¿é—®å’Œä¿®æ”¹å¯å˜çš„é™æ€å˜é‡æ˜¯ä¸å®‰å…¨çš„ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> COUNTER: <span class="built_in">u32</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">add_to_count</span></span>(inc: <span class="built_in">u32</span>) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        COUNTER += inc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    add_to_count(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"COUNTER: &#123;&#125;"</span>, COUNTER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œä»»ä½•è¯»å†™é™æ€å˜é‡ <code>COUNTER</code> çš„ä»£ç éƒ½å¿…é¡»ä½äº <code>unsafe</code> ä»£ç å—ä¸­ã€‚</p><h4 id="å®ç°ä¸å®‰å…¨-trait"><a href="#å®ç°ä¸å®‰å…¨-trait" class="headerlink" title="å®ç°ä¸å®‰å…¨ trait"></a>å®ç°ä¸å®‰å…¨ trait</h4><p>å½“æŸä¸ª trait ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªæ–¹æ³•æ‹¥æœ‰ç¼–è¯‘å™¨æ— æ³•æ ¡éªŒçš„ä¸å®‰å…¨å› ç´ æ—¶ï¼Œæˆ‘ä»¬å°±ç§°è¿™ä¸ª trait æ˜¯ä¸å®‰å…¨çš„ã€‚å¯ä»¥åœ¨ trait å®šä¹‰çš„å‰é¢åŠ ä¸Š <code>unsafe</code> å…³é”®å­—æ¥å£°æ˜ä¸€ä¸ªä¸å®‰å…¨ traitï¼ŒåŒæ—¶è¯¥ trait ä¹Ÿåªèƒ½åœ¨ <code>unsafe</code> ä»£ç å—ä¸­å®ç°ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="class"><span class="keyword">trait</span> <span class="title">Foo</span></span> &#123;</span><br><span class="line">    <span class="comment">// æŸäº›æ–¹æ³•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> Foo <span class="keyword">for</span> <span class="built_in">i32</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹åº”çš„æ–¹æ³•å®ç°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡ä½¿ç”¨ <code>unsafe impl</code>ï¼Œæˆ‘ä»¬å‘ Rust ä¿è¯æˆ‘ä»¬ä¼šæ‰‹åŠ¨ç»´æŠ¤å¥½é‚£äº›ç¼–è¯‘å™¨æ— æ³•éªŒè¯çš„ä¸å®‰å…¨å› ç´ ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener">The Rust Programming Language</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Rust å†…éƒ¨éšè—äº†ä¸€ç§ä¸ä¼šå¼ºåˆ¶å®æ–½å†…å­˜å®‰å…¨ä¿éšœçš„è¯­è¨€ï¼š&lt;strong&gt;ä¸å®‰å…¨ Rust&lt;/strong&gt;ã€‚&lt;br&gt;å…¶ä¹‹æ‰€ä»¥å­˜åœ¨ï¼Œæ˜¯å› ä¸ºé™æ€åˆ†æä»æœ¬è´¨ä¸Šè®²æ˜¯ä¿å®ˆçš„ï¼Œå®ƒå®å¯é”™æ€ä¸€äº›åˆæ³•ç¨‹åºä¹Ÿä¸ä¼šæ¥å—å¯èƒ½éæ³•çš„ä»£ç ã€‚&lt;br&gt;ä½¿ç”¨ä¸å®‰å…¨ä»£ç çš„ç¼ºç‚¹åœ¨äºç¨‹åºå‘˜éœ€è¦å¯¹è‡ªå·±çš„è¡Œä¸ºè´Ÿè´£ã€‚è‹¥
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Rust" scheme="https://rollingstarky.github.io/tags/Rust/"/>
    
      <category term="Pointer" scheme="https://rollingstarky.github.io/tags/Pointer/"/>
    
      <category term="Memory" scheme="https://rollingstarky.github.io/tags/Memory/"/>
    
      <category term="Unsafe" scheme="https://rollingstarky.github.io/tags/Unsafe/"/>
    
  </entry>
  
  <entry>
    <title>The Rust programming language è¯»ä¹¦ç¬”è®°â€”â€”å¹¶å‘</title>
    <link href="https://rollingstarky.github.io/2021/07/29/the-rust-programming-language-reading-notes-concurrency/"/>
    <id>https://rollingstarky.github.io/2021/07/29/the-rust-programming-language-reading-notes-concurrency/</id>
    <published>2021-07-28T16:00:00.000Z</published>
    <updated>2021-07-28T16:58:34.590Z</updated>
    
    <content type="html"><![CDATA[<p><strong>å¹¶å‘ç¼–ç¨‹ï¼ˆconcurrent programmingï¼‰</strong>å…è®¸ç¨‹åºä¸­çš„ä¸åŒéƒ¨åˆ†ç›¸äº’ç‹¬ç«‹åœ°è¿è¡Œï¼Œè€Œ<strong>å¹¶è¡Œç¼–ç¨‹ï¼ˆparallel programmingï¼‰</strong>åˆ™å…è®¸ç¨‹åºä¸­çš„ä¸åŒéƒ¨åˆ†åŒæ—¶æ‰§è¡Œã€‚<br>Rust ä¸­çš„æ‰€æœ‰æƒå’Œç±»å‹ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¸®åŠ©å¼€å‘è€…ç®¡ç†å†…å­˜å®‰å…¨åŠå¹¶å‘é—®é¢˜ã€‚</p><p>é«˜çº§è¯­è¨€å¾€å¾€é€šè¿‡æ”¾å¼ƒéƒ¨åˆ†æ§åˆ¶èƒ½åŠ›æ¥è·å¾—æœ‰ç›Šäºç”¨æˆ·çš„æŠ½è±¡ï¼Œå› æ­¤åªæ”¯æŒå…¨éƒ¨è§£å†³æ–¹æ¡ˆçš„ä¸€éƒ¨åˆ†æ˜¯å¯ä»¥ç†è§£çš„è®¾è®¡ç­–ç•¥ã€‚æ¯”å¦‚ Erlang æä¾›äº†ä¸€å¥—ä¼˜é›…çš„æ¶ˆæ¯ä¼ é€’å¹¶å‘ç‰¹æ€§ï¼Œä½†æ²¡æœ‰æä¾›å¯ä»¥åœ¨çº¿ç¨‹é—´å…±äº«çŠ¶æ€çš„ç®€å•æ–¹æ³•ã€‚<br>åº•å±‚è¯­è¨€è¢«æœŸæœ›åœ¨ä»»æ„åœºæ™¯ä¸‹éƒ½å¯ä»¥æä¾›ä¸€å¥—æ€§èƒ½æœ€ä½³çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶å¯¹ç¡¬ä»¶å»ºç«‹å°½å¯èƒ½å°‘çš„æŠ½è±¡ï¼Œå› æ­¤ Rust æä¾›äº†å¤šç§å»ºæ¨¡å¹¶å‘é—®é¢˜çš„å·¥å…·ã€‚</p><h4 id="ä½¿ç”¨çº¿ç¨‹åŒæ—¶è¿è¡Œä»£ç "><a href="#ä½¿ç”¨çº¿ç¨‹åŒæ—¶è¿è¡Œä»£ç " class="headerlink" title="ä½¿ç”¨çº¿ç¨‹åŒæ—¶è¿è¡Œä»£ç "></a>ä½¿ç”¨çº¿ç¨‹åŒæ—¶è¿è¡Œä»£ç </h4><p>å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œï¼Œå› æ­¤å°†ç¨‹åºä¸­çš„è®¡ç®—æ“ä½œæ‹†åˆ†è‡³å¤šä¸ªçº¿ç¨‹å¯ä»¥æé«˜æ€§èƒ½ã€‚ä½†ä¹Ÿå¢åŠ äº†ç¨‹åºçš„å¤æ‚åº¦ï¼Œå› ä¸º<strong>ä¸åŒçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…·ä½“é¡ºåºæ˜¯æ— æ³•ç¡®å®šçš„</strong>ã€‚å¯èƒ½å¯¼è‡´ä¸‹åˆ—é—®é¢˜ï¼š</p><ul><li>å½“å¤šä¸ªçº¿ç¨‹ä»¥ä¸ä¸€è‡´çš„é¡ºåºè®¿é—®æ•°æ®æˆ–èµ„æºæ—¶äº§ç”Ÿçš„<strong>ç«äº‰çŠ¶æ€ï¼ˆrace conditionï¼‰</strong></li><li>å½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å°è¯•è·å–å¯¹æ–¹æŒæœ‰çš„èµ„æºæ—¶äº§ç”Ÿçš„<strong>æ­»é”ï¼ˆdeadlockï¼‰</strong>ï¼Œä¼šå¯¼è‡´è¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½æ— æ³•ç»§ç»­è¿è¡Œ</li><li>åªä¼šå‡ºç°åœ¨ç‰¹å®šæƒ…å½¢ä¸‹ä¸”éš¾ä»¥ç¨³å®šå¤ç°å’Œä¿®å¤çš„ bug</li></ul><h5 id="ä½¿ç”¨-spawn-åˆ›å»ºæ–°çº¿ç¨‹"><a href="#ä½¿ç”¨-spawn-åˆ›å»ºæ–°çº¿ç¨‹" class="headerlink" title="ä½¿ç”¨ spawn åˆ›å»ºæ–°çº¿ç¨‹"></a>ä½¿ç”¨ <code>spawn</code> åˆ›å»ºæ–°çº¿ç¨‹</h5><p>å¯ä»¥è°ƒç”¨ <code>thread::spawn</code> å‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°ï¼Œè¯¥é—­åŒ…ä¼šåŒ…å«æˆ‘ä»¬æƒ³è¦åœ¨æ–°çº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    thread::spawn(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"hi number &#123;&#125; from the spawned thread!"</span>, i);</span><br><span class="line">            thread::sleep(Duration::from_millis(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"hi number &#123;&#125; from the main thread!"</span>, i);</span><br><span class="line">        thread::sleep(Duration::from_millis(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hi number 1 from the main thread!</span><br><span class="line">hi number 1 from the spawned thread!</span><br><span class="line">hi number 2 from the main thread!</span><br><span class="line">hi number 2 from the spawned thread!</span><br><span class="line">hi number 3 from the main thread!</span><br><span class="line">hi number 3 from the spawned thread!</span><br><span class="line">hi number 4 from the main thread!</span><br><span class="line">hi number 4 from the spawned thread!</span><br><span class="line">hi number 5 from the spawned thread!</span><br></pre></td></tr></table></figure></p><p>ä¸»çº¿ç¨‹é¦–å…ˆæ‰“å°å‡ºäº†æ–‡æœ¬ï¼Œå³ä¾¿æ–°çº¿ç¨‹çš„æ‰“å°è¯­å¥å‡ºç°å¾—æ›´æ—©ä¸€äº›ã€‚è¿™äº›çº¿ç¨‹å¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œï¼Œæ‰§è¡Œé¡ºåºç”±æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ç­–ç•¥å†³å®šã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªè¦ä¸Šè¿°ç¨‹åºä¸­çš„ä¸»çº¿ç¨‹è¿è¡Œç»“æŸï¼Œåˆ›å»ºå‡ºçš„æ–°çº¿ç¨‹ä¹Ÿä¼šåœæ­¢ï¼Œä¸ç®¡å…¶æ‰“å°ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚<br>è™½ç„¶æˆ‘ä»¬è¦æ±‚æ–°çº¿ç¨‹ä¸åœæ‰“å°æ–‡æœ¬ç›´åˆ° <code>i</code> è¿­ä»£åˆ° 9ï¼Œä½†å®ƒåœ¨ä¸»çº¿ç¨‹åœæ­¢å‰ä»…è¿­ä»£åˆ°äº† 5ã€‚</p><h5 id="ä½¿ç”¨-join-å¥æŸ„ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ"><a href="#ä½¿ç”¨-join-å¥æŸ„ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ" class="headerlink" title="ä½¿ç”¨ join å¥æŸ„ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ"></a>ä½¿ç”¨ <code>join</code> å¥æŸ„ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ</h5><p><code>thread::spawn</code> çš„è¿”å›ç±»å‹æ˜¯ä¸€ä¸ªè‡ªæŒæœ‰æ‰€æœ‰æƒçš„ <code>joinHandle</code>ï¼Œè°ƒç”¨å®ƒçš„ <code>join</code> æ–¹æ³•å¯ä»¥é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å¯¹åº”çš„æ–°çº¿ç¨‹è¿è¡Œç»“æŸã€‚</p><p>è°ƒç”¨ <code>join</code> æ–¹æ³•ä¿è¯æ–°çº¿ç¨‹èƒ½å¤Ÿåœ¨ <code>main</code> å‡½æ•°é€€å‡ºå‰æ‰§è¡Œå®Œæ¯•ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> handle = thread::spawn(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"hi number &#123;&#125; from the spawned thread!"</span>, i);</span><br><span class="line">            thread::sleep(Duration::from_millis(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"hi number &#123;&#125; from the main thread!"</span>, i);</span><br><span class="line">        thread::sleep(Duration::from_millis(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    handle.join().unwrap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hi number 1 from the main thread!</span><br><span class="line">hi number 1 from the spawned thread!</span><br><span class="line">hi number 2 from the main thread!</span><br><span class="line">hi number 2 from the spawned thread!</span><br><span class="line">hi number 3 from the main thread!</span><br><span class="line">hi number 3 from the spawned thread!</span><br><span class="line">hi number 4 from the main thread!</span><br><span class="line">hi number 4 from the spawned thread!</span><br><span class="line">hi number 5 from the spawned thread!</span><br><span class="line">hi number 6 from the spawned thread!</span><br><span class="line">hi number 7 from the spawned thread!</span><br><span class="line">hi number 8 from the spawned thread!</span><br><span class="line">hi number 9 from the spawned thread!</span><br></pre></td></tr></table></figure></p><p>å‡å¦‚å°† <code>handle.join()</code> æ”¾ç½®åˆ° <code>main</code> å‡½æ•°çš„ <code>for</code> å¾ªç¯ä¹‹å‰ï¼Œå³ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> handle = thread::spawn(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"hi number &#123;&#125; from the spawned thread!"</span>, i);</span><br><span class="line">            thread::sleep(Duration::from_millis(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    handle.join().unwrap();</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"hi number &#123;&#125; from the main thread!"</span>, i);</span><br><span class="line">        thread::sleep(Duration::from_millis(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œç”±äºä¸»çº¿ç¨‹ä¼šç­‰å¾…æ–°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åæ‰å¼€å§‹æ‰§è¡Œè‡ªå·±çš„ <code>for</code> å¾ªç¯ï¼Œç¨‹åºçš„è¾“å‡ºå°†ä¸å†å‡ºç°äº¤æ›¿çš„æƒ…å½¢ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hi number 1 from the spawned thread!</span><br><span class="line">hi number 2 from the spawned thread!</span><br><span class="line">hi number 3 from the spawned thread!</span><br><span class="line">hi number 4 from the spawned thread!</span><br><span class="line">hi number 5 from the spawned thread!</span><br><span class="line">hi number 6 from the spawned thread!</span><br><span class="line">hi number 7 from the spawned thread!</span><br><span class="line">hi number 8 from the spawned thread!</span><br><span class="line">hi number 9 from the spawned thread!</span><br><span class="line">hi number 1 from the main thread!</span><br><span class="line">hi number 2 from the main thread!</span><br><span class="line">hi number 3 from the main thread!</span><br><span class="line">hi number 4 from the main thread!</span><br></pre></td></tr></table></figure></p><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œè¯¸å¦‚åœ¨å“ªé‡Œè°ƒç”¨ <code>join</code> ç­‰å¾®å°ç»†èŠ‚ä¹Ÿä¼šå½±å“åˆ°å¤šä¸ªçº¿ç¨‹æ˜¯å¦èƒ½å¤ŸåŒæ—¶è¿è¡Œã€‚</p><h5 id="åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨-move-é—­åŒ…"><a href="#åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨-move-é—­åŒ…" class="headerlink" title="åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨ move é—­åŒ…"></a>åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨ <code>move</code> é—­åŒ…</h5><p><code>move</code> é—­åŒ…å¸¸è¢«ç”¨æ¥ä¸ <code>thread::spawn</code> å‡½æ•°é…åˆä½¿ç”¨ï¼Œå…è®¸åœ¨æŸä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨æ¥è‡ªå¦ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> handle = thread::spawn(|| &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Here's a vector: &#123;:?&#125;"</span>, v);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    handle.join().unwrap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ç¼–è¯‘ä¸Šè¿°ä»£ç æ—¶ä¼šæŠ¥å‡º <code>error[E0373]: closure may outlive the current function, but it borrows `v`, which is owned by the current function</code> é”™è¯¯ã€‚<br>Rust åœ¨æ¨å¯¼å‡ºå¦‚ä½•æ•è· <code>v</code> åå†³å®šè®©é—­åŒ…å€Ÿç”¨ <code>v</code>ï¼Œå› ä¸ºé—­åŒ…ä¸­çš„ <code>println!</code> åªéœ€è¦ä½¿ç”¨ <code>v</code> çš„å¼•ç”¨ã€‚ä½† Rust ä¸çŸ¥é“æ–°çº¿ç¨‹ä¼šè¿è¡Œå¤šä¹…ï¼Œå› æ­¤å®ƒæ— æ³•ç¡®å®š <code>v</code> çš„å¼•ç”¨æ˜¯å¦ä¸€ç›´æœ‰æ•ˆã€‚</p><p>é€šè¿‡åœ¨é—­åŒ…å‰æ·»åŠ  <code>move</code> å…³é”®å­—ï¼Œä¼šå¼ºåˆ¶é—­åŒ…è·å¾—å®ƒæ‰€éœ€å€¼çš„æ‰€æœ‰æƒï¼Œè€Œä¸ä»…ä»…æ˜¯åŸºäº Rust çš„æ¨å¯¼æ¥è·å¾—å€¼çš„å€Ÿç”¨ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> handle = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Here's a vector: &#123;:?&#125;"</span>, v);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    handle.join().unwrap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="ä½¿ç”¨æ¶ˆæ¯ä¼ é€’åœ¨çº¿ç¨‹é—´è½¬ç§»æ•°æ®"><a href="#ä½¿ç”¨æ¶ˆæ¯ä¼ é€’åœ¨çº¿ç¨‹é—´è½¬ç§»æ•°æ®" class="headerlink" title="ä½¿ç”¨æ¶ˆæ¯ä¼ é€’åœ¨çº¿ç¨‹é—´è½¬ç§»æ•°æ®"></a>ä½¿ç”¨æ¶ˆæ¯ä¼ é€’åœ¨çº¿ç¨‹é—´è½¬ç§»æ•°æ®</h4><p>ä½¿ç”¨æ¶ˆæ¯ä¼ é€’ï¼ˆmessage passingï¼‰æœºåˆ¶æ¥ä¿è¯å¹¶å‘å®‰å…¨æ­£å˜å¾—è¶Šæ¥è¶Šæµè¡Œã€‚Go è¯­è¨€æ–‡æ¡£ä¸­çš„å£å·æ­£ä½“ç°äº†è¿™æ ·çš„æ€è·¯ï¼š<strong>ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜</strong>ã€‚</p><p>Rust çš„æ ‡å‡†åº“ä¸­å®ç°äº†ä¸€ä¸ªåä¸º<strong>é€šé“ï¼ˆchannelï¼‰</strong>çš„ç¼–ç¨‹æ¦‚å¿µï¼Œå¯ä»¥è¢«ç”¨æ¥å®ç°åŸºäºæ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æœºåˆ¶ã€‚<br>é€šé“ç”±å‘é€è€…ï¼ˆtransmitterï¼‰å’Œæ¥æ”¶è€…ï¼ˆreceiverï¼‰ä¸¤éƒ¨åˆ†ç»„æˆã€‚å‘é€è€…ä½äºé€šé“çš„ä¸Šæ¸¸ï¼Œæ¥æ”¶è€…ä½äºä¸‹æ¸¸ã€‚<br>æŸä¸€å¤„çš„ä»£ç å¯ä»¥é€šè¿‡è°ƒç”¨å‘é€è€…çš„æ–¹æ³•æ¥ä¼ é€æ•°æ®ï¼Œå¦ä¸€å¤„ä»£ç åˆ™å¯ä»¥é€šè¿‡æ£€æŸ¥æ¥æ”¶è€…æ¥è·å–æ•°æ®ã€‚<br>å½“å‘é€è€…æˆ–æ¥æ”¶è€…çš„ä»»ä½•ä¸€ç«¯è¢«ä¸¢å¼ƒï¼Œåˆ™ç›¸åº”çš„é€šé“è¢«å…³é—­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::channel();</span><br><span class="line"></span><br><span class="line">    thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> val = <span class="built_in">String</span>::from(<span class="string">"hi"</span>);</span><br><span class="line">        tx.send(val).unwrap();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> received = rx.recv().unwrap();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Got: &#123;&#125;"</span>, received);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; Got: hi</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä½¿ç”¨ <code>mpsc::channel</code> å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„é€šé“ã€‚<strong>mpsc</strong> æ˜¯è‹±æ–‡ <strong>multiple producer, single consum</strong>ï¼ˆå¤šä¸ªç”Ÿäº§è€…ï¼Œå•ä¸ªæ¶ˆè´¹è€…ï¼‰çš„ç¼©å†™ã€‚<br><code>mpsc::channel</code> ä¼šè¿”å›ä¸€ä¸ªå«æœ‰å‘é€ç«¯ä¸æ¥æ”¶ç«¯çš„å…ƒç»„ã€‚<br>å†ä½¿ç”¨ <code>thread::spawn</code> ç”Ÿæˆä¸€ä¸ªæ–°çº¿ç¨‹ã€‚ä¸ºäº†ä»¤æ–°çº¿ç¨‹æ‹¥æœ‰å‘é€ç«¯ <code>tx</code> çš„æ‰€æœ‰æƒï¼Œä½¿ç”¨ <code>move</code> å…³é”®å­—å°† <code>tx</code> ç§»åŠ¨åˆ°äº†é—­åŒ…çš„ç¯å¢ƒä¸­ã€‚<br>æ–°çº¿ç¨‹å¿…é¡»æ‹¥æœ‰é€šé“å‘é€ç«¯çš„æ‰€æœ‰æƒæ‰èƒ½é€šè¿‡é€šé“æ¥å‘é€æ¶ˆæ¯ã€‚<br>å‘é€ç«¯æä¾›äº† <code>send</code> æ–¹æ³•æ¥å¤„ç†æˆ‘ä»¬æƒ³è¦å‘é€çš„å€¼ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å› <code>Result&lt;T, E&gt;</code> ç±»å‹ä½œä¸ºç»“æœã€‚å½“æ¥æ”¶ç«¯å·²ç»è¢«ä¸¢å¼ƒè€Œæ— æ³•ç»§ç»­ä¼ é€’å†…å®¹æ—¶ï¼Œæ‰§è¡Œå‘é€æ“ä½œä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p><p>é€šé“çš„æ¥æ”¶ç«¯æœ‰ä¸¤ä¸ªå¯ç”¨äºè·å–æ¶ˆæ¯çš„æ–¹æ³•ã€‚å…¶ä¸­ <code>recv</code> ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ‰§è¡Œç›´åˆ°æœ‰å€¼è¢«ä¼ å…¥é€šé“ã€‚ä¸€æ—¦æœ‰å€¼ä¼ å…¥é€šé“ï¼Œ<code>recv</code> å°±ä¼šå°†å…¶åŒ…è£¹åœ¨ <code>Result&lt;T, E&gt;</code> ä¸­è¿”å›ã€‚è‹¥é€šé“çš„å‘é€ç«¯å…¨éƒ¨å…³é—­äº†ï¼Œ<code>recv</code> ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯æ¥è¡¨æ˜å½“å‰é€šé“å†ä¹Ÿæ²¡æœ‰å¯æ¥æ”¶çš„å€¼ã€‚<br><code>try_recv</code> æ–¹æ³•ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œå®ƒä¼šç«‹å³è¿”å› <code>Result&lt;T, E&gt;</code>ã€‚å½“é€šé“ä¸­å­˜åœ¨æ¶ˆæ¯æ—¶ï¼Œè¿”å›åŒ…å«è¯¥æ¶ˆæ¯çš„ <code>Ok</code> å˜ä½“ï¼›å¦åˆ™è¿”å› <code>Err</code> å˜ä½“ã€‚å¯ä»¥ç¼–å†™ä¸€ä¸ªä¸æ–­è°ƒç”¨ <code>try_recv</code> æ–¹æ³•çš„å¾ªç¯ï¼Œå¹¶åœ¨æœ‰æ¶ˆæ¯æ—¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œæ²¡æœ‰æ¶ˆæ¯æ—¶æ‰§è¡Œå…¶ä»–æŒ‡ä»¤ã€‚</p><h5 id="å‘é€å¤šä¸ªå€¼"><a href="#å‘é€å¤šä¸ªå€¼" class="headerlink" title="å‘é€å¤šä¸ªå€¼"></a>å‘é€å¤šä¸ªå€¼</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::channel();</span><br><span class="line"></span><br><span class="line">    thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> vals = <span class="built_in">vec!</span>[</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"hi"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"from"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"the"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"thread"</span>),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> vals &#123;</span><br><span class="line">            tx.send(val).unwrap();</span><br><span class="line">            thread::sleep(Duration::from_secs(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> received <span class="keyword">in</span> rx &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Got: &#123;&#125;"</span>, received);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; Got: hi</span></span><br><span class="line"><span class="comment">// =&gt; Got: from</span></span><br><span class="line"><span class="comment">// =&gt; Got: the</span></span><br><span class="line"><span class="comment">// =&gt; Got: thread</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¼šè¿­ä»£æ–°çº¿ç¨‹ä¸­çš„åŠ¨æ€æ•°ç»„æ¥é€ä¸ªå‘é€å…¶ä¸­çš„å­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æ¯æ¬¡å‘é€åè°ƒç”¨ <code>thread::sleep</code> å‡½æ•°æ¥ç¨ä½œæš‚åœã€‚<br>åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå°† <code>rx</code> è§†ä½œè¿­ä»£å™¨ï¼Œä¸å†æ˜¾å¼åœ°è°ƒç”¨ <code>recv</code> å‡½æ•°ã€‚è¿­ä»£ä¸­çš„ä»£ç ä¼šæ‰“å°å‡ºæ¯ä¸ªæ¥æ”¶åˆ°çš„å€¼ï¼Œå¹¶åœ¨é€šé“å…³é—­æ—¶é€€å‡ºå¾ªç¯ã€‚<br>ä»£ç æ‰§è¡Œæ—¶æ¯æ¬¡æ‰“å°åéƒ½ä¼šå‡ºç° 1 ç§’çš„æ—¶é—´é—´éš”ã€‚ä½†æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ä¸»çº¿ç¨‹çš„ <code>for</code> å¾ªç¯ä¸­æ‰§è¡Œå»¶è¿ŸæŒ‡ä»¤ï¼Œè¡¨æ˜ä¸»çº¿ç¨‹ç¡®å®åœ¨ç­‰å¾…æ¥æ”¶æ–°çº¿ç¨‹ä¸­ä¼ é€’è¿‡æ¥çš„å€¼ã€‚</p><h5 id="é€šè¿‡å…‹éš†å‘é€è€…åˆ›å»ºå¤šä¸ªç”Ÿäº§è€…"><a href="#é€šè¿‡å…‹éš†å‘é€è€…åˆ›å»ºå¤šä¸ªç”Ÿäº§è€…" class="headerlink" title="é€šè¿‡å…‹éš†å‘é€è€…åˆ›å»ºå¤šä¸ªç”Ÿäº§è€…"></a>é€šè¿‡å…‹éš†å‘é€è€…åˆ›å»ºå¤šä¸ªç”Ÿäº§è€…</h5><p>é€šè¿‡å…‹éš†é€šé“çš„å‘é€ç«¯æ¥åˆ›å»ºå‡ºå¤šä¸ªèƒ½å¤Ÿå‘é€å€¼åˆ°åŒä¸€ä¸ªæ¥æ”¶ç«¯çš„çº¿ç¨‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::channel();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> tx1 = mpsc::Sender::clone(&amp;tx);</span><br><span class="line">    thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> vals = <span class="built_in">vec!</span>[</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"hi"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"from"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"the"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"thread"</span>),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> vals &#123;</span><br><span class="line">            tx1.send(val).unwrap();</span><br><span class="line">            thread::sleep(Duration::from_secs(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> vals = <span class="built_in">vec!</span>[</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"more"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"messages"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"for"</span>),</span><br><span class="line">            <span class="built_in">String</span>::from(<span class="string">"you"</span>),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> vals &#123;</span><br><span class="line">            tx.send(val).unwrap();</span><br><span class="line">            thread::sleep(Duration::from_secs(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> received <span class="keyword">in</span> rx &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Got: &#123;&#125;"</span>, received);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; Got: hi</span></span><br><span class="line"><span class="comment">// =&gt; Got: more</span></span><br><span class="line"><span class="comment">// =&gt; Got: from</span></span><br><span class="line"><span class="comment">// =&gt; Got: messages</span></span><br><span class="line"><span class="comment">// =&gt; Got: for</span></span><br><span class="line"><span class="comment">// =&gt; Got: the</span></span><br><span class="line"><span class="comment">// =&gt; Got: you</span></span><br><span class="line"><span class="comment">// =&gt; Got: thread</span></span><br></pre></td></tr></table></figure></p><h4 id="å…±äº«çŠ¶æ€çš„å¹¶å‘"><a href="#å…±äº«çŠ¶æ€çš„å¹¶å‘" class="headerlink" title="å…±äº«çŠ¶æ€çš„å¹¶å‘"></a>å…±äº«çŠ¶æ€çš„å¹¶å‘</h4><p>ä»æŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œä»»ä½•ç¼–ç¨‹è¯­è¨€ä¸­çš„é€šé“éƒ½æœ‰äº›ç±»ä¼¼äº<strong>å•ä¸€æ‰€æœ‰æƒ</strong>çš„æ¦‚å¿µã€‚å› ä¸ºç”¨æˆ·ä¸åº”è¯¥åœ¨å€¼ä¼ é€’ç»™é€šé“åå†æ¬¡ä½¿ç”¨å®ƒã€‚<br>åŸºäºå…±äº«å†…å­˜çš„å¹¶å‘é€šä¿¡æœºåˆ¶æ›´ç±»ä¼¼äº<strong>å¤šé‡æ‰€æœ‰æƒ</strong>æ¦‚å¿µï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ç›¸åŒçš„å†…å­˜åœ°å€ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ™ºèƒ½æŒ‡é’ˆå®ç°å¤šé‡æ‰€æœ‰æƒï¼Œä½†ç”±äºéœ€è¦åŒæ—¶ç®¡ç†å¤šä¸ªæ‰€æœ‰è€…ï¼Œä¼šä¸ºç³»ç»Ÿå¢åŠ é¢å¤–çš„å¤æ‚æ€§ã€‚å½“ç„¶ï¼ŒRust çš„ç±»å‹ç³»ç»Ÿå’Œæ‰€æœ‰æƒè§„åˆ™æœ‰åŠ©äºæ­£ç¡®åœ°ç®¡ç†è¿™äº›æ‰€æœ‰æƒã€‚</p><h5 id="äº’æ–¥ä½“ï¼ˆmutexï¼‰"><a href="#äº’æ–¥ä½“ï¼ˆmutexï¼‰" class="headerlink" title="äº’æ–¥ä½“ï¼ˆmutexï¼‰"></a>äº’æ–¥ä½“ï¼ˆmutexï¼‰</h5><p><strong>äº’æ–¥ä½“åœ¨ä»»æ„æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ•°æ®</strong>ã€‚ä¸ºäº†è®¿é—®äº’æ–¥ä½“ä¸­çš„æ•°æ®ï¼Œçº¿ç¨‹å¿…é¡»é¦–å…ˆå‘å‡ºä¿¡å·æ¥è·å–äº’æ–¥ä½“çš„é”ï¼ˆlockï¼‰ã€‚<br>é”æ˜¯äº’æ–¥ä½“çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ç§æ•°æ®ç»“æ„è¢«ç”¨æ¥è®°å½•å½“å‰è°æ‹¥æœ‰æ•°æ®çš„å”¯ä¸€è®¿é—®æƒã€‚</p><p>å…³äºäº’æ–¥ä½“å¿…é¡»ç‰¢è®°ä»¥ä¸‹ä¸¤æ¡è§„åˆ™ï¼š</p><ul><li>å¿…é¡»åœ¨ä½¿ç”¨æ•°æ®å‰å°è¯•è·å–é”</li><li>å¿…é¡»åœ¨ä½¿ç”¨å®Œäº’æ–¥ä½“å®ˆæŠ¤çš„æ•°æ®åé‡Šæ”¾é”ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æ‰èƒ½ç»§ç»­æ‰§è¡Œè·å–é”çš„æ“ä½œ</li></ul><p>åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨äº’æ–¥ä½“ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m = Mutex::new(<span class="number">5</span>);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> num = m.lock().unwrap();</span><br><span class="line">        *num = <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"m = &#123;:?&#125;"</span>, m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; m = Mutex &#123; data: 6 &#125;</span></span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†è®¿é—® <code>Mutex&lt;T&gt;</code> å®ä¾‹ä¸­çš„æ•°æ®ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è°ƒç”¨å…¶ <code>lock</code> æ–¹æ³•æ¥è·å–é”ã€‚æ­¤è°ƒç”¨ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æˆ‘ä»¬å–å¾—é”ä¸ºæ­¢ã€‚<br>å½“å‰çº¿ç¨‹å¯¹äº <code>lock</code> å‡½æ•°çš„è°ƒç”¨ä¼šåœ¨å…¶ä»–æŸä¸ªæŒæœ‰é”çš„çº¿ç¨‹å‘ç”Ÿ <code>panic</code> æ—¶å¤±è´¥ï¼Œå› æ­¤ä¸Šè¿°ä»£ç é€‰æ‹©ä½¿ç”¨ <code>unwrap</code> åœ¨æ„å¤–å‘ç”Ÿæ—¶è§¦å‘å½“å‰çº¿ç¨‹çš„ <code>panic</code>ã€‚</p><p>ä¸€æ—¦è·å–äº†é”ï¼Œä¾¿å¯ä»¥å°†å®ƒçš„è¿”å›å€¼ <code>num</code> è§†ä½œä¸€ä¸ªæŒ‡å‘å†…éƒ¨æ•°æ®çš„å¯å˜å¼•ç”¨ã€‚<br>Rust çš„ç±»å‹ç³»ç»Ÿä¼šç¡®ä¿æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>m</code> çš„å€¼ä¹‹å‰æ‰§è¡ŒåŠ é”æ“ä½œã€‚å› ä¸º <code>Mutex&lt;i32&gt;</code> å¹¶ä¸æ˜¯ <code>i32</code> ç±»å‹ï¼Œæˆ‘ä»¬å¿…é¡»è·å–é”æ‰èƒ½ä½¿ç”¨å…¶å†…éƒ¨çš„ <code>i32</code> å€¼ã€‚</p><p>å®é™…ä¸Šå¯¹ <code>lock</code> çš„è°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªåä¸º <code>MutexGuard</code> çš„æ™ºèƒ½æŒ‡é’ˆã€‚è¯¥æ™ºèƒ½æŒ‡é’ˆé€šè¿‡å®ç° <code>Deref</code> æ¥æŒ‡å‘å­˜å‚¨åœ¨å†…éƒ¨çš„æ•°æ®ï¼Œé€šè¿‡å®ç° <code>Drop</code> å®Œæˆè‡ªå·±ç¦»å¼€ä½œç”¨åŸŸæ—¶çš„è‡ªåŠ¨è§£é”æ“ä½œã€‚<br>è¿™ç§é‡Šæ”¾è¿‡ç¨‹ä¼šå‘ç”Ÿåœ¨å†…éƒ¨ä½œç”¨åŸŸçš„ç»“å°¾å¤„ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šå› ä¸ºå¿˜è®°é‡Šæ”¾é”è€Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•ç»§ç»­ä½¿ç”¨è¯¥äº’æ–¥ä½“ã€‚</p><h5 id="å¤šä¸ªçº¿ç¨‹é—´å…±äº«-Mutex-lt-T-gt"><a href="#å¤šä¸ªçº¿ç¨‹é—´å…±äº«-Mutex-lt-T-gt" class="headerlink" title="å¤šä¸ªçº¿ç¨‹é—´å…±äº« Mutex&lt;T&gt;"></a>å¤šä¸ªçº¿ç¨‹é—´å…±äº« <code>Mutex&lt;T&gt;</code></h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> counter = Mutex::new(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> handles = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> handle = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> num = counter.lock().unwrap();</span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.push(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> handle <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.join().unwrap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Result: &#123;&#125;"</span>, *counter.lock().unwrap());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¼šä¾æ¬¡å¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­åˆ†åˆ«ä¸ºå…±äº«çš„è®¡æ•°å™¨çš„å€¼åŠ  1ã€‚<br>ä½†ä»£ç ç›®å‰æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œä¼šæŠ¥å‡º <strong>error[E0382]: use of moved value: <code>counter</code></strong> é”™è¯¯ã€‚<br>åŸå› æ˜¯å˜é‡ <code>counter</code> è¢«ç§»åŠ¨è¿›äº† <code>handle</code> æŒ‡ä»£çš„çº¿ç¨‹ä¸­ï¼Œè¿™ä¸€ç§»åŠ¨è¡Œä¸ºé˜»æ­¢æˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ <code>lock</code> æ¥å†æ¬¡æ•è· <code>counter</code>ã€‚</p><h5 id="å¤šçº¿ç¨‹ä¸å¤šé‡æ‰€æœ‰æƒ"><a href="#å¤šçº¿ç¨‹ä¸å¤šé‡æ‰€æœ‰æƒ" class="headerlink" title="å¤šçº¿ç¨‹ä¸å¤šé‡æ‰€æœ‰æƒ"></a>å¤šçº¿ç¨‹ä¸å¤šé‡æ‰€æœ‰æƒ</h5><p>æ™ºèƒ½æŒ‡é’ˆ <code>Rc&lt;T&gt;</code> æä¾›çš„å¼•ç”¨è®¡æ•°èƒ½å¤Ÿä¸ºå•ä¸ªå€¼èµ‹äºˆå¤šä¸ªæ‰€æœ‰è€…ã€‚<br>ç°åœ¨å°è¯•ä½¿ç”¨ <code>Rc&lt;T&gt;</code> æ¥åŒ…è£¹ <code>Mutex&lt;T&gt;</code>ï¼Œå¹¶åœ¨æ¯æ¬¡éœ€è¦ç§»åŠ¨æ‰€æœ‰æƒè‡³çº¿ç¨‹æ—¶å…‹éš† <code>Rc&lt;T&gt;</code>ã€‚çœ‹æ”¹è¿›åçš„ç¨‹åºèƒ½å¦ç¼–è¯‘é€šè¿‡ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> counter = Rc::new(Mutex::new(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> handles = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> counter = Rc::clone(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> handle = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> num = counter.lock().unwrap();</span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.push(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> handle <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.join().unwrap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Result: &#123;&#125;"</span>, *counter.lock().unwrap());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å†æ¬¡å°è¯•ç¼–è¯‘ä»£ç ï¼ŒæŠ¥å‡ºå¦å¤–ä¸€ä¸ªé”™è¯¯ï¼š<code>error[E0277]: `Rc&lt;Mutex&lt;i32&gt;&gt;` cannot be sent between threads safely</code>ã€‚<br>åŸå› æ˜¯ <code>Rc&lt;T&gt;</code> åœ¨è·¨çº¿ç¨‹ä½¿ç”¨æ—¶å¹¶ä¸å®‰å…¨ã€‚<code>Rc&lt;T&gt;</code> ä¼šåœ¨æ¯æ¬¡è°ƒç”¨ <code>clone</code> çš„è¿‡ç¨‹ä¸­å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œåœ¨å…‹éš†å‡ºçš„å®ä¾‹è¢«ä¸¢å¼ƒåå‡å°‘å¼•ç”¨è®¡æ•°ã€‚ä½†å®ƒå¹¶æ²¡æœ‰ä½¿ç”¨ä»»ä½•å¹¶å‘åŸè¯­æ¥ä¿è¯ä¿®æ”¹è®¡æ•°çš„è¿‡ç¨‹ä¸­ä¸ä¼šè¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰€æ‰“æ–­ã€‚è¿™ææœ‰å¯èƒ½å¯¼è‡´è®¡æ•°é”™è¯¯å¹¶äº§ç”Ÿè¯¡å¼‚çš„ bugã€‚</p><h5 id="åŸå­å¼•ç”¨è®¡æ•°-Arc-lt-T-gt"><a href="#åŸå­å¼•ç”¨è®¡æ•°-Arc-lt-T-gt" class="headerlink" title="åŸå­å¼•ç”¨è®¡æ•° Arc&lt;T&gt;"></a>åŸå­å¼•ç”¨è®¡æ•° <code>Arc&lt;T&gt;</code></h5><p><code>Arc&lt;T&gt;</code> ç±»å‹æ—¢æ‹¥æœ‰ç±»ä¼¼äº <code>Rc&lt;T&gt;</code> çš„è¡Œä¸ºï¼Œåˆä¿è¯è‡ªå·±å¯ä»¥è¢«å®‰å…¨åœ°ç”¨äºå¹¶å‘åœºæ™¯ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> counter = Arc::new(Mutex::new(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> handles = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> counter = Arc::clone(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> handle = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> num = counter.lock().unwrap();</span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.push(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> handle <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.join().unwrap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Result: &#123;&#125;"</span>, *counter.lock().unwrap());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; Result: 10</span></span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨ <code>Arc&lt;T&gt;</code> æ›¿æ¢æ‰ä»£ç ä¸­çš„ <code>Rc&lt;T&gt;</code> åï¼Œä»£ç å¯ä»¥ç¼–è¯‘é€šè¿‡ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRust å¹¶ä¸èƒ½ä½¿ä½ å®Œå…¨é¿å…ä½¿ç”¨ <code>Mutex&lt;T&gt;</code> è¿‡ç¨‹ä¸­æ‰€æœ‰çš„é€»è¾‘é”™è¯¯ã€‚ä½¿ç”¨ <code>Mutex&lt;T&gt;</code> ä¹Ÿä¼šæœ‰äº§ç”Ÿæ­»é”ï¼ˆdeadlockï¼‰çš„é£é™©ã€‚å½“æŸä¸ªæ“ä½œéœ€è¦åŒæ—¶é”ä½ä¸¤ä¸ªèµ„æºï¼Œè€Œä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«æŒæœ‰å…¶ä¸­ä¸€ä¸ªé”å¹¶ç›¸äº’è¯·æ±‚å¦å¤–ä¸€ä¸ªé”æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥æ— ç©·å°½çš„ç­‰å¾…è¿‡ç¨‹ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener">The Rust Programming Language</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;å¹¶å‘ç¼–ç¨‹ï¼ˆconcurrent programmingï¼‰&lt;/strong&gt;å…è®¸ç¨‹åºä¸­çš„ä¸åŒéƒ¨åˆ†ç›¸äº’ç‹¬ç«‹åœ°è¿è¡Œï¼Œè€Œ&lt;strong&gt;å¹¶è¡Œç¼–ç¨‹ï¼ˆparallel programmingï¼‰&lt;/strong&gt;åˆ™å…è®¸ç¨‹åºä¸­çš„ä¸åŒéƒ¨åˆ†åŒæ—¶æ‰§è¡Œã€‚&lt;br&gt;Rust ä¸­çš„æ‰€æœ‰æƒ
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Advanced" scheme="https://rollingstarky.github.io/tags/Advanced/"/>
    
      <category term="Concurrency" scheme="https://rollingstarky.github.io/tags/Concurrency/"/>
    
      <category term="Thread" scheme="https://rollingstarky.github.io/tags/Thread/"/>
    
      <category term="Rust" scheme="https://rollingstarky.github.io/tags/Rust/"/>
    
      <category term="Deadlock" scheme="https://rollingstarky.github.io/tags/Deadlock/"/>
    
      <category term="Channel" scheme="https://rollingstarky.github.io/tags/Channel/"/>
    
  </entry>
  
  <entry>
    <title>The Rust programming language è¯»ä¹¦ç¬”è®°â€”â€”æ™ºèƒ½æŒ‡é’ˆ</title>
    <link href="https://rollingstarky.github.io/2021/07/26/the-rust-programming-language-reading-notes-smart-pointer/"/>
    <id>https://rollingstarky.github.io/2021/07/26/the-rust-programming-language-reading-notes-smart-pointer/</id>
    <published>2021-07-25T16:00:00.000Z</published>
    <updated>2021-07-26T15:34:22.264Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æŒ‡é’ˆï¼ˆpointerï¼‰</strong>æ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œç”¨æ¥æŒ‡ä»£é‚£äº›åŒ…å«å†…å­˜åœ°å€çš„å˜é‡ã€‚è¿™äº›åœ°å€â€œæŒ‡å‘â€å†…å­˜ä¸­çš„å…¶ä»–æ•°æ®ã€‚<br>Rust ä¸­æœ€å¸¸è§çš„æŒ‡é’ˆæ˜¯<strong>å¼•ç”¨</strong>ï¼Œä¼š<strong>å€Ÿç”¨</strong>å®ƒæ‰€æŒ‡å‘çš„æ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¼•ç”¨æ²¡æœ‰ä»»ä½•å…¶ä»–åŠŸèƒ½å’Œé¢å¤–çš„å¼€é”€ã€‚<br><strong>æ™ºèƒ½æŒ‡é’ˆï¼ˆsmart pointerï¼‰</strong>æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒçš„è¡Œä¸ºç±»ä¼¼äºæŒ‡é’ˆä½†<strong>æ‹¥æœ‰é¢å¤–çš„å…ƒæ•°æ®å’Œé™„åŠ åŠŸèƒ½</strong>ã€‚</p><p>åœ¨æ‹¥æœ‰æ‰€æœ‰æƒå’Œå€Ÿç”¨æ¦‚å¿µçš„ Rust ä¸­ï¼š<strong>å¼•ç”¨åªæ˜¯ç”¨æ¥å€Ÿç”¨æ•°æ®çš„æŒ‡é’ˆï¼›è€Œå¤§å¤šæ•°æ™ºèƒ½æŒ‡é’ˆæœ¬èº«å°±æ‹¥æœ‰å®ƒä»¬æŒ‡å‘çš„å€¼</strong>ã€‚<br>æ¯”å¦‚ <code>String</code> å’Œ <code>Vec&lt;T&gt;</code> ç±»å‹å°±éƒ½å¯ä»¥è¢«ç®—ä½œæ™ºèƒ½æŒ‡é’ˆã€‚å®ƒä»¬éƒ½æ‹¥æœ‰ä¸€ç‰‡å†…å­˜åŒºåŸŸå¹¶å…è®¸ç”¨æˆ·å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œæ‹¥æœ‰å…ƒæ•°æ®ï¼ˆå¦‚å®¹é‡ç­‰ï¼‰ï¼Œèƒ½æä¾›é¢å¤–çš„åŠŸèƒ½æˆ–ä¿éšœï¼ˆå¦‚ <code>String</code> ä¼šä¿è¯å…¶ä¸­çš„æ•°æ®å¿…æ˜¯åˆæ³•çš„ <code>UTF-8</code> ç¼–ç ï¼‰ã€‚</p><p>é€šå¸¸ä½¿ç”¨ç»“æ„ä½“æ¥å®ç°æ™ºèƒ½æŒ‡é’ˆã€‚åŒºåˆ«äºæ™®é€šçš„ç»“æ„ä½“ï¼Œæ™ºèƒ½æŒ‡é’ˆä¼šå®ç° <code>Deref</code> ä¸ <code>Drop</code> è¿™ä¸¤ä¸ª <code>trait</code>ã€‚Deref trait ä½¿å¾—æ™ºèƒ½æŒ‡é’ˆçš„å®ä¾‹æ‹¥æœ‰ä¸å¼•ç”¨ä¸€è‡´çš„è¡Œä¸ºï¼›Drop trait ä½¿å¾—ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆç¦»å¼€ä½œç”¨åŸŸæ—¶è¿è¡Œçš„ä»£ç ã€‚</p><p>æ ‡å‡†åº“ä¸­æœ€ä¸ºå¸¸è§çš„æ™ºèƒ½æŒ‡é’ˆå¦‚ä¸‹ï¼š</p><ul><li><code>Box&lt;T&gt;</code>ï¼šå¯ç”¨äºåœ¨å †ä¸Šåˆ†é…æ•°æ®</li><li><code>Rc&lt;T&gt;</code>ï¼šå…·å¤‡å¤šé‡æ‰€æœ‰æƒçš„<strong>å¼•ç”¨è®¡æ•°ç±»å‹</strong></li><li><code>Ref&lt;T&gt;</code> å’Œ <code>ReMut&lt;T&gt;</code>ï¼šå¯ä»¥é€šè¿‡ <code>RefCell&lt;T&gt;</code> è®¿é—®ï¼Œæ˜¯ä¸€ç§å¯ä»¥åœ¨è¿è¡Œæ—¶è€Œä¸æ˜¯ç¼–è¯‘æ—¶æ‰§è¡Œå€Ÿç”¨è§„åˆ™çš„ç±»å‹</li></ul><h4 id="ä½¿ç”¨-Box-lt-T-gt-åœ¨å †ä¸Šåˆ†é…æ•°æ®"><a href="#ä½¿ç”¨-Box-lt-T-gt-åœ¨å †ä¸Šåˆ†é…æ•°æ®" class="headerlink" title="ä½¿ç”¨ Box&lt;T&gt; åœ¨å †ä¸Šåˆ†é…æ•°æ®"></a>ä½¿ç”¨ <code>Box&lt;T&gt;</code> åœ¨å †ä¸Šåˆ†é…æ•°æ®</h4><p><strong>è£…ç®±ï¼ˆboxï¼‰</strong>æ˜¯æœ€ç®€å•çš„ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå…¶ç±»å‹ä¸º <code>Box&lt;T&gt;</code>ã€‚å®ƒä½¿æˆ‘ä»¬å¯ä»¥å°†æ•°æ®å­˜å‚¨åœ¨å †ä¸Šï¼Œå¹¶åœ¨æ ˆä¸­ä¿ç•™ä¸€ä¸ªæŒ‡å‘å †æ•°æ®çš„æŒ‡é’ˆã€‚</p><p>è£…ç®±å¸¸è¢«ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p><ul><li>æ‹¥æœ‰ä¸€ä¸ªæ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šå¤§å°çš„ç±»å‹ï¼Œä½†åˆæƒ³åœ¨ä¸€ä¸ªè¦æ±‚å›ºå®šå°ºå¯¸çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­ä½¿ç”¨è¿™ä¸ªç±»å‹</li><li>éœ€è¦ä¼ é€’å¤§é‡æ•°æ®çš„æ‰€æœ‰æƒï¼Œä½†åˆä¸å¸Œæœ›äº§ç”Ÿå¤§é‡æ•°æ®çš„å¤åˆ¶è¡Œä¸º</li><li>å¸Œæœ›æ‹¥æœ‰ä¸€ä¸ªå®ç°äº†æŒ‡å®š trait çš„ç±»å‹å€¼ï¼Œä½†åˆä¸å…³å¿ƒå…·ä½“çš„ç±»å‹</li></ul><p>ä½¿ç”¨è£…ç®±åœ¨å †ä¸Šå­˜å‚¨ä¸€ä¸ª <code>i32</code> å€¼ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="built_in">Box</span>::new(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"b = &#123;&#125;"</span>, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å°†å•ä¸€å€¼å­˜æ”¾åœ¨å †ä¸Šæ²¡æœ‰å¤ªå¤§ç”¨å¤„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½å¯ä»¥å°†ç±»ä¼¼çš„å•ä¸ª <code>i32</code> å€¼é»˜è®¤æ”¾ç½®åœ¨æ ˆä¸Šã€‚</p><h5 id="ä½¿ç”¨è£…ç®±å®šä¹‰é€’å½’ç±»å‹"><a href="#ä½¿ç”¨è£…ç®±å®šä¹‰é€’å½’ç±»å‹" class="headerlink" title="ä½¿ç”¨è£…ç®±å®šä¹‰é€’å½’ç±»å‹"></a>ä½¿ç”¨è£…ç®±å®šä¹‰é€’å½’ç±»å‹</h5><p>Rust å¿…é¡»åœ¨ç¼–è¯‘æ—¶çŸ¥é“æ¯ä¸€ç§ç±»å‹å æ®çš„ç©ºé—´å¤§å°ï¼Œä½†æœ‰ä¸€ç§è¢«ç§°ä¸º<strong>é€’å½’</strong>çš„ç±»å‹æ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šå…·ä½“å¤§å°ã€‚<br>é€’å½’ç±»å‹çš„å€¼å¯ä»¥åœ¨è‡ªèº«ä¸­å­˜å‚¨å¦ä¸€ä¸ªç›¸åŒç±»å‹çš„å€¼ï¼Œè¿™ç§åµŒå¥—ç†è®ºä¸Šå¯ä»¥æ— ç©·æ— å°½åœ°è¿›è¡Œä¸‹å»ï¼Œæ ¹æœ¬æ— æ³•è®¡ç®—å‡ºå…·ä½“çš„ç©ºé—´å¤§å°ã€‚</p><p>é“¾æ¥åˆ—è¡¨ï¼ˆcons listï¼‰æ˜¯ä¸€ç§åœ¨å‡½æ•°å¼è¯­è¨€ä¸­éå¸¸å¸¸è§çš„æ•°æ®ç±»å‹ã€‚<code>cons</code> å‡½æ•°ä¼šå°†ä¸¤ä¸ªå‚æ•°ç»„æˆä¸€ä¸ªäºŒå…ƒç»„ï¼Œè€Œè¿™ä¸ªå…ƒç»„é€šå¸¸ç”±ä¸€ä¸ªå€¼å’Œå¦ä¸€ä¸ªäºŒå…ƒç»„ç»„æˆï¼Œé€šè¿‡è¿™ç§ä¸æ–­åµŒå¥—å…ƒç»„çš„å½¢å¼æœ€ç»ˆç»„æˆä¸€ä¸ªåˆ—è¡¨ã€‚<br>ä½¿ç”¨æšä¸¾æ¥å®šä¹‰ä¸€ä¸ªé“¾æ¥åˆ—è¡¨ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, List),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> list = Cons(<span class="number">1</span>, Cons(<span class="number">2</span>, Cons(<span class="number">3</span>, Nil)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°ä»£ç åœ¨ç¼–è¯‘æ—¶ä¼šæŠ¥å‡º <code>error[E0072]: recursive type `List` has infinite size</code> é”™è¯¯ã€‚</p><p>Rust åœ¨è®¡ç®—æšä¸¾ç±»å‹éœ€è¦çš„ç©ºé—´å¤§å°æ—¶ï¼Œä¼šéå†æšä¸¾ä¸­çš„æ¯ä¸€ä¸ªæˆå‘˜æ¥æ‰¾åˆ°éœ€è¦æœ€å¤§ç©ºé—´çš„é‚£ä¸ªå˜ä½“ã€‚å› ä¸ºåœ¨æ¯ä¸ªæ—¶é—´ç‚¹ï¼Œåªä¼šæœ‰ä¸€ä¸ªå˜ä½“å­˜åœ¨ã€‚<br>å¯¹äºé€’å½’ç±»å‹å¤§å°çš„è®¡ç®—ï¼Œä»¥å‰é¢çš„ <code>List</code> ä¸ºä¾‹ï¼Œç¼–è¯‘å™¨ä¼šå…ˆæ£€æŸ¥ <code>Cons</code> å˜ä½“ï¼Œå®ƒæŒæœ‰ä¸€ä¸ª <code>i32</code> ç±»å‹çš„å€¼åŠå¦å¤–ä¸€ä¸ª <code>List</code> ç±»å‹ï¼›ä¸ºäº†ç¡®å®šæ­¤å¤„<code>List</code> çš„å¤§å°ï¼Œç¼–è¯‘å™¨åˆä¼šä» <code>Cons</code> å¼€å§‹éå†å…¶ä¸‹çš„æ‰€æœ‰å˜ä½“ï¼Œè¿™æ ·çš„æ£€æŸ¥å°†æ°¸è¿œè¿›è¡Œä¸‹å»ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/6875152-23761fd6dc9ac77d.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åŒ…å«æ— ç©·å¤š Cons å˜ä½“çš„æ— ç©· List"></p><p>å¯ä»¥ä½¿ç”¨ <code>Box&lt;T&gt;</code> å°†é€’å½’ç±»å‹çš„å¤§å°å›ºå®šä¸‹æ¥ã€‚<br><code>Box&lt;T&gt;</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå…¶å¤§å°æ€»æ˜¯æ’å®šçš„ï¼Œä¸ä¼šå› ä¸ºæŒ‡å‘æ•°æ®çš„å¤§å°è€Œå‘ç”Ÿå˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>Cons</code> å˜ä½“ä¸­å­˜æ”¾ä¸€ä¸ª <code>Box&lt;T&gt;</code> æŒ‡é’ˆï¼Œ<code>Box&lt;T&gt;</code> æŒ‡å‘ä¸‹ä¸€ä¸ªå­˜å‚¨åœ¨å †ä¸Šçš„ <code>List</code>ã€‚å³åµŒå¥—çš„ <code>List</code> å¹¶æ²¡æœ‰ç›´æ¥å­˜æ”¾åœ¨ <code>Cons</code> å˜ä½“ä¸­ï¼Œè€Œæ˜¯æ”¾ç½®åœ¨å †ä¸Šï¼Œæ‰“ç ´äº†æ— é™é€’å½’çš„è¿‡ç¨‹ã€‚<br>æ­¤æ—¶ä»»æ„çš„ <code>List</code> å€¼éƒ½åªéœ€è¦å ç”¨ä¸€ä¸ª <code>i32</code> å€¼åŠ ä¸Šä¸€ä¸ªè£…ç®±æŒ‡é’ˆçš„å¤§å°ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/6875152-688437fa1045d8cb.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Box in Cons"></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, <span class="built_in">Box</span>&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> list = Cons(<span class="number">1</span>, <span class="built_in">Box</span>::new(Cons(<span class="number">2</span>, <span class="built_in">Box</span>::new(Cons(<span class="number">3</span>, <span class="built_in">Box</span>::new(Nil))))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è£…ç®±é™¤äº†é—´æ¥è®¿é—®å†…å­˜å’Œå †åˆ†é…ï¼Œæ²¡æœ‰æä¾›ä»»ä½•å…¶ä»–çš„ç‰¹æ®ŠåŠŸèƒ½ï¼Œä¹Ÿæ²¡æœ‰è¿™äº›ç‰¹æ®ŠåŠŸèƒ½é™„å¸¦çš„æ€§èƒ½å¼€é”€ã€‚å› æ­¤æ­£å¥½èƒ½è¢«ç”¨åœ¨ç±»ä¼¼äºé“¾æ¥åˆ—è¡¨è¿™ç±»åªæ˜¯éœ€è¦é—´æ¥è®¿é—®çš„åœºæ™¯ä¸­ã€‚</p><h4 id="é€šè¿‡-Deref-trait-å°†æ™ºèƒ½æŒ‡é’ˆè§†ä½œå¸¸è§„å¼•ç”¨"><a href="#é€šè¿‡-Deref-trait-å°†æ™ºèƒ½æŒ‡é’ˆè§†ä½œå¸¸è§„å¼•ç”¨" class="headerlink" title="é€šè¿‡ Deref trait å°†æ™ºèƒ½æŒ‡é’ˆè§†ä½œå¸¸è§„å¼•ç”¨"></a>é€šè¿‡ <code>Deref trait</code> å°†æ™ºèƒ½æŒ‡é’ˆè§†ä½œå¸¸è§„å¼•ç”¨</h4><p>å®ç° <code>Deref trait</code> ä½¿æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰è§£å¼•ç”¨è¿ç®—ç¬¦ <code>*</code> çš„è¡Œä¸ºï¼Œè¿™æ„å‘³ç€åŸæœ¬ç”¨äºå¤„ç†å¼•ç”¨çš„ä»£ç å¯ä»¥ä¸åŠ ä¿®æ”¹åœ°ç”¨äºå¤„ç†æ™ºèƒ½æŒ‡é’ˆã€‚</p><h5 id="ä½¿ç”¨è§£å¼•ç”¨è·³è½¬åˆ°æŒ‡é’ˆæŒ‡å‘çš„å€¼"><a href="#ä½¿ç”¨è§£å¼•ç”¨è·³è½¬åˆ°æŒ‡é’ˆæŒ‡å‘çš„å€¼" class="headerlink" title="ä½¿ç”¨è§£å¼•ç”¨è·³è½¬åˆ°æŒ‡é’ˆæŒ‡å‘çš„å€¼"></a>ä½¿ç”¨è§£å¼•ç”¨è·³è½¬åˆ°æŒ‡é’ˆæŒ‡å‘çš„å€¼</h5><p>æŒ‡é’ˆå¯ä»¥è¢«ç†è§£ä¸ºä¸€ç§ç®­å¤´ï¼Œä¼šæŒ‡å‘å­˜å‚¨åœ¨åˆ«å¤„çš„å€¼ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> y = &amp;x;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, x);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, *y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ•°å­—å’Œå¼•ç”¨æ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥æ¯”è¾ƒ <code>5</code> å’Œ <code>y</code>ã€‚å¿…é¡»ä½¿ç”¨ <code>*y</code> æ¥è·³è½¬åˆ°å¼•ç”¨æŒ‡å‘çš„å€¼ã€‚</p><h5 id="æŠŠ-Box-lt-T-gt-å½“æˆå¼•ç”¨æ¥æ“ä½œ"><a href="#æŠŠ-Box-lt-T-gt-å½“æˆå¼•ç”¨æ¥æ“ä½œ" class="headerlink" title="æŠŠ Box&lt;T&gt; å½“æˆå¼•ç”¨æ¥æ“ä½œ"></a>æŠŠ <code>Box&lt;T&gt;</code> å½“æˆå¼•ç”¨æ¥æ“ä½œ</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> y = <span class="built_in">Box</span>::new(x);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, x);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, *y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ"><a href="#è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ"></a>è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyBox</span></span>&lt;T&gt;(T);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(x: T) -&gt; MyBox&lt;T&gt; &#123;</span><br><span class="line">        MyBox(x)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> MyBox&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Target</span></span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">deref</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;T &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> y = MyBox::new(x);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, x);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, *y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­çš„ <code>MyBox</code> æ˜¯ä¸€ä¸ªæ‹¥æœ‰ <code>T</code> ç±»å‹çš„å…ƒç»„ç»“æ„ä½“ï¼Œå…¶å…³è”å‡½æ•° <code>MyBox::new</code> æ¥æ”¶ä¸€ä¸ª <code>T</code> ç±»å‹çš„å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­˜å‚¨æœ‰ä¼ å…¥å€¼çš„ <code>MyBox</code> å®ä¾‹ä½œä¸ºç»“æœã€‚</p><p>ä¸ºäº†ä¸º <code>MyBox&lt;T&gt;</code> ç±»å‹å®ç°è§£å¼•ç”¨åŠŸèƒ½ï¼Œä»£ç ä¸­å®ç°äº† <code>Deref trait</code>ã€‚<br>æ ‡å‡†åº“ä¸­çš„ Deref trait è¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ª <code>deref</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå€Ÿç”¨ <code>self</code> å¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘å†…éƒ¨æ•°æ®çš„å¼•ç”¨ã€‚<br><code>deref</code> æ–¹æ³•ä½“ä¸­çš„ <code>&amp;self.0</code> æ„å‘³ç€ <code>deref</code> ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘å€¼çš„å¼•ç”¨ï¼Œè¿›è€Œå…è®¸è°ƒç”¨è€…é€šè¿‡ <code>*</code> è¿ç®—ç¬¦è®¿é—®å€¼ã€‚<br>ä»£ç ä¸­çš„ <code>*y</code> ä¼šè¢« Rust éšå¼åœ°å±•å¼€ä¸º <code>*(y.deref())</code>ã€‚ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨å®Œå…¨ç›¸åŒçš„æ–¹å¼ç¼–å†™ä»£ç æ¥å¤„ç†å¸¸è§„å¼•ç”¨åŠå®ç°äº† Deref trait çš„ç±»å‹ã€‚</p><h4 id="å‡½æ•°å’Œæ–¹æ³•çš„éšå¼è§£å¼•ç”¨è½¬æ¢"><a href="#å‡½æ•°å’Œæ–¹æ³•çš„éšå¼è§£å¼•ç”¨è½¬æ¢" class="headerlink" title="å‡½æ•°å’Œæ–¹æ³•çš„éšå¼è§£å¼•ç”¨è½¬æ¢"></a>å‡½æ•°å’Œæ–¹æ³•çš„éšå¼è§£å¼•ç”¨è½¬æ¢</h4><p>è§£å¼•ç”¨è½¬æ¢æ˜¯ Rust ä¸ºå‡½æ•°å’Œæ–¹æ³•çš„å‚æ•°æä¾›çš„ä¸€ç§ç¼–ç¨‹ç‰¹æ€§ã€‚å½“æŸä¸ªç±»å‹ T å®ç°äº† Deref trait æ—¶ï¼Œå®ƒèƒ½å¤Ÿå°† T çš„å¼•ç”¨è½¬æ¢ä¸º T ç»è¿‡ Deref æ“ä½œåç”Ÿæˆçš„å¼•ç”¨ã€‚<br>å½“æˆ‘ä»¬å°†æŸä¸ªç±»å‹çš„å€¼å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç±»å‹æˆ–æ–¹æ³•ï¼Œä½†ä¼ å…¥çš„ç±»å‹ä¸å‚æ•°ç±»å‹ä¸ä¸€è‡´æ—¶ï¼Œè§£å¼•ç”¨è½¬æ¢å°±ä¼šè‡ªåŠ¨å‘ç”Ÿã€‚ç¼–è¯‘å™¨ä¼šæ’å…¥ä¸€ç³»åˆ—çš„ deref æ–¹æ³•æ¥å°†æˆ‘ä»¬æä¾›çš„ç±»å‹è½¬æ¢ä¸ºå‚æ•°æ‰€éœ€çš„ç±»å‹ã€‚</p><p>è§£å¼•ç”¨è½¬æ¢ä½¿ç¨‹åºå‘˜åœ¨è°ƒç”¨å‡½æ•°æˆ–æ–¹æ³•æ—¶æ— éœ€å¤šæ¬¡æ˜¾å¼åœ°ä½¿ç”¨ <code>&amp;</code> å’Œ <code>*</code> æ“ä½œç¬¦æ¥è¿›è¡Œå¼•ç”¨å’Œè§£å¼•ç”¨æ“ä½œã€‚æˆ‘ä»¬å› è€Œå¯ä»¥æ›´å¤šåœ°ç¼–å†™å‡ºèƒ½å¤ŸåŒæ—¶ä½œç”¨äºå¸¸è§„å¼•ç”¨å’Œæ™ºèƒ½æŒ‡é’ˆçš„ä»£ç ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyBox</span></span>&lt;T&gt;(T);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(x: T) -&gt; MyBox&lt;T&gt; &#123;</span><br><span class="line">        MyBox(x)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> MyBox&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Target</span></span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">deref</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;T &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hello</span></span>(name: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Hello, &#123;&#125;!"</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m = MyBox::new(<span class="built_in">String</span>::from(<span class="string">"Rust"</span>));</span><br><span class="line">    hello(&amp;m);</span><br><span class="line">    <span class="comment">// =&gt; Hello, Rust!</span></span><br><span class="line">    hello(&amp;(*m)[..]);</span><br><span class="line">    <span class="comment">// =&gt; Hello, Rust!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>&amp;m</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>MyBox&lt;String&gt;</code> å€¼çš„å¼•ç”¨ã€‚å› ä¸º <code>MyBox&lt;T&gt;</code> å®ç°äº† Deref traitï¼ŒRust å¯ä»¥é€šè¿‡è°ƒç”¨ deref å°† <code>&amp;MyBox&lt;String&gt;</code> è½¬æ¢ä¸º <code>String</code>ï¼›å› ä¸ºæ ‡å‡†åº“ä¸º <code>String</code> æä¾›çš„ Deref å®ç°ä¼šè¿”å›å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œæ‰€ä»¥ Rust å¯ä»¥ç»§ç»­è°ƒç”¨ deref å°† <code>&amp;String</code> è½¬æ¢ä¸º <code>&amp;str</code>ï¼Œæœ€ç»ˆä¸ <code>hello</code> å‡½æ•°çš„å®šä¹‰åŒ¹é…ã€‚</p><h5 id="è§£å¼•ç”¨è½¬æ¢ä¸å¯å˜æ€§"><a href="#è§£å¼•ç”¨è½¬æ¢ä¸å¯å˜æ€§" class="headerlink" title="è§£å¼•ç”¨è½¬æ¢ä¸å¯å˜æ€§"></a>è§£å¼•ç”¨è½¬æ¢ä¸å¯å˜æ€§</h5><p>ä½¿ç”¨ <code>Deref trait</code> èƒ½å¤Ÿé‡è½½ä¸å¯å˜å¼•ç”¨çš„ <code>*</code> è¿ç®—ç¬¦ï¼Œä½¿ç”¨ <code>DerefMut trait</code> èƒ½å¤Ÿé‡è½½å¯å˜å¼•ç”¨çš„ <code>*</code> è¿ç®—ç¬¦ã€‚</p><p>Rust ä¼šåœ¨ç±»å‹ä¸ trait æ»¡è¶³ä¸‹é¢ 3 ç§æƒ…å†µæ—¶æ‰§è¡Œè§£å¼•ç”¨è½¬æ¢ï¼š</p><ul><li>å½“ <code>T: Deref&lt;Target=U&gt;</code> æ—¶ï¼Œå…è®¸ <code>&amp;T</code> è½¬æ¢ä¸º <code>&amp;U</code></li><li>å½“ <code>T: DerefMut&lt;Target=U&gt;</code> æ—¶ï¼Œå…è®¸ <code>&amp;mut T</code> è½¬æ¢ä¸º <code>&amp;mut U</code></li><li>å½“ <code>T: Deref&lt;Target=U&gt;</code> æ—¶ï¼Œå…è®¸ <code>&amp;mut T</code> è½¬æ¢ä¸º <code>&amp;U</code></li></ul><h4 id="å€ŸåŠ©-Drop-trait-åœ¨æ¸…ç†æ—¶è¿è¡Œä»£ç "><a href="#å€ŸåŠ©-Drop-trait-åœ¨æ¸…ç†æ—¶è¿è¡Œä»£ç " class="headerlink" title="å€ŸåŠ© Drop trait åœ¨æ¸…ç†æ—¶è¿è¡Œä»£ç "></a>å€ŸåŠ© <strong>Drop trait</strong> åœ¨æ¸…ç†æ—¶è¿è¡Œä»£ç </h4><p>Drop trait å…è®¸æˆ‘ä»¬åœ¨å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶æ‰§è¡ŒæŸäº›è‡ªå®šä¹‰æ“ä½œã€‚å¯ä»¥ä¸ºä»»æ„ç±»å‹å®ç°ä¸€ä¸ª Drop traitï¼Œå®ƒå¸¸å¸¸è¢«ç”¨æ¥é‡Šæ”¾è¯¸å¦‚æ–‡ä»¶ã€ç½‘ç»œè¿æ¥ç­‰èµ„æºã€‚<br>å‡ ä¹æ¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆçš„å®ç°éƒ½ä¼šç”¨åˆ°è¿™ä¸€ traitï¼Œæ¯”å¦‚ <code>Box&lt;T&gt;</code> é€šè¿‡è‡ªå®šä¹‰ Drop æ¥é‡Šæ”¾è£…ç®±æŒ‡é’ˆæŒ‡å‘çš„å †å†…å­˜ç©ºé—´ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CustomSmartPointer</span></span> &#123;</span><br><span class="line">    data: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> CustomSmartPointer &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Dropping CustomSmartPointer with data `&#123;&#125;`!"</span>, <span class="keyword">self</span>.data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> c = CustomSmartPointer &#123;</span><br><span class="line">        data: <span class="built_in">String</span>::from(<span class="string">"my stuff"</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> d = CustomSmartPointer &#123;</span><br><span class="line">        data: <span class="built_in">String</span>::from(<span class="string">"other stuff"</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"CustomSmartPointer created."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; CustomSmartPointer created.</span></span><br><span class="line"><span class="comment">// =&gt; Dropping CustomSmartPointer with data `other stuff`!</span></span><br><span class="line"><span class="comment">// =&gt; Dropping CustomSmartPointer with data `my stuff`!</span></span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨-std-mem-drop-æå‰ä¸¢å¼ƒå€¼"><a href="#ä½¿ç”¨-std-mem-drop-æå‰ä¸¢å¼ƒå€¼" class="headerlink" title="ä½¿ç”¨ std::mem::drop æå‰ä¸¢å¼ƒå€¼"></a>ä½¿ç”¨ <code>std::mem::drop</code> æå‰ä¸¢å¼ƒå€¼</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CustomSmartPointer</span></span> &#123;</span><br><span class="line">    data: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> CustomSmartPointer &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Dropping CustomSmartPointer with data `&#123;&#125;`!"</span>, <span class="keyword">self</span>.data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> c = CustomSmartPointer &#123;</span><br><span class="line">        data: <span class="built_in">String</span>::from(<span class="string">"some data"</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"CustomSmartPointer created."</span>);</span><br><span class="line">    <span class="built_in">drop</span>(c);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"CustomSmartPointer dropped before the end of main"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; CustomSmartPointer created.</span></span><br><span class="line"><span class="comment">// =&gt; Dropping CustomSmartPointer with data `some data`!</span></span><br><span class="line"><span class="comment">// =&gt; CustomSmartPointer dropped before the end of main</span></span><br></pre></td></tr></table></figure><h4 id="åŸºäºå¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆ-Rc"><a href="#åŸºäºå¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆ-Rc" class="headerlink" title="åŸºäºå¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆ Rc"></a>åŸºäºå¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆ <strong>Rc<t></t></strong></h4><p>æ‰€æœ‰æƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯æ¸…æ™°çš„ï¼Œå¯¹äºä¸€ä¸ªç»™å®šçš„å€¼ï¼Œå¯ä»¥å‡†ç¡®åœ°åˆ¤æ–­å‡ºå“ªä¸ªå˜é‡æ‹¥æœ‰å®ƒã€‚<br>ä½†åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå•ä¸ªå€¼ä¹Ÿå¯èƒ½åŒæ—¶è¢«å¤šä¸ªæ‰€æœ‰è€…æŒæœ‰ã€‚<br>æ¯”å¦‚åœ¨å›¾æ•°æ®ç»“æ„ä¸­ï¼Œå¤šä¸ªè¾¹å¯èƒ½ä¼šæŒ‡å‘ç›¸åŒçš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹åŒæ—¶å±äºæ‰€æœ‰æŒ‡å‘å®ƒçš„è¾¹ã€‚ä¸€ä¸ªèŠ‚ç‚¹åªè¦åœ¨ä»»æ„æŒ‡å‘å®ƒçš„è¾¹è¿˜å­˜åœ¨æ—¶å°±ä¸åº”è¯¥è¢«æ¸…ç†æ‰ã€‚<br>Rust æä¾›äº†ä¸€ç§åä¸º <code>Rc&lt;T&gt;</code> çš„ç±»å‹æ¥æ”¯æŒå¤šé‡æ‰€æœ‰æƒã€‚<code>Rc&lt;T&gt;</code> ç±»å‹çš„å®ä¾‹ä¼šåœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªç”¨äºè®°å½•å€¼å¼•ç”¨æ¬¡æ•°çš„è®¡æ•°å™¨ï¼Œä»è€Œç¡®è®¤è¿™ä¸ªå€¼æ˜¯å¦ä»åœ¨ä½¿ç”¨ã€‚è‹¥å¯¹ä¸€ä¸ªå€¼çš„å¼•ç”¨æ¬¡æ•°ä¸ºé›¶ï¼Œå°±æ„å‘³ç€è¿™ä¸ªå€¼å¯ä»¥è¢«å®‰å…¨åœ°æ¸…ç†æ‰ã€‚</p><p>å½“ä½ å¸Œæœ›å°†å †ä¸Šçš„ä¸€äº›æ•°æ®åˆ†äº«ç»™ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†åŒæ—¶ä½¿ç”¨ï¼Œè€Œåˆæ— æ³•åœ¨ç¼–è¯‘æœŸç¡®å®šå“ªä¸ªéƒ¨åˆ†ä¼šæœ€åé‡Šæ”¾è¿™äº›æ•°æ®æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>Rc&lt;T&gt;</code> ç±»å‹ã€‚<br>ç›¸ååœ°ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸç¡®å®šå“ªä¸€éƒ¨åˆ†æœ€åä¼šé‡Šæ”¾æ•°æ®ï¼Œé‚£ä¹ˆå°±åªéœ€è¦è®©è¿™éƒ¨åˆ†ä»£ç æˆä¸ºæ•°æ®çš„æ‰€æœ‰è€…å³å¯ã€‚<br><strong><code>Rc&lt;T&gt;</code> åªèƒ½è¢«ç”¨äºå•çº¿ç¨‹åœºæ™¯ä¸­</strong>ã€‚</p><h5 id="ä½¿ç”¨-Rc-lt-T-gt-å…±äº«æ•°æ®"><a href="#ä½¿ç”¨-Rc-lt-T-gt-å…±äº«æ•°æ®" class="headerlink" title="ä½¿ç”¨ Rc&lt;T&gt; å…±äº«æ•°æ®"></a>ä½¿ç”¨ <code>Rc&lt;T&gt;</code> å…±äº«æ•°æ®</h5><p>åˆ›å»ºä¸¤ä¸ªé“¾æ¥åˆ—è¡¨ï¼Œå¹¶è®©å®ƒä»¬åŒæ—¶æŒæœ‰ç¬¬ä¸‰ä¸ªåˆ—è¡¨çš„æ‰€æœ‰æƒã€‚<br><img src="https://upload-images.jianshu.io/upload_images/6875152-46c80b946fd197b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Cons List"></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, <span class="built_in">Box</span>&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = Cons(<span class="number">5</span>, <span class="built_in">Box</span>::new(Cons(<span class="number">10</span>, <span class="built_in">Box</span>::new(Nil))));</span><br><span class="line">    <span class="keyword">let</span> b = Cons(<span class="number">3</span>, <span class="built_in">Box</span>::new(a));</span><br><span class="line">    <span class="keyword">let</span> c = Cons(<span class="number">4</span>, <span class="built_in">Box</span>::new(a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è¯•ç¼–è¯‘ä¸Šè¿°ä»£ç ä¼šæŠ¥å‡º <strong>error[E0382]: use of moved value: <code>a</code></strong> é”™è¯¯ã€‚åŸå› æ˜¯ <code>a</code> åˆ—è¡¨ä¼šåœ¨åˆ›å»º <code>b</code> åˆ—è¡¨æ—¶è¢«ç§»åŠ¨è‡³ <code>b</code> ä¸­ã€‚å³ <code>b</code> åˆ—è¡¨æŒæœ‰äº† <code>a</code> åˆ—è¡¨çš„æ‰€æœ‰æƒã€‚éšåå†æ¬¡å°è¯•ä½¿ç”¨ <code>a</code> æ¥åˆ›å»º <code>c</code> åˆ—è¡¨æ—¶å°±ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸º <code>a</code> å·²ç»è¢«ç§»èµ°äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = Rc::new(Cons(<span class="number">5</span>, Rc::new(Cons(<span class="number">10</span>, Rc::new(Nil)))));</span><br><span class="line">    <span class="keyword">let</span> b = Cons(<span class="number">3</span>, Rc::clone(&amp;a));</span><br><span class="line">    <span class="keyword">let</span> c = Cons(<span class="number">4</span>, Rc::clone(&amp;a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæ¯ä¸ª <code>Cons</code> å˜ä½“éƒ½æŒæœ‰ä¸€ä¸ªå€¼åŠä¸€ä¸ªæŒ‡å‘ List çš„ <code>Rc&lt;T&gt;</code>ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨åˆ›å»º <code>b</code> çš„è¿‡ç¨‹ä¸­å…‹éš† <code>a</code> çš„ <code>Rc&lt;List&gt;</code> æ™ºèƒ½æŒ‡é’ˆå³å¯ï¼Œæ— éœ€è·å– <code>a</code> çš„æ‰€æœ‰æƒã€‚<br>è¿™ä½¿å¾— <code>a</code> å’Œ <code>b</code> å¯ä»¥å…±äº« <code>Rc&lt;List&gt;</code> æ•°æ®çš„æ‰€æœ‰æƒï¼Œå¹¶ä½¿æ™ºèƒ½æŒ‡é’ˆä¸­çš„å¼•ç”¨è®¡æ•°ä» 1 å¢åŠ åˆ° 2ã€‚éšååˆ›å»º <code>c</code> æ—¶ä¹Ÿä¼šåŒæ ·å…‹éš† <code>a</code> å¹¶å°†å¼•ç”¨è®¡æ•°ä» 2 å¢åŠ åˆ° 3ã€‚<br>æ¯æ¬¡è°ƒç”¨ <code>Rc::clone</code> éƒ½ä¼šä½¿å¼•ç”¨è®¡æ•°å¢åŠ ï¼Œè€Œ <code>Rc&lt;List&gt;</code> ä¸­çš„æ•°æ®åªæœ‰åœ¨å¼•ç”¨è®¡æ•°å™¨å‡å°‘åˆ° 0 æ—¶æ‰ä¼šè¢«çœŸæ­£æ¸…ç†æ‰ã€‚</p><h5 id="å…‹éš†-Rc-lt-T-gt-ä¼šå¢åŠ å¼•ç”¨è®¡æ•°"><a href="#å…‹éš†-Rc-lt-T-gt-ä¼šå¢åŠ å¼•ç”¨è®¡æ•°" class="headerlink" title="å…‹éš† Rc&lt;T&gt; ä¼šå¢åŠ å¼•ç”¨è®¡æ•°"></a>å…‹éš† <code>Rc&lt;T&gt;</code> ä¼šå¢åŠ å¼•ç”¨è®¡æ•°</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = Rc::new(Cons(<span class="number">5</span>, Rc::new(Cons(<span class="number">10</span>, Rc::new(Nil)))));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"count after creating a = &#123;&#125;"</span>, Rc::strong_count(&amp;a));</span><br><span class="line">    <span class="keyword">let</span> b = Cons(<span class="number">4</span>, Rc::clone(&amp;a));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"count after creating b = &#123;&#125;"</span>, Rc::strong_count(&amp;a));</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> c = Cons(<span class="number">4</span>, Rc::clone(&amp;a));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"count after creating c = &#123;&#125;"</span>, Rc::strong_count(&amp;a));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"count after c goes out of scope = &#123;&#125;"</span>, Rc::strong_count(&amp;a));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; count after creating a = 1</span></span><br><span class="line"><span class="comment">// =&gt; count after creating b = 2</span></span><br><span class="line"><span class="comment">// =&gt; count after creating c = 3</span></span><br><span class="line"><span class="comment">// =&gt; count after c goes out of scope = 2</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>a</code> å­˜å‚¨çš„ <code>Rc&lt;List&gt;</code> æ‹¥æœ‰åˆå§‹å¼•ç”¨è®¡æ•° 1ï¼Œå¹¶åœ¨éšåæ¯æ¬¡è°ƒç”¨ <code>clone</code> æ—¶å¢åŠ  1ã€‚å½“ <code>c</code> ç¦»å¼€ä½œç”¨åŸŸè¢«ä¸¢å¼ƒæ—¶ï¼Œå¼•ç”¨è®¡æ•°å‡å°‘ 1ã€‚<code>Rc&lt;T&gt;</code> çš„ <code>Drop</code> å®ç°ä¼šåœ¨ <code>Rc&lt;T&gt;</code> ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨å°†å¼•ç”¨è®¡æ•°å‡ 1ã€‚</p><p>ä½¿ç”¨ <code>Rc&lt;T&gt;</code> å¯ä»¥ä½¿å•ä¸ªå€¼æ‹¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ï¼Œè€Œå¼•ç”¨è®¡æ•°æœºåˆ¶åˆ™ä¿è¯äº†è¿™ä¸ªå€¼ä¼šåœ¨å…¶æ‰€æœ‰è€…å­˜æ´»æ—¶ä¸€ç›´æœ‰æ•ˆï¼Œå¹¶åœ¨æ‰€æœ‰è€…å…¨éƒ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è¢«è‡ªåŠ¨æ¸…ç†ã€‚<br><code>Rc&lt;T&gt;</code> é€šè¿‡ä¸å¯å˜å¼•ç”¨ä½¿ä½ å¯ä»¥åœ¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ä¹‹é—´å…±äº«åªè¯»æ•°æ®ã€‚ä½†å¦‚æœ <code>Rc&lt;T&gt;</code> ä¹Ÿå…è®¸æŒæœ‰å¤šä¸ªå¯å˜å¼•ç”¨çš„è¯ï¼Œå°±ä¼šè¿åä¸€ä¸ªå€Ÿç”¨åŸåˆ™ï¼šå¤šä¸ªæŒ‡å‘åŒä¸€åŒºåŸŸçš„å¯å˜å€Ÿç”¨ä¼šå¯¼è‡´æ•°æ®ç«äº‰åŠæ•°æ®ä¸ä¸€è‡´ã€‚<br>ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œå…è®¸æ•°æ®å¯å˜æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚å®é™…ä¸Šå¯ä»¥é€šè¿‡ <code>RefCell&lt;T&gt;</code> ä¸ <code>Rc&lt;T&gt;</code> è”åˆä½¿ç”¨æ¥ç»•å¼€ä¸å¯å˜çš„é™åˆ¶ã€‚</p><h4 id="RefCell-å’Œå†…éƒ¨å¯å˜æ€§æ¨¡å¼"><a href="#RefCell-å’Œå†…éƒ¨å¯å˜æ€§æ¨¡å¼" class="headerlink" title="RefCell å’Œå†…éƒ¨å¯å˜æ€§æ¨¡å¼"></a>RefCell<t> å’Œå†…éƒ¨å¯å˜æ€§æ¨¡å¼</t></h4><p><strong>å†…éƒ¨å¯å˜æ€§</strong> æ˜¯ Rust çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒå…è®¸ä½ åœ¨åªæŒæœ‰ä¸å¯å˜å¼•ç”¨çš„å‰æä¸‹å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚ä¸ºäº†èƒ½å¤Ÿæ”¹å˜æ•°æ®ï¼Œæ­¤æ¨¡å¼åœ¨å®ƒçš„æ•°æ®ç»“æ„ä¸­ä½¿ç”¨äº† <code>unsafe</code> ä»£ç æ¥ç»•è¿‡ Rust æ­£å¸¸çš„å¯å˜æ€§å’Œå€Ÿç”¨è§„åˆ™ã€‚<br>å‡å¦‚æˆ‘ä»¬èƒ½å¤Ÿä¿è¯è‡ªå·±çš„ä»£ç åœ¨è¿è¡Œæ—¶ç¬¦åˆå€Ÿç”¨è§„åˆ™ï¼Œå°±å¯ä»¥åœ¨å³ä½¿ç¼–è¯‘å™¨æ— æ³•åœ¨ç¼–è¯‘é˜¶æ®µä¿è¯ç¬¦åˆå€Ÿç”¨è§„åˆ™çš„å‰æä¸‹ï¼Œä½¿ç”¨é‚£äº›é‡‡ç”¨äº†å†…éƒ¨å¯å˜æ€§æ¨¡å¼çš„ç±»å‹ã€‚å®ç°è¿‡ç¨‹ä¸­æ¶‰åŠçš„é‚£äº›ä¸å®‰å…¨ä»£ç ä¼šè¢«å¦¥å–„åœ°å°è£…åœ¨å®‰å…¨çš„ API å†…ï¼Œè€Œç±»å‹æœ¬èº«ä»å¤–éƒ¨çœ‹ä¾ç„¶æ˜¯ä¸å¯å˜çš„ã€‚</p><h5 id="ä½¿ç”¨-RefCell-lt-T-gt-åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™"><a href="#ä½¿ç”¨-RefCell-lt-T-gt-åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™" class="headerlink" title="ä½¿ç”¨ RefCell&lt;T&gt; åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™"></a>ä½¿ç”¨ <code>RefCell&lt;T&gt;</code> åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™</h5><p>Rust ä¸­çš„å€Ÿç”¨è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´å†…ï¼Œåªèƒ½æ‹¥æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨æˆ–è€…ä»»æ„æ•°é‡çš„ä¸å¯å˜å¼•ç”¨</li><li>å¼•ç”¨æ€»æ˜¯æœ‰æ•ˆçš„</li></ul><p>å¯¹äºä¸€èˆ¬å¼•ç”¨å’Œ <code>Box&lt;T&gt;</code> çš„ä»£ç ï¼ŒRust ä¼šåœ¨<strong>ç¼–è¯‘é˜¶æ®µ</strong>å¼ºåˆ¶ä»£ç éµå®ˆè¿™äº›å€Ÿç”¨è§„åˆ™ã€‚è€Œå¯¹äºä½¿ç”¨ <code>RefCell&lt;T&gt;</code> çš„ä»£ç ï¼ŒRust åªä¼šåœ¨<strong>è¿è¡Œæ—¶</strong>æ£€æŸ¥è¿™äº›è§„åˆ™ï¼Œå¹¶åœ¨è¿åçš„æ—¶å€™è§¦å‘ panic æ¥æå‰ç»ˆæ­¢ç¨‹åºã€‚</p><p>å€Ÿç”¨è§„åˆ™çš„æ£€æŸ¥æ”¾åœ¨ç¼–è¯‘é˜¶æ®µä¸ä»…ä¼šå¸®åŠ©æˆ‘ä»¬åœ¨å¼€å‘é˜¶æ®µå°½æ—©æš´éœ²é—®é¢˜ï¼Œå¹¶ä¸”ä¸ä¼šå¸¦æ¥ä»»ä½•è¿è¡Œæ—¶å¼€é”€ã€‚å¯¹äºå¤§å¤šæ•°åœºæ™¯éƒ½æ˜¯æœ€ä½³çš„é€‰æ‹©ã€‚<br>åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™å¯ä»¥ä½¿æˆ‘ä»¬å®ç°æŸäº›ç‰¹å®šçš„å†…å­˜å®‰å…¨åœºæ™¯ï¼Œå³ä¾¿è¿™äº›åœºæ™¯æ— æ³•é€šè¿‡ç¼–è¯‘æ—¶æ£€æŸ¥ã€‚å› ä¸ºæŸäº›é™æ€åˆ†ææ˜¯æ ¹æœ¬æ— æ³•å®Œæˆçš„ã€‚è¿™ç±»ç¼–è¯‘å™¨æ— æ³•ç†è§£ä»£ç ï¼Œä½†å¼€å‘è€…å¯ä»¥ä¿è¯å€Ÿç”¨è§„åˆ™èƒ½å¤Ÿæ»¡è¶³çš„åœºæ™¯ï¼Œå°±é€‚ç”¨äº <code>RefCell&lt;T&gt;</code>ã€‚</p><h5 id="å¯å˜åœ°å€Ÿç”¨ä¸€ä¸ªä¸å¯å˜çš„å€¼"><a href="#å¯å˜åœ°å€Ÿç”¨ä¸€ä¸ªä¸å¯å˜çš„å€¼" class="headerlink" title="å¯å˜åœ°å€Ÿç”¨ä¸€ä¸ªä¸å¯å˜çš„å€¼"></a>å¯å˜åœ°å€Ÿç”¨ä¸€ä¸ªä¸å¯å˜çš„å€¼</h5><p><strong>å†…éƒ¨å¯å˜æ€§æ¨¡å¼å…è®¸ç”¨æˆ·æ›´æ”¹ä¸€ä¸ªä¸å¯å˜å€¼çš„å†…éƒ¨æ•°æ®</strong>ã€‚<br>å€Ÿç”¨è§„åˆ™é™åˆ¶ç”¨æˆ·å¯å˜åœ°å€Ÿç”¨ä¸€ä¸ªä¸å¯å˜çš„å€¼ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> y = &amp;<span class="keyword">mut</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªå€¼å¯¹å¤–ä¿æŒä¸å¯å˜æ€§çš„åŒæ—¶èƒ½å¤Ÿåœ¨æ–¹æ³•å†…éƒ¨ä¿®æ”¹è‡ªèº«ã€‚é™¤äº†è¿™ä¸ªå€¼æœ¬èº«çš„æ–¹æ³•ï¼Œå…¶ä½™çš„ä»£ç ä»ä¸èƒ½ä¿®æ”¹è¿™ä¸ªå€¼ã€‚<br>ä½¿ç”¨ <code>RefCell&lt;T&gt;</code> å¯ä»¥è·å¾—è¿™ç§å†…éƒ¨å¯å˜æ€§ã€‚<br>è¿™ç§å†…éƒ¨å¯å˜æ€§çš„æœºåˆ¶æŠŠå€Ÿç”¨è§„åˆ™çš„æ£€æŸ¥ä»ç¼–è¯‘æœŸå»¶ååˆ°äº†è¿è¡Œé˜¶æ®µï¼Œè‹¥è¿åäº†å€Ÿç”¨è§„åˆ™ï¼Œåªä¼šåœ¨è¿è¡Œæ—¶è§¦å‘ <strong>panic!</strong>ã€‚</p><p><strong>å†…éƒ¨å¯å˜æ€§çš„åº”ç”¨åœºæ™¯ï¼šæ¨¡æ‹Ÿå¯¹è±¡</strong><br><strong>æµ‹è¯•æ›¿ä»£</strong>æ˜¯ä¸€ç§é€šç”¨çš„ç¼–ç¨‹æ¦‚å¿µï¼Œä»£è¡¨äº†é‚£äº›åœ¨æµ‹è¯•å·¥ä½œä¸­è¢«ç”¨ä½œå…¶ä»–ç±»å‹æ›¿ä»£å“çš„ç±»å‹ã€‚è€Œ<strong>æ¨¡æ‹Ÿå¯¹è±¡</strong>åˆ™æŒ‡ä»£äº†æµ‹è¯•æ›¿ä»£ä¸­æŸäº›ç‰¹å®šçš„ç±»å‹ï¼Œä¼šæ‰¿æ‹…èµ·è®°å½•æµ‹è¯•è¿‡ç¨‹çš„å·¥ä½œã€‚</p><p>Rust æ²¡æœ‰å’Œå…¶ä»–è¯­è¨€ä¸­ç±»ä¼¼çš„å¯¹è±¡æ¦‚å¿µï¼Œä¹Ÿæ²¡æœ‰åœ¨æ ‡å‡†åº“ä¸­æä¾›æ¨¡æ‹Ÿå¯¹è±¡çš„æµ‹è¯•åŠŸèƒ½ã€‚ä½†æ˜¯å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªç»“æ„ä½“æ¥å®ç°ä¸æ¨¡æ‹Ÿå¯¹è±¡ç›¸åŒçš„æ•ˆæœã€‚<br>æ¯”å¦‚æˆ‘ä»¬å¸Œæœ›å¼€å‘ä¸€ä¸ªåº“ï¼Œä¼šåŸºäºå½“å‰å€¼ä¸æœ€å¤§å€¼ä¹‹é—´çš„æ¥è¿‘ç¨‹åº¦å‘å¤–ä¼ é€’ä¿¡æ¯ã€‚æ¯”å¦‚å¯ä»¥è®°å½•ç”¨æˆ·è°ƒç”¨ä¸åŒ API çš„æ¬¡æ•°ï¼Œå¹¶ä¸è®¾ç½®çš„è°ƒç”¨é™é¢ä½œæ¯”è¾ƒã€‚<br>ä½¿ç”¨è¿™ä¸ªåº“çš„åº”ç”¨ç¨‹åºéœ€è¦è‡ªè¡Œå®ç°å‘é€æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œä¾‹å¦‚åœ¨åº”ç”¨ç¨‹åºä¸­æ‰“å°ä¿¡æ¯ã€å‘é€é‚®ä»¶ã€å‘é€æ–‡å­—çŸ­ä¿¡ç­‰ã€‚<br>æºä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Messenger</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">send</span></span>(&amp;<span class="keyword">self</span>, msg: &amp;<span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LimitTracker</span></span>&lt;<span class="symbol">'a</span>, T: <span class="symbol">'a</span> + Messenger&gt; &#123;</span><br><span class="line">    messenger: &amp;<span class="symbol">'a</span> T,</span><br><span class="line">    value: <span class="built_in">usize</span>,</span><br><span class="line">    max: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>, T&gt; LimitTracker&lt;<span class="symbol">'a</span>, T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Messenger,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(messenger: &amp;T, max: <span class="built_in">usize</span>) -&gt; LimitTracker&lt;T&gt; &#123;</span><br><span class="line">        LimitTracker &#123;</span><br><span class="line">            messenger,</span><br><span class="line">            value: <span class="number">0</span>,</span><br><span class="line">            max,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_value</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, value: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> percentage_of_max = <span class="keyword">self</span>.value <span class="keyword">as</span> <span class="built_in">f64</span> / <span class="keyword">self</span>.max <span class="keyword">as</span> <span class="built_in">f64</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">1.0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger.send(<span class="string">"Error: You're over your quota!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">0.9</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger</span><br><span class="line">                .send(<span class="string">"Urgent warning: You've used 90% of your quota!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">0.75</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger</span><br><span class="line">                .send(<span class="string">"Warning: You've used 75% of your quota!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MockMessenger</span></span> &#123;</span><br><span class="line">        sent_messages: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> MockMessenger &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; MockMessenger &#123;</span><br><span class="line">            MockMessenger &#123;</span><br><span class="line">                sent_messages: <span class="built_in">vec!</span>[],</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> Messenger <span class="keyword">for</span> MockMessenger &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">send</span></span>(&amp;<span class="keyword">self</span>, message: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.sent_messages.push(<span class="built_in">String</span>::from(message));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">it_sends_an_over_75_percent_warning_message</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> mock_messenger = MockMessenger::new();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> limit_tracker = LimitTracker::new(&amp;mock_messenger, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        limit_tracker.set_value(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(mock_messenger.sent_messages.len(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>Messenger</code> trait çš„ <code>send</code> æ–¹æ³•å¯ä»¥æ¥æ”¶ <code>self</code> çš„ä¸å¯å˜å¼•ç”¨åŠä¸€æ¡æ–‡æœ¬æ¶ˆæ¯ä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬éœ€è¦åœ¨æµ‹è¯•ä¸­ç¡®å®šçš„æ˜¯ï¼Œå½“æŸæ®µç¨‹åºä½¿ç”¨ä¸€ä¸ªå®ç°äº† Messenger trait çš„æ¨¡æ‹Ÿå¯¹è±¡ä¸ä¸€ä¸ª max å€¼æ¥åˆ›å»º <code>LimitTracker</code> å®ä¾‹æ—¶ï¼Œä¼ å…¥çš„ä¸åŒ value å€¼èƒ½å¤Ÿè§¦å‘ messenger å‘é€ä¸åŒçš„ä¿¡æ¯ã€‚<br>æ­¤å¤„çš„æ¨¡æ‹Ÿå¯¹è±¡ <code>MockMessenger</code> åœ¨è°ƒç”¨ <code>send</code> æ—¶åªéœ€è¦å°†æ”¶åˆ°çš„æ¶ˆæ¯å­˜æ¡£è®°å½•å³å¯ï¼Œä¸éœ€è¦çœŸçš„å»å‘é€é‚®ä»¶æˆ–çŸ­ä¿¡ã€‚ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡åˆ›å»º <code>LimitTracker</code> å®ä¾‹åï¼Œå°±å¯ä»¥é€šè¿‡è°ƒç”¨ <code>set_value</code> æ–¹æ³•æ£€æŸ¥æ¨¡æ‹Ÿå¯¹è±¡ä¸­æ˜¯å¦å­˜å‚¨äº†æˆ‘ä»¬å¸Œæœ›è§åˆ°çš„æ¶ˆæ¯ã€‚</p><p>å°è¯•ç¼–è¯‘ï¼ˆ<code>cargo test</code>ï¼‰ä¸Šè¿°ä»£ç ä¼šæŠ¥å‡ºå¦‚ä¸‹é”™è¯¯ï¼š<br><code>error[E0596]: cannot borrow `self.sent_messages` as mutable, as it is behind a `&amp;` reference</code></p><p><code>send</code> æ–¹æ³•æ¥æ”¶äº† <code>self</code> çš„ä¸å¯å˜å¼•ç”¨ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•é€šè¿‡ä¿®æ”¹ <code>MockMessenger</code> çš„å†…å®¹æ¥è®°å½•æ¶ˆæ¯ã€‚æˆ‘ä»¬ä¹Ÿä¸èƒ½å°†å‡½æ•°ç­¾åä¿®æ”¹ä¸º <code>&amp;mut self</code>ï¼Œå› ä¸ºä¿®æ”¹åçš„ç­¾åä¸ Messenger trait å®šä¹‰çš„ <code>send</code> ç­¾åä¸ç¬¦ã€‚<br>æ­¤æ—¶å°±æ˜¯ä¸€ä¸ªéå¸¸é€‚åˆå†…éƒ¨å¯å˜æ€§çš„åœºæ™¯ã€‚åªè¦åœ¨ <code>RefCell&lt;T&gt;</code> ä¸­å­˜å…¥ <code>sent_messages</code>ï¼Œ<code>send</code> æ–¹æ³•å°±èƒ½å¤Ÿä¿®æ”¹ <code>sent_messages</code>ã€‚</p><p>ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Messenger</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">send</span></span>(&amp;<span class="keyword">self</span>, msg: &amp;<span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LimitTracker</span></span>&lt;<span class="symbol">'a</span>, T: <span class="symbol">'a</span> + Messenger&gt; &#123;</span><br><span class="line">    messenger: &amp;<span class="symbol">'a</span> T,</span><br><span class="line">    value: <span class="built_in">usize</span>,</span><br><span class="line">    max: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>, T&gt; LimitTracker&lt;<span class="symbol">'a</span>, T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Messenger,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(messenger: &amp;T, max: <span class="built_in">usize</span>) -&gt; LimitTracker&lt;T&gt; &#123;</span><br><span class="line">        LimitTracker &#123;</span><br><span class="line">            messenger,</span><br><span class="line">            value: <span class="number">0</span>,</span><br><span class="line">            max,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_value</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, value: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> percentage_of_max = <span class="keyword">self</span>.value <span class="keyword">as</span> <span class="built_in">f64</span> / <span class="keyword">self</span>.max <span class="keyword">as</span> <span class="built_in">f64</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">1.0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger.send(<span class="string">"Error: You're over your quota!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">0.9</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger</span><br><span class="line">                .send(<span class="string">"Urgent warning: You've used 90% of your quota!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">0.75</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger</span><br><span class="line">                .send(<span class="string">"Warning: You've used 75% of your quota!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MockMessenger</span></span> &#123;</span><br><span class="line">        sent_messages: RefCell&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;&gt;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> MockMessenger &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; MockMessenger &#123;</span><br><span class="line">            MockMessenger &#123;</span><br><span class="line">                sent_messages: RefCell::new(<span class="built_in">vec!</span>[]),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> Messenger <span class="keyword">for</span> MockMessenger &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">send</span></span>(&amp;<span class="keyword">self</span>, message: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.sent_messages.borrow_mut().push(<span class="built_in">String</span>::from(message));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">it_sends_an_over_75_percent_warning_message</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> mock_messenger = MockMessenger::new();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> limit_tracker = LimitTracker::new(&amp;mock_messenger, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        limit_tracker.set_value(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(mock_messenger.sent_messages.borrow().len(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>sent_messages</code> å­—æ®µçš„ç±»å‹å˜ä¸ºäº† <code>RefCell&lt;Vec&lt;String&gt;&gt;</code>ã€‚å¯¹äº <code>send</code> æ–¹æ³•çš„å®ç°ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°ä¾ç„¶æ˜¯ <code>self</code> çš„ä¸å¯å˜å€Ÿç”¨ï¼Œä¸ trait çš„å®šä¹‰ä¿æŒä¸€è‡´ã€‚åé¢çš„ä»£ç è°ƒç”¨ <code>self.messages.borrow_mut</code> æ–¹æ³•è·å– <code>RefCell&lt;Vec&lt;String&gt;&gt;</code> å†…éƒ¨å€¼ï¼ˆä¹Ÿå°±æ˜¯åŠ¨æ€æ•°ç»„ï¼‰çš„å¯å˜å¼•ç”¨ï¼Œå†è°ƒç”¨å…¶ <code>push</code> æ–¹æ³•å­˜å…¥æ•°æ®ã€‚<br>åœ¨æ–­è¨€è¯­å¥ä¸­ï¼Œè°ƒç”¨äº† <code>RefCell&lt;Vec&lt;String&gt;&gt;</code> çš„ <code>borrow</code> æ–¹æ³•æ¥å–å¾—åŠ¨æ€æ•°ç»„çš„ä¸å¯å˜å¼•ç”¨ã€‚</p><p>å¯¹äº <code>RefCell&lt;T&gt;</code> è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>borrow</code> ä¸ <code>borrow_mut</code> åˆ†åˆ«åˆ›å»ºä¸å¯å˜å’Œå¯å˜å¼•ç”¨ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šåˆ†åˆ«è¿”å› <code>Ref&lt;T&gt;</code> ä¸ <code>RefMut&lt;T&gt;</code> ä¸¤ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå¯ä»¥è¢«å½“ä½œä¸€èˆ¬çš„å¼•ç”¨æ¥å¯¹å¾…ã€‚<br><code>RefCell&lt;T&gt;</code> ä¼šè®°å½•å½“å‰å­˜åœ¨å¤šå°‘ä¸ªæ´»è·ƒçš„ <code>Ref&lt;T&gt;</code> å’Œ <code>RefMut&lt;T&gt;</code>ï¼Œç»´æŠ¤å’Œç¼–è¯‘å™¨åŒæ ·çš„å€Ÿç”¨è§„åˆ™ï¼šä»»ä½•ç»™å®šçš„æ—¶é—´éƒ½åªå…è®¸æ‹¥æœ‰å¤šä¸ªä¸å¯å˜å€Ÿç”¨æˆ–ä¸€ä¸ªå¯å˜å€Ÿç”¨ã€‚<br>å½“å€Ÿç”¨è§„åˆ™è¢«è¿èƒŒæ—¶ï¼Œ<code>RefCell&lt;T&gt;</code> ä¼šåœ¨<strong>è¿è¡Œæ—¶</strong>è§¦å‘ panicã€‚</p><h4 id="Rc-lt-T-gt-å’Œ-RefCell-lt-T-gt-å®ç°ä¸€ä¸ªæ‹¥æœ‰å¤šé‡æ‰€æœ‰æƒçš„å¯å˜æ•°æ®"><a href="#Rc-lt-T-gt-å’Œ-RefCell-lt-T-gt-å®ç°ä¸€ä¸ªæ‹¥æœ‰å¤šé‡æ‰€æœ‰æƒçš„å¯å˜æ•°æ®" class="headerlink" title="Rc&lt;T&gt; å’Œ RefCell&lt;T&gt; å®ç°ä¸€ä¸ªæ‹¥æœ‰å¤šé‡æ‰€æœ‰æƒçš„å¯å˜æ•°æ®"></a><code>Rc&lt;T&gt;</code> å’Œ <code>RefCell&lt;T&gt;</code> å®ç°ä¸€ä¸ªæ‹¥æœ‰å¤šé‡æ‰€æœ‰æƒçš„å¯å˜æ•°æ®</h4><p><code>Rc&lt;T&gt;</code> å…è®¸å¤šä¸ªæ‰€æœ‰è€…æŒæœ‰åŒä¸€æ•°æ®ï¼Œä½†åªèƒ½æä¾›é’ˆå¯¹æ•°æ®çš„ä¸å¯å˜è®¿é—®ã€‚è‹¥åœ¨ <code>Rc&lt;T&gt;</code> å†…å­˜å‚¨äº† <code>RefCell&lt;T&gt;</code>ï¼Œå°±å¯ä»¥å®šä¹‰å‡ºæ‹¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ä¸”èƒ½å¤Ÿè¿›è¡Œä¿®æ”¹çš„å€¼äº†ã€‚</p><p>åœ¨ <code>Cons</code> å®šä¹‰ä¸­ä½¿ç”¨ <code>RefCell&lt;T&gt;</code> æ¥å®ç°ä¿®æ”¹ç°æœ‰åˆ—è¡¨å†…æ•°å€¼çš„åŠŸèƒ½ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(Rc&lt;RefCell&lt;<span class="built_in">i32</span>&gt;&gt;, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> value = Rc::new(RefCell::new(<span class="number">5</span>));</span><br><span class="line">    <span class="keyword">let</span> a = Rc::new(Cons(Rc::clone(&amp;value), Rc::new(Nil)));</span><br><span class="line">    <span class="keyword">let</span> b = Cons(Rc::new(RefCell::new(<span class="number">6</span>)), Rc::clone(&amp;a));</span><br><span class="line">    <span class="keyword">let</span> c = Cons(Rc::new(RefCell::new(<span class="number">10</span>)), Rc::clone(&amp;a));</span><br><span class="line"></span><br><span class="line">    *value.borrow_mut() += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"a after = &#123;:?&#125;"</span>, a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"b after = &#123;:?&#125;"</span>, b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"c after = &#123;:?&#125;"</span>, c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="å¾ªç¯å¼•ç”¨ä¸å†…å­˜æ³„æ¼"><a href="#å¾ªç¯å¼•ç”¨ä¸å†…å­˜æ³„æ¼" class="headerlink" title="å¾ªç¯å¼•ç”¨ä¸å†…å­˜æ³„æ¼"></a>å¾ªç¯å¼•ç”¨ä¸å†…å­˜æ³„æ¼</h4><p>ä¸æ•°æ®ç«äº‰ä¸åŒï¼Œåœ¨ç¼–è¯‘æœŸå½»åº•é˜²æ­¢å†…å­˜æ³„æ¼å¹¶ä¸æ˜¯ Rust åšå‡ºçš„ä¿è¯ã€‚è¿™æ„å‘³ç€å†…å­˜æ³„æ¼åœ¨ Rust ä¸­æ˜¯ä¸€ç§å†…å­˜å®‰å…¨è¡Œä¸ºã€‚<br>å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>Rc&lt;T&gt;</code> å’Œ <code>RefCell&lt;T&gt;</code> åˆ›å»ºå‡ºç›¸äº’å¼•ç”¨æˆç¯çŠ¶çš„å®ä¾‹ã€‚ç”±äºç¯ä¸­æ¯ä¸€ä¸ªæŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°éƒ½ä¸å¯èƒ½å‡å°‘åˆ° 0ï¼Œå¯¹åº”çš„å€¼ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ä¸¢å¼ƒï¼Œæœ€ç»ˆé€ æˆå†…å­˜æ³„æ¼ã€‚</p><p>ä»£ç ä¸­å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>Rc&lt;List&gt;</code> å®ä¾‹å¹¶å­˜å‚¨è‡³å˜é‡ <code>a</code>ï¼Œå…¶ä¸­çš„ List åˆå§‹å€¼ä¸º <code>5, Nil</code>ã€‚<br>ä¹‹ååˆåˆ›å»ºäº†ä¸€ä¸ª <code>Rc&lt;List&gt;</code> å®ä¾‹å¹¶å­˜å‚¨è‡³å˜é‡ <code>b</code>ï¼Œå…¶ä¸­çš„ List åŒ…å«æ•°å€¼ 10 åŠæŒ‡å‘åˆ—è¡¨ <code>a</code> çš„æŒ‡é’ˆã€‚<br>æ¥ç€å°† <code>a</code> æŒ‡å‘çš„ä¸‹ä¸€ä¸ªå…ƒç´  <code>Nil</code> ä¿®æ”¹ä¸º <code>b</code>ï¼Œæ­¤æ—¶å³åˆ›å»ºå‡ºäº†å¾ªç¯å¼•ç”¨ã€‚</p><p>åœ¨å®Œæˆ <code>a</code> æŒ‡å‘ <code>b</code> çš„æ“ä½œåï¼Œè¿™ä¸¤ä¸ª <code>Rc&lt;List&gt;</code> å®ä¾‹çš„å¼•ç”¨è®¡æ•°éƒ½å˜ä¸ºäº† 2ã€‚è€Œåœ¨ <code>main</code> å‡½æ•°ç»“å°¾å¤„ï¼ŒRust ä¼šé¦–å…ˆé‡Šæ”¾ <code>b</code>ï¼Œå¹¶ä½¿ <code>b</code> å­˜å‚¨çš„ <code>Rc&lt;List&gt;</code> å®ä¾‹çš„å¼•ç”¨è®¡æ•°å‡å°‘ 1ã€‚<br>ä½†ç”±äº <code>a</code> ä»ç„¶æœ‰ä¸€ä¸ªæŒ‡å‘ <code>b</code> ä¸­ <code>Rc&lt;List&gt;</code> çš„å¼•ç”¨ï¼Œè¿™ä¸ª <code>Rc&lt;List&gt;</code> çš„å¼•ç”¨è®¡æ•°ä»ç„¶æ˜¯ 1 è€Œä¸æ˜¯ 0ã€‚å› æ­¤è¯¥ <code>Rc&lt;List&gt;</code> åœ¨å †ä¸Šçš„å†…å­˜ä¸ä¼šè¢«é‡Šæ”¾ï¼Œè¿™å—å†…å­˜ä¼šæ°¸è¿œä»¥å¼•ç”¨è®¡æ•°ä¸º 1 çš„çŠ¶æ€ä¿ç•™åœ¨å †ä¸Šã€‚<br><img src="https://upload-images.jianshu.io/upload_images/6875152-55a8d6b393cb625e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="a å’Œ b ç›¸äº’æŒ‡å‘çš„å¾ªç¯å¼•ç”¨"></p><p>å‡å¦‚å»é™¤æœ€åä¸€è¡Œ <code>println!</code> çš„æ³¨é‡Šå¹¶å†æ¬¡è¿è¡Œç¨‹åºï¼ŒRust ä¼šåœ¨å°è¯•å°†å¾ªç¯å¼•ç”¨æ‰“å°å‡ºæ¥çš„è¿‡ç¨‹ä¸­åå¤åœ°ä» <code>a</code> è·³è½¬åˆ° <code>b</code>ï¼Œå†ä» <code>b</code> è·³è½¬è‡³ <code>a</code>ï¼Œç›´åˆ°å‘ç”Ÿæ ˆæº¢å‡ºä¸ºæ­¢ã€‚</p><p>å¦‚æœç¨‹åºä¸­å­˜åœ¨ <code>RefCell&lt;T&gt;</code> åŒ…å« <code>Rc&lt;T&gt;</code> æˆ–å…¶ä»–è”ç”¨äº†å†…éƒ¨å¯å˜æ€§ä¸å¼•ç”¨è®¡æ•°æŒ‡é’ˆçš„æƒ…å½¢ï¼Œå°±éœ€è¦è‡ªè¡Œç¡®ä¿ä¸ä¼šåœ¨ä»£ç ä¸­åˆ›å»ºå‡ºå¾ªç¯å¼•ç”¨ã€‚<br>åˆ›å»ºå‡ºå¾ªç¯å¼•ç”¨æ„å‘³ç€ä»£ç é€»è¾‘æœ‰ bugï¼Œå¯ä»¥é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•åŠå…¶ä»–è½¯ä»¶å¼€å‘æ‰‹æ®µæ¥å°½å¯èƒ½åœ°é¿å…ã€‚</p><h4 id="ä½¿ç”¨-Weak-lt-T-gt-æ›¿ä»£-Rc-lt-T-gt-æ¥é¿å…å¾ªç¯å¼•ç”¨"><a href="#ä½¿ç”¨-Weak-lt-T-gt-æ›¿ä»£-Rc-lt-T-gt-æ¥é¿å…å¾ªç¯å¼•ç”¨" class="headerlink" title="ä½¿ç”¨ Weak&lt;T&gt; æ›¿ä»£ Rc&lt;T&gt; æ¥é¿å…å¾ªç¯å¼•ç”¨"></a>ä½¿ç”¨ <code>Weak&lt;T&gt;</code> æ›¿ä»£ <code>Rc&lt;T&gt;</code> æ¥é¿å…å¾ªç¯å¼•ç”¨</h4><p>è°ƒç”¨ <code>Rc::clone</code> ä¼šå¢åŠ  <code>Rc&lt;T&gt;</code> å®ä¾‹çš„ <code>strong_count</code> å¼•ç”¨è®¡æ•°ï¼Œè€Œ <code>Rc&lt;T&gt;</code> å®ä¾‹åªæœ‰åœ¨ <code>strong_count</code> ä¸º 0 æ—¶æ‰ä¼šè¢«æ¸…ç†ã€‚<br>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è°ƒç”¨ <code>Rc::downgrade</code> å‡½æ•°æ¥åˆ›å»º <code>Rc&lt;T&gt;</code> å®ä¾‹ä¸­å€¼çš„å¼±å¼•ç”¨ã€‚ä½¿ç”¨ <code>Rc&lt;T&gt;</code> çš„å¼•ç”¨æ¥è°ƒç”¨ <code>Rc::downgrade</code> ä¼šè¿”å›ä¸€ä¸ªç±»å‹ä¸º <code>Weak&lt;T&gt;</code> çš„æ™ºèƒ½æŒ‡é’ˆï¼Œè¿™ä¸€æ“ä½œä¼šè®© <code>Rc&lt;T&gt;</code> çš„ <code>weak_count</code> è®¡æ•°å¢åŠ  1ã€‚<code>Rc&lt;T&gt;</code> ç±»å‹ä½¿ç”¨ <code>weak_count</code> æ¥è®°å½•å½“å‰å­˜åœ¨å¤šå°‘ä¸ª <code>Weak&lt;T&gt;</code> å¼•ç”¨ï¼Œä½†ä¸ä¼šåœ¨æ‰§è¡Œæ¸…ç†æ“ä½œå‰è¦æ±‚ <code>weak_count</code> å¿…é¡»ä¸º 0ã€‚<br>å¼ºå¼•ç”¨å¯ä»¥è¢«ç”¨æ¥å…±äº«ä¸€ä¸ª <code>Rc&lt;T&gt;</code> å®ä¾‹çš„æ‰€æœ‰æƒï¼Œè€Œå¼±å¼•ç”¨åˆ™ä¸ä¼šè¡¨è¾¾æ‰€æœ‰æƒå…³ç³»ã€‚ä¸€æ—¦å¼ºå¼•ç”¨è®¡æ•°ä¸º 0ï¼Œä»»ä½•ç”±å¼±å¼•ç”¨ç»„æˆçš„å¾ªç¯å°±ä¼šè¢«æ‰“ç ´ã€‚<strong>å¼±å¼•ç”¨ä¸ä¼šé€ æˆå¾ªç¯å¼•ç”¨</strong>ã€‚<br>æˆ‘ä»¬æ— æ³•ç¡®å®š <code>Weak&lt;T&gt;</code> å¼•ç”¨çš„å€¼æ˜¯å¦å·²ç»è¢«é‡Šæ”¾ï¼Œå› æ­¤éœ€è¦åœ¨ä½¿ç”¨ <code>Weak&lt;T&gt;</code> æŒ‡å‘çš„å€¼ä¹‹å‰ç¡®ä¿å®ƒä¾ç„¶å­˜åœ¨ã€‚å¯ä»¥è°ƒç”¨ <code>Weak&lt;T&gt;</code> å®ä¾‹çš„ <code>upgrade</code> æ–¹æ³•æ¥å®Œæˆè¿™ä¸€éªŒè¯ã€‚æ­¤å‡½æ•°è¿”å›çš„ <code>Option&lt;Rc&lt;T&gt;&gt;</code> ä¼šåœ¨ <code>Rc&lt;T&gt;</code> å€¼ä¾ç„¶å­˜åœ¨æ—¶è¡¨è¾¾ä¸º <code>Some</code>ï¼Œåœ¨ <code>Rc&lt;T&gt;</code> å€¼è¢«é‡Šæ”¾æ—¶è¡¨è¾¾ä¸º <code>None</code>ã€‚Rust èƒ½å¤Ÿä¿è¯ <code>Some</code> å’Œ <code>None</code> ä¸¤ä¸ªåˆ†æ”¯éƒ½å¾—åˆ°å¦¥å–„çš„å¤„ç†ï¼Œä¸ä¼šäº§ç”Ÿæ— æ•ˆæŒ‡é’ˆä¹‹ç±»çš„é—®é¢˜ã€‚</p><h5 id="åˆ›å»ºæ ‘çŠ¶ç»“æ„ä½“ï¼šå¸¦æœ‰å­èŠ‚ç‚¹çš„-Node"><a href="#åˆ›å»ºæ ‘çŠ¶ç»“æ„ä½“ï¼šå¸¦æœ‰å­èŠ‚ç‚¹çš„-Node" class="headerlink" title="åˆ›å»ºæ ‘çŠ¶ç»“æ„ä½“ï¼šå¸¦æœ‰å­èŠ‚ç‚¹çš„ Node"></a>åˆ›å»ºæ ‘çŠ¶ç»“æ„ä½“ï¼šå¸¦æœ‰å­èŠ‚ç‚¹çš„ Node</h5><p>æºä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span> &#123;</span><br><span class="line">    value: <span class="built_in">i32</span>,</span><br><span class="line">    children: RefCell&lt;<span class="built_in">Vec</span>&lt;Rc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> leaf = Rc::new(Node &#123;</span><br><span class="line">        value: <span class="number">3</span>,</span><br><span class="line">        children: RefCell::new(<span class="built_in">vec!</span>[]),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> branch = Rc::new(Node &#123;</span><br><span class="line">        value: <span class="number">5</span>,</span><br><span class="line">        children: RefCell::new(<span class="built_in">vec!</span>[Rc::clone(&amp;leaf)]),</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å¸Œæœ› Node æŒæœ‰è‡ªèº«æ‰€æœ‰å­èŠ‚ç‚¹å¹¶é€šè¿‡å˜é‡æ¥å…±äº«å®ƒä»¬çš„æ‰€æœ‰æƒï¼Œä»è€Œå¯ä»¥ç›´æ¥è®¿é—®æ ‘ä¸­çš„æ¯ä¸ª Nodeã€‚å› æ­¤å°† <code>Vec&lt;T&gt;</code> çš„å…ƒç´ å®šä¹‰ä¸º <code>Rc&lt;Node&gt;</code> ç±»å‹çš„å€¼ã€‚<br>æˆ‘ä»¬è¿˜å¸Œæœ›åœ¨ <code>children</code> å­—æ®µä¸­ä½¿ç”¨ <code>RefCell&lt;T&gt;</code> åŒ…è£¹ <code>Vec&lt;Rc&lt;Node&gt;&gt;</code> æ¥å®ç°å†…éƒ¨å¯å˜æ€§ã€‚<br>æˆ‘ä»¬ä½¿ç”¨ä¸Šè¿°ç»“æ„ä½“å®šä¹‰ä¸€ä¸ªå€¼ä¸º 3 ä¸”æ²¡æœ‰å­èŠ‚ç‚¹çš„ Node å®ä¾‹ï¼Œå¹¶å°†å…¶ä½œä¸ºå¶å­èŠ‚ç‚¹å­˜å…¥ <code>leaf</code> å˜é‡ã€‚å†å®šä¹‰ä¸€ä¸ªå€¼ä¸º 5 ä¸”å°† <code>leaf</code> ä½œä¸ºå­èŠ‚ç‚¹çš„ <code>branch</code> å®ä¾‹ã€‚æ¥ç€å…‹éš† <code>leaf</code> çš„ <code>Rc&lt;Node&gt;</code> å®ä¾‹ï¼Œå¹¶å°†å…¶å­˜å…¥ <code>branch</code>ã€‚<br>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>branch.children</code> æ¥ä» <code>branch</code> è®¿é—® <code>leaf</code>ï¼Œä½†æ˜¯åä¹‹åˆ™ä¸è¡Œã€‚å› ä¸º <code>leaf</code> å¹¶ä¸æŒæœ‰ <code>branch</code> çš„å¼•ç”¨ï¼Œå®ƒç”šè‡³å¯¹ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´å­˜åœ¨çˆ¶å­å…³ç³»ä¸€æ— æ‰€çŸ¥ã€‚</p><h5 id="å¢åŠ å­èŠ‚ç‚¹æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨"><a href="#å¢åŠ å­èŠ‚ç‚¹æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨" class="headerlink" title="å¢åŠ å­èŠ‚ç‚¹æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨"></a>å¢åŠ å­èŠ‚ç‚¹æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨</h5><p>ä¸ºäº†è®©å­èŠ‚ç‚¹æ„è¯†åˆ°çˆ¶èŠ‚ç‚¹çš„å­˜åœ¨ï¼Œå¯ä»¥ä¸º <code>Node</code> ç»“æ„ä½“æ·»åŠ ä¸€ä¸ª <code>parent</code> å­—æ®µã€‚ä½† <code>parent</code> çš„ç±»å‹ä¸èƒ½æ˜¯ <code>Rc&lt;T&gt;</code>ï¼Œä¼šåˆ›å»ºå¾ªç¯å¼•ç”¨ã€‚<code>branch.children</code> æŒ‡å‘ <code>leaf</code> çš„åŒæ—¶ä½¿ <code>leaf.parent</code> æŒ‡å‘ <code>branch</code> ä¼šå¯¼è‡´ä¸¤è€…çš„ <code>strong_count</code> éƒ½æ— æ³•æ¸…é›¶ã€‚</p><p>çˆ¶èŠ‚ç‚¹è‡ªç„¶æ‹¥æœ‰å­èŠ‚ç‚¹çš„æ‰€æœ‰æƒï¼Œå› ä¸ºçˆ¶èŠ‚ç‚¹è¢«ä¸¢å¼ƒæ—¶ï¼Œå­èŠ‚ç‚¹ä¹Ÿåº”è¯¥éšä¹‹è¢«ä¸¢å¼ƒï¼›ä½†å­èŠ‚ç‚¹å´ä¸åº”è¯¥æ‹¥æœ‰çˆ¶èŠ‚ç‚¹çš„æ‰€æœ‰æƒï¼Œå³çˆ¶èŠ‚ç‚¹çš„å­˜åœ¨ä¸ä¼šå› ä¸ºä¸¢å¼ƒå­èŠ‚ç‚¹è€Œå—åˆ°å½±å“ã€‚<br>è¿™æ°å¥½æ˜¯ä½¿ç”¨å¼±å¼•ç”¨çš„åœºæ™¯ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc, Weak&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span> &#123;</span><br><span class="line">    value: <span class="built_in">i32</span>,</span><br><span class="line">    parent: RefCell&lt;Weak&lt;Node&gt;&gt;,</span><br><span class="line">    children: RefCell&lt;<span class="built_in">Vec</span>&lt;Rc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> leaf = Rc::new(Node &#123;</span><br><span class="line">        value: <span class="number">3</span>,</span><br><span class="line">        parent: RefCell::new(Weak::new()),</span><br><span class="line">        children: RefCell::new(<span class="built_in">vec!</span>[]),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"leaf parent = &#123;:?&#125;"</span>, leaf.parent.borrow().upgrade());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> branch = Rc::new(Node &#123;</span><br><span class="line">        value: <span class="number">5</span>,</span><br><span class="line">        parent: RefCell::new(Weak::new()),</span><br><span class="line">        children: RefCell::new(<span class="built_in">vec!</span>[Rc::clone(&amp;leaf)]),</span><br><span class="line">    &#125;);</span><br><span class="line">    *leaf.parent.borrow_mut() = Rc::downgrade(&amp;branch);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"leaf parent = &#123;:?&#125;"</span>, leaf.parent.borrow().upgrade());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; leaf parent = None</span></span><br><span class="line"><span class="comment">// =&gt; leaf parent = Some(Node &#123; value: 5, parent: RefCell &#123; value: (Weak) &#125;, children: RefCell &#123; value: [Node &#123; value: 3, parent: RefCell &#123; value: (Weak) &#125;, children: RefCell &#123; value: [] &#125; &#125;] &#125; &#125;)</span></span><br></pre></td></tr></table></figure></p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>branch</code> åˆ›å»ºå®Œæ¯•åï¼Œæˆ‘ä»¬é€šè¿‡ <code>RefCell&lt;Weak&lt;Node&gt;&gt;</code> çš„ <code>borrow_mut</code> æ–¹æ³•å–å‡º <code>leaf</code> ä¸­ <code>parent</code> å­—æ®µçš„å¯å˜å€Ÿç”¨ï¼Œå†ä½¿ç”¨ <code>Rc::downgrade</code> å‡½æ•°è·å– <code>branch</code> ä¸­ <code>Rc&lt;Node&gt;</code> çš„ <code>Weak&lt;Node&gt;</code> å¼•ç”¨ï¼Œå°†å…¶å­˜å…¥ <code>leaf</code> çš„ <code>parent</code> å­—æ®µä¸­ã€‚<br>æœ€ååœ¨æ‰“å° <code>leaf</code> çš„çˆ¶èŠ‚ç‚¹æ—¶ï¼Œä¾¿å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåŒ…å«äº† <code>branch</code> å®é™…å†…å®¹çš„ <code>Some</code> å˜ä½“ï¼Œå³è¡¨æ˜ <code>leaf</code> å¯ä»¥è®¿é—®å…¶çˆ¶èŠ‚ç‚¹ã€‚å¦å¤–ï¼Œæ­¤æ—¶æ‰“å° <code>leaf</code> è¿˜å¯ä»¥é¿å…ä¹‹å‰å› å¾ªç¯å¼•ç”¨å¯¼è‡´çš„æ ˆæº¢å‡ºæ•…éšœï¼Œå› ä¸º <code>Weak&lt;Node&gt;</code> å¼•ç”¨ä¼šè¢«ç›´æ¥æ‰“å°ä¸º <code>(Weak)</code>ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener">The Rust Programming Language</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æŒ‡é’ˆï¼ˆpointerï¼‰&lt;/strong&gt;æ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œç”¨æ¥æŒ‡ä»£é‚£äº›åŒ…å«å†…å­˜åœ°å€çš„å˜é‡ã€‚è¿™äº›åœ°å€â€œæŒ‡å‘â€å†…å­˜ä¸­çš„å…¶ä»–æ•°æ®ã€‚&lt;br&gt;Rust ä¸­æœ€å¸¸è§çš„æŒ‡é’ˆæ˜¯&lt;strong&gt;å¼•ç”¨&lt;/strong&gt;ï¼Œä¼š&lt;strong&gt;å€Ÿç”¨&lt;/strong&gt;å®ƒæ‰€æŒ‡å‘çš„æ•°æ®ã€‚é™¤æ­¤ä¹‹
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="DataStructure" scheme="https://rollingstarky.github.io/tags/DataStructure/"/>
    
      <category term="Rust" scheme="https://rollingstarky.github.io/tags/Rust/"/>
    
      <category term="Ownership" scheme="https://rollingstarky.github.io/tags/Ownership/"/>
    
      <category term="Pointer" scheme="https://rollingstarky.github.io/tags/Pointer/"/>
    
      <category term="Memory" scheme="https://rollingstarky.github.io/tags/Memory/"/>
    
      <category term="Heap" scheme="https://rollingstarky.github.io/tags/Heap/"/>
    
      <category term="Stack" scheme="https://rollingstarky.github.io/tags/Stack/"/>
    
      <category term="Borrow" scheme="https://rollingstarky.github.io/tags/Borrow/"/>
    
  </entry>
  
  <entry>
    <title>The Rust programming language è¯»ä¹¦ç¬”è®°â€”â€”æšä¸¾ç±»å‹</title>
    <link href="https://rollingstarky.github.io/2021/07/13/the-rust-programming-language-reading-notes-enum-and-match/"/>
    <id>https://rollingstarky.github.io/2021/07/13/the-rust-programming-language-reading-notes-enum-and-match/</id>
    <published>2021-07-12T16:00:00.000Z</published>
    <updated>2021-07-13T13:02:39.454Z</updated>
    
    <content type="html"><![CDATA[<p>æšä¸¾ç±»å‹ï¼ˆ<strong>enum</strong>ï¼‰ï¼Œé€šå¸¸ä¹Ÿè¢«ç®€ç§°ä¸º<strong>æšä¸¾</strong>ï¼Œå®ƒå…è®¸æˆ‘ä»¬åˆ—ä¸¾æ‰€æœ‰å¯èƒ½çš„å€¼æ¥å®šä¹‰ä¸€ä¸ªç±»å‹ã€‚<br>æšä¸¾æ­é… <code>match</code> è¡¨è¾¾å¼ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„æšä¸¾å€¼æ¥æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚<br>Rust ä¸­çš„æšä¸¾æ›´ç±»ä¼¼äº Haskell è¿™ç±»å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„<strong>ä»£æ•°æ•°æ®ç±»å‹ï¼ˆADTï¼‰</strong>ã€‚</p><h4 id="å®šä¹‰æšä¸¾"><a href="#å®šä¹‰æšä¸¾" class="headerlink" title="å®šä¹‰æšä¸¾"></a>å®šä¹‰æšä¸¾</h4><p>å‡è®¾æˆ‘ä»¬éœ€è¦å¯¹ IP åœ°å€è¿›è¡Œå¤„ç†ã€‚ç›®å‰åªæœ‰ä¸¤ç§å¹¿æ³›è¢«ä½¿ç”¨çš„ IP åœ°å€æ ‡å‡†ï¼šIPv4 å’Œ IPv6ã€‚<br>æˆ‘ä»¬åªéœ€è¦å¤„ç†è¿™ä¸¤ç§æƒ…å½¢ï¼Œä¸”ä¸€ä¸ªåœ°å€è¦ä¹ˆæ˜¯ IPv4ï¼Œè¦ä¹ˆæ˜¯ IPv6ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æšä¸¾å°†æ‰€æœ‰å¯èƒ½çš„å€¼ï¼ˆIPv4 å’Œ IPv6ï¼‰åˆ—ä¸¾å‡ºæ¥ï¼Œä½œä¸ºä¸€ç§æ–°çš„æ•°æ®ç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IpAddrKind</span></span> &#123;</span><br><span class="line">    V4,</span><br><span class="line">    V6,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œ<code>IpAddrKind</code> å°±æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ä»£ç ä¸­éšå¤„ä½¿ç”¨çš„è‡ªå®šä¹‰æ•°æ®ç±»å‹äº†ã€‚</p><h5 id="æšä¸¾å€¼"><a href="#æšä¸¾å€¼" class="headerlink" title="æšä¸¾å€¼"></a>æšä¸¾å€¼</h5><p>å¯ä»¥å‚ç…§ä¸‹é¢çš„ä»£ç ä½¿ç”¨ <code>IpAddrKind</code> ä¸­çš„ä¸¤ä¸ªå˜ä½“ï¼ˆ<code>V4</code> å’Œ <code>V6</code>ï¼‰åˆ›å»ºå®ä¾‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> four = IpAddrKind::V4;</span><br><span class="line"><span class="keyword">let</span> six = IpAddrKind::V6;</span><br></pre></td></tr></table></figure></p><p>ç”±äº <code>IpAddrKind:V4</code> å’Œ <code>IpAddrKind:V6</code> æ‹¥æœ‰ç›¸åŒçš„ç±»å‹ï¼ˆéƒ½æ˜¯ <code>IpAddrKind</code>ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¥æ”¶ <code>IpAddrKind</code> ç±»å‹å‚æ•°çš„å‡½æ•°æ¥ç»Ÿä¸€å¤„ç†å®ƒä»¬ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">route</span></span>(ip_type: IpAddrKind) &#123; &#125;</span><br></pre></td></tr></table></figure></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»æ„ä¸€ä¸ªå˜ä½“æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°äº†ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">route(IpAddrKind::V4);</span><br><span class="line">route(IpAddrKind::V6);</span><br></pre></td></tr></table></figure></p><p>å½“å‰å®šä¹‰çš„æšä¸¾ç±»å‹ <code>IpAddrKind</code>ï¼Œè¿˜åªèƒ½åŒºåˆ† IP åœ°å€çš„ç§ç±»ï¼Œæ²¡æœ‰åŠæ³•å»å­˜å‚¨å®é™…çš„ IP åœ°å€æ•°æ®ã€‚<br>å¯ä»¥ä½¿ç”¨ç»“æ„ä½“æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IpAddrKind</span></span> &#123;</span><br><span class="line">    V4,</span><br><span class="line">    V6,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IpAddr</span></span> &#123;</span><br><span class="line">    kind: IpAddrKind,</span><br><span class="line">    address: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = IpAddr &#123;</span><br><span class="line">    kind: IpAddrKind::V4,</span><br><span class="line">    address: <span class="built_in">String</span>::from(<span class="string">"127.0.0.1"</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> loopback = IpAddr &#123;</span><br><span class="line">    kind: IpAddrKind::V6,</span><br><span class="line">    address: <span class="built_in">String</span>::from(<span class="string">"::1"</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†æšä¸¾å…³è”çš„æ•°æ®åµŒå…¥å…¶å˜ä½“å†…ï¼Œè€Œä¸ç”¨åƒä¸Šé¢é‚£æ ·å°†æšä¸¾é›†æˆè‡³ç»“æ„ä½“ä¸­ã€‚</p><p>ä¸‹é¢çš„ä»£ç ç›´æ¥å®šä¹‰äº† <code>IpAddr</code> æšä¸¾ï¼Œ<code>V4</code> å’Œ <code>V6</code> ä¸¤ä¸ªå˜ä½“éƒ½è¢«å…³è”ä¸Šäº†ä¸€ä¸ª String å€¼ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IpAddr</span></span> &#123;</span><br><span class="line">    V4(<span class="built_in">String</span>),</span><br><span class="line">    V6(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = IpAddr::V4(<span class="built_in">String</span>::from(<span class="string">"127.0.0.1"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> loopback = IpAddr::V6(<span class="built_in">String</span>::from(<span class="string">"::1"</span>));</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬ç›´æ¥å°†æ•°æ®é™„åŠ åˆ°æšä¸¾çš„æ¯ä¸ªå˜ä½“ä¸­ï¼Œå°±ä¸éœ€è¦é¢å¤–åœ°ä½¿ç”¨ç»“æ„ä½“äº†ã€‚</p><p>å¦å¤–ä¸€ä¸ªæšä¸¾æ›¿ä»£ç»“æ„ä½“çš„ä¼˜åŠ¿åœ¨äºï¼Œ<strong>æ¯ä¸ªå˜ä½“å¯ä»¥æ‹¥æœ‰ä¸åŒç±»å‹å’Œæ•°é‡çš„å…³è”æ•°æ®ï¼ŒåŒæ—¶æ‰€æœ‰å˜ä½“ä»å±äºåŒä¸€ä¸ªæšä¸¾ç±»å‹</strong>ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IpAddr</span></span> &#123;</span><br><span class="line">    V4(<span class="built_in">u8</span>, <span class="built_in">u8</span>, <span class="built_in">u8</span>, <span class="built_in">u8</span>),</span><br><span class="line">    V6(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = IpAddr::V4(<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> loopback = IpAddr::V6(<span class="built_in">String</span>::from(<span class="string">"::1"</span>));</span><br></pre></td></tr></table></figure></p><p>å‚è€ƒä¸‹é¢ä»£ç ä¸­å®šä¹‰çš„ä¸€ä¸ª <code>Message</code> æšä¸¾ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Message</span></span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Move &#123; x: <span class="built_in">i32</span>, y: <span class="built_in">i32</span> &#125;,</span><br><span class="line">    Write(<span class="built_in">String</span>),</span><br><span class="line">    ChangeColor(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¯¥æšä¸¾æ‹¥æœ‰ 4 ä¸ªå†…åµŒäº†ä¸åŒç±»å‹æ•°æ®çš„å˜ä½“ï¼š</p><ul><li>Quit æ²¡æœ‰å…³è”ä»»ä½•æ•°æ®</li><li>Move åŒ…å«äº†ä¸€ä¸ªåŒ¿åç»“æ„ä½“</li><li>Write åŒ…å«äº†ä¸€ä¸ª String</li><li>ChangeColor åŒ…å«äº† 3 ä¸ª i32 å€¼</li></ul><p>æšä¸¾æœ‰äº›ç±»ä¼¼äºå®šä¹‰å¤šä¸ªä¸åŒç±»å‹çš„ç»“æ„ä½“ã€‚ä½†æšä¸¾é™¤äº†ä¸ä¼šä½¿ç”¨ <code>struct</code> å…³é”®å­—ï¼Œè¿˜å°†å˜ä½“ä»¬ç»„åˆåˆ°äº†åŒä¸€ä¸ª <code>Message</code> ç±»å‹ä¸­ã€‚<br>ä¸‹é¢ä»£ç ä¸­çš„ç»“æ„ä½“å¯ä»¥å­˜å‚¨ä¸è¿™äº›å˜ä½“å®Œå…¨ä¸€æ ·çš„æ•°æ®ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QuitMessage</span></span>; <span class="comment">// ç©ºç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MoveMessage</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">i32</span>,</span><br><span class="line">    y: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WriteMessage</span></span>(<span class="built_in">String</span>); <span class="comment">// å…ƒç»„ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ChangeColorMessage</span></span>(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>); <span class="comment">// å…ƒç»„ç»“æ„ä½“</span></span><br></pre></td></tr></table></figure></p><p>ä¸¤ç§å®ç°æ–¹å¼çš„å·®åˆ«åœ¨äºï¼Œå¦‚æœä½¿ç”¨äº†ä¸åŒçš„ç»“æ„ä½“ï¼Œåˆ™<strong>æ¯ä¸ªç»“æ„ä½“éƒ½ä¼šæ‹¥æœ‰è‡ªå·±çš„ç±»å‹</strong>ï¼Œæ— æ³•è½»æ˜“å®šä¹‰ä¸€ä¸ªç»Ÿä¸€å¤„ç†è¿™äº›ç±»å‹çš„å‡½æ•°ã€‚è€Œå‰é¢çš„ <strong><code>Message</code> æšä¸¾æ˜¯å•ç‹¬çš„ä¸€ä¸ªç±»å‹</strong>ã€‚</p><p>æ­£å¦‚æˆ‘ä»¬å¯ä»¥ç”¨ <code>impl</code> å…³é”®å­—å®šä¹‰ç»“æ„ä½“çš„æ–¹æ³•ä¸€æ ·ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä¸º <code>Message</code> å®šä¹‰è‡ªå·±çš„æ–¹æ³•ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Message &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// æ–¹æ³•åœ¨è¿™é‡Œå®šä¹‰</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m = Message::Write(<span class="built_in">String</span>::from(<span class="string">"hello"</span>));</span><br><span class="line">    m.call();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="Option-æšä¸¾åŠç©ºå€¼å¤„ç†"><a href="#Option-æšä¸¾åŠç©ºå€¼å¤„ç†" class="headerlink" title="Option æšä¸¾åŠç©ºå€¼å¤„ç†"></a>Option æšä¸¾åŠç©ºå€¼å¤„ç†</h4><p><code>Option</code> æ˜¯ä¸€ç§å®šä¹‰äºæ ‡å‡†åº“ä¸­çš„æšä¸¾ç±»å‹ï¼Œå®ƒæè¿°äº†ä¸€ç§å€¼å¯èƒ½ä¸å­˜åœ¨çš„æƒ…å½¢ã€‚å€ŸåŠ©ç±»å‹ç³»ç»Ÿï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å¦¥å–„åœ°å¤„ç†äº†æ‰€æœ‰åº”è¯¥è¢«å¤„ç†çš„æƒ…å†µã€‚</p><p>Rust æ²¡æœ‰åƒå…¶ä»–è¯­è¨€ä¸€æ ·æ”¯æŒ<strong>ç©ºå€¼ï¼ˆNullï¼‰</strong>ã€‚ç©ºå€¼æœ¬èº«æ˜¯ä¸€ä¸ªå€¼ï¼Œä½†å®ƒçš„å«ä¹‰å´æ˜¯æ²¡æœ‰å€¼ã€‚<br>ç©ºå€¼çš„é—®é¢˜åœ¨äºï¼Œå½“ä½ å°è¯•åƒä½¿ç”¨éç©ºå€¼é‚£æ ·ä½¿ç”¨ç©ºå€¼æ—¶ï¼Œå°±ä¼šè§¦å‘æŸç§ç¨‹åº¦ä¸Šçš„é”™è¯¯ã€‚ç”±äºç©ºæˆ–éç©ºçš„å±æ€§å¹¿æ³›æ•£å¸ƒåœ¨ç¨‹åºä¸­ï¼Œå› æ­¤å¾ˆéš¾é¿å…å¼•èµ·æ­¤ç±»é—®é¢˜ã€‚<br>ä½†ç©ºå€¼æœ¬èº«æ‰€å°è¯•è¡¨è¾¾çš„æ¦‚å¿µä»æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå®ƒä»£è¡¨äº†å› ä¸ºæŸç§åŸå› è€Œå˜å¾—æ— æ•ˆæˆ–ç¼ºå¤±çš„å€¼ã€‚</p><p>Rust ä¸­è™½ç„¶æ²¡æœ‰ç©ºå€¼ï¼Œä½†æä¾›äº†ä¸€ä¸ªæ‹¥æœ‰ç±»ä¼¼æ¦‚å¿µçš„æšä¸¾ <code>Option&lt;T&gt;</code>ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ ‡è¯†ä¸€ä¸ªå€¼æ— æ•ˆæˆ–ç¼ºå¤±ã€‚<br><code>Option&lt;T&gt;</code> åœ¨æ ‡å‡†åº“ä¸­çš„å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Option</span></span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="literal">Some</span>(T),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>Option&lt;T&gt;</code> æ˜¯ä¸€ä¸ªæ™®é€šçš„æšä¸¾ç±»å‹ï¼Œ<code>Some&lt;T&gt;</code> å’Œ <code>None</code> æ˜¯è¯¥ç±»å‹çš„å˜ä½“ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> some_number = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> some_string = <span class="literal">Some</span>(<span class="string">"a string"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> absent_number: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; = <span class="literal">None</span>;</span><br></pre></td></tr></table></figure></p><p>è‹¥ä½¿ç”¨ <code>None</code> è€Œä¸æ˜¯ <code>Some</code> å˜ä½“æ¥è¿›è¡Œèµ‹å€¼ï¼Œåˆ™éœ€è¦æ˜ç¡®å£°æ˜è¿™ä¸ª <code>Option&lt;T&gt;</code> çš„å…·ä½“ç±»å‹ï¼Œå¦åˆ™ç¼–è¯‘å™¨æ— æ³•è¿›è¡Œç±»å‹æ¨å¯¼ã€‚</p><p>å½“æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª <code>Some</code> å€¼æ—¶ï¼Œå°±å¯ä»¥ç¡®å®šå€¼æ˜¯å­˜åœ¨çš„ï¼Œå¹¶ä¸”è¢« <code>Some</code> æ‰€æŒæœ‰ï¼›å½“æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª <code>None</code> å€¼æ—¶ï¼Œå°±çŸ¥é“å½“å‰å¹¶ä¸å­˜åœ¨ä¸€ä¸ªæœ‰æ•ˆçš„å€¼ã€‚<br><code>Option&lt;T&gt;</code> çš„è®¾è®¡ç›¸å¯¹äºç©ºå€¼çš„ä¼˜åŠ¿åœ¨äºï¼Œ<strong><code>Option&lt;T&gt;</code> å’Œ <code>T</code> æ˜¯ä¸åŒçš„ç±»å‹ï¼Œç¼–è¯‘å™¨ä¸ä¼šå…è®¸æˆ‘ä»¬åƒä½¿ç”¨æ™®é€šå€¼ä¸€æ ·ç›´æ¥å»ä½¿ç”¨ <code>Option&lt;T&gt;</code> çš„å€¼</strong>ã€‚å¦‚ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x: <span class="built_in">i8</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> y: <span class="built_in">Option</span>&lt;<span class="built_in">i8</span>&gt; = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sum = x + y;</span><br></pre></td></tr></table></figure></p><p>è¿è¡Œä¸Šè¿°ä»£ç ä¼šå¯¼è‡´ç¼–è¯‘å™¨æŠ¥é”™ï¼Œå› ä¸º <code>i8</code> å’Œ <code>Option&lt;i8&gt;</code> æ˜¯ä¸åŒçš„ç±»å‹ã€‚<br>å½“æˆ‘ä»¬æŒæœ‰çš„ç±»å‹æ˜¯ <code>i8</code> æ—¶ï¼Œç¼–è¯‘å™¨å¯ä»¥ç¡®ä¿è¯¥å€¼æ˜¯æœ‰æ•ˆçš„ã€‚ä½†æ˜¯<strong>å½“æˆ‘ä»¬æŒæœ‰çš„ç±»å‹æ˜¯ <code>Option&lt;i8&gt;</code> æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦è€ƒè™‘å€¼ä¸å­˜åœ¨çš„æƒ…å†µï¼Œç¼–è¯‘å™¨ä¼šè¿«ä½¿æˆ‘ä»¬åœ¨ä½¿ç”¨å€¼ä¹‹å‰æ­£ç¡®åœ°åšå‡ºå¤„ç†æ“ä½œ</strong>ã€‚</p><p><strong>ä¸ºäº†æŒæœ‰ä¸€ä¸ªå¯èƒ½ä¸ºç©ºçš„å€¼ï¼Œæˆ‘ä»¬æ€»æ˜¯éœ€è¦å°†å…¶æ˜¾å¼åœ°æ”¾å…¥å¯¹åº”ç±»å‹çš„ <code>Option&lt;T&gt;</code> å€¼å½“ä¸­ã€‚å½“æˆ‘ä»¬éšåä½¿ç”¨è¿™ä¸ªå€¼æ—¶ï¼Œä¹Ÿå¿…é¡»æ˜¾å¼åœ°å¤„ç†å®ƒå¯èƒ½ä¸ºç©ºçš„æƒ…å†µ</strong>ã€‚<br>å³åœ¨å¤„ç† <code>Option&lt;T&gt;</code> æ—¶ï¼Œå¿…é¡»ç¼–å†™åº”å¯¹æ¯ä¸ªå˜ä½“çš„ä»£ç ã€‚æŸäº›ä»£ç åªä¼šåœ¨æŒæœ‰ <code>Some(T)</code> å€¼æ—¶è¿è¡Œï¼Œå®ƒä»¬å¯ä»¥ä½¿ç”¨å˜ä½“ä¸­å­˜å‚¨çš„ <code>T</code>ï¼›å¦å¤–ä¸€äº›ä»£ç åˆ™åªä¼šåœ¨æŒæœ‰ <code>None</code> å€¼æ—¶è¿è¡Œï¼Œè¿™äº›ä»£ç æ²¡æœ‰å¯ç”¨çš„ <code>T</code> å€¼ã€‚</p><p><code>match</code> è¡¨è¾¾å¼å°±æ˜¯ä¸€ç§å¯ä»¥ç”¨æ¥å¤„ç† <code>Option&lt;T&gt;</code> è¿™ç±»æšä¸¾çš„æ§åˆ¶æµç»“æ„ã€‚å®ƒå…è®¸æˆ‘ä»¬åŸºäºæšä¸¾æ‹¥æœ‰çš„å˜ä½“æ¥å†³å®šè¿è¡Œçš„ä»£ç åˆ†æ”¯ï¼Œå¹¶å…è®¸ä»£ç é€šè¿‡æ¨¡å¼åŒ¹é…æ¥è·å–å˜ä½“å†…çš„æ•°æ®ã€‚</p><h4 id="æ§åˆ¶æµè¿ç®—ç¬¦-match"><a href="#æ§åˆ¶æµè¿ç®—ç¬¦-match" class="headerlink" title="æ§åˆ¶æµè¿ç®—ç¬¦ match"></a>æ§åˆ¶æµè¿ç®—ç¬¦ match</h4><p><code>match</code> æ˜¯ Rust ä¸­ä¸€ä¸ªå¼ºå¤§çš„æ§åˆ¶æµè¿ç®—ç¬¦ï¼Œå®ƒå…è®¸å°†ä¸€ä¸ªå€¼ä¸ä¸€ç³»åˆ—æ¨¡å¼ç›¸æ¯”è¾ƒï¼Œå¹¶æ ¹æ®åŒ¹é…çš„æ¨¡å¼æ‰§è¡Œç›¸åº”çš„ä»£ç ã€‚è¿™äº›æ¨¡å¼å¯ä»¥ç”±å­—é¢é‡ã€å˜é‡åã€é€šé…ç¬¦åŠè®¸å¤šå…¶ä»–ä¸œè¥¿ç»„æˆã€‚</p><p>ä¸‹é¢çš„ä»£ç ä¼šæ¥æ”¶ä¸€ä¸ªç¾å›½çš„ç¡¬å¸ä½œä¸ºè¾“å…¥ï¼Œç¡®å®šç¡¬å¸çš„ç±»å‹å¹¶è¿”å›å…¶åˆ†å€¼ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Coin</span></span> &#123;</span><br><span class="line">    Penny,</span><br><span class="line">    Nickel,</span><br><span class="line">    Dime,</span><br><span class="line">    Quarter,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">value_in_cents</span></span>(coin: Coin) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> coin &#123;</span><br><span class="line">        Coin::Penny =&gt; <span class="number">1</span>,</span><br><span class="line">        Coin::Nickel =&gt; <span class="number">5</span>,</span><br><span class="line">        Coin::Dime =&gt; <span class="number">10</span>,</span><br><span class="line">        Coin::Quarter =&gt; <span class="number">25</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> coin = Coin::Dime;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, value_in_cents(coin));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¯ä¸ª <code>match</code> åˆ†æ”¯æ‰€å…³è”çš„ä»£ç åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼è¿è¡Œçš„ç»“æœåŒæ—¶ä¹Ÿä¼šä½œä¸ºæ•´ä¸ª <code>match</code> è¡¨è¾¾å¼çš„ç»“æœè¿”å›ã€‚</p><h5 id="ç»‘å®šå€¼çš„æ¨¡å¼"><a href="#ç»‘å®šå€¼çš„æ¨¡å¼" class="headerlink" title="ç»‘å®šå€¼çš„æ¨¡å¼"></a>ç»‘å®šå€¼çš„æ¨¡å¼</h5><p>åŒ¹é…åˆ†æ”¯è¿˜å¯ä»¥ç»‘å®šåŒ¹é…å¯¹è±¡çš„éƒ¨åˆ†å€¼ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä»æšä¸¾å˜ä½“ä¸­æå–ç‰¹å®šçš„å€¼ã€‚</p><p>æ¯”å¦‚ç¾å›½çš„ 25 ç¾åˆ†ç¡¬å¸ 50 ä¸ªå·é‡‡ç”¨äº†ä¸åŒçš„è®¾è®¡ã€‚ç°åœ¨å°†è¿™äº›ä¿¡æ¯æ·»åŠ è‡³æšä¸¾ä¸­ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span> <span class="comment">// æ–¹ä¾¿æ‰“å°è¾“å‡ºé»˜è®¤ä¸æ”¯æŒæ‰“å°çš„ç±»å‹</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">UsState</span></span> &#123;</span><br><span class="line">    Alabama,</span><br><span class="line">    Alaska,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Coin</span></span> &#123;</span><br><span class="line">    Penny,</span><br><span class="line">    Nickel,</span><br><span class="line">    Dime,</span><br><span class="line">    Quarter(UsState),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">value_in_cents</span></span>(coin: Coin) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> coin &#123;</span><br><span class="line">        Coin::Penny =&gt; <span class="number">1</span>,</span><br><span class="line">        Coin::Nickel =&gt; <span class="number">5</span>,</span><br><span class="line">        Coin::Dime =&gt; <span class="number">10</span>,</span><br><span class="line">        Coin::Quarter(state) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"State quarter from &#123;:?&#125;."</span>, state);</span><br><span class="line">            <span class="number">25</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> alaska = UsState::Alaska;</span><br><span class="line">    <span class="keyword">let</span> coin = Coin::Quarter(alaska);</span><br><span class="line">    value_in_cents(coin);</span><br><span class="line">    <span class="comment">// =&gt; State quarter from Alaska.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¨¡å¼ä¸­åŠ å…¥äº†ä¸€ä¸ªåä¸º <code>state</code> çš„å˜é‡ç”¨äºåŒ¹é…å˜ä½“ <code>Coin::Quarter</code> ä¸­çš„å€¼ã€‚å½“åŒ¹é…åˆ° <code>Coin::Quarter</code> æ—¶ï¼Œå˜é‡ <code>state</code> å°±ä¼šç»‘å®šåˆ° 25 ç¾åˆ†æ‰€åŒ…å«çš„å€¼ä¸Šã€‚<br>æ¯”å¦‚ä»£ç ä¸­ <code>Coin::Quarter(UsState::Alaska)</code> ä½œä¸º <code>coin</code> çš„å€¼ä¼ å…¥ <code>value_in_cents</code> å‡½æ•°ï¼Œæœ€ç»ˆå€¼ <code>UsState::Alaska</code> è¢«ç»‘å®šåˆ°å˜é‡ <code>state</code> ä¸Šã€‚</p><h4 id="åŒ¹é…-Option"><a href="#åŒ¹é…-Option" class="headerlink" title="åŒ¹é… Option"></a>åŒ¹é… Option<t></t></h4><p>å¯ä»¥ä½¿ç”¨ <code>match</code> è¡¨è¾¾å¼æ¥å¤„ç† <code>Option&lt;T&gt;</code>ï¼Œä» <code>Some</code> ä¸­å–å‡ºå†…éƒ¨çš„ <code>T</code> å€¼ã€‚<br>æ¯”å¦‚ç¼–å†™ä¸€ä¸ªæ¥æ”¶ <code>Option&lt;i32&gt;</code> çš„å‡½æ•°ï¼Œè‹¥å…¶ä¸­æœ‰å€¼å­˜åœ¨ï¼Œåˆ™å°†è¿™ä¸ªå€¼åŠ  1ï¼›è‹¥å…¶ä¸­ä¸å­˜åœ¨å€¼ï¼Œåˆ™ç›´æ¥è¿”å› <code>None</code>ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">plus_one</span></span>(x: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt;) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> x &#123;</span><br><span class="line">        <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"The result is None"</span>);</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Some</span>(i) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"The result is &#123;&#125;"</span>, i + <span class="number">1</span>);</span><br><span class="line">            <span class="literal">Some</span>(i + <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> five = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> six = plus_one(five);</span><br><span class="line">    <span class="keyword">let</span> none = plus_one(<span class="literal">None</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>åŒ¹é…å¿…é¡»ç©·ä¸¾æ‰€æœ‰çš„å¯èƒ½</strong>ã€‚å°¤å…¶æ˜¯ <code>Option&lt;T&gt;</code> è¿™ä¸ªä¾‹å­ä¸­ï¼ŒRust ä¼šå¼ºè¿«æˆ‘ä»¬æ˜ç¡®åœ°å¤„ç†å€¼ä¸º <code>None</code> çš„æƒ…å½¢ã€‚</p><h5 id="ç®€å•æ§åˆ¶æµ-if-let"><a href="#ç®€å•æ§åˆ¶æµ-if-let" class="headerlink" title="ç®€å•æ§åˆ¶æµ if let"></a>ç®€å•æ§åˆ¶æµ <code>if let</code></h5><p><code>if let</code> èƒ½è®©æˆ‘ä»¬é€šè¿‡ä¸€ç§ä¸é‚£ä¹ˆç¹ççš„è¯­æ³•ç»“åˆä½¿ç”¨ <code>if</code> ä¸ <code>let</code>ï¼Œå¤„ç†é‚£äº›åªå…³å¿ƒæŸä¸€ç§åŒ¹é…è€Œå¿½ç•¥å…¶ä»–åŒ¹é…çš„æƒ…å†µã€‚<br>ä¸‹é¢çš„ä»£ç ä¼šåŒ¹é…ä¸€ä¸ª <code>Option&lt;u32&gt;</code> çš„å€¼ï¼Œå¹¶åªåœ¨å€¼ä¸º 3 æ—¶æ‰§è¡Œä»£ç ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> some_number = <span class="literal">Some</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">match</span> some_number &#123;</span><br><span class="line">        <span class="literal">Some</span>(<span class="number">3</span>) =&gt; <span class="built_in">println!</span>(<span class="string">"three"</span>),</span><br><span class="line">        _ =&gt; (),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†æ»¡è¶³ <code>match</code> è¡¨è¾¾å¼<strong>ç©·å°½æ€§</strong>çš„è¦æ±‚ï¼Œæˆ‘ä»¬ä¸å¾—ä¸åœ¨å¤„ç†å®Œ <code>Some(3)</code> å˜ä½“åé¢å¤–åŠ ä¸Šä¸€å¥ <code>_ =&gt; ()</code>ã€‚<br>å¯ä»¥ä½¿ç”¨ <code>if let</code> ä»¥ä¸€ç§æ›´ç®€å•çš„æ–¹å¼å®ç°ä¸Šè¿°ä»£ç ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="number">3</span>) = some_number &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"three"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿˜å¯ä»¥åœ¨ <code>if let</code> ä¸­æ­é…ä½¿ç”¨ <code>else</code>ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> some_number = <span class="literal">Some</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="number">3</span>) = some_number &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"three"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"other number"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener">The Rust Programming Language</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æšä¸¾ç±»å‹ï¼ˆ&lt;strong&gt;enum&lt;/strong&gt;ï¼‰ï¼Œé€šå¸¸ä¹Ÿè¢«ç®€ç§°ä¸º&lt;strong&gt;æšä¸¾&lt;/strong&gt;ï¼Œå®ƒå…è®¸æˆ‘ä»¬åˆ—ä¸¾æ‰€æœ‰å¯èƒ½çš„å€¼æ¥å®šä¹‰ä¸€ä¸ªç±»å‹ã€‚&lt;br&gt;æšä¸¾æ­é… &lt;code&gt;match&lt;/code&gt; è¡¨è¾¾å¼ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„æšä¸¾å€¼æ¥æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚&lt;br&gt;
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Functional" scheme="https://rollingstarky.github.io/tags/Functional/"/>
    
      <category term="ADT" scheme="https://rollingstarky.github.io/tags/ADT/"/>
    
      <category term="Pattern" scheme="https://rollingstarky.github.io/tags/Pattern/"/>
    
      <category term="Match" scheme="https://rollingstarky.github.io/tags/Match/"/>
    
      <category term="Rust" scheme="https://rollingstarky.github.io/tags/Rust/"/>
    
      <category term="Enum" scheme="https://rollingstarky.github.io/tags/Enum/"/>
    
  </entry>
  
  <entry>
    <title>The Rust programming language è¯»ä¹¦ç¬”è®°â€”â€”åŒ…ï¼ˆpackageï¼‰ã€å•å…ƒåŒ…ï¼ˆcrateï¼‰ä¸æ¨¡å—ç³»ç»Ÿ</title>
    <link href="https://rollingstarky.github.io/2021/07/09/the-rust-programming-language-reading-notes-package-crate-and-module-system/"/>
    <id>https://rollingstarky.github.io/2021/07/09/the-rust-programming-language-reading-notes-package-crate-and-module-system/</id>
    <published>2021-07-08T16:00:00.000Z</published>
    <updated>2021-07-08T16:40:32.519Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æ¨¡å—ç³»ç»Ÿ"><a href="#æ¨¡å—ç³»ç»Ÿ" class="headerlink" title="æ¨¡å—ç³»ç»Ÿ"></a>æ¨¡å—ç³»ç»Ÿ</h4><p>åœ¨ç¼–å†™è¾ƒä¸ºå¤æ‚çš„é¡¹ç›®æ—¶ï¼Œåˆç†åœ°å¯¹ä»£ç è¿›è¡Œç»„ç»‡ä¸ç®¡ç†éå¸¸é‡è¦ã€‚åªæœ‰æŒ‰ç…§ä¸åŒçš„ç‰¹æ€§æ¥ç»„ç»‡æˆ–åˆ†å‰²ç›¸å…³åŠŸèƒ½çš„ä»£ç ï¼Œæ‰èƒ½å¤Ÿæ¸…æ™°åœ°æ‰¾åˆ°å®ç°æŒ‡å®šåŠŸèƒ½çš„ä»£ç ç‰‡æ®µï¼Œç¡®å®šå“ªäº›åœ°æ–¹éœ€è¦ä¿®æ”¹ã€‚</p><p>é™¤äº†å¯¹åŠŸèƒ½è¿›è¡Œåˆ†ç»„ï¼Œå¯¹å®ç°çš„ç»†èŠ‚è¿›è¡Œå°è£…å¯ä»¥ä½¿å¼€å‘è€…åœ¨æ›´é«˜çš„å±‚æ¬¡ä¸Šå¤ç”¨ä»£ç ï¼šä¸€æ—¦å®ç°äº†æŸä¸ªåŠŸèƒ½ï¼Œå…¶ä»–ä»£ç å°±å¯ä»¥é€šè¿‡å…¬å…±æ¥å£è°ƒç”¨è¿™ä¸ªæ“ä½œï¼Œè€Œæ— éœ€äº†è§£å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚</p><p>Rust æä¾›äº†ä¸€ç³»åˆ—çš„åŠŸèƒ½æ¥ç®¡ç†ä»£ç ï¼ŒåŒ…æ‹¬å†³å®šå“ªäº›ç»†èŠ‚æ˜¯æš´éœ²çš„ï¼Œé‚£äº›ç»†èŠ‚æ˜¯ç§æœ‰çš„ï¼Œä»¥åŠä¸åŒçš„ä½œç”¨åŸŸå†…å­˜åœ¨å“ªäº›åç§°ã€‚è¿™äº›åŠŸèƒ½è¢«ç»Ÿç§°ä¸º<strong>æ¨¡å—ç³»ç»Ÿ</strong>ï¼š</p><ul><li><strong>åŒ…ï¼ˆpackageï¼‰</strong>ï¼šä¸€ä¸ªç”¨äºæ„å»ºã€æµ‹è¯•å¹¶åˆ†äº«å•å…ƒåŒ…çš„ Cargo ç‰¹æ€§</li><li><strong>å•å…ƒåŒ…ï¼ˆcrateï¼‰</strong>ï¼šä¸€ä¸ªç”¨äºç”Ÿæˆåº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶çš„æ ‘å½¢æ¨¡å—ç»“æ„</li><li><strong>æ¨¡å—ï¼ˆmoduleï¼‰</strong>åŠ <strong>use å…³é”®å­—</strong>ï¼šç”¨äºæ§åˆ¶æ–‡ä»¶ç»“æ„ã€ä½œç”¨åŸŸåŠè·¯å¾„çš„ç§æœ‰æ€§</li><li><strong>è·¯å¾„ï¼ˆpathï¼‰</strong>ï¼šä¸€ç§ç”¨äºå‘½åæ¡ç›®çš„æ–¹æ³•ï¼Œè¿™äº›æ¡ç›®åŒ…æ‹¬ç»“æ„ä½“ã€å‡½æ•°å’Œæ¨¡å—ç­‰</li></ul><h4 id="åŒ…ä¸å•å…ƒåŒ…"><a href="#åŒ…ä¸å•å…ƒåŒ…" class="headerlink" title="åŒ…ä¸å•å…ƒåŒ…"></a>åŒ…ä¸å•å…ƒåŒ…</h4><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>cargo new</code> å‘½ä»¤åˆ›å»ºæ–°é¡¹ç›®æ—¶ï¼Œå¦‚ï¼š<br><code>cargo new restaurant</code></p><p>Cargo ä¼šè‡ªåŠ¨åˆ›å»ºå¦‚ä¸‹ç»“æ„çš„ Rust é¡¹ç›®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">restaurant</span><br><span class="line">â”œâ”€â”€ Cargo.toml</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â””â”€â”€ main.rs</span><br></pre></td></tr></table></figure></p><p>Cargo é»˜è®¤ä¼šå°†è‡ªåŠ¨ç”Ÿæˆçš„ <code>src/main.rs</code> æºæ–‡ä»¶è§†ä½œä¸€ä¸ªäºŒè¿›åˆ¶å•å…ƒåŒ…ï¼ˆcrateï¼‰çš„æ ¹èŠ‚ç‚¹ï¼Œä¸åŒ…ï¼ˆpackageï¼‰æ‹¥æœ‰ç›¸åŒçš„åç§°ï¼ˆå³ <code>restaurant</code>ï¼‰ã€‚<br>å‡è®¾åŒ…çš„ç›®å½•ä¸­åŒ…å«æ–‡ä»¶ <code>src/lib.rs</code>ï¼ŒCargo ä¹Ÿä¼šè‡ªåŠ¨å°†å…¶è§†ä½œä¸åŒ…åŒåçš„åº“å•å…ƒåŒ…çš„æ ¹èŠ‚ç‚¹ã€‚<br>å¯ä»¥åœ¨è·¯å¾„ <code>src/bin</code> ä¸‹æ·»åŠ æºæ–‡ä»¶æ¥åˆ›å»ºæ›´å¤šçš„äºŒè¿›åˆ¶å•å…ƒåŒ…ï¼Œè¿™äº›æºæ–‡ä»¶éƒ½ä¼šè¢«è§†ä½œç‹¬ç«‹çš„äºŒè¿›åˆ¶å•å…ƒåŒ…ã€‚</p><p>è‡ªåŠ¨ç”Ÿæˆçš„ <code>src/main.rs</code> æºæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>src/lib.rs</code> æºæ–‡ä»¶ï¼ŒæŠŠä¸Šé¢çš„æ‰“å°è¾“å‡ºçš„æ“ä½œä½œä¸ºå…¬å…±å‡½æ•°å®šä¹‰åœ¨ <code>lib.rs</code> ä¸­ï¼Œå†åœ¨ <code>main.rs</code> ä¸­è°ƒç”¨è¯¥å…¬å…±å‡½æ•°ï¼Œæ•ˆæœä¸ä¹‹å‰æ˜¯ä¸€è‡´çš„ã€‚</p><p><code>src/lib.rs</code> ä»£ç ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">greeting</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Hello, World!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>src/main.rs</code> ä»£ç ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    restaurant::greeting();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å› ä¸º <code>lib.rs</code> é»˜è®¤ä¼šä½œä¸ºä¸€ä¸ªä¸åŒ…åŒåï¼ˆéƒ½å« <code>restaurant</code>ï¼‰çš„åº“å•å…ƒåŒ…ï¼ˆcrateï¼‰å­˜åœ¨ï¼Œä¸”å…¶ä¸­çš„ <code>greeting</code> å‡½æ•°å·²è¢«å£°æ˜ä¸ºå…¬å¼€çš„ï¼ˆ<code>pub</code>ï¼‰ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨ <code>main.rs</code> ä¸­ä½¿ç”¨ <code>restaurant::greeting()</code> è°ƒç”¨ <code>lib.rs</code> ä¸­å®šä¹‰çš„ <code>greeting</code> å‡½æ•°ã€‚</p><p>ä½¿ç”¨ <code>cargo run</code> å‘½ä»¤è¿è¡Œé¡¹ç›®åï¼Œ<code>target/debug</code> è·¯å¾„ä¸‹é™¤äº†åƒä¹‹å‰ä¸€æ ·ç”Ÿæˆ <code>restaurant</code> å¯æ‰§è¡Œæ–‡ä»¶å¤–ï¼Œè¿˜ä¼šé¢å¤–ç”Ÿæˆ <code>librestaurant.rlib</code> åº“æ–‡ä»¶ã€‚</p><p>å•å…ƒåŒ…å¯ä»¥å°†ç›¸å…³çš„åŠŸèƒ½åˆ†ç»„ï¼Œå¹¶æ”¾åˆ°<strong>åŒä¸€ä½œç”¨åŸŸ</strong>ä¸‹ï¼Œè¿™æ ·ä¾¿å¯ä»¥ä½¿è¿™äº›åŠŸèƒ½è½»æ¾åœ°åœ¨å¤šä¸ªé¡¹ç›®ä¸­å…±äº«ã€‚<br>å°†å•å…ƒåŒ…çš„åŠŸèƒ½ä¿ç•™åœ¨å®ƒä»¬è‡ªå·±çš„ä½œç”¨åŸŸä¸­æœ‰åŠ©äºæŒ‡æ˜æŸä¸ªç‰¹å®šåŠŸèƒ½æ¥æºäºå“ªä¸ªå•å…ƒåŒ…ï¼Œå¹¶é¿å…å¯èƒ½çš„å‘½åå†²çªã€‚<br>æ¯”å¦‚ <code>rand</code> åŒ…æä¾›äº†ä¸€ä¸ªåä¸º <code>Rng</code> çš„ traitï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥åœ¨è‡ªå·±çš„å•å…ƒåŒ…ä¸­å®šä¹‰ä¸€ä¸ªåä¸º <code>Rng</code> çš„ç»“æ„ä½“ã€‚æ­£æ˜¯ç”±äºè¿™äº›åŠŸèƒ½è¢«æ”¾ç½®åœ¨äº†å„è‡ªçš„ä½œç”¨åŸŸä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ <code>rng::Rng</code> è®¿é—® rand åŒ…ä¸­æä¾›çš„ <code>Rng</code> traitï¼Œè€Œ <code>Rng</code> åˆ™æŒ‡å‘åˆšåˆšåˆ›å»ºçš„ <code>Rng</code> ç»“æ„ä½“ã€‚</p><h5 id="é€šè¿‡å®šä¹‰æ¨¡å—æ¥æ§åˆ¶ä½œç”¨åŸŸåŠç§æœ‰æ€§"><a href="#é€šè¿‡å®šä¹‰æ¨¡å—æ¥æ§åˆ¶ä½œç”¨åŸŸåŠç§æœ‰æ€§" class="headerlink" title="é€šè¿‡å®šä¹‰æ¨¡å—æ¥æ§åˆ¶ä½œç”¨åŸŸåŠç§æœ‰æ€§"></a>é€šè¿‡å®šä¹‰æ¨¡å—æ¥æ§åˆ¶ä½œç”¨åŸŸåŠç§æœ‰æ€§</h5><p>å‡è®¾æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªæä¾›å°±é¤æœåŠ¡çš„åº“å•å…ƒåŒ…ã€‚ä¸€ä¸ªç°å®çš„åº—é¢å¸¸å¸¸ä¼šåˆ’åˆ†ä¸ºå‰å…ä¸åå¨ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‰å…è´Ÿè´£ç‚¹å•å’Œç»“è´¦ç­‰ï¼Œåå¨åˆ™è´Ÿè´£åˆ¶ä½œæ–™ç†ã€‚</p><p>ä¸ºäº†æŒ‰ç…§é¤å…çš„å®é™…å·¥ä½œæ–¹å¼æ¥ç»„ç»‡å•å…ƒåŒ…ï¼Œå¯ä»¥å°†å‡½æ•°æ”¾ç½®åœ¨åµŒå¥—çš„æ¨¡å—ä¸­ã€‚ä¿®æ”¹ <code>src/lib.rs</code> æºä»£ç æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> front_of_house &#123;</span><br><span class="line">    <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">seat_at_table</span></span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Seat at table."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mod</span> serving &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">take_order</span></span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Taking order."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">take_payment</span></span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Taking payment."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>mod</code> å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªæ¨¡å—ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ <code>front_of_house</code>ï¼‰ï¼Œæ¨¡å—å†…è¿˜å¯ä»¥ç»§ç»­å®šä¹‰å…¶ä»–æ¨¡å—ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ <code>hosting</code> å’Œ <code>serving</code>ï¼‰ã€‚æ¨¡å—å†…åŒæ ·ä¹Ÿå¯ä»¥åŒ…å«å…¶ä»–æ¡ç›®çš„å®šä¹‰ï¼Œå¦‚ç»“æ„ä½“ã€æšä¸¾ã€å¸¸é‡ã€trait æˆ–å‡½æ•°ç­‰ã€‚</p><p><code>src/main.rs</code> ä¸ <code>src/lib.rs</code> è¢«ç§°ä½œå•å…ƒåŒ…ï¼ˆcrateï¼‰çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä»¬çš„å†…å®¹å„è‡ªç»„æˆäº†ä¸€ä¸ªåä¸º <code>crate</code> çš„æ¨¡å—ã€‚è¿™ä¸ªæ¨¡å—çš„ç»“æ„ä¹Ÿè¢«ç§°ä¸ºæ¨¡å—æ ‘ã€‚<br>ä¸Šé¢ <code>src/lib.rs</code> å½¢æˆçš„æ ‘çŠ¶æ¨¡å—ç»“æ„å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crate</span><br><span class="line"> â””â”€â”€ front_of_house</span><br><span class="line">     â”œâ”€â”€ hosting</span><br><span class="line">     â”‚   â””â”€â”€ seat_at_table</span><br><span class="line">     â””â”€â”€ serving</span><br><span class="line">         â”œâ”€â”€ take_order</span><br><span class="line">         â””â”€â”€ take_payment</span><br></pre></td></tr></table></figure></p><h4 id="è·¯å¾„"><a href="#è·¯å¾„" class="headerlink" title="è·¯å¾„"></a>è·¯å¾„</h4><p>ç±»ä¼¼äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨è·¯å¾„è¿›è¡Œå¯¼èˆªï¼Œåœ¨ Rust çš„æ¨¡å—æ ‘ä¸­å®šä½æŸä¸ªæ¡ç›®åŒæ ·éœ€è¦ä½¿ç”¨è·¯å¾„ã€‚</p><p>è·¯å¾„æœ‰ä¸¤ç§å½¢å¼ï¼š</p><ul><li>ä½¿ç”¨å•å…ƒåŒ…åæˆ–å­—é¢é‡ crate ä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„ç»å¯¹è·¯å¾„</li><li>ä½¿ç”¨ <code>self</code>ã€<code>super</code> æˆ–å†…éƒ¨æ ‡è¯†ç¬¦ä»å½“å‰æ¨¡å—å¼€å§‹çš„ç›¸å¯¹è·¯å¾„</li></ul><p>ç»å¯¹è·¯å¾„ä¸ç›¸å¯¹è·¯å¾„éƒ½è‡³å°‘ç”±ä¸€ä¸ªæ ‡è¯†ç¬¦ç»„æˆï¼Œæ ‡è¯†ç¬¦ä¹‹é—´ä½¿ç”¨åŒå†’å·ï¼ˆ<code>::</code>ï¼‰åˆ†éš”ã€‚</p><p>ç°åœ¨å°è¯•åœ¨æ¨¡å—å¤–éƒ¨è°ƒç”¨æ¨¡å—ä¸­å®šä¹‰çš„å‡½æ•°ã€‚åœ¨ <code>src/lib.rs</code> æœ«å°¾æ·»åŠ ä¸€ä¸ªå…¬å…±å‡½æ•° <code>eat_at_restaurant</code>ï¼Œè°ƒç”¨æ¨¡å— <code>front_of_house</code> ä¸­å®šä¹‰çš„å‡½æ•°ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    <span class="comment">// ç»å¯¹è·¯å¾„</span></span><br><span class="line">    crate::front_of_house::hosting::seat_at_table();</span><br><span class="line">    <span class="comment">// ç›¸å¯¹è·¯å¾„</span></span><br><span class="line">    front_of_house::serving::take_order();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹ <code>src/main.rs</code>ï¼Œåœ¨ <code>main</code> å‡½æ•°ä¸­è°ƒç”¨ä¸Šä¸€æ­¥ä¸­å®šä¹‰çš„å…¬å…±å‡½æ•°ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    restaurant::eat_at_restaurant();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å°è¯•ç¼–è¯‘é¡¹ç›®ï¼Œä¼šæŠ¥å‡ºå¦‚ä¸‹é”™è¯¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error[E0603]: module `hosting` is private</span><br><span class="line">error[E0603]: module `serving` is private</span><br></pre></td></tr></table></figure></p><p>å³æ¨¡å— <code>hosting</code> å’Œ <code>serving</code> æ˜¯ç§æœ‰çš„ï¼ŒRust ä¸å…è®¸æˆ‘ä»¬è®¿é—®ã€‚<br>Rust ä¸­çš„æ¨¡å—ä¸ä»…ä»…ç”¨äºç»„ç»‡ä»£ç ï¼ŒåŒæ—¶ä¹Ÿå®šä¹‰äº†<strong>ç§æœ‰è¾¹ç•Œ</strong>ï¼šå¤–éƒ¨ä»£ç æ— æ³•çŸ¥æ™“ã€è°ƒç”¨æˆ–ä¾èµ–é‚£äº›ç”±ç§æœ‰è¾¹ç•Œå°è£…äº†çš„å®ç°ç»†èŠ‚ã€‚<br><strong>Rust ä¸­çš„æ‰€æœ‰æ¡ç›®ï¼ˆå‡½æ•°ã€æ–¹æ³•ã€ç»“æ„ä½“ã€æšä¸¾ã€æ¨¡å—åŠå¸¸é‡ï¼‰é»˜è®¤éƒ½æ˜¯ç§æœ‰çš„ï¼Œå¤„äºçˆ¶çº§æ¨¡å—ä¸­çš„æ¡ç›®æ— æ³•ä½¿ç”¨å­æ¨¡å—ä¸­çš„ç§æœ‰æ¡ç›®ï¼Œä½†å­æ¨¡å—ä¸­çš„æ¡ç›®å¯ä»¥ä½¿ç”¨å…¶ç¥–å…ˆæ¨¡å—ä¸­çš„æ¡ç›®</strong>ã€‚<br>Rust å¸Œæœ›é»˜è®¤éšè—å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œè¿™æ ·ç”¨æˆ·å°±èƒ½æ˜ç¡®åœ°çŸ¥é“ä¿®æ”¹å“ªäº›å†…å®¹ä¸ä¼šç ´åå¤–éƒ¨ä»£ç ã€‚</p><h5 id="ä½¿ç”¨-pub-å…³é”®å­—æš´éœ²è·¯å¾„"><a href="#ä½¿ç”¨-pub-å…³é”®å­—æš´éœ²è·¯å¾„" class="headerlink" title="ä½¿ç”¨ pub å…³é”®å­—æš´éœ²è·¯å¾„"></a>ä½¿ç”¨ pub å…³é”®å­—æš´éœ²è·¯å¾„</h5><p>å¯ä»¥ä½¿ç”¨ <code>pub</code> å…³é”®å­—å°†æŸäº›æ¡ç›®æ ‡è®°ä¸ºå…¬å…±çš„ï¼Œä»è€Œä½¿å­æ¨¡å—ä¸­çš„è¿™äº›éƒ¨åˆ†å¯ä»¥è¢«æš´éœ²åˆ°ç¥–å…ˆæ¨¡å—ä¸­ã€‚<br>æ¥ä¸Šé¢çš„ä¾‹å­ï¼Œä¸ºäº†ä½¿çˆ¶æ¨¡å—ä¸­çš„ <code>eat_at_restaurant</code> å‡½æ•°èƒ½å¤Ÿæ­£å¸¸è®¿é—®å­æ¨¡å—ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨ <code>pub</code> å…³é”®å­—æ¥æ ‡è®° <code>hosting</code> å’Œ <code>serving</code> æ¨¡å—ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¨¡å—è¢« <code>pub</code> æ ‡è®°ï¼Œå…¶æ•ˆæœä»…é™äºæ¨¡å—æœ¬èº«ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å®ƒå†…éƒ¨æ¡ç›®çš„çŠ¶æ€ï¼Œæ¨¡å—ä¸­çš„å†…å®¹ä¾æ—§æ˜¯ç§æœ‰çš„ã€‚ä¸ºäº†ä½¿å‰é¢çš„ä»£ç æ­£å¸¸å·¥ä½œï¼Œè¿˜å¿…é¡»åœ¨éœ€è¦å…¬å¼€çš„å‡½æ•°å‰é¢æ·»åŠ  <code>pub</code> å…³é”®å­—ã€‚</p><p>ç¼–è¾‘ <code>src/lib.rs</code> ä¸­ï¼Œå†…å®¹æ”¹åŠ¨å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> front_of_house &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">seat_at_table</span></span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Seat at table."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> serving &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_order</span></span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Taking order."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_payment</span></span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Taking payment."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    <span class="comment">// ç»å¯¹è·¯å¾„</span></span><br><span class="line">    crate::front_of_house::hosting::seat_at_table();</span><br><span class="line">    <span class="comment">// ç›¸å¯¹è·¯å¾„</span></span><br><span class="line">    front_of_house::serving::take_order();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶ç¨‹åºå³å¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p><h5 id="å°†ç»“æ„ä½“å£°æ˜ä¸ºå…¬å…±çš„"><a href="#å°†ç»“æ„ä½“å£°æ˜ä¸ºå…¬å…±çš„" class="headerlink" title="å°†ç»“æ„ä½“å£°æ˜ä¸ºå…¬å…±çš„"></a>å°†ç»“æ„ä½“å£°æ˜ä¸ºå…¬å…±çš„</h5><p>å½“æˆ‘ä»¬åœ¨ç»“æ„ä½“å®šä¹‰å‰ä½¿ç”¨ <code>pub</code> å…³é”®å­—æ—¶ï¼Œç»“æ„ä½“æœ¬èº«å°±æˆä¸ºäº†å…¬å…±ç»“æ„ä½“ï¼Œä½†æ˜¯å®ƒçš„å­—æ®µä¾æ—§ä¿æŒç§æœ‰çŠ¶æ€ã€‚<br>æˆ‘ä»¬å¯ä»¥é€ä¸€å†³å®šæ˜¯å¦å°†æŸä¸ªå­—æ®µå…¬å¼€ã€‚</p><p>ä¸‹é¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ªå…¬å…±çš„ <code>back_of_house::Breakfast</code> ç»“æ„ä½“ï¼Œå¹¶ä»¤å…¶ <code>toast</code> å­—æ®µå…¬å¼€ï¼Œè€Œ <code>seasonal_fruit</code> å­—æ®µä¿æŒç§æœ‰ã€‚ä½¿å¾—å®¢æˆ·å¯ä»¥è‡ªè¡Œé€‰æ‹©æƒ³è¦çš„é¢åŒ…ï¼Œè€Œåªæœ‰å¨å¸ˆæ‰èƒ½æ ¹æ®å­£èŠ‚ä¸å­˜è´§å†³å®šé…é¤æ°´æœã€‚</p><p>ç¼–è¾‘ <code>src/lib.rs</code> æºæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ <code>back_of_house</code> æ¨¡å—ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> back_of_house &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Breakfast</span></span> &#123;</span><br><span class="line">        <span class="keyword">pub</span> toast: <span class="built_in">String</span>,</span><br><span class="line">        seasonal_fruit: <span class="built_in">String</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">impl</span> Breakfast &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">summer</span></span>(toast: &amp;<span class="built_in">str</span>) -&gt; Breakfast &#123;</span><br><span class="line">            Breakfast &#123;</span><br><span class="line">                toast: <span class="built_in">String</span>::from(toast),</span><br><span class="line">                seasonal_fruit: <span class="built_in">String</span>::from(<span class="string">"peaches"</span>),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†æµ‹è¯•æ–°æ·»åŠ çš„ä»£ç èƒ½å¦æ­£å¸¸å·¥ä½œï¼Œä¿®æ”¹ <code>src/lib.rs</code> ä¸­çš„ <code>eat_at_restaurant</code> å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    <span class="comment">// é€‰æ‹©é»‘éº¦é¢åŒ…ä½œä¸ºå¤å­£æ—©é¤</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> meal = back_of_house::Breakfast::summer(<span class="string">"Rye"</span>);</span><br><span class="line">    <span class="comment">// ä¿®æ”¹æˆ‘ä»¬æƒ³è¦çš„é¢åŒ…ç±»å‹</span></span><br><span class="line">    meal.toast = <span class="built_in">String</span>::from(<span class="string">"Wheat"</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"I'd like &#123;&#125; toast please"</span>, meal.toast);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥çš„è¿™ä¸€è¡Œæ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œæˆ‘ä»¬ä¸èƒ½çœ‹åˆ°æˆ–æ›´æ¢é™„å¸¦çš„å­£èŠ‚æ€§æ°´æœ</span></span><br><span class="line">    <span class="comment">// meal.seasonal_fruit = String::from("blueberries");</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>back_of_house::Breakfast</code> ç»“æ„ä½“ä¸­çš„ <code>toast</code> å­—æ®µæ˜¯å…¬å…±çš„ï¼Œæˆ‘ä»¬å› æ­¤èƒ½å¤Ÿåœ¨ <code>eat_at_restaurant</code> ä¸­ä½¿ç”¨ç‚¹å·è¯»å†™ <code>toast</code> å­—æ®µã€‚<br>åŒæ ·ç”±äº <code>seasonal_fruit</code> å­—æ®µæ˜¯ç§æœ‰çš„ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨ <code>eat_at_restaurant</code> ä¸­è®¿é—®å®ƒã€‚<br>å¦å¤–ï¼Œç”±äº <code>back_of_house::Breakfast</code> æ‹¥æœ‰ä¸€ä¸ªç§æœ‰å­—æ®µï¼Œè¿™ä¸ªç»“æ„ä½“å¿…é¡»æä¾›ä¸€ä¸ªå…¬å…±çš„å…³è”å‡½æ•°æ¥æ„é€  <code>Breakfast</code> å®ä¾‹ï¼ˆæœ¬ä¾‹ä¸­çš„ <code>summer</code>ï¼‰ï¼Œå¦åˆ™æˆ‘ä»¬å°†æ— æ³•åœ¨ç»“æ„ä½“å¤–éƒ¨åˆ›å»ºä»»ä½•çš„ <code>Breakfast</code> å®ä¾‹ã€‚</p><h4 id="ç”¨-use-å…³é”®å­—å°†è·¯å¾„å¯¼å…¥ä½œç”¨åŸŸ"><a href="#ç”¨-use-å…³é”®å­—å°†è·¯å¾„å¯¼å…¥ä½œç”¨åŸŸ" class="headerlink" title="ç”¨ use å…³é”®å­—å°†è·¯å¾„å¯¼å…¥ä½œç”¨åŸŸ"></a>ç”¨ <code>use</code> å…³é”®å­—å°†è·¯å¾„å¯¼å…¥ä½œç”¨åŸŸ</h4><p>åŸºäºè·¯å¾„æ¥è°ƒç”¨å‡½æ•°çš„å†™æ³•çœ‹ä¸Šå»ä¼šæœ‰äº›é‡å¤ä¸å†—é•¿ã€‚æ— è®ºæˆ‘ä»¬ä½¿ç”¨ç»å¯¹è·¯å¾„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„æ¥æŒ‡å®š <code>seat_at_table</code> å‡½æ•°ï¼Œéƒ½å¿…é¡»åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æŒ‡å®šè·¯å¾„ä¸Šçš„ <code>front_of_house</code> å’Œ <code>hosting</code> èŠ‚ç‚¹ã€‚<br>å¯ä»¥å€ŸåŠ© <code>use</code> å…³é”®å­—å°†è·¯å¾„å¼•å…¥ä½œç”¨åŸŸï¼Œç®€åŒ–ä¸Šè¿°æ­¥éª¤ã€‚å¦‚ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="keyword">use</span> crate::front_of_house::hosting;</span><br><span class="line"><span class="comment">// ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="keyword">use</span> self::front_of_house::serving;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    hosting::seat_at_table();</span><br><span class="line">    serving::take_order();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ä½œç”¨åŸŸä¸­ä½¿ç”¨ <code>use</code> å¼•å…¥è·¯å¾„æœ‰ç‚¹ç±»ä¼¼äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºç¬¦å·é“¾æ¥ã€‚é€šè¿‡åœ¨å•å…ƒåŒ…çš„æ ¹èŠ‚ç‚¹ä¸‹æ·»åŠ ä¸Šè¿°ä¸¤æ¡ <code>use</code> è¯­å¥ï¼Œ<code>hosting</code> å’Œ <code>serving</code> æˆäº†è¯¥ä½œç”¨åŸŸä¸‹çš„ä¸€ä¸ªæœ‰æ•ˆåç§°ï¼Œå°±å¦‚åŒè¿™ä¸¤ä¸ªæ¨¡å—è¢«å®šä¹‰åœ¨æ ¹èŠ‚ç‚¹ä¸‹ä¸€æ ·ã€‚</p><p>è¿™é‡Œä½¿ç”¨äº† <code>use crate::front_of_house::hosting</code> å¹¶æ¥ç€è°ƒç”¨ <code>hosting::seat_at_table</code>ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ <code>use crate::front_of_house::hosting::seat_at_table</code> æ¥ç›´æ¥å¼•å…¥ <code>seat_at_table</code> å‡½æ•°ã€‚<br>ç›¸å¯¹è€Œè¨€ï¼Œå‰è€…çš„æ–¹å¼æ›´å¸¸ç”¨ä¸€äº›ã€‚ä½¿ç”¨ <code>use</code> å°†å‡½æ•°çš„çˆ¶æ¨¡å—å¼•å…¥ä½œç”¨åŸŸï¼Œæ„å‘³ç€æˆ‘ä»¬å¿…é¡»åœ¨è°ƒç”¨å‡½æ•°æ—¶æŒ‡å®šè¿™ä¸ªçˆ¶æ¨¡å—ï¼Œä»è€Œæ›´æ¸…æ™°åœ°è¡¨æ˜å½“å‰å‡½æ•°æ²¡æœ‰è¢«å®šä¹‰åœ¨å½“å‰ä½œç”¨åŸŸä¸­ã€‚</p><p>ä¸åŒäºå‡½æ•°ï¼Œä½¿ç”¨ <code>use</code> å°†ç»“æ„ä½“ã€æšä¸¾æˆ–å…¶ä»–æ¡ç›®å¼•å…¥ä½œç”¨åŸŸæ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºé€šè¿‡æŒ‡å®šå®Œæ•´è·¯å¾„çš„æ–¹å¼å¼•å…¥ã€‚</p><h5 id="ä½¿ç”¨-as-æä¾›æ–°çš„åç§°"><a href="#ä½¿ç”¨-as-æä¾›æ–°çš„åç§°" class="headerlink" title="ä½¿ç”¨ as æä¾›æ–°çš„åç§°"></a>ä½¿ç”¨ <code>as</code> æä¾›æ–°çš„åç§°</h5><p>ä½¿ç”¨ use å°†å¤šä¸ªåŒåç±»å‹å¼•å…¥ä½œç”¨åŸŸæ—¶ï¼Œè¿˜å¯ä»¥åœ¨è·¯å¾„åä½¿ç”¨ <code>as</code> å…³é”®å­—ä¸ºç±»å‹æŒ‡å®šä¸€ä¸ªæ–°çš„æœ¬åœ°åç§°ï¼Œä¹Ÿå°±æ˜¯åˆ«åã€‚å¦‚ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::<span class="built_in">Result</span>;</span><br><span class="line"><span class="keyword">use</span> std::io::<span class="built_in">Result</span> <span class="keyword">as</span> IoResult;</span><br></pre></td></tr></table></figure></p><h5 id="ä½¿ç”¨-pub-use-é‡å¯¼å‡ºåç§°"><a href="#ä½¿ç”¨-pub-use-é‡å¯¼å‡ºåç§°" class="headerlink" title="ä½¿ç”¨ pub use é‡å¯¼å‡ºåç§°"></a>ä½¿ç”¨ <code>pub use</code> é‡å¯¼å‡ºåç§°</h5><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>use</code> å…³é”®å­—å°†åç§°å¼•å…¥ä½œç”¨åŸŸæ—¶ï¼Œè¿™ä¸ªåç§°ä¼šä»¥ç§æœ‰çš„æ–¹å¼åœ¨æ–°çš„ä½œç”¨åŸŸä¸­ç”Ÿæ•ˆã€‚ä¸ºäº†è®©å¤–éƒ¨ä»£ç èƒ½å¤Ÿè®¿é—®åˆ°è¿™äº›åç§°ï¼Œå¯ä»¥é€šè¿‡ç»„åˆä½¿ç”¨ <code>pub</code> å’Œ <code>use</code> ä¿®é¥°å…¶è·¯å¾„ã€‚<br>è¿™é¡¹æŠ€æœ¯ä¹Ÿè¢«ç§°ä½œé‡å¯¼å‡ºã€‚</p><p>æ¯”å¦‚ä½¿ç”¨ <code>pub</code> ä¿®é¥°å‰é¢ <code>src/lib.rs</code> ä¸­çš„æŸæ¡ <code>use</code> è¯­å¥ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> crate::front_of_house::hosting;</span><br></pre></td></tr></table></figure></p><p>äºæ˜¯åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ <code>src/main.rs</code> ä¸­ä¹Ÿå°±å¯ä»¥ä½¿ç”¨ <code>restaurant::hosting::seat_at_table()</code> å½¢å¼çš„ä»£ç è°ƒç”¨ <code>hosting</code> æ¨¡å—ä¸­çš„å‡½æ•°äº†ã€‚<br>é€šè¿‡ä½¿ç”¨ <code>pub use</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–å†™ä»£ç æ—¶ä½¿ç”¨ä¸€ç§ç»“æ„ï¼Œåœ¨å¯¹å¤–æš´éœ²æ—¶ä½¿ç”¨å¦å¤–ä¸€ç§ä¸åŒçš„ç»“æ„ã€‚è¿™ä¸€æ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬çš„ä»£ç åº“å¯¹ç¼–å†™è€…å’Œè°ƒç”¨è€…åŒæ—¶ä¿æŒè‰¯å¥½çš„ç»„ç»‡ç»“æ„ã€‚</p><h4 id="å°†æ¨¡å—æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶"><a href="#å°†æ¨¡å—æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶" class="headerlink" title="å°†æ¨¡å—æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶"></a>å°†æ¨¡å—æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶</h4><p>å½“æ¨¡å—è§„æ¨¡é€æ¸å¢å¤§æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬çš„å®šä¹‰ç§»åŠ¨åˆ°æ–°çš„æ–‡ä»¶ä¸­ã€‚<br>æ¯”å¦‚æˆ‘ä»¬éœ€è¦å°† <code>src/lib.rs</code> ä¸­å®šä¹‰çš„ <code>front_of_house</code> æ¨¡å—ç§»åŠ¨åˆ°å®ƒè‡ªå·±çš„æ–‡ä»¶ <code>src/front_of_house.rs</code> ä¸­ã€‚é¦–å…ˆå°†æ ¹èŠ‚ç‚¹æ–‡ä»¶ <code>lib.rs</code> ä¸­çš„ä»£ç æ”¹ä¸ºå¦‚ä¸‹ç‰ˆæœ¬ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> front_of_house;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> self::front_of_house::serving;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> crate::front_of_house::hosting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    hosting::seat_at_table();</span><br><span class="line">    serving::take_order();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ <code>mod front_of_house</code> åä½¿ç”¨åˆ†å·è€Œä¸æ˜¯ä»£ç å—ï¼Œä¼šè®© Rust å‰å¾€ä¸å½“å‰æ¨¡å—åŒåçš„æ–‡ä»¶ä¸­åŠ è½½æ¨¡å—å†…å®¹ã€‚å› æ­¤å¯ä»¥å°† <code>front_of_house</code> æ¨¡å—çš„å…·ä½“å®šä¹‰è½¬ç§»åˆ° <code>src/front_of_house.rs</code> æ–‡ä»¶ä¸­ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/front_of_house.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">seat_at_table</span></span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Seat at table."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> serving &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_order</span></span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Taking order."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_payment</span></span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Taking payment."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>äº‹å®ä¸Šè¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œç»§ç»­æ‹†è§£ <code>front_of_house</code> æ¨¡å—åˆ°å…¶ä»–æ–‡ä»¶ä¸­ã€‚é¦–å…ˆå°† <code>src/front_of_house.rs</code> æ–‡ä»¶çš„å†…å®¹æ”¹ä¸ºå¦‚ä¸‹ç‰ˆæœ¬ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> hosting;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> serving;</span><br></pre></td></tr></table></figure></p><p>æ¥ç€åˆ›å»ºä¸€ä¸ª <code>src/front_of_house</code> ç›®å½•ï¼Œä»¥åŠä¸€ä¸ª <code>src/front_of_house/hosting.rs</code> æ–‡ä»¶ç”¨æ¥å­˜æ”¾ <code>hosting</code> æ¨¡å—çš„å®šä¹‰ï¼Œä¸€ä¸ª <code>src/front_of_house/serving.rs</code> æ–‡ä»¶å­˜æ”¾ <code>serving</code> æ¨¡å—çš„å®šä¹‰ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/front_of_house/hosting.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">seat_at_table</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Seat at table."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/front_of_house/serving.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_order</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Taking order."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_payment</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Taking payment."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœä¸å‰ä¸¤ç§ç‰ˆæœ¬ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚<br>æ­¤æ—¶ <code>restaurant</code> é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">restaurant</span><br><span class="line">â”œâ”€â”€ Cargo.lock</span><br><span class="line">â”œâ”€â”€ Cargo.toml</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â”œâ”€â”€ front_of_house</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ hosting.rs</span><br><span class="line">    â”‚Â Â  â””â”€â”€ serving.rs</span><br><span class="line">    â”œâ”€â”€ front_of_house.rs</span><br><span class="line">    â”œâ”€â”€ lib.rs</span><br><span class="line">    â””â”€â”€ main.rs</span><br></pre></td></tr></table></figure></p><p>æ‰€æœ‰çš„ä¿®æ”¹éƒ½æ²¡æœ‰æ”¹å˜åŸæœ‰çš„æ¨¡å—æ ‘ç»“æ„ï¼Œå°½ç®¡è¿™äº›å®šä¹‰è¢«æ”¾ç½®åˆ°äº†ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œ<code>eat_at_restaurant</code> ä¸­çš„å‡½æ•°è°ƒç”¨ä¾æ—§æœ‰æ•ˆã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener">The Rust Programming Language</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æ¨¡å—ç³»ç»Ÿ&quot;&gt;&lt;a href=&quot;#æ¨¡å—ç³»ç»Ÿ&quot; class=&quot;headerlink&quot; title=&quot;æ¨¡å—ç³»ç»Ÿ&quot;&gt;&lt;/a&gt;æ¨¡å—ç³»ç»Ÿ&lt;/h4&gt;&lt;p&gt;åœ¨ç¼–å†™è¾ƒä¸ºå¤æ‚çš„é¡¹ç›®æ—¶ï¼Œåˆç†åœ°å¯¹ä»£ç è¿›è¡Œç»„ç»‡ä¸ç®¡ç†éå¸¸é‡è¦ã€‚åªæœ‰æŒ‰ç…§ä¸åŒçš„ç‰¹æ€§æ¥ç»„ç»‡æˆ–åˆ†å‰²ç›¸å…³åŠŸèƒ½çš„ä»£ç ï¼Œæ‰èƒ½å¤Ÿæ¸…æ™°åœ°æ‰¾åˆ°å®
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Package" scheme="https://rollingstarky.github.io/tags/Package/"/>
    
      <category term="Project" scheme="https://rollingstarky.github.io/tags/Project/"/>
    
      <category term="Rust" scheme="https://rollingstarky.github.io/tags/Rust/"/>
    
      <category term="Module" scheme="https://rollingstarky.github.io/tags/Module/"/>
    
      <category term="Crate" scheme="https://rollingstarky.github.io/tags/Crate/"/>
    
      <category term="Scope" scheme="https://rollingstarky.github.io/tags/Scope/"/>
    
  </entry>
  
  <entry>
    <title>Haskell åŸºæœ¬è¯­æ³•ï¼ˆäº”ï¼‰è‡ªå®šä¹‰ Types</title>
    <link href="https://rollingstarky.github.io/2021/07/06/basic-haskell-user-defined-types/"/>
    <id>https://rollingstarky.github.io/2021/07/06/basic-haskell-user-defined-types/</id>
    <published>2021-07-05T16:00:00.000Z</published>
    <updated>2021-07-06T14:50:37.604Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ADT-Algebraic-data-types"><a href="#ADT-Algebraic-data-types" class="headerlink" title="ADT (Algebraic data types)"></a>ADT (Algebraic data types)</h4><p>ç±»ä¼¼ <code>Bool</code>ã€<code>Int</code>ã€<code>Char</code> è¿™äº›éƒ½æ˜¯å†…ç½®çš„æ•°æ®ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong><code>data</code></strong> å…³é”®å­—åˆ›å»ºè‡ªå·±çš„ç±»å‹ã€‚</p><p>æ ‡å‡†åº“ä¸­çš„ <code>Bool</code> ç±»å‹å®é™…ä¸Šæ˜¯è¿™æ ·å®šä¹‰çš„ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Bool</span> = <span class="type">False</span> | <span class="type">True</span></span></span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>=</code> å·¦è¾¹éƒ¨åˆ†æŒ‡å®šç±»å‹çš„åç§°ï¼Œå³è¾¹éƒ¨åˆ†å«åš <strong>value constructors</strong>ï¼Œç”¨æ¥æŒ‡å®šå½“å‰ç±»å‹èƒ½å¤Ÿæ‹¥æœ‰çš„ä¸åŒæ•°å€¼ã€‚<br>æ•´ä¸ªè¯­å¥å¯ä»¥è¯»ä½œâ€œ<code>Bool</code> ç±»å‹å¯ä»¥ä½¿ç”¨ <code>True</code> æˆ–è€… <code>False</code> ä½œä¸ºå®ƒçš„å€¼â€ã€‚</p><p>ç°åœ¨æ€è€ƒä¸‹åº”è¯¥ç”¨æ€æ ·çš„å½¢å¼è¡¨ç¤ºä¸€ç§å½¢çŠ¶ã€‚å¯ä»¥ä½¿ç”¨å…ƒç»„ï¼Œæ¯”å¦‚åœ†åœˆå¯ä»¥è¡¨ç¤ºä¸º <code>(43.1, 55.0, 10.4)</code>ã€‚å‰ä¸¤é¡¹è¡¨ç¤ºåœ†å¿ƒçš„åæ ‡ï¼Œæœ€åä¸€é¡¹è¡¨ç¤ºåŠå¾„ã€‚<br>ä½†è¿™ç§å½¢å¼çš„å…ƒç»„ä¹ŸåŒæ ·å¯ä»¥è¡¨ç¤ºä¸€ä¸ªä¸‰ç»´å‘é‡æˆ–è€…å…¶ä»–å¯¹è±¡ã€‚æ›´å¥½ä¸€ç‚¹çš„æ–¹æ³•æ˜¯åˆ›å»ºè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ã€‚</p><p>å‡è®¾ä¸€ä¸ªå½¢çŠ¶å¯¹è±¡å¯ä»¥æ˜¯åœ†æˆ–è€…çŸ©å½¢ï¼Œåˆ™å¯ä»¥å®šä¹‰å¦‚ä¸‹å½¢å¼çš„ <code>Shape</code> ç±»å‹ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Shape</span> = <span class="type">Circle</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> | <span class="type">Rectangle</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span></span></span><br></pre></td></tr></table></figure></p><p>å¯ä»¥è¿™æ ·ç†è§£ï¼Œ<code>Circle</code> value constructor åŒ…å«ä¸‰ä¸ª Float ç±»å‹çš„å­—æ®µï¼Œå‰ä¸¤ä¸ªå­—æ®µæ˜¯åœ†å¿ƒçš„åæ ‡ï¼Œæœ€åä¸€ä¸ªå­—æ®µè¡¨ç¤ºåŠå¾„ï¼›<code>Rectangle</code> value constructor åŒ…å«å››ä¸ª Float ç±»å‹çš„å­—æ®µï¼Œå‰ä¸¤ä¸ªå­—æ®µè¡¨ç¤ºå·¦ä¸Šè§’é¡¶ç‚¹çš„åæ ‡ï¼Œåä¸¤ä¸ªå­—æ®µè¡¨ç¤ºå³ä¸‹è§’çš„åæ ‡ã€‚</p><p>Value constructor å®é™…ä¸Šæ˜¯ä¸€ç§å‡½æ•°ï¼Œæ‰€è°“çš„â€œå­—æ®µâ€æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œæœ€ç»ˆè¿”å›ç‰¹å®šçš„æ•°æ®ç±»å‹ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :t <span class="type">Circle</span></span><br><span class="line"><span class="type">Circle</span> :: <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Shape</span></span><br><span class="line"><span class="type">Prelude</span>&gt; :t <span class="type">Rectangle</span></span><br><span class="line"><span class="type">Rectangle</span> :: <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Shape</span></span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥å°±å¯ä»¥é’ˆå¯¹ <code>Shape</code> ç±»å‹å®šä¹‰ä¸€ä¸ª <code>surface</code> å‡½æ•°ï¼Œç”¨æ¥è®¡ç®—æŸä¸ª Shape çš„é¢ç§¯ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">surface</span> :: <span class="type">Shape</span> -&gt; <span class="type">Float</span>  </span><br><span class="line"><span class="title">surface</span> (<span class="type">Circle</span> _ _ r) = pi * r ^ <span class="number">2</span>  </span><br><span class="line"><span class="title">surface</span> (<span class="type">Rectangle</span> x1 y1 x2 y2) = (abs (x2 - x1)) * (abs (y2 - y1))</span><br></pre></td></tr></table></figure></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :&#123;</span><br><span class="line"><span class="type">Prelude</span>| surface :: <span class="type">Shape</span> -&gt; <span class="type">Float</span></span><br><span class="line"><span class="type">Prelude</span>| surface (<span class="type">Circle</span> _ _ r) = pi * r ^ <span class="number">2</span></span><br><span class="line"><span class="type">Prelude</span>| surface (<span class="type">Rectangle</span> x1 y1 x2 y2) = (abs (x2 - x1)) * (abs (y2 - y1))</span><br><span class="line"><span class="type">Prelude</span>| :&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt;</span><br><span class="line"><span class="type">Prelude</span>&gt; surface (<span class="type">Circle</span> <span class="number">10</span> <span class="number">20</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">314.15927</span></span><br><span class="line"><span class="type">Prelude</span>&gt; surface (<span class="type">Rectangle</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">100</span>)</span><br><span class="line"><span class="number">10000.0</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å½“æˆ‘ä»¬åœ¨ <code>ghci</code> ä¸­åƒè°ƒç”¨å‡½æ•°é‚£æ ·ç›´æ¥æ‰§è¡Œå¦‚ <code>Circle 10 20 5</code> è¿™ç±»å‘½ä»¤æ—¶ï¼Œä¼šæŠ¥å‡ºå¦‚ä¸‹é”™è¯¯ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; (<span class="type">Circle</span> <span class="number">10</span> <span class="number">20</span> <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">&lt;interactive&gt;:<span class="number">14</span>:<span class="number">1</span>: error:</span><br><span class="line">    â€¢ <span class="type">No</span> <span class="keyword">instance</span> for (<span class="type">Show</span> <span class="type">Shape</span>) arising from a use <span class="keyword">of</span> â€˜printâ€™</span><br><span class="line">    â€¢ <span class="type">In</span> a stmt <span class="keyword">of</span> an interactive <span class="type">GHCi</span> command: print it</span><br></pre></td></tr></table></figure></p><p>åŸå› æ˜¯ Haskell ä¸æ¸…æ¥šå¦‚ä½•å°†æ­¤å¤„çš„è‡ªå®šä¹‰ç±»å‹è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ã€‚å½“åœ¨ <code>ghci</code> ä¸­æ‰“å°ä¸€ä¸ªå€¼æ—¶ï¼Œå®é™…ä¸Š Haskell è°ƒç”¨äº† <code>show</code> å‡½æ•°ç”¨æ¥è·å–å¯¹åº”å€¼çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå¹¶è¾“å‡ºåˆ°å‘½ä»¤è¡Œã€‚<br>ä¸ºäº†ä½¿æˆ‘ä»¬çš„ <code>Shape</code> ç±»å‹æ”¯æŒæ‰“å°è¾“å‡ºï¼Œéœ€è¦ä»¤å…¶å®ç° <code>Show</code> typeclassã€‚è¯­æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Shape</span> = <span class="type">Circle</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> | <span class="type">Rectangle</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶ <code>Shape</code> ç±»å‹å³å¯æ”¯æŒæ‰“å°è¾“å‡ºæ“ä½œï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="class"><span class="keyword">data</span> <span class="type">Shape</span> = <span class="type">Circle</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> | <span class="type">Rectangle</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> <span class="type">Float</span> <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Circle</span> <span class="number">10</span> <span class="number">20</span> <span class="number">5</span></span><br><span class="line"><span class="type">Circle</span> <span class="number">10.0</span> <span class="number">20.0</span> <span class="number">5.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Rectangle</span> <span class="number">50</span> <span class="number">230</span> <span class="number">60</span> <span class="number">90</span></span><br><span class="line"><span class="type">Rectangle</span> <span class="number">50.0</span> <span class="number">230.0</span> <span class="number">60.0</span> <span class="number">90.0</span></span><br></pre></td></tr></table></figure></p><p>Value constructor å®é™…ä¸Šå°±æ˜¯å‡½æ•°ï¼Œä¹Ÿå› æ­¤æ”¯æŒ <code>map</code>ã€partially apply ç­‰æ“ä½œã€‚<br>æ¯”å¦‚å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç åˆ›å»ºä¸€ç³»åˆ—åŠå¾„ä¸åŒçš„åŒå¿ƒåœ†ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; map (<span class="type">Circle</span> <span class="number">10</span> <span class="number">20</span>) [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>]</span><br><span class="line">[<span class="type">Circle</span> <span class="number">10.0</span> <span class="number">20.0</span> <span class="number">4.0</span>,<span class="type">Circle</span> <span class="number">10.0</span> <span class="number">20.0</span> <span class="number">5.0</span>,<span class="type">Circle</span> <span class="number">10.0</span> <span class="number">20.0</span> <span class="number">6.0</span>,<span class="type">Circle</span> <span class="number">10.0</span> <span class="number">20.0</span> <span class="number">6.0</span>]</span><br></pre></td></tr></table></figure></p><p>è®©æˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ª <code>Point</code> ç±»å‹ï¼Œå¹¶ä»¤å…¶æˆä¸º <code>Shape</code> ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œæ›´åŠ å®¹æ˜“ç†è§£ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Point</span> = <span class="type">Point</span> <span class="type">Float</span> <span class="type">Float</span> <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Shape</span> = <span class="type">Circle</span> <span class="type">Point</span> <span class="type">Float</span> | <span class="type">Rectangle</span> <span class="type">Point</span> <span class="type">Point</span> <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶çš„ <code>Circle</code> ç±»å‹æ‹¥æœ‰ä¸¤ä¸ªå­—æ®µï¼Œç”¨ <code>Point</code> ç±»å‹è¡¨ç¤ºåœ†åœˆçš„åœ†å¿ƒï¼Œå†åŠ ä¸€ä¸ª <code>Float</code> ç±»å‹è¡¨ç¤ºåŠå¾„ã€‚</p><p>é‡æ–°å®ç°ä¸‹ä¹‹å‰çš„ <code>surface</code> å‡½æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">surface</span> :: <span class="type">Shape</span> -&gt; <span class="type">Float</span></span><br><span class="line"><span class="title">surface</span> (<span class="type">Circle</span> _ r) = pi * r ^ <span class="number">2</span></span><br><span class="line"><span class="title">surface</span> (<span class="type">Rectangle</span> (<span class="type">Point</span> x1 y1) (<span class="type">Point</span> x2 y2)) = (abs (x2 - x1)) * (abs (y2 - y1))</span><br></pre></td></tr></table></figure></p><p>åªéœ€è¦é‡æ–°å®šä¹‰æ¨¡å¼åŒ¹é…çš„éƒ¨åˆ†å³å¯ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; surface (<span class="type">Rectangle</span> (<span class="type">Point</span> <span class="number">0</span> <span class="number">0</span>) (<span class="type">Point</span> <span class="number">100</span> <span class="number">100</span>))</span><br><span class="line"><span class="number">10000.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; surface (<span class="type">Circle</span> (<span class="type">Point</span> <span class="number">0</span> <span class="number">0</span>) <span class="number">24</span>)</span><br></pre></td></tr></table></figure></p><p>è¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>nudge</code> å‡½æ•°ç”¨æ¥ç§»åŠ¨æŸä¸ªå½¢çŠ¶å¯¹è±¡çš„ä½ç½®ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªå½¢çŠ¶åŠå…¶åœ¨ x è½´å’Œ y è½´ä¸Šçš„åç§»é‡ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªåŒæ ·å¤§å°ã€ä¸åŒä½ç½®çš„å½¢çŠ¶å¯¹è±¡ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">nudge</span> :: <span class="type">Shape</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">Shape</span></span><br><span class="line"><span class="title">nudge</span> (<span class="type">Circle</span> (<span class="type">Point</span> x y) r) a b = <span class="type">Circle</span> (<span class="type">Point</span> (x+a) (y+b)) r</span><br><span class="line"><span class="title">nudge</span> (<span class="type">Rectangle</span> (<span class="type">Point</span> x1 y1) (<span class="type">Point</span> x2 y2)) a b = <span class="type">Rectangle</span> (<span class="type">Point</span> (x1+a) (y1+b)) (<span class="type">Point</span> (x2+a) (y2+b))</span><br></pre></td></tr></table></figure></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; nudge (<span class="type">Circle</span> (<span class="type">Point</span> <span class="number">34</span> <span class="number">34</span>) <span class="number">10</span>) <span class="number">5</span> <span class="number">10</span></span><br><span class="line"><span class="type">Circle</span> (<span class="type">Point</span> <span class="number">39.0</span> <span class="number">44.0</span>) <span class="number">10.0</span></span><br></pre></td></tr></table></figure><h4 id="Record-è¯­æ³•"><a href="#Record-è¯­æ³•" class="headerlink" title="Record è¯­æ³•"></a>Record è¯­æ³•</h4><p>å‡è®¾åˆ›å»ºä¸€ä¸ªåä¸º <code>Person</code> çš„è‡ªå®šä¹‰æ•°æ®ç±»å‹ã€‚å®ƒéœ€è¦åŒ…å«åå­—ã€å§“æ°ã€å¹´é¾„ã€èº«é«˜ã€æ‰‹æœºå·å’Œæœ€å–œæ¬¢çš„å†°æ·‡æ·‹ç§ç±»ç­‰å­—æ®µã€‚<br>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç å®ç°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="class"><span class="keyword">data</span> <span class="type">Person</span> = <span class="type">Person</span> <span class="type">String</span> <span class="type">String</span> <span class="type">Int</span> <span class="type">Float</span> <span class="type">String</span> <span class="type">String</span> <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> guy = <span class="type">Person</span> <span class="string">"Buddy"</span> <span class="string">"Finklestein"</span> <span class="number">43</span> <span class="number">184.2</span> <span class="string">"526-2928"</span> <span class="string">"Chocolate"</span></span><br><span class="line"><span class="type">Prelude</span>&gt; guy</span><br><span class="line"><span class="type">Person</span> <span class="string">"Buddy"</span> <span class="string">"Finklestein"</span> <span class="number">43</span> <span class="number">184.2</span> <span class="string">"526-2928"</span> <span class="string">"Chocolate"</span></span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°ä»£ç æ˜¯å¯ä»¥è¿è¡Œçš„ï¼Œä½†å¯è¯»æ€§å´å¾ˆå·®ã€‚<br>å½“æˆ‘ä»¬éœ€è¦åˆ›å»ºå‡½æ•°æ¥è·å– Person å¯¹è±¡ä¸­çš„æŸä¸ªå­—æ®µçš„å€¼æ—¶ï¼Œå¯èƒ½å°±éœ€è¦å€ŸåŠ©å¦‚ä¸‹å½¢å¼çš„ä»£ç ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">firstName</span> :: <span class="type">Person</span> -&gt; <span class="type">String</span></span><br><span class="line"><span class="title">firstName</span> (<span class="type">Person</span> firstname _ _ _ _ _) = firstname</span><br><span class="line">  </span><br><span class="line"><span class="title">lastName</span> :: <span class="type">Person</span> -&gt; <span class="type">String</span></span><br><span class="line"><span class="title">lastName</span> (<span class="type">Person</span> _ lastname _ _ _ _) = lastname</span><br><span class="line">  </span><br><span class="line"><span class="title">age</span> :: <span class="type">Person</span> -&gt; <span class="type">Int</span></span><br><span class="line"><span class="title">age</span> (<span class="type">Person</span> _ _ age _ _ _) = age</span><br><span class="line">  </span><br><span class="line"><span class="title">height</span> :: <span class="type">Person</span> -&gt; <span class="type">Float</span></span><br><span class="line"><span class="title">height</span> (<span class="type">Person</span> _ _ _ height _ _) = height</span><br><span class="line">  </span><br><span class="line"><span class="title">phoneNumber</span> :: <span class="type">Person</span> -&gt; <span class="type">String</span></span><br><span class="line"><span class="title">phoneNumber</span> (<span class="type">Person</span> _ _ _ _ number _) = number</span><br><span class="line">  </span><br><span class="line"><span class="title">flavor</span> :: <span class="type">Person</span> -&gt; <span class="type">String</span></span><br><span class="line"><span class="title">flavor</span> (<span class="type">Person</span> _ _ _ _ _ flavor) = flavor</span><br></pre></td></tr></table></figure></p><p>é‰´äºä¸Šè¿°åœºæ™¯ä¸­çš„ä»£ç å®ç°æœ‰è¯¸å¤šä¸æ–¹ä¾¿çš„åœ°æ–¹ï¼ŒHaskell æä¾›äº†å¦å¤–ä¸€ç§åˆ›å»ºæ•°æ®ç±»å‹çš„æ–¹æ³•ï¼Œå³ Record è¯­æ³•ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Person</span> = <span class="type">Person</span> &#123; <span class="title">firstName</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class">                     , <span class="title">lastName</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class">                     , <span class="title">age</span> :: <span class="type">Int</span></span></span><br><span class="line"><span class="class">                     , <span class="title">height</span> :: <span class="type">Float</span></span></span><br><span class="line"><span class="class">                     , <span class="title">phoneNumber</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class">                     , <span class="title">flavor</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class">                     &#125; <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br></pre></td></tr></table></figure></p><p>é€šè¿‡ä¸Šè¿°è¯­æ³•ï¼ŒHaskell ä¼šè‡ªåŠ¨åˆ›å»º <code>firstName</code>ã€<code>lastName</code>ã€<code>age</code>ã€<code>height</code>ã€<code>phoneNumber</code>ã€<code>flavor</code> ç­‰å‡½æ•°ï¼Œç”¨äºè®¿é—®è¯¥ç±»å‹å¯¹è±¡ä¸­çš„å¯¹åº”å­—æ®µã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :t flavor</span><br><span class="line"><span class="title">flavor</span> :: <span class="type">Person</span> -&gt; <span class="type">String</span></span><br><span class="line"><span class="type">Prelude</span>&gt; :t firstName</span><br><span class="line"><span class="title">firstName</span> :: <span class="type">Person</span> -&gt; <span class="type">String</span></span><br></pre></td></tr></table></figure></p><p>Record è¯­æ³•çš„å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼ŒValue constructor ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰å­—æ®µéƒ½å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°ï¼Œæ–¹ä¾¿å„å­—æ®µä¹‹é—´çš„ç›¸äº’åŒºåˆ†ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="class"><span class="keyword">data</span> <span class="type">Car</span> = <span class="type">Car</span> &#123;<span class="title">company</span> :: <span class="type">String</span>, <span class="title">model</span> :: <span class="type">String</span>, <span class="title">year</span> :: <span class="type">Int</span>&#125; <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> car = <span class="type">Car</span> &#123;company=<span class="string">"Ford"</span>, model=<span class="string">"Mustang"</span>, year=<span class="number">1967</span>&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; car</span><br><span class="line"><span class="type">Car</span> &#123;company = <span class="string">"Ford"</span>, model = <span class="string">"Mustang"</span>, year = <span class="number">1967</span>&#125;</span><br></pre></td></tr></table></figure></p><p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªç”¨äºè¡¨ç¤ºä¸‰ç»´å‘é‡çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>data Vector = Vector Int Int Int</code> è¯­å¥ã€‚ä½†è¿™æ ·çš„è¯­æ³•å¯¹äºå‰é¢çš„ <code>Person</code> å’Œ <code>Car</code> æ¥è®²ï¼Œå…¶å«ä¹‰å°±ä¸å¦‚ä½¿ç”¨ Record è¯­æ³•æ¥å¾—æ¸…æ™°ã€‚</p><h4 id="å‚æ•°åŒ–ç±»å‹"><a href="#å‚æ•°åŒ–ç±»å‹" class="headerlink" title="å‚æ•°åŒ–ç±»å‹"></a>å‚æ•°åŒ–ç±»å‹</h4><p>Value constructor å¯ä»¥æ¥æ”¶ç‰¹å®šæ•°é‡çš„å‚æ•°æ¥ç”Ÿæˆä¸€ä¸ªç‰¹å®šç±»å‹çš„å€¼ã€‚æ¯”å¦‚å‰é¢çš„ <code>Car</code> æ¥æ”¶ 3 ä¸ªå‚æ•°ç”Ÿæˆä¸€ä¸ªæ–°çš„ carã€‚<br><strong>Type constructor</strong> åˆ™å¯ä»¥æ¥æ”¶ type ä½œä¸ºå‚æ•°æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å‹ã€‚</p><p>æ¯”å¦‚å†…ç½®çš„ <code>Maybe</code> çš„å®ç°ï¼š<br><code>data Maybe a = Nothing | Just a</code></p><p>å…¶ä¸­ <code>a</code> è¡¨ç¤ºç±»å‹å‚æ•°ï¼Œ<code>Maybe</code> å³ä¸º type constructorã€‚æˆ‘ä»¬å¯ä»¥å‘ <code>Maybe</code> ä¼ å…¥ä¸€ä¸ª <code>Char</code> ä½œä¸ºç±»å‹å‚æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°çš„ <code>Maybe Char</code> ç±»å‹ã€‚æ¯”å¦‚å€¼ <code>Just &#39;a&#39;</code> å°±å±äº <code>Maybe Char</code> ç±»å‹ã€‚<br>åŒæ ·çš„æ–¹å¼å¯ä»¥å¾—åˆ°ç±»å‹ <code>Maybe Int</code>ã€<code>Maybe String</code> ç­‰ç­‰ã€‚</p><p><code>Maybe</code> å®é™…ä¸Šè¡¨ç¤ºä¸€ç§<strong>å¯é€‰é¡¹</strong>ï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„æŸç§ç‰¹å®šç±»å‹çš„å€¼ï¼Œä¹Ÿå¯ä»¥ä»€ä¹ˆå€¼éƒ½ä¸åŒ…å«ï¼ˆ<code>Nothing</code>ï¼‰ã€‚æ¯”å¦‚ <code>Maybe Int</code> ç±»å‹å°±è¡¨ç¤ºè¯¥ç±»å‹çš„å€¼å¯èƒ½åŒ…å« <code>Int</code>ï¼ˆå€¼ <code>Just 5</code>ï¼‰ï¼Œä¹Ÿå¯èƒ½ä¸åŒ…å«ä»»æ„ç±»å‹ï¼ˆ<code>Nothing</code>ï¼‰ã€‚</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :t <span class="type">Just</span> <span class="string">"Haha"</span></span><br><span class="line"><span class="type">Just</span> <span class="string">"Haha"</span> :: <span class="type">Maybe</span> [<span class="type">Char</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; :t <span class="type">Just</span> <span class="number">84</span></span><br><span class="line"><span class="type">Just</span> <span class="number">84</span> :: <span class="type">Num</span> a =&gt; <span class="type">Maybe</span> a</span><br><span class="line"><span class="type">Prelude</span>&gt; :t <span class="type">Nothing</span></span><br><span class="line"><span class="type">Nothing</span> :: <span class="type">Maybe</span> a</span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Just</span> <span class="number">10</span> :: <span class="type">Maybe</span> <span class="type">Double</span></span><br><span class="line"><span class="type">Just</span> <span class="number">10.0</span></span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šè¿˜æœ‰ä¸€ç§ç±»å‹æ¶‰åŠåˆ°äº†ç±»å‹å‚æ•°ï¼Œåªä¸è¿‡å€ŸåŠ©äº†è¯­æ³•ç³–ï¼Œå…¶å½¢å¼ç¨æœ‰ä¸åŒã€‚è¯¥ç±»å‹å°±æ˜¯ listã€‚<br>list ç±»å‹å¯ä»¥æ¥æ”¶ä¸€ä¸ªç±»å‹å‚æ•°ç”Ÿæˆæ›´å…·ä½“çš„ç±»å‹ã€‚æ¯”å¦‚ <code>[Int]</code>ã€<code>[Char]</code> ç”šè‡³ <code>[[String]]</code> ç­‰ç­‰ã€‚<br>ä½†æ˜¯æ²¡æœ‰ä»»ä½•å€¼çš„ç±»å‹å¯ä»¥æ˜¯ <code>[]</code>ã€‚ç©ºåˆ—è¡¨å®é™…ä¸Šå¯ä»¥è¡¨ç°å¾—åƒä»»æ„ç±»å‹çš„åˆ—è¡¨ï¼Œå…¶ç±»å‹æ˜¯ <code>[a]</code>ï¼Œä¹Ÿå› æ­¤å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å½¢å¼çš„è¡¨è¾¾å¼ï¼š<code>[1,2,3] ++ []</code>ã€<code>[&quot;ha&quot;,&quot;ha&quot;,&quot;ha&quot;] ++ []</code>ã€‚</p><p>ä¸‹é¢çš„ä»£ç å®ç°äº†ä¸€ç§ä¸‰ç»´çš„å‘é‡ç±»å‹ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Vector</span> a = <span class="type">Vector</span> a a a <span class="keyword">deriving</span> (<span class="type">Show</span>)</span></span><br><span class="line">  </span><br><span class="line"><span class="title">vplus</span> :: (<span class="type">Num</span> t) =&gt; <span class="type">Vector</span> t -&gt; <span class="type">Vector</span> t -&gt; <span class="type">Vector</span> t  </span><br><span class="line">(<span class="type">Vector</span> i j k) `vplus` (<span class="type">Vector</span> l m n) = <span class="type">Vector</span> (i+l) (j+m) (k+n)</span><br><span class="line">  </span><br><span class="line"><span class="title">vectMult</span> :: (<span class="type">Num</span> t) =&gt; <span class="type">Vector</span> t -&gt; t -&gt; <span class="type">Vector</span> t  </span><br><span class="line">(<span class="type">Vector</span> i j k) `vectMult` m = <span class="type">Vector</span> (i*m) (j*m) (k*m)</span><br><span class="line">  </span><br><span class="line"><span class="title">scalarMult</span> :: (<span class="type">Num</span> t) =&gt; <span class="type">Vector</span> t -&gt; <span class="type">Vector</span> t -&gt; t  </span><br><span class="line">(<span class="type">Vector</span> i j k) `scalarMult` (<span class="type">Vector</span> l m n) = i*l + j*m + k*n</span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°å‡½æ•°å¯ä»¥ä½œç”¨åœ¨ <code>Vector Int</code>ã€<code>Vector Integer</code>ã€<code>Vector  Float</code> ç±»å‹ä¸Šï¼Œåªè¦ç±»å‹ <code>Vector a</code> ä¸­çš„ <code>a</code> å±äº <code>Num</code> typeclassã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Vector</span> <span class="number">3</span> <span class="number">5</span> <span class="number">8</span> `vplus` <span class="type">Vector</span> <span class="number">9</span> <span class="number">2</span> <span class="number">8</span></span><br><span class="line"><span class="type">Vector</span> <span class="number">12</span> <span class="number">7</span> <span class="number">16</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Vector</span> <span class="number">3</span> <span class="number">9</span> <span class="number">7</span> `vectMult` <span class="number">10.0</span></span><br><span class="line"><span class="type">Vector</span> <span class="number">30.0</span> <span class="number">90.0</span> <span class="number">70.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Vector</span> <span class="number">4</span> <span class="number">9</span> <span class="number">5</span> `scalarMult` <span class="type">Vector</span> <span class="number">9.0</span> <span class="number">2.0</span> <span class="number">4.0</span></span><br><span class="line"><span class="number">74.0</span></span><br></pre></td></tr></table></figure></p><p>ç±»å‹å‚æ•°é€šå¸¸ç”¨åœ¨å½“ type constructor ä¸­åŒ…å«çš„ç±»å‹å¯¹è¯¥ç±»å‹çš„æ­£å¸¸å·¥ä½œå¹¶ä¸äº§ç”Ÿå½±å“æ—¶ã€‚å³æˆ‘ä»¬çš„è‡ªå®šä¹‰ç±»å‹è¡¨ç°å¾—åƒæŸç§â€œç›’å­â€ï¼Œé‡Œé¢å¯ä»¥æ”¾ä»»æ„çš„ç‰¹å®šç±»å‹çš„å€¼ã€‚</p><h4 id="æ´¾ç”Ÿå®ä¾‹"><a href="#æ´¾ç”Ÿå®ä¾‹" class="headerlink" title="æ´¾ç”Ÿå®ä¾‹"></a>æ´¾ç”Ÿå®ä¾‹</h4><p><strong>typeclass æ˜¯ä¸€ç§å®šä¹‰äº†æŸç§è¡Œä¸ºçš„æ¥å£</strong>ã€‚è‹¥æŸä¸ªç±»å‹æ”¯æŒ typeclass å®šä¹‰çš„è¡Œä¸ºï¼Œåˆ™è¯¥ç±»å‹æˆä¸º typeclass çš„å®ä¾‹ã€‚<br>æ¯”å¦‚ <code>Eq</code> typeclass å®šä¹‰äº†å¯ä»¥è¢«æµ‹è¯•æ˜¯å¦ç›¸ç­‰çš„è¡Œä¸ºï¼Œè€Œæ•´æ•°ä¹‹é—´å¯ä»¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ï¼Œå› æ­¤ <code>Int</code> ç±»å‹æ˜¯ <code>Eq</code> typeclass çš„å®ä¾‹ã€‚ä¸æ­¤åŒæ—¶ï¼Œä½œä¸º <code>Eq</code> æ¥å£çš„å‡½æ•°å¦‚ <code>==</code> å’Œ <code>/=</code>ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ <code>Int</code> ç±»å‹çš„å€¼ï¼Œæµ‹è¯•å®ƒä»¬æ˜¯å¦ç›¸ç­‰ï¼ˆæˆ–ä¸ç›¸ç­‰ï¼‰ã€‚</p><p>typeclass ç»å¸¸ä¼šä¸å…¶ä»–è¯­è¨€å¦‚ Java ä¸­çš„ç±»ç›¸æ··æ·†ã€‚å®é™…ä¸Šåœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œç±»å¯ä»¥çœ‹ä½œåˆ›å»ºå¯¹è±¡ï¼ˆåŒ…å«è‡ªèº«çŠ¶æ€å’Œè¡Œä¸ºï¼‰çš„è“å›¾ï¼›è€Œ typeclass åˆ™æ›´åƒæ˜¯æ¥å£ã€‚<br>åœ¨ Haskell ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºæŸä¸ªæ•°æ®ç±»å‹ï¼Œç„¶åè€ƒè™‘è¯¥ç±»å‹æœ‰æ€æ ·çš„è¡Œä¸ºã€‚è‹¥è¯¥ç±»å‹å¯ä»¥è¢«æ’åºï¼Œåˆ™ä»¤å…¶æˆä¸º <code>Ord</code> typeclass çš„å®ä¾‹ã€‚è¿™ä¹‹åè¯¥ç±»å‹çš„å€¼å°±å¯ä»¥è¢« <code>&gt;</code>ã€<code>&lt;</code>ã€<code>compare</code> ç­‰æ¯”è¾ƒå¤§å°çš„å‡½æ•°è°ƒç”¨äº†ã€‚</p><p>ç°åœ¨å‡è®¾ä¸¤ä¸ªäººå¯ä»¥æœ‰ç›¸åŒçš„å§“æ°ã€åå­—å’Œå¹´é¾„ï¼Œåˆ™è¿™ä¸¤ä¸ªäººå°±æ˜¯â€œç›¸ç­‰â€çš„ã€‚ç”±æ­¤åˆ›å»ºä¸€ä¸ªå¯ä»¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰çš„ <code>Person</code> ç±»å‹ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Person</span> = <span class="type">Person</span> &#123; <span class="title">firstName</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class">                     , <span class="title">lastName</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class">                     , <span class="title">age</span> :: <span class="type">Int</span></span></span><br><span class="line"><span class="class">                     &#125; <span class="keyword">deriving</span> (<span class="type">Eq</span>)</span></span><br></pre></td></tr></table></figure></p><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>==</code> æ¯”è¾ƒä¸¤ä¸ªå®ç°äº† <code>Eq</code> typeclass  çš„ç±»å‹å®ä¾‹æ—¶ï¼ŒHaskell ä¼šå…ˆç”¨ <code>==</code> æ¯”è¾ƒä¸¤ä¸ªç±»å‹å®ä¾‹çš„ value constructor æ˜¯å¦ç›¸ç­‰ï¼Œå†æ¯”è¾ƒç±»å‹å®ä¾‹ä¸­åŒ…å«çš„æ‰€æœ‰å­—æ®µçš„å€¼æ˜¯å¦éƒ½ç›¸ç­‰ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> mikeD = <span class="type">Person</span> &#123;firstName = <span class="string">"Michael"</span>, lastName = <span class="string">"Diamond"</span>, age = <span class="number">43</span>&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> adRock = <span class="type">Person</span> &#123;firstName = <span class="string">"Adam"</span>, lastName = <span class="string">"Horovitz"</span>, age = <span class="number">41</span>&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> mca = <span class="type">Person</span> &#123;firstName = <span class="string">"Adam"</span>, lastName = <span class="string">"Yauch"</span>, age = <span class="number">44</span>&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; mca == adRock</span><br><span class="line"><span class="type">False</span></span><br><span class="line"><span class="type">Prelude</span>&gt; mikeD == adRock</span><br><span class="line"><span class="type">False</span></span><br><span class="line"><span class="type">Prelude</span>&gt; mikeD == mikeD</span><br><span class="line"><span class="type">True</span></span><br><span class="line"><span class="type">Prelude</span>&gt; mikeD == <span class="type">Person</span> &#123;firstName = <span class="string">"Michael"</span>, lastName = <span class="string">"Diamond"</span>, age = <span class="number">43</span>&#125;</span><br><span class="line"><span class="type">True</span></span><br></pre></td></tr></table></figure></p><p>ç”±äº <code>Person</code> ç±»å‹ç°åœ¨æ˜¯ <code>Eq</code> typeclass çš„å®ä¾‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å…¶ä¼ ç»™ç±»å‹çº¦æŸæ˜¯ <code>Eq a</code> çš„å‡½æ•°ï¼Œæ¯”å¦‚ <code>elem</code>ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> beastieBoys = [mca, adRock, mikeD]</span><br><span class="line"><span class="type">Prelude</span>&gt; mikeD `elem` beastieBoys</span><br><span class="line"><span class="type">True</span></span><br></pre></td></tr></table></figure></p><p><code>Show</code> å’Œ <code>Read</code> typeclass ä¸ç±»å‹å€¼çš„å­—ç¬¦ä¸²è½¬æ¢æœ‰å…³ã€‚<code>Show</code> è¡¨ç¤ºå°†ç±»å‹å€¼è½¬æ¢ä¸º Stringï¼Œ<code>Read</code> åˆ™è¡¨ç¤ºå°† String è½¬æ¢ä¸ºç‰¹å®šç±»å‹çš„å€¼ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :&#123;</span><br><span class="line"><span class="type">Prelude</span>| <span class="class"><span class="keyword">data</span> <span class="type">Person</span> = <span class="type">Person</span> &#123; <span class="title">firstName</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class"><span class="type">Prelude</span>|                      , <span class="title">lastName</span> :: <span class="type">String</span></span></span><br><span class="line"><span class="class"><span class="type">Prelude</span>|                      , <span class="title">age</span> :: <span class="type">Int</span></span></span><br><span class="line"><span class="class"><span class="type">Prelude</span>|                      &#125; <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Show</span>, <span class="type">Read</span>)</span></span><br><span class="line"><span class="type">Prelude</span>| :&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> mikeD = <span class="type">Person</span> &#123;firstName = <span class="string">"Michael"</span>, lastName = <span class="string">"Diamond"</span>, age = <span class="number">43</span>&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; mikeD</span><br><span class="line"><span class="type">Person</span> &#123;firstName = <span class="string">"Michael"</span>, lastName = <span class="string">"Diamond"</span>, age = <span class="number">43</span>&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="string">"mikeD is: "</span> ++ show mikeD</span><br><span class="line"><span class="string">"mikeD is: Person &#123;firstName = \"Michael\", lastName = \"Diamond\", age = 43&#125;"</span></span><br><span class="line"><span class="type">Prelude</span>&gt; read <span class="string">"Person &#123;firstName =\"Michael\", lastName =\"Diamond\", age = 43&#125;"</span> :: <span class="type">Person</span></span><br><span class="line"><span class="type">Person</span> &#123;firstName = <span class="string">"Michael"</span>, lastName = <span class="string">"Diamond"</span>, age = <span class="number">43</span>&#125;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºå®ç°äº† <code>Ord</code> typeclass çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® value constructor ä¸­å€¼å‡ºç°çš„é¡ºåºæ¯”è¾ƒåŒä¸€ç±»å‹ä¸åŒå€¼çš„å¤§å°ã€‚value constructor ä¸­å·¦ä¾§çš„å€¼æ€»å°äºå³ä¾§çš„å€¼ã€‚å†…ç½®çš„ Bool ç±»å‹å¯ä»¥å¤§æ¦‚è§†ä½œæœ‰å¦‚ä¸‹å®ç°ï¼š<br><code>data Bool = False | True deriving (Ord)</code><br>åˆ™åœ¨æ¯”è¾ƒ <code>False</code> å’Œ <code>True</code> æ—¶ï¼Œ<code>False</code> æ€»å°äº <code>True</code>ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="type">False</span> &lt; <span class="type">True</span></span><br><span class="line"><span class="type">True</span></span><br></pre></td></tr></table></figure></p><p>å€ŸåŠ© <code>Enum</code> å’Œ <code>Bounded</code> typeclassï¼Œå¯ä»¥å¾ˆè½»æ¾åœ°å®ç°æšä¸¾ç±»å‹çš„ ADTã€‚æ¯”å¦‚ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Day</span> = <span class="type">Monday</span> | <span class="type">Tuesday</span> | <span class="type">Wednesday</span> | <span class="type">Thursday</span> | <span class="type">Friday</span> | <span class="type">Saturday</span> | <span class="type">Sunday</span></span></span><br><span class="line">           <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>, <span class="type">Show</span>, <span class="type">Read</span>, <span class="type">Bounded</span>, <span class="type">Enum</span>)</span><br></pre></td></tr></table></figure></p><p>ç”±äº <code>Day</code> ç±»å‹å®ç°äº† <code>Show</code> å’Œ <code>Read</code> typeclassï¼Œåˆ™å¯ä»¥åœ¨æ­¤ç±»å‹ä¸å­—ç¬¦ä¸²ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Wednesday</span></span><br><span class="line"><span class="type">Wednesday</span></span><br><span class="line"><span class="type">Prelude</span>&gt; show <span class="type">Wednesday</span></span><br><span class="line"><span class="string">"Wednesday"</span></span><br><span class="line"><span class="type">Prelude</span>&gt; read <span class="string">"Saturday"</span> :: <span class="type">Day</span></span><br><span class="line"><span class="type">Saturday</span></span><br></pre></td></tr></table></figure></p><p>åˆç”±äº <code>Day</code> ç±»å‹å®ç°äº† <code>Eq</code> å’Œ <code>Ord</code> typeclassï¼Œåˆ™å¯ä»¥åœ¨ <code>Day</code> ç±»å‹çš„å€¼ä¹‹é—´è¿›è¡Œæ¯”è¾ƒï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Saturday</span> == <span class="type">Sunday</span></span><br><span class="line"><span class="type">False</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Saturday</span> == <span class="type">Saturday</span></span><br><span class="line"><span class="type">True</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Saturday</span> &gt; <span class="type">Friday</span></span><br><span class="line"><span class="type">True</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="type">Monday</span> `compare` <span class="type">Wednesday</span></span><br><span class="line"><span class="type">LT</span></span><br></pre></td></tr></table></figure></p><p>åˆç”±äº <code>Day</code> ç±»å‹å®ç°äº† <code>Bounded</code> typeclassï¼Œæˆ‘ä»¬å¯ä»¥è·å–â€œæœ€ä½â€å’Œæœ€é«˜çš„ <code>Day</code> ç±»å‹å€¼ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; minBound :: <span class="type">Day</span></span><br><span class="line"><span class="type">Monday</span></span><br><span class="line"><span class="type">Prelude</span>&gt; maxBound :: <span class="type">Day</span></span><br><span class="line"><span class="type">Sunday</span></span><br></pre></td></tr></table></figure></p><p>åˆç”±äº <code>Day</code> ç±»å‹å®ç°äº† <code>Enum</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œåºåˆ—ç±»å‹çš„æ“ä½œï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; succ <span class="type">Monday</span></span><br><span class="line"><span class="type">Tuesday</span></span><br><span class="line"><span class="type">Prelude</span>&gt; pred <span class="type">Saturday</span></span><br><span class="line"><span class="type">Friday</span></span><br><span class="line"><span class="type">Prelude</span>&gt; [<span class="type">Thursday</span> .. <span class="type">Sunday</span>]</span><br><span class="line">[<span class="type">Thursday</span>,<span class="type">Friday</span>,<span class="type">Saturday</span>,<span class="type">Sunday</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; [minBound .. maxBound] :: [<span class="type">Day</span>]</span><br><span class="line">[<span class="type">Monday</span>,<span class="type">Tuesday</span>,<span class="type">Wednesday</span>,<span class="type">Thursday</span>,<span class="type">Friday</span>,<span class="type">Saturday</span>,<span class="type">Sunday</span>]</span><br></pre></td></tr></table></figure></p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="http://learnyouahaskell.com/" target="_blank" rel="noopener">Learn You a Haskell for Great Good!</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ADT-Algebraic-data-types&quot;&gt;&lt;a href=&quot;#ADT-Algebraic-data-types&quot; class=&quot;headerlink&quot; title=&quot;ADT (Algebraic data types)&quot;&gt;&lt;/a&gt;ADT (Algebra
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Functional" scheme="https://rollingstarky.github.io/tags/Functional/"/>
    
      <category term="Haskell" scheme="https://rollingstarky.github.io/tags/Haskell/"/>
    
      <category term="Type" scheme="https://rollingstarky.github.io/tags/Type/"/>
    
      <category term="Typeclass" scheme="https://rollingstarky.github.io/tags/Typeclass/"/>
    
      <category term="ADT" scheme="https://rollingstarky.github.io/tags/ADT/"/>
    
  </entry>
  
  <entry>
    <title>Haskell åŸºæœ¬è¯­æ³•ï¼ˆå››ï¼‰é«˜é˜¶å‡½æ•°</title>
    <link href="https://rollingstarky.github.io/2021/06/30/basic-haskell-high-order-function/"/>
    <id>https://rollingstarky.github.io/2021/06/30/basic-haskell-high-order-function/</id>
    <published>2021-06-29T16:00:00.000Z</published>
    <updated>2021-06-30T12:33:08.138Z</updated>
    
    <content type="html"><![CDATA[<p>Haskell ä¸­çš„å‡½æ•°å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æˆ–è¿”å›å€¼ï¼Œè¿™ç±»å‡½æ•°å«åš<strong>é«˜é˜¶å‡½æ•°ï¼ˆhigh order functionsï¼‰</strong>ã€‚<br>æƒ³è¦é€šè¿‡<strong>å®šä¹‰æ˜¯ä»€ä¹ˆ</strong>è€Œä¸æ˜¯<strong>å®šä¹‰ä¸€ç³»åˆ—å¯ä»¥æ”¹å˜ç¨‹åºçŠ¶æ€çš„æ­¥éª¤</strong>æ¥å®Œæˆè®¡ç®—è¿‡ç¨‹ï¼Œé«˜é˜¶å‡½æ•°æ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p><h4 id="Curried-functions"><a href="#Curried-functions" class="headerlink" title="Curried functions"></a>Curried functions</h4><p><strong>Haskell ä¸­çš„å‡½æ•°å®é™…ä¸Šéƒ½åªæ¥æ”¶ä¸€ä¸ªå‚æ•°</strong>ã€‚å‰é¢é‡åˆ°çš„æ¥æ”¶å¤šä¸ªå‚æ•°çš„å‡½æ•°æ˜¯ä¸€ç§ <strong>Curried functions</strong>ï¼Œå¯ä»¥çœ‹ä½œæŸç§ç‰¹æ®Šå½¢å¼ã€‚<br>æ¯”å¦‚ <code>max 4 5</code>ï¼Œçœ‹ä¸Šå»æ˜¯å‘å‡½æ•° <code>max</code> ä¼ å…¥ä¸¤ä¸ªå‚æ•° <code>4</code> å’Œ <code>5</code>ï¼Œè¿”å›æ•°å€¼è¾ƒå¤§çš„ <code>5</code>ã€‚å®é™…çš„è®¡ç®—è¿‡ç¨‹æ˜¯ <code>(max 4) 5</code>ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; max <span class="number">4</span> <span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="type">Prelude</span>&gt; (max <span class="number">4</span>) <span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></p><p>é¦–å…ˆå°†å‚æ•° <code>4</code> ä¼ é€’ç»™å‡½æ•° <code>max</code>ï¼Œ<strong>ä¼šè¿”å›å¦ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä»»æ„ä¸€ä¸ªå‚æ•°ï¼Œå°†è¯¥å‚æ•°ä¸æ•°å­— 4 æ¯”è¾ƒï¼Œè¿”å›è¾ƒå¤§çš„æ•°</strong>ã€‚æ‰€ä»¥åé¢å°† <code>5</code> ä¼ ç»™å‡½æ•° <code>(max 4)</code> åï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»“æœ <code>5</code>ã€‚<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> maxWithFour = max <span class="number">4</span></span><br><span class="line"><span class="type">Prelude</span>&gt; maxWithFour <span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆè¿™ç§å½¢å¼çš„å‡½æ•°ç©¶ç«Ÿæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ</p><p>å½“æˆ‘ä»¬ä½¿ç”¨éƒ¨åˆ†å‚æ•°è°ƒç”¨æŸä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šç›´æ¥å¾—åˆ°ç»“æœï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª<strong>éƒ¨åˆ†åº”ç”¨ï¼ˆpartially appliedï¼‰</strong>çš„å‡½æ•°ã€‚è¿™ä¸ªéƒ¨åˆ†åº”ç”¨çš„å‡½æ•°å¯ä»¥ç»§ç»­æ¥æ”¶å‰©ä½™çš„å‚æ•°ï¼Œæœ€ç»ˆå¾—åˆ°è®¡ç®—ç»“æœã€‚</p><p>partially applied æœºåˆ¶å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬ç®€å•åœ°å®ç°åŠ¨æ€åœ°åˆ›å»ºå‡½æ•°ã€å°†å‡½æ•°ä½œä¸ºå‚æ•°ä¼ å…¥ã€ç”¨ç‰¹å®šæ•°æ®åˆå§‹åŒ–å‡½æ•°ç­‰éœ€æ±‚ã€‚</p><p>å¯¹äºå‡½æ•° <code>multThree</code>ï¼š<br><code>let multThree x y z = x * y * z</code><br>å®ƒå¯ä»¥æ¥æ”¶ä¸‰ä¸ªæ•°å­—ä½œä¸ºå‚æ•°ï¼Œå¹¶è®¡ç®—è¿™ä¸‰ä¸ªå‚æ•°çš„ä¹˜ç§¯ä½œä¸ºè¿”å›å€¼ã€‚</p><p>å¦‚ <code>multThree 3 5 9</code>ï¼Œå®é™…ä¸Šçš„æ‰§è¡Œæµç¨‹ä¸º <code>((multThree 3) 5) 9</code>ã€‚</p><ul><li>å°†æ•°å­— 3 ä¼ é€’ç»™ <code>multThree</code>ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå‡½æ•° <code>(multThree 3)</code>ã€‚è¯¥å‡½æ•°æ¥æ”¶ä»»æ„ä¸¤ä¸ªæ•°å­—ï¼Œå¹¶è®¡ç®—å®ƒä»¬å’Œ 3 çš„ä¹˜ç§¯</li><li>å°†æ•°å­— 5 ä¼ é€’ç»™ <code>(multThree 3)</code>ï¼Œè¿”å›å¦ä¸€ä¸ªå‡½æ•° <code>((multThree 3) 5)</code>ã€‚è¯¥å‡½æ•°æ¥æ”¶ä»»æ„ä¸€ä¸ªæ•°å­—ï¼Œå¹¶è®¡ç®—å®ƒå’Œ 15 çš„ä¹˜ç§¯</li><li>å°†æ•°å­— 9 ä¼ é€’ç»™ <code>((multThree 3) 5)</code>ï¼Œè¿”å› 9 å’Œ 15 çš„ä¹˜ç§¯ä½œä¸ºç»“æœ</li></ul><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> multThreeNums x y z = x * y * z</span><br><span class="line"><span class="type">Prelude</span>&gt; multThreeNums <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> multTwoNumsWithNine = multThreeNums <span class="number">9</span></span><br><span class="line"><span class="type">Prelude</span>&gt; multTwoNumsWithNine <span class="number">2</span> <span class="number">3</span></span><br><span class="line"><span class="number">54</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> multOneNumWithEighteen = multTwoNumsWithNine <span class="number">2</span></span><br><span class="line"><span class="type">Prelude</span>&gt; multOneNumWithEighteen <span class="number">10</span></span><br><span class="line"><span class="number">180</span></span><br></pre></td></tr></table></figure><p>ä¸­ç¼€å‡½æ•°å¦‚ <code>+ - * /</code> ç­‰ä¹Ÿå¯ä»¥ partially appliedã€‚</p><p>æ¯”å¦‚å¯ä»¥å°†æ•°å­— 5 ä¼ é€’ç»™ä¸­ç¼€å‡½æ•° <code>+</code> ç”Ÿæˆä¸€ä¸ªæ–°çš„å‡½æ•° <code>(5+)</code>ï¼Œè€Œæ–°å‡½æ•° <code>(5+)</code> å¯ä»¥æ¥æ”¶ä¸€ä¸ªæ•°å­—ä½œä¸ºå‚æ•°ï¼Œè¿”å›è¯¥å‚æ•°ä¸ 5 çš„å’Œã€‚<br>å³å‡½æ•° <code>(5+)</code> å…¶å®æ˜¯ä¸­ç¼€å‡½æ•° <code>+</code> å›ºå®šä¸€ä¸ªå‚æ•° 5 ä¹‹åç”Ÿæˆçš„æ–°å‡½æ•°ï¼Œè¿™ä¸ªæ–°å‡½æ•°æ¥æ”¶ä»»ä½•ä¸€ä¸ªæ•°å­—ä½œä¸ºå¦ä¸€ä¸ªåŠ æ•°å¹¶æ±‚å’Œã€‚</p><p>ä½¿ç”¨ <code>/</code> å›ºå®šé™¤æ•°ç”Ÿæˆæ–°å‡½æ•° <code>divideByTen</code>ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> divideByTen = (/<span class="number">10</span>)</span><br><span class="line"><span class="type">Prelude</span>&gt; divideByTen <span class="number">200</span></span><br><span class="line"><span class="number">20.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; (/<span class="number">10</span>) <span class="number">200</span></span><br><span class="line"><span class="number">20.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="number">200</span> / <span class="number">10</span></span><br><span class="line"><span class="number">20.0</span></span><br></pre></td></tr></table></figure></p><p><code>divideByTen 200</code> ç­‰åŒäº <code>(/10) 200</code> ç­‰åŒäº <code>200 / 10</code>ã€‚</p><p>åŒæ ·çš„æ–¹å¼è¿˜å¯ä»¥å®šä¹‰ <code>divideTen</code> å›ºå®šè¢«é™¤æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> divideTen = (<span class="number">10</span>/)</span><br><span class="line"><span class="type">Prelude</span>&gt; divideTen <span class="number">2</span></span><br><span class="line"><span class="number">5.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; (<span class="number">10</span>/) <span class="number">2</span></span><br><span class="line"><span class="number">5.0</span></span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="number">10</span> / <span class="number">2</span></span><br><span class="line"><span class="number">5.0</span></span><br></pre></td></tr></table></figure></p><p>æ£€æŸ¥è¾“å…¥çš„å­—ç¬¦æ˜¯å¦æ˜¯å¤§å†™å­—æ¯ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> isUpperAlphanum = (`elem` ['<span class="type">A'</span>..'<span class="type">Z'</span>])</span><br><span class="line"><span class="type">Prelude</span>&gt; isUpperAlphanum '<span class="type">D'</span></span><br><span class="line"><span class="type">True</span></span><br><span class="line"><span class="type">Prelude</span>&gt; isUpperAlphanum 'a'</span><br><span class="line"><span class="type">False</span></span><br></pre></td></tr></table></figure></p><h4 id="å‡½æ•°ä½œä¸ºå‚æ•°"><a href="#å‡½æ•°ä½œä¸ºå‚æ•°" class="headerlink" title="å‡½æ•°ä½œä¸ºå‚æ•°"></a>å‡½æ•°ä½œä¸ºå‚æ•°</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> applyTwice f x = f (f x)</span><br><span class="line"><span class="type">Prelude</span>&gt; applyTwice (+<span class="number">3</span>) <span class="number">10</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="type">Prelude</span>&gt; applyTwice (++ <span class="string">" HAHA"</span>) <span class="string">"HEY"</span></span><br><span class="line"><span class="string">"HEY HAHA HAHA"</span></span><br><span class="line"><span class="type">Prelude</span>&gt; applyTwice (<span class="string">"HAHA "</span> ++) <span class="string">"HEY"</span></span><br><span class="line"><span class="string">"HAHA HAHA HEY"</span></span><br><span class="line"><span class="type">Prelude</span>&gt; applyTwice (<span class="number">3</span>:) [<span class="number">1</span>]</span><br><span class="line">[<span class="number">3</span>,<span class="number">3</span>,<span class="number">1</span>]</span><br></pre></td></tr></table></figure><h5 id="zipWith-çš„è‡ªå®šä¹‰å®ç°"><a href="#zipWith-çš„è‡ªå®šä¹‰å®ç°" class="headerlink" title="zipWith çš„è‡ªå®šä¹‰å®ç°"></a>zipWith çš„è‡ªå®šä¹‰å®ç°</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">zipWith'</span> :: (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]</span><br><span class="line"><span class="title">zipWith'</span> _ [] _ = []</span><br><span class="line"><span class="title">zipWith'</span> _ _ [] = []</span><br><span class="line"><span class="title">zipWith'</span> f (x:xs) (y:ys) = f x y : zipWith' f xs ys</span><br></pre></td></tr></table></figure><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :&#123;</span><br><span class="line"><span class="type">Prelude</span>| zipWith' :: (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]</span><br><span class="line"><span class="title">ith'</span> f <span class="type">Prelude</span>| zipWith' _ [] _ = []</span><br><span class="line"><span class="type">Prelude</span>| zipWith' _ _ [] = []</span><br><span class="line"><span class="type">Prelude</span>| zipWith' f (x:xs) (y:ys) = f x y : zipWith' f xs ys</span><br><span class="line"><span class="type">Prelude</span>| :&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt;</span><br><span class="line"><span class="type">Prelude</span>&gt; zipWith' (+) [<span class="number">4</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span>] [<span class="number">2</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">[<span class="number">6</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">9</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; zipWith' (++) [<span class="string">"foo "</span>, <span class="string">"bar "</span>, <span class="string">"baz "</span>] [<span class="string">"fighters"</span>, <span class="string">"hoppers"</span>, <span class="string">"aldrin"</span>]</span><br><span class="line">[<span class="string">"foo fighters"</span>,<span class="string">"bar hoppers"</span>,<span class="string">"baz aldrin"</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; zipWith' (*) (replicate <span class="number">5</span> <span class="number">2</span>) [<span class="number">1.</span>.]</span><br><span class="line">[<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br></pre></td></tr></table></figure><h5 id="flip-çš„è‡ªå®šä¹‰å®ç°"><a href="#flip-çš„è‡ªå®šä¹‰å®ç°" class="headerlink" title="flip çš„è‡ªå®šä¹‰å®ç°"></a>flip çš„è‡ªå®šä¹‰å®ç°</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">flip'</span> :: (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c</span><br><span class="line"><span class="title">flip'</span> f y x = f x y</span><br></pre></td></tr></table></figure><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :&#123;</span><br><span class="line"><span class="type">Prelude</span>| flip' :: (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c</span><br><span class="line"><span class="type">Prelude</span>| flip' f y x = f x y</span><br><span class="line"><span class="type">Prelude</span>| :&#125;</span><br><span class="line"><span class="type">Prelude</span>&gt;</span><br><span class="line"><span class="type">Prelude</span>&gt; flip' zip [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>] <span class="string">"hello"</span></span><br><span class="line">[('h',<span class="number">1</span>),('e',<span class="number">2</span>),('l',<span class="number">3</span>),('l',<span class="number">4</span>),('o',<span class="number">5</span>)]</span><br><span class="line"><span class="type">Prelude</span>&gt; zipWith (flip' div) [<span class="number">2</span>,<span class="number">2.</span>.] [<span class="number">10</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">2</span>]</span><br><span class="line">[<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br></pre></td></tr></table></figure><h4 id="Maps-amp-Filters"><a href="#Maps-amp-Filters" class="headerlink" title="Maps &amp; Filters"></a>Maps &amp; Filters</h4><p><code>map</code> æ¥æ”¶ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªåˆ—è¡¨ä½œä¸ºå‚æ•°ï¼Œå¯ä»¥å°†å‡½æ•°åº”ç”¨åˆ°åˆ—è¡¨çš„æ¯ä¸€é¡¹å…ƒç´ ä¸Šã€‚</p><p><code>map</code> å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">map</span> :: (a -&gt; b) -&gt; [a] -&gt; [b]  </span><br><span class="line"><span class="title">map</span> _ [] = []  </span><br><span class="line"><span class="title">map</span> f (x:xs) = f x : map f xs</span><br></pre></td></tr></table></figure></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; map (+<span class="number">3</span>) [<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">6</span>]</span><br><span class="line">[<span class="number">4</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">9</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; map (++ <span class="string">"!"</span>) [<span class="string">"BIFF"</span>, <span class="string">"BANG"</span>, <span class="string">"POW"</span>]</span><br><span class="line">[<span class="string">"BIFF!"</span>,<span class="string">"BANG!"</span>,<span class="string">"POW!"</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; map (replicate <span class="number">3</span>) [<span class="number">3.</span><span class="number">.6</span>]</span><br><span class="line">[[<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>],[<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>],[<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>],[<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>]]</span><br><span class="line"><span class="type">Prelude</span>&gt; map (map (^<span class="number">2</span>)) [[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],[<span class="number">7</span>,<span class="number">8</span>]]</span><br><span class="line">[[<span class="number">1</span>,<span class="number">4</span>],[<span class="number">9</span>,<span class="number">16</span>,<span class="number">25</span>,<span class="number">36</span>],[<span class="number">49</span>,<span class="number">64</span>]]</span><br><span class="line"><span class="type">Prelude</span>&gt; map fst [(<span class="number">1</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">3</span>),(<span class="number">2</span>,<span class="number">6</span>),(<span class="number">2</span>,<span class="number">5</span>)]</span><br><span class="line">[<span class="number">1</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p><code>filter</code> æ¥æ”¶ä¸€ä¸ªåˆ¤æ–­å‡½æ•°å’Œä¸€ä¸ªåˆ—è¡¨ä½œä¸ºå‚æ•°ï¼Œè¿”å›åˆ—è¡¨ä¸­æ‰€æœ‰ä½¿åˆ¤æ–­å‡½æ•°ä¸ºçœŸçš„å…ƒç´ ã€‚</p><p><code>filter</code> å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">filter</span> :: (a -&gt; <span class="type">Bool</span>) -&gt; [a] -&gt; [a]</span><br><span class="line"><span class="title">filter</span> _ [] = []</span><br><span class="line"><span class="title">filter</span> p (x:xs)</span><br><span class="line">    | p x       = x : filter p xs</span><br><span class="line">    | otherwise = filter p xs</span><br></pre></td></tr></table></figure></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; filter (&gt;<span class="number">3</span>) [<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">[<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; filter (==<span class="number">3</span>) [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">[<span class="number">3</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; filter even [<span class="number">1.</span><span class="number">.10</span>]</span><br><span class="line">[<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> notNull x = not (null x) <span class="keyword">in</span> filter notNull [[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[],[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>],[<span class="number">2</span>,<span class="number">2</span>],[],[],[]]</span><br><span class="line">[[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>],[<span class="number">2</span>,<span class="number">2</span>]]</span><br><span class="line"><span class="type">Prelude</span>&gt; filter (`elem` ['a'..'z']) <span class="string">"u LaUgH aT mE BeCaUsE I aM diFfeRent"</span></span><br><span class="line"><span class="string">"uagameasadifeent"</span></span><br><span class="line"><span class="type">Prelude</span>&gt; filter (`elem` ['<span class="type">A'</span>..'<span class="type">Z'</span>]) <span class="string">"i lauGh At You BecAuse u r aLL the Same"</span></span><br><span class="line"><span class="string">"GAYBALLS"</span></span><br></pre></td></tr></table></figure><p>å€ŸåŠ© filter å®ç° quicksortï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">quicksort</span> :: (<span class="type">Ord</span> a) =&gt; [a] -&gt; [a]</span><br><span class="line"><span class="title">quicksort</span> [] = []</span><br><span class="line"><span class="title">quicksort</span> (x:xs) =</span><br><span class="line">    <span class="keyword">let</span> smallerSorted = quicksort (filter (&lt;=x) xs)</span><br><span class="line">        biggerSorted = quicksort (filter (&gt;x) xs)</span><br><span class="line">    <span class="keyword">in</span>  smallerSorted ++ [x] ++ biggerSorted</span><br></pre></td></tr></table></figure></p><p>æ‰¾å‡º 100000 ä»¥å†…èƒ½å¤Ÿè¢« 3829 æ•´é™¤çš„æœ€å¤§çš„æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">largestDivisible</span> :: (<span class="type">Integral</span> a) =&gt; a</span><br><span class="line"><span class="title">largestDivisible</span> = head (filter p [<span class="number">100000</span>,<span class="number">99999.</span>.])</span><br><span class="line">    <span class="keyword">where</span> p x = x `mod` <span class="number">3829</span> == <span class="number">0</span></span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>p x = x `mod` 3829 == 0</code> å®šä¹‰äº†å‡½æ•° <code>p</code> ä½œä¸º <code>filter</code> çš„åˆ¤æ–­å‡½æ•°ï¼Œè€Œåˆ—è¡¨ <code>[100000, 99999..]</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ªé€†åºçš„æ— ç©·åˆ—è¡¨ã€‚<br>å€ŸåŠ© Haskell çš„<strong>æƒ°æ€§è®¡ç®—</strong>æœºåˆ¶ï¼Œå‡½æ•°è·å–çš„æ˜¯æœ€å¤§çš„å¯è¢«æ•´é™¤çš„æ•°ï¼Œè·å¾—è¯¥å€¼åå°±ä¸ä¼šå†ç»§ç»­è®¡ç®—ä¸‹å»ã€‚</p><p>å®é™…ä¸Šè¿˜å¯ä»¥è¿™æ ·ä½¿ç”¨ <code>map</code> å‡½æ•°ï¼š<br><code>map (*) [0..]</code><br>å°†å‡½æ•° <code>*</code> æ˜ å°„åˆ°åˆ—è¡¨ <code>[0..]</code>ï¼Œä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—å‡½æ•°çš„æ–°åˆ—è¡¨ã€‚æ–°åˆ—è¡¨çš„å½¢å¼ç±»ä¼¼ <code>[(0*),(1*),(2*),(3*),(4*),(5*)..]</code>ã€‚<br>å…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå‡½æ•°å¦‚ <code>(4*)</code>ï¼Œéƒ½æ˜¯æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„å‡½æ•° <code>*</code> å›ºå®šäº†ä¸€ä¸ªå‚æ•°åçš„å½¢å¼ï¼Œå†å‘å…¶ä¼ å…¥ä¸€ä¸ªå‚æ•°å³å¯å®Œæˆä¹˜æ³•è¿ç®—ã€‚</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> listOfFuns = map (*) [<span class="number">0.</span>.]</span><br><span class="line"><span class="type">Prelude</span>&gt; (listOfFuns !! <span class="number">4</span>) <span class="number">5</span></span><br><span class="line"><span class="number">20</span></span><br></pre></td></tr></table></figure><p><code>!!</code> å‡½æ•°å¯ä»¥ä»æŒ‡å®šåˆ—è¡¨ä¸­æ ¹æ®ç´¢å¼•å€¼è·å–ç‰¹å®šçš„å…ƒç´ ã€‚<code>(listOfFuns !! 4)</code> å³ä¸º <code>(4*)</code>ã€‚</p><h4 id="Lambdas"><a href="#Lambdas" class="headerlink" title="Lambdas"></a>Lambdas</h4><p>Lambda åŸºæœ¬ä¸Šæ˜¯ä»£ç ä¸­åªä½¿ç”¨ä¸€æ¬¡çš„åŒ¿åå‡½æ•°ã€‚<br>ç”± <code>\</code> åæ–œæ ç¬¦å·æŒ‡å®šå‚æ•°ï¼Œ<code>-&gt;</code> ç¬¦å·æŒ‡å®šå‡½æ•°ä½“ã€‚</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; zipWith (\a b -&gt; a * b - <span class="number">1</span>) [<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>] [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">[<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>å’Œé€šå¸¸çš„å‡½æ•°ç±»ä¼¼ï¼Œlambda ä¸­ä¹Ÿå¯ä»¥åº”ç”¨æ¨¡å¼åŒ¹é…ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; map (\(a,b) -&gt; a + b) [(<span class="number">1</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">3</span>),(<span class="number">2</span>,<span class="number">6</span>),(<span class="number">2</span>,<span class="number">5</span>)]</span><br><span class="line">[<span class="number">3</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">7</span>]</span><br></pre></td></tr></table></figure></p><p>ä¸åŒçš„æ˜¯ï¼Œlambda ä¸æ”¯æŒå¯¹åŒä¸€ä¸ªå‚æ•°å®šä¹‰å¤šä¸ªæ¨¡å¼ã€‚</p><h4 id="Fold"><a href="#Fold" class="headerlink" title="Fold"></a>Fold</h4><p>Fold æœ‰ç‚¹ç±»ä¼¼äº <code>map</code> å‡½æ•°ï¼Œåªä¸è¿‡ fold æ“ä½œæœ€ç»ˆä¼šå°†åˆ—è¡¨ä¸­çš„å…ƒç´ å½’å¹¶ï¼ˆ<strong>reduce</strong>ï¼‰åˆ°å•ä¸ªå€¼ã€‚</p><p>Fold å‡½æ•°æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>binary functionï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°</li><li>åˆå§‹å€¼ï¼šç§°ä½œç´¯åŠ å™¨ï¼ˆaccumulatorï¼‰</li><li>éœ€è¦è¢«æŠ˜å çš„åˆ—è¡¨</li></ul><p>é¦–å…ˆæ˜¯ binary function æ¥æ”¶ accumulator å’Œåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºå‚æ•°ï¼Œæ‰§è¡Œç‰¹å®šçš„è®¡ç®—åè¿”å›ä¸€ä¸ªæ–°çš„ accumulatorï¼›<br>binary function ç»§ç»­æ¥æ”¶åˆšè¿”å›çš„æ–° accumulator å’Œåˆ—è¡¨ä¸­å‰©ä½™å…ƒç´ ä¸­çš„ç¬¬ä¸€ä¸ªä½œä¸ºå‚æ•°ï¼Œæ‰§è¡Œè®¡ç®—å¹¶è¿”å›æ–°çš„ accumulatorï¼›<br>è‹¥å¹²æ¬¡å¾ªç¯è¿‡åï¼Œåˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ è¢«ä¼ å…¥ binary functionï¼Œè¿”å›çš„ accumulator å³ä¸ºæ•´ä¸ªåˆ—è¡¨å½’å¹¶ï¼ˆæŠ˜å ï¼‰åçš„æœ€ç»ˆç»“æœã€‚</p><h5 id="å·¦æŠ˜å -foldl"><a href="#å·¦æŠ˜å -foldl" class="headerlink" title="å·¦æŠ˜å  foldl"></a>å·¦æŠ˜å  <code>foldl</code></h5><p>è¿ç”¨å·¦æŠ˜å ï¼ˆä»å·¦ä¾§å¼€å§‹æŠ˜å ï¼‰å®ç°è‡ªå®šä¹‰çš„ <code>sum</code> å‡½æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> sum' xs = foldl (\acc x -&gt; acc + x) <span class="number">0</span> xs</span><br><span class="line"><span class="type">Prelude</span>&gt; sum' [<span class="number">3</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure></p><p>å¯¹åº”åˆ°å‰é¢æåˆ°çš„æ¦‚å¿µï¼Œlambda å‡½æ•° <code>(\acc x -&gt; acc + x)</code> å³ä¸º binary functionï¼Œ<code>0</code> æ˜¯åˆå§‹å€¼ï¼ˆaccumulatorï¼‰ï¼Œ<code>xs</code> ä¸ºä¼ å…¥çš„å¾…æŠ˜å åˆ—è¡¨ã€‚</p><p>å€ŸåŠ© curried functionï¼Œç”šè‡³å¯ä»¥å†™å‡ºæ›´ç®€å•çš„å½¢å¼ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">let</span> sum' = foldl (+) <span class="number">0</span></span><br></pre></td></tr></table></figure></p><p>lambda å‡½æ•° <code>(\acc x -&gt; acc + x)</code> å®é™…ä¸Šç­‰æ•ˆäº <code>(+)</code>ã€‚<br>å¯¹äº <code>xs</code> å‚æ•°çš„åŒ–ç®€ï¼ŒåŸå› æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œè‹¥å‡½æ•°å…·æœ‰ <code>foo a = bar b a</code> è¿™æ ·çš„å½¢å¼ï¼Œåˆ™è¯¥å‡½æ•°å¯ä»¥ç®€åŒ–ä¸º <code>foo = bar b</code>ã€‚</p><p>è¿ç”¨å·¦æŠ˜å å®ç°è‡ªå®šä¹‰çš„ <code>elem</code> å‡½æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> elem' y ys = foldl (\acc x -&gt; <span class="keyword">if</span> x == y <span class="keyword">then</span> <span class="type">True</span> <span class="keyword">else</span> acc) <span class="type">False</span> ys</span><br><span class="line"><span class="type">Prelude</span>&gt; elem' <span class="number">2</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="type">True</span></span><br></pre></td></tr></table></figure></p><h5 id="å³æŠ˜å -foldr"><a href="#å³æŠ˜å -foldr" class="headerlink" title="å³æŠ˜å  foldr"></a>å³æŠ˜å  <code>foldr</code></h5><p>è¿ç”¨å³æŠ˜å ï¼ˆä»å³ä¾§å¼€å§‹æŠ˜å ï¼‰å®ç°è‡ªå®šä¹‰çš„ <code>map</code> å‡½æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; <span class="keyword">let</span> map' f xs = foldr (\x acc -&gt; f x : acc) [] xs</span><br><span class="line"><span class="type">Prelude</span>&gt; map' (+<span class="number">3</span>) [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br></pre></td></tr></table></figure></p><p>æ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªæŠ˜å å‡½æ•° <code>foldl1</code> å’Œ <code>foldr1</code>ã€‚å®ƒä»¬ä¸ <code>foldl</code> å’Œ <code>foldr</code> çš„åŠŸèƒ½åŸºæœ¬ç›¸åŒï¼Œåªä¸è¿‡ä¸éœ€è¦æ˜¾å¼åœ°æä¾›åˆå§‹å€¼ã€‚è€Œæ˜¯ä¼šè‡ªåŠ¨åœ°å°†åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå€¼ï¼ˆä¸ç®¡ä»å·¦èµ·è¿˜æ˜¯ä»å³èµ·ï¼‰ä½œä¸ºåˆå§‹å€¼ã€‚</p><p>ä»¥ä¸‹æ˜¯å‡ ä¸ªé€šè¿‡ fold æ“ä½œå®ç°çš„æ ‡å‡†åº“å‡½æ•°ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">maximum'</span> :: (<span class="type">Ord</span> a) =&gt; [a] -&gt; a</span><br><span class="line"><span class="title">maximum'</span> = foldr1 (\x acc -&gt; <span class="keyword">if</span> x &gt; acc <span class="keyword">then</span> x <span class="keyword">else</span> acc)</span><br><span class="line">  </span><br><span class="line"><span class="title">reverse'</span> :: [a] -&gt; [a]</span><br><span class="line"><span class="title">reverse'</span> = foldl (\acc x -&gt; x : acc) []</span><br><span class="line">  </span><br><span class="line"><span class="title">product'</span> :: (<span class="type">Num</span> a) =&gt; [a] -&gt; a</span><br><span class="line"><span class="title">product'</span> = foldr1 (*)</span><br><span class="line">  </span><br><span class="line"><span class="title">filter'</span> :: (a -&gt; <span class="type">Bool</span>) -&gt; [a] -&gt; [a]</span><br><span class="line"><span class="title">filter'</span> p = foldr (\x acc -&gt; <span class="keyword">if</span> p x <span class="keyword">then</span> x : acc <span class="keyword">else</span> acc) []</span><br><span class="line">  </span><br><span class="line"><span class="title">head'</span> :: [a] -&gt; a</span><br><span class="line"><span class="title">head'</span> = foldr1 (\x _ -&gt; x)</span><br><span class="line">  </span><br><span class="line"><span class="title">last'</span> :: [a] -&gt; a</span><br><span class="line"><span class="title">last'</span> = foldl1 (\_ x -&gt; x)</span><br></pre></td></tr></table></figure></p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="http://learnyouahaskell.com/" target="_blank" rel="noopener">Learn You a Haskell for Great Good!</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Haskell ä¸­çš„å‡½æ•°å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æˆ–è¿”å›å€¼ï¼Œè¿™ç±»å‡½æ•°å«åš&lt;strong&gt;é«˜é˜¶å‡½æ•°ï¼ˆhigh order functionsï¼‰&lt;/strong&gt;ã€‚&lt;br&gt;æƒ³è¦é€šè¿‡&lt;strong&gt;å®šä¹‰æ˜¯ä»€ä¹ˆ&lt;/strong&gt;è€Œä¸æ˜¯&lt;strong&gt;å®šä¹‰ä¸€ç³»åˆ—å¯ä»¥æ”¹å˜ç¨‹åºçŠ¶æ€çš„æ­¥éª¤&lt;
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Functional" scheme="https://rollingstarky.github.io/tags/Functional/"/>
    
      <category term="Haskell" scheme="https://rollingstarky.github.io/tags/Haskell/"/>
    
      <category term="Function" scheme="https://rollingstarky.github.io/tags/Function/"/>
    
      <category term="Map" scheme="https://rollingstarky.github.io/tags/Map/"/>
    
      <category term="Reduce" scheme="https://rollingstarky.github.io/tags/Reduce/"/>
    
      <category term="Filter" scheme="https://rollingstarky.github.io/tags/Filter/"/>
    
  </entry>
  
  <entry>
    <title>Haskell åŸºæœ¬è¯­æ³•ï¼ˆä¸‰ï¼‰é€’å½’</title>
    <link href="https://rollingstarky.github.io/2021/06/29/basic-haskell-recursion/"/>
    <id>https://rollingstarky.github.io/2021/06/29/basic-haskell-recursion/</id>
    <published>2021-06-28T16:00:00.000Z</published>
    <updated>2021-06-29T12:12:17.348Z</updated>
    
    <content type="html"><![CDATA[<p>é€’å½’æ˜¯ä¸€ç§å®šä¹‰å‡½æ•°çš„æ–¹å¼ï¼Œåœ¨è¯¥æ–¹å¼ä¸‹ï¼Œå‡½æ•°çš„å®šä¹‰ä¸­è°ƒç”¨äº†è¯¥å‡½æ•°æœ¬èº«ã€‚æœ‰ç‚¹åƒä¿„ç½—æ–¯å¥—å¨ƒã€‚</p><p>æ•°å­¦ä¸­çš„å®šä¹‰å¾ˆå¤šæ—¶å€™éƒ½ä¼šç”¨åˆ°é€’å½’ï¼Œæ¯”å¦‚ fibonacci æ•°åˆ—ï¼š</p><ul><li><code>F(0) = 1</code></li><li><code>F(1) = 1</code></li><li><code>F(n) = F(n - 1) + F(n - 2)</code></li></ul><p>äºæ˜¯æœ‰ <code>F(3) = F(2) + F(1) = (F(1) + F(0)) + F(1) = 2</code>ã€‚</p><p>é€’å½’å‡½æ•°çš„å®šä¹‰ä¸­ï¼Œå¹¶ä¸åªæ˜¯åŒ…å«è°ƒç”¨è‡ªèº«çš„ä»£ç ï¼Œå¸¸å¸¸è¿˜éœ€è¦éé€’å½’å½¢å¼çš„å®šä¹‰ï¼Œå¦‚ä¸Šé¢çš„ <code>F(0) = 1</code> å’Œ <code>F(1) = 1</code>ã€‚è¿™æ ·çš„ä»£ç ç§°ä½œ<strong>è¾¹ç¼˜æ¡ä»¶ï¼ˆedge conditionï¼‰</strong>ã€‚<br>è¾¹ç¼˜æ¡ä»¶å¯¹äºé€’å½’å‡½æ•°çš„ç»ˆæ­¢è‡³å…³é‡è¦ã€‚å‡å¦‚ä¸Šé¢çš„ <code>F(0)</code> å’Œ <code>F(1)</code> æœªå®šä¹‰ï¼Œåˆ™ä»»ä½•ä¸€ä¸ªè¾“å…¥éƒ½ä¼šå¯¼è‡´å‡½æ•°æ— é™è°ƒç”¨è‡ªèº«ï¼Œæ°¸è¿œä¸ä¼šç»ˆæ­¢ã€‚</p><p>é€’å½’æ˜¯ Haskell ä¸­å¾ˆé‡è¦çš„æ¦‚å¿µã€‚ä¸åŒäºå‘½ä»¤å¼çš„è¯­è¨€ï¼Œåœ¨ Haskell ä¸­éœ€è¦<strong>å®šä¹‰è®¡ç®—æœ¬èº«æ˜¯ä»€ä¹ˆ</strong>ï¼Œè€Œä¸æ˜¯<strong>å®šä¹‰æ€æ ·ä¸€æ­¥æ­¥å¾—å‡ºç»“æœ</strong>ã€‚</p><h5 id="æ±‚æœ€å¤§å€¼"><a href="#æ±‚æœ€å¤§å€¼" class="headerlink" title="æ±‚æœ€å¤§å€¼"></a>æ±‚æœ€å¤§å€¼</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">maximum'</span> :: (<span class="type">Ord</span> a) =&gt; [a] -&gt; a</span><br><span class="line"><span class="title">maximum'</span> [] = error <span class="string">"maximum of empty list"</span></span><br><span class="line"><span class="title">maximum'</span> [x] = x</span><br><span class="line"><span class="title">maximum'</span> (x:xs)</span><br><span class="line">    | x &gt; maxTail = x</span><br><span class="line">    | otherwise = maxTail</span><br><span class="line">    <span class="keyword">where</span> maxTail = maximum' xs</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>max</code> å‡½æ•°ï¼ˆè¿”å›ä¸¤ä¸ªè¾“å…¥å€¼ä¸­è¾ƒå¤§çš„é‚£ä¸ªï¼‰ç¼–å†™æ›´çŸ­çš„å½¢å¼ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">maximum'</span> :: (<span class="type">Ord</span> a) =&gt; [a] -&gt; a</span><br><span class="line"><span class="title">maximum'</span> [] = error <span class="string">"maximum of empty list"</span></span><br><span class="line"><span class="title">maximum'</span> [x] = x</span><br><span class="line"><span class="title">maximum'</span> (x:xs) = max x (maximum' xs)</span><br></pre></td></tr></table></figure></p><p>å½“è¾“å…¥ä¸º <code>[2, 5, 1]</code> æ—¶ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š<br><code>maximum&#39; [2, 5, 1]</code> -&gt; <code>max 2 (maximum&#39; [5, 1])</code> -&gt; <code>max 2 (max 5 (maximum&#39; [1]))</code> -&gt; <code>max 2 (max 5 1)</code> -&gt; <code>max 2 5</code> -&gt; <code>5</code>ã€‚</p><h5 id="ç”Ÿæˆç”±å›ºå®šæ•°é‡çš„åŒä¸€å…ƒç´ æ„æˆçš„åˆ—è¡¨"><a href="#ç”Ÿæˆç”±å›ºå®šæ•°é‡çš„åŒä¸€å…ƒç´ æ„æˆçš„åˆ—è¡¨" class="headerlink" title="ç”Ÿæˆç”±å›ºå®šæ•°é‡çš„åŒä¸€å…ƒç´ æ„æˆçš„åˆ—è¡¨"></a>ç”Ÿæˆç”±å›ºå®šæ•°é‡çš„åŒä¸€å…ƒç´ æ„æˆçš„åˆ—è¡¨</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">replicate'</span> :: (<span class="type">Num</span> i, <span class="type">Ord</span> i) =&gt; i -&gt; a -&gt; [a]</span><br><span class="line"><span class="title">replicate'</span> n x</span><br><span class="line">    | n &lt;= <span class="number">0</span>    = []</span><br><span class="line">    | otherwise = x:replicate' (n<span class="number">-1</span>) x</span><br></pre></td></tr></table></figure><p>å¦‚ <code>replicate&#39; 3 5</code> -&gt; <code>5:(replicate&#39; 2 5)</code> -&gt; <code>5:(5:(replicate&#39; 1 5))</code> -&gt; <code>5:(5:(5:(replicate&#39; 0 5)))</code> -&gt; <code>5:(5:(5:[]))</code> -&gt; <code>[5, 5, 5]</code>ã€‚</p><h5 id="å–å‡ºåˆ—è¡¨ä¸­çš„å‰å‡ ä¸ªå…ƒç´ "><a href="#å–å‡ºåˆ—è¡¨ä¸­çš„å‰å‡ ä¸ªå…ƒç´ " class="headerlink" title="å–å‡ºåˆ—è¡¨ä¸­çš„å‰å‡ ä¸ªå…ƒç´ "></a>å–å‡ºåˆ—è¡¨ä¸­çš„å‰å‡ ä¸ªå…ƒç´ </h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">take'</span> :: (<span class="type">Num</span> i, <span class="type">Ord</span> i) =&gt; i -&gt; [a] -&gt; [a]  </span><br><span class="line"><span class="title">take'</span> n _</span><br><span class="line">    | n &lt;= <span class="number">0</span>   = []</span><br><span class="line"><span class="title">take'</span> _ []     = []</span><br><span class="line"><span class="title">take'</span> n (x:xs) = x : take' (n<span class="number">-1</span>) xs</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>take&#39; n _</code> å’Œ <code>take&#39; _ []</code> åˆ†åˆ«ä½œä¸ºä¸¤ç§ä¸åŒæƒ…å†µä¸‹çš„ç»ˆæ­¢æ¡ä»¶ã€‚<br>ç¬¬ä¸€ä¸ªæ¨¡å¼ <code>take&#39; n _</code> è¡¨ç¤ºå½“ <code>n</code> å°äºç­‰äº 0 æ—¶ï¼Œä¸ç®¡è¾“å…¥çš„æ˜¯ä»€ä¹ˆæ ·çš„åˆ—è¡¨éƒ½è¿”å›ç©ºåˆ—è¡¨ <code>[]</code>ã€‚<br>å¯ä»¥ä½œä¸ºå¦‚ <code>take&#39; 2 [1, 2, 3]</code> çš„ç»ˆæ­¢æ¡ä»¶ã€‚å³å‰ä¸¤ä¸ªå…ƒç´ è¢«å–å‡ºå¹¶æ‹¼æ¥æˆ <code>[1, 2]</code> å <code>n</code> ç­‰äº 0ï¼Œæ»¡è¶³ç¬¬ä¸€ä¸ªæ¨¡å¼ï¼Œé€’å½’ç»ˆæ­¢ã€‚<br>ç¬¬äºŒä¸ªæ¨¡å¼ <code>take _ []</code> è¡¨ç¤ºå½“è¾“å…¥çš„åˆ—è¡¨æ˜¯ç©ºåˆ—è¡¨æ—¶ï¼Œä¸ç®¡ <code>n</code> æ˜¯å¤šå°‘éƒ½è¿”å›ç©ºåˆ—è¡¨ã€‚<br>å¯ä»¥ä½œä¸ºå¦‚ <code>take&#39; 3 [1, 2]</code> çš„ç»ˆæ­¢æ¡ä»¶ã€‚å³å‰ä¸¤ä¸ªå…ƒç´ è¢«å–å‡ºå¹¶æ‹¼æ¥æˆ <code>[1, 2]</code> åï¼Œn ä¸º 1ï¼Œä½†åˆ—è¡¨æˆä¸ºç©ºåˆ—è¡¨ï¼Œæ»¡è¶³ç¬¬äºŒä¸ªæ¨¡å¼ï¼Œé€’å½’ç»ˆæ­¢ã€‚<br>ç¬¬ä¸‰ä¸ªæ¨¡å¼ <code>take&#39; n (x:xs)</code> åˆ™ç”¨æ¥å®šä¹‰ä»è¾“å…¥çš„åˆ—è¡¨å¤´éƒ¨é€ä¸ªå–å‡º n ä¸ªå…ƒç´ å¹¶æ‹¼æ¥æˆæ–°åˆ—è¡¨çš„é€’å½’é€»è¾‘ã€‚</p><h5 id="reverse-çš„è‡ªå®šä¹‰å®ç°"><a href="#reverse-çš„è‡ªå®šä¹‰å®ç°" class="headerlink" title="reverse çš„è‡ªå®šä¹‰å®ç°"></a>reverse çš„è‡ªå®šä¹‰å®ç°</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">reverse'</span> :: [a] -&gt; [a]</span><br><span class="line"><span class="title">reverse'</span> [] = []</span><br><span class="line"><span class="title">reverse'</span> (x:xs) = reverse' xs ++ [x]</span><br></pre></td></tr></table></figure><h5 id="zip-çš„è‡ªå®šä¹‰å®ç°"><a href="#zip-çš„è‡ªå®šä¹‰å®ç°" class="headerlink" title="zip çš„è‡ªå®šä¹‰å®ç°"></a>zip çš„è‡ªå®šä¹‰å®ç°</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">zip'</span> :: [a] -&gt; [b] -&gt; [(a,b)]</span><br><span class="line"><span class="title">zip'</span> _ [] = []</span><br><span class="line"><span class="title">zip'</span> [] _ = []</span><br><span class="line"><span class="title">zip'</span> (x:xs) (y:ys) = (x,y):zip' xs ys</span><br></pre></td></tr></table></figure><h5 id="elem-çš„è‡ªå®šä¹‰å®ç°ï¼ˆåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªåˆ—è¡¨ï¼‰"><a href="#elem-çš„è‡ªå®šä¹‰å®ç°ï¼ˆåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªåˆ—è¡¨ï¼‰" class="headerlink" title="elem çš„è‡ªå®šä¹‰å®ç°ï¼ˆåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªåˆ—è¡¨ï¼‰"></a>elem çš„è‡ªå®šä¹‰å®ç°ï¼ˆåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªåˆ—è¡¨ï¼‰</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">elem'</span> :: (<span class="type">Eq</span> a) =&gt; a -&gt; [a] -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">elem'</span> a [] = <span class="type">False</span></span><br><span class="line"><span class="title">elem'</span> a (x:xs)</span><br><span class="line">    | a == x    = <span class="type">True</span></span><br><span class="line">    | otherwise = a `elem'` xs</span><br></pre></td></tr></table></figure><h5 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h5><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">quicksort</span> :: (<span class="type">Ord</span> a) =&gt; [a] -&gt; [a]</span><br><span class="line"><span class="title">quicksort</span> [] = []</span><br><span class="line"><span class="title">quicksort</span> (x:xs) =</span><br><span class="line">    <span class="keyword">let</span> smallerSorted = quicksort [a | a &lt;- xs, a &lt;= x]</span><br><span class="line">        biggerSorted = quicksort [a | a &lt;- xs, a &gt; x]</span><br><span class="line">    <span class="keyword">in</span>  smallerSorted ++ [x] ++ biggerSorted</span><br></pre></td></tr></table></figure><h5 id="é€’å½’æ€ç»´"><a href="#é€’å½’æ€ç»´" class="headerlink" title="é€’å½’æ€ç»´"></a>é€’å½’æ€ç»´</h5><p>é€’å½’å‡½æ•°çš„å®šä¹‰é€šå¸¸éµå¾ªå¦‚ä¸‹æ¨¡å¼ï¼š</p><ul><li>å®šä¹‰è¾¹ç¼˜æ¡ä»¶ï¼ˆedge conditonï¼‰ç”¨äºåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ç»ˆæ­¢é€’å½’çš„æ‰§è¡Œ</li><li>å–å‡ºéƒ¨åˆ†å…ƒç´ æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œå†è°ƒç”¨é€’å½’å‡½æ•°æœ¬èº«å¤„ç†å‰©ä½™çš„å…ƒç´ </li></ul><p>æŸä¸ªåˆ—è¡¨ä¸­æ‰€æœ‰å…ƒç´ ä¹‹å’Œç­‰äºè¯¥åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŠ ä¸Šå‰©ä½™çš„æ‰€æœ‰å…ƒç´ ä¹‹å’Œï¼›æŸä¸ªåˆ—è¡¨çš„é•¿åº¦ç­‰äºå°¾éƒ¨ï¼ˆå»é™¤å¤´éƒ¨ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰æ‰€æœ‰å…ƒç´ çš„é•¿åº¦åŠ  1ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œedge condition å°±æ˜¯ä»¤é€’å½’å‡½æ•°æ— å®é™…æ„ä¹‰çš„æ¡ä»¶ã€‚å¯¹äºåˆ—è¡¨æ¥è¯´ï¼Œæœ€å¸¸è§çš„ edge condition å°±æ˜¯ç©ºåˆ—è¡¨ã€‚</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p><a href="http://learnyouahaskell.com/" target="_blank" rel="noopener">Learn You a Haskell for Great Good!</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;é€’å½’æ˜¯ä¸€ç§å®šä¹‰å‡½æ•°çš„æ–¹å¼ï¼Œåœ¨è¯¥æ–¹å¼ä¸‹ï¼Œå‡½æ•°çš„å®šä¹‰ä¸­è°ƒç”¨äº†è¯¥å‡½æ•°æœ¬èº«ã€‚æœ‰ç‚¹åƒä¿„ç½—æ–¯å¥—å¨ƒã€‚&lt;/p&gt;
&lt;p&gt;æ•°å­¦ä¸­çš„å®šä¹‰å¾ˆå¤šæ—¶å€™éƒ½ä¼šç”¨åˆ°é€’å½’ï¼Œæ¯”å¦‚ fibonacci æ•°åˆ—ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;F(0) = 1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;F(
      
    
    </summary>
    
      <category term="Program" scheme="https://rollingstarky.github.io/categories/Program/"/>
    
    
      <category term="Program" scheme="https://rollingstarky.github.io/tags/Program/"/>
    
      <category term="Functional" scheme="https://rollingstarky.github.io/tags/Functional/"/>
    
      <category term="Haskell" scheme="https://rollingstarky.github.io/tags/Haskell/"/>
    
      <category term="Function" scheme="https://rollingstarky.github.io/tags/Function/"/>
    
      <category term="Recursion" scheme="https://rollingstarky.github.io/tags/Recursion/"/>
    
      <category term="Computation" scheme="https://rollingstarky.github.io/tags/Computation/"/>
    
  </entry>
  
</feed>
